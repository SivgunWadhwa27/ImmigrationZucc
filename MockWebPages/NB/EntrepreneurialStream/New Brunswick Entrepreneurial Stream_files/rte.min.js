window.CUI=window.CUI||{};
CUI.rte=CUI.rte||{};
CUI.rte.commands={};
CUI.rte.plugins={};
CUI.rte.adapter={};
CUI.rte.ui={};
CUI.rte.ui.ext={};
CUI.rte.ui.cui={};
CUI.rte.ui.stub={};
var Class;
var Exception;
(function(){var c=function(e){var d=e.bind(this);
d._methodName=e._methodName;
this[d._methodName]=d;
return d
};
var b=function(d){d.extend=this;
return new Class(d)
};
Class=function(d){d=d||{};
if(d.hasOwnProperty("extend")&&!d.extend){throw new Class.NonTruthyExtendError(d.toString==="function"?d.toString():d.toString)
}var g=d.extend||Object;
var k=d.construct;
var e=d.destruct;
delete d.bind;
delete d.extend;
delete d.destruct;
delete d.construct;
if(d.hasOwnProperty("toString")&&typeof d.toString!=="function"){var i=d.toString;
d.toString=function(){return i.toString()
}
}else{if(!d.hasOwnProperty("toString")&&g.prototype.hasOwnProperty("toString")){d.toString=g.prototype.toString
}}var l=d;
var h=Object.create(g&&g.prototype);
h.superClass=g.prototype;
if(l){for(var j in l){if(l.hasOwnProperty(j)){h[j]=l[j];
if(typeof l[j]==="function"){h[j]._methodName=j;
h[j]._parentProto=h
}}}}h.inherited=function(p){var o=p.callee;
var m=o._methodName;
if(!m){throw new Class.MissingCalleeError(this.toString())
}var r=o._parentProto;
var n=null;
while(r.superClass){r=r.superClass;
n=r[m];
if(typeof n==="function"){break
}}if(typeof n==="function"){var q=this.inherited;
this.inherited=r.inherited;
var s=n.apply(this,p);
this.inherited=q;
return s
}else{throw new Class.InheritedMethodNotFoundError(this.toString(),m)
}};
h.bind=c;
h.destruct=function(){if(typeof e==="function"){e.apply(this)
}if(g&&g.prototype&&typeof g.prototype.destruct==="function"){g.prototype.destruct.apply(this)
}};
h.construct=function(){var m=arguments;
if(m[0]===undefined){m.length=1;
m[0]={}
}if(g&&g.prototype&&typeof g.prototype.construct==="function"){g.prototype.construct.apply(this,arguments)
}if(typeof k==="function"){k.apply(this,arguments)
}};
var f=function(){var m=Object.create(h);
h.construct.apply(m,arguments);
return m
};
f.toString=h.toString;
f.prototype=h;
f.extend=b;
h.constructor=f;
return f
};
if(!Object.create){Object.create=function(e){if(arguments.length>1){throw new Error("Object.create implementation only accepts the first parameter.")
}function d(){}d.prototype=e;
return new d()
}
}if(!Function.prototype.bind){Function.prototype.bind=function(e){if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")
}var h=Array.prototype.slice.call(arguments,1);
var g=this;
var d=function(){};
var f=function(){return g.apply(this instanceof d?this:e,h.concat(Array.prototype.slice.call(arguments)))
};
d.prototype=this.prototype;
f.prototype=new d();
return f
}
}Exception=new Class({extend:Error,construct:function(){this.name="Error";
this.message="General exception"
},toString:function(){return this.name+": "+this.message
}});
var a=Exception.extend({name:"Class Exception"});
Class.NonTruthyExtendError=a.extend({construct:function(d){this.message=d+" attempted to extend a non-truthy object"
}});
Class.InheritedMethodNotFoundError=a.extend({construct:function(e,d){this.message=e+" can't call method '"+d+"', no method defined in parent classes"
}});
Class.MissingCalleeError=a.extend({construct:function(d){this.message=d+" can't call inherited method: calling method did not have _methodName"
}})
}());
CUI.rte.Eventing=function(){var a=[];
return{on:function(f,g,b,e,d,c){var h=function(j){var i=new CUI.rte.adapter.ExtEvent(j,f);
e.call(this,i)
};
a.push({handler:e,wrapper:h});
CQ.Ext.EventManager.on(g,b,h,d,c)
},un:function(g,b,d,c){var h=null;
for(var f=0;
f<a.length;
f++){if(a[f].handler===d){h=a[f].wrapper;
a.splice(f,1);
break
}}if(h==null){throw new Error("Unregistered handler provided.")
}CQ.Ext.EventManager.un(g,b,h,c)
}}
}();
CUI.rte.EditorEvent=new Class({toString:"EditorEvent",type:null,key:null,charCode:0,metaKeyPressed:false,ctrlKeyPressed:false,button:Math.NaN,cancelKey:false,editContext:null,_init:function(a){CUI.rte.Utils.apply(this,a)
},getType:function(){return this.type
},isCaretKey:function(){throw new Error("EditorEvent#isCaretKey must be overridden by the extending class.")
},isCaretMovement:function(){throw new Error("EditorEvent#isCaretMovement must be overridden by the extending class.")
},getKey:function(){return this.key
},getCharCode:function(){return this.charCode
},isTab:function(){throw new Error("EditorEvent#isTab must be overridden by the extending class.")
},isEnter:function(){throw new Error("EditorEvent#isEnter must be overridden by the extending class.")
},isSpace:function(){throw new Error("EditorEvent#isSpace must be overridden by the extending class.")
},isBackSpace:function(){throw new Error("EditorEvent#isBackSpace must be overridden by the extending class.")
},isDelete:function(){throw new Error("EditorEvent#isDelete must be overridden by the extending class.")
},isShift:function(){return this.shiftKeyPressed
},isMeta:function(){return this.metaKeyPressed
},isCtrl:function(){return this.ctrlKeyPressed
},getPos:function(){return this.pos
},getButton:function(){return this.button
},preventDefault:function(){throw new Error("EditorEvent#preventDefault must be overridden by the extending class.")
},stopPropagation:function(){throw new Error("EditorEvent#stopPropagation must be overridden by the extending class.")
},stopEvent:function(){throw new Error("EditorEvent#stopEvent must be overridden by the extending class.")
}});
CUI.rte.adapter.ExtEvent=new Class({toString:"ExtEvent",extend:CUI.rte.EditorEvent,nativeEvent:null,extEvent:null,construct:function(b,c){this.nativeEvent=b;
this.extEvent=b;
var a={type:b.type,key:b.getKey(),charCode:b.getCharCode(),metaKeyPressed:b.metaKey,ctrlKeyPressed:b.ctrlKey,shiftKeyPressed:b.shiftKey,pos:{x:b.getPageX(),y:b.getPageY()},button:b.button,editContext:c};
this._init(a)
},isTab:function(){return this.nativeEvent.getKey()==this.nativeEvent.TAB
},isEnter:function(){return this.nativeEvent.getKey()==this.nativeEvent.ENTER
},isSpace:function(){return this.nativeEvent.getKey()==this.nativeEvent.SPACE
},isBackSpace:function(){return this.nativeEvent.getKey()==this.nativeEvent.BACKSPACE
},isDelete:function(){return this.nativeEvent.getKey()==this.nativeEvent.DELETE
},isCaretKey:function(){var a=this.nativeEvent.getKey();
return(a==this.nativeEvent.UP)||(a==this.nativeEvent.DOWN)||(a==this.nativeEvent.LEFT)||(a==this.nativeEvent.RIGHT)
},isCaretMovement:function(){var a=this.nativeEvent.getKey();
return this.isCaretKey()||(a==this.nativeEvent.PAGE_UP)||(a==this.nativeEvent.PAGE_DOWN)||(a==this.nativeEvent.HOME)||(a==this.nativeEvent.END)
},preventDefault:function(){this.nativeEvent.preventDefault()
},stopPropagation:function(){this.nativeEvent.stopPropagation()
},stopEvent:function(){this.nativeEvent.stopEvent()
}});
CUI.rte.Query=function(){return{selectNode:function(a,b){return CQ.Ext.DomQuery.selectNode(a,b)
},select:function(a,b){return CQ.Ext.DomQuery.select(a,b)
}}
}();
CUI.rte.AdapterUtils=function(){return{isArray:function(a){return CQ.Ext.isArray(a)
},isString:function(a){return CQ.Ext.isString(a)
},apply:function(c,a,b){return CQ.Ext.apply(c,a,b)
},getPagePosition:function(a){return CQ.Ext.get(a).getXY()
},getWidth:function(a){return CQ.Ext.get(a).getSize().width
},getHeight:function(a){return CQ.Ext.get(a).getSize().height
},jsonDecode:function(a){return CQ.Ext.util.JSON.decode(a)
},getBlankImageUrl:function(){return CQ.Ext.BLANK_IMAGE_URL
}}
}();
CUI.rte.Constants={EXTENSION_HTML:".html"};
CUI.rte.Hooks=new Class({copyObject:function(d){var b;
if(CUI.rte.Utils.isArray(d)){b=[];
for(var c=0;
c<d.length;
c++){b.push(this.copyObject(d[c]))
}}else{if(typeof(d)=="object"){b={};
for(var a in d){if(d.hasOwnProperty(a)){b[a]=this.copyObject(d[a])
}}}else{b=d
}}return b
},applyDefaults:function(d,c){d=d||{};
c=c||{};
if(typeof(d)==="object"){for(var b in c){if(c.hasOwnProperty(b)){var a=c[b];
if(a&&(typeof(a)==="object")&&!CUI.rte.Utils.isArray(a)){d[b]=this.applyDefaults(d[b],a)
}else{if(typeof(d[b])==="undefined"){d[b]=a
}}}}}return d
},getMainWindow:function(){return window
},processUrl:function(a,b){return a
},onPluginCreated:function(a){return a
},resolveRelativePath:function(e){var g=document.location.pathname;
var b=g.substring(0,g.lastIndexOf("/"));
var f=b.split("/");
var d=e.split("/");
for(var c=0;
c<d.length;
c++){var a=d[c];
if(a===".."){if(f.length<=1){throw new Error("Invalid relative path: "+e)
}f.splice(f.length-1,1)
}else{if(a!=="."){f.push(a)
}}}return f.join("/")
},isExistingPage:function(a){return true
},getServerPrefix:function(a){var c=a.indexOf("://");
if(c<0){return""
}var b=a.indexOf("/",c+3);
return b<0?a:a.substring(0,b)
}});
CUI.rte.I18nProvider=new Class({getText:function(b,a){return b
}});
CUI.rte.Utils=function(){var a=null;
var d=function(){if(!a){a=new CUI.rte.Hooks()
}return a
};
var c=null;
var b=function(){if(!c){c=new CUI.rte.I18nProvider()
}return c
};
return{scope:function(f,e){return function(){return f.apply(e,arguments)
}
},defer:function(i,g,h,f){var e=i;
if(h){e=function(){if(f){i.apply(h,f)
}else{i.call(h)
}}
}else{if(f){e=function(){i.apply(h,f)
}
}}return window.setTimeout(e,g)
},htmlEncode:function(e){if(e){e=String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")
}return e
},htmlDecode:function(e){if(e){e=String(e).replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&amp;/g,"&")
}return e
},stripTags:function(e){if(e){e=String(e).replace(/<\/?[a-z][a-z0-9]*[^<>]*>/gi,"")
}return e
},merge:function(g,f){for(var e in f){if(f.hasOwnProperty(e)){g[e]=f[e]
}}return g
},setI18nProvider:function(e){c=e
},i18n:function(f,e){return b().getText(f,e)
},copyObject:function(e){return d().copyObject(e)
},applyDefaults:function(f,e){return d().applyDefaults(f,e)
},getMainWindow:function(){return d().getMainWindow()
},processUrl:function(e,f){return d().processUrl(e,f)
},onPluginCreated:function(e){return d().onPluginCreated(e)
},resolveRelativePath:function(e){return d().resolveRelativePath(e)
},isExistingPage:function(e){return d().isExistingPage(e)
},getServerPrefix:function(e){return d().getServerPrefix(e)
},URL_IMAGE:"image",URL_LINK:"link",isArray:CUI.rte.AdapterUtils.isArray,isString:CUI.rte.AdapterUtils.isString,apply:CUI.rte.AdapterUtils.apply,getPagePosition:CUI.rte.AdapterUtils.getPagePosition,getWidth:CUI.rte.AdapterUtils.getWidth,getHeight:CUI.rte.AdapterUtils.getHeight,jsonDecode:CUI.rte.AdapterUtils.jsonDecode,getBlankImageUrl:CUI.rte.AdapterUtils.getBlankImageUrl}
}();
CUI.rte.EditContext=new Class({toString:"EditContext",iFrame:null,win:null,doc:null,root:null,state:null,construct:function(a,d,c,b){this.iFrame=a;
this.win=d;
this.doc=c;
this.root=b;
this.state={}
},createElement:function(a){return(this.doc!=null?this.doc.createElement(a):null)
},createTextNode:function(a){return(this.doc!=null?this.doc.createTextNode(a):null)
},isInitialized:function(){return(this.win!=null)&&(this.doc!=null)&&(this.root!=null)
},setState:function(a,b){this.state[a]=b
},getState:function(a){var b=undefined;
if(this.state.hasOwnProperty(a)){b=this.state[a]
}return b
},removeState:function(a){if(this.state.hasOwnProperty(a)){delete this.state[a]
}}});
CUI.rte.EditorKernel=new Class({toString:"EditorKernel",removeSingleParagraphContainer:false,singleParagraphContainerReplacement:null,linkInternalize:null,htmlRules:null,preProcessor:null,postProcessor:null,registeredCommands:null,registeredPlugins:null,editContext:null,internalListeners:null,uiListeners:null,toolbar:null,backgroundToolbars:{},contextMenuBuilder:null,contextMenu:null,contextMenuSavedRange:null,registeredHandlers:null,isEventingEstablished:false,isEventingDisabled:true,isTemporaryBlur:false,isFocusHandlingDisabled:false,hasFocus:false,isEnabled:false,focusGainActions:null,keyboardShortcuts:null,uiToolkit:null,dialogManager:null,selectionChangeTracker:null,lockCount:0,tbBuilder:null,construct:function(d,h){d=d||{};
CUI.rte.Utils.applyDefaults(d,{linkInternalize:[{tag:"a",attribute:"href"},{tag:"img",attribute:"src"}]});
this.keyboardShortcuts={};
this.registeredCommands=CUI.rte.commands.CommandRegistry.createRegisteredCommands();
this.registeredPlugins=CUI.rte.plugins.PluginRegistry.createRegisteredPlugins(this);
CUI.rte.Compatibility.moveDeprecatedPluginConfig(d);
CUI.rte.Compatibility.moveDeprecatedHtmlRules(d);
CUI.rte.Compatibility.configurePlugins(d,this,h);
delete d.rtePlugins;
if(d.htmlRules){this.htmlRules=new CUI.rte.HtmlRules(d.htmlRules);
delete d.htmlRules
}else{this.htmlRules=new CUI.rte.HtmlRules()
}if(d.uiToolkit){this.uiToolkit=d.uiToolkit;
delete d.uiToolkit
}else{this.uiToolkit=CUI.rte._toolkit||CUI.rte.EditorKernel.DEFAULT_TOOLKIT
}this.linkInternalize=d.linkInternalize;
delete d.linkInternalize;
var b={};
if(this.tagReplace){for(var a in this.tagReplace){if(this.tagReplace.hasOwnProperty(a)){var e=this.tagReplace[a];
b[a]={rename:e}
}}}var g=this.htmlRules.serializer.cleanup?this.htmlRules.serializer.cleanup.pre:undefined;
g=g?g:{tagsToRemove:["font"]};
var f=this.htmlRules.serializer.cleanup?this.htmlRules.serializer.cleanup.post:undefined;
f=f?f:{tagsToRemove:["font"]};
this.setProcessors(g,f);
var c=CUI.rte.ui.ToolkitRegistry.get(this.uiToolkit);
this.contextMenuBuilder=c.createContextMenuBuilder(this);
this.dialogManager=c.createDialogManager(this);
this.registeredHandlers=[];
this.isEnabled=true;
this.focusGainActions={}
},setProcessors:function(b,a){this.preProcessor=new CUI.rte.DomCleanup(b);
this.postProcessor=new CUI.rte.DomCleanup(a)
},getEditContext:function(){if(this.editContext==null){this.editContext=new CUI.rte.EditContext()
}return this.editContext
},getHtmlRules:function(){return this.htmlRules
},getPlugin:function(b){var a;
if(this.registeredPlugins.hasOwnProperty(b)){a=this.registeredPlugins[b]
}return a
},getContentPath:function(){return null
},getFocusDom:function(a){return null
},focus:function(a){},blurFocus:function(a){},calculateWindowPosition:function(a){return[0,0]
},calculateContextMenuPosition:function(a){return[0,0]
},canEditSource:function(){return false
},getDialogManager:function(){return this.dialogManager
},deferFocus:function(a){CUI.rte.Utils.defer(function(){this.focus();
if(a&&(typeof(a)=="function")){a()
}},10,this)
},disableEventHandling:function(){this.isEventingDisabled=true
},reenableEventHandling:function(){this.isEventingDisabled=false
},enableFocusHandling:function(){this.isFocusHandlingDisabled=false
},disableFocusHandling:function(){this.isFocusHandlingDisabled=true
},lock:function(){this.lockCount++;
if(this.isLocked()&&!this.isEventingDisabled){this.disableEventHandling()
}},unlock:function(){this.lockCount--;
if(!this.isLocked()&&this.isEventingDisabled){this.reenableEventHandling()
}},isLocked:function(){return(this.lockCount>0)
},initializeGeckoSpecific:function(){var a=CUI.rte.Common;
if(a.ua.isGecko&&this.isEnabled){var b=this.getEditContext();
if(b.isInitialized()){try{b.doc.execCommand("useCSS",true)
}catch(c){}try{b.doc.execCommand("styleWithCSS",false,false)
}catch(c){}try{b.doc.execCommand("enableInlineTableEditing",false,false)
}catch(c){}}}},initializeCaret:function(a){},restoreSelectionToLastKnownBookmark:function(){var c=CUI.rte.Selection;
var a=CUI.rte.Common;
var b=this.getEditContext();
if(a.ua.isOldIE&&this.lastKnownBookmark){if(!this.hasFocus){this.focus()
}c.selectBookmark(b,this.lastKnownBookmark)
}},registerHandler:function(f,b,e,d,c){var a=CUI.rte.Common;
if(a.ua.isTouchInIframe&&a.strStartsWith(b,"touch")){return
}CUI.rte.Eventing.on(this.editContext,f,b,e,d,c);
this.registeredHandlers.push({obj:f,eventName:b,handler:e,scope:d})
},registerHandlers:function(f,c,e,b){for(var a in c){if(c.hasOwnProperty(a)){var d=c[a];
this.registerHandler(f,a,d,e,b)
}}},unregisterHandlers:function(){var c=this.registeredHandlers.length;
for(var a=0;
a<c;
a++){var b=this.registeredHandlers[a];
CUI.rte.Eventing.un(b.obj,b.eventName,b.handler,b.scope)
}this.registeredHandlers.length=0
},initializeEventHandling:function(){if(this.isEventingEstablished){return
}var a=CUI.rte.Common;
var b=this.getEditContext();
if(b.isInitialized()&&this.isEnabled){this.isEventingEstablished=true;
var d=b.doc;
if(a.ua.isIE){this.registerHandlers(d,{selectionchange:function(f){this.onEditorEvent(f)
},keyup:function(f){this.onEditorEvent(f);
if(this.isEventingDisabled){return
}this.firePluginEvent("deferredkeyup",f,true)
},mousedown:function(f){if(this.isEventingDisabled){return
}this.firePluginEvent("deferredmousedown",f,true)
},mouseup:function(f){if(this.isEventingDisabled){return
}this.firePluginEvent("deferredmouseup",f,true)
}},this,{buffer:100})
}else{this.registerHandlers(d,{keyup:function(f){this.onEditorEvent(f);
if(this.isEventingDisabled){return
}this.firePluginEvent("deferredkeyup",f,true)
}},this,{buffer:100});
if(!a.ua.isTouch){this.registerHandlers(d,{mousedown:function(f){if(this.isEventingDisabled){return
}this.firePluginEvent("deferredmousedown",f,true)
},mouseup:function(f){this.onEditorEvent(f);
if(this.isEventingDisabled){return
}this.firePluginEvent("deferredmouseup",f,true)
}},this,{buffer:100})
}else{this.registerHandlers(d,{touchstart:function(f){if(this.isEventingDisabled){return
}this.firePluginEvent("deferredmousedown",f,true)
},touchend:function(f){this.onEditorEvent(f);
if(this.isEventingDisabled){return
}this.firePluginEvent("deferredmouseup",f,true)
}},this,{buffer:100});
var c=this;
this.selectionChangeTracker=window.setInterval(function(){var g=CUI.rte.Selection;
var e=g.createSelectionBookmark(b);
if(this.lastKnownSelection){var f=this.lastKnownSelection;
if((e.startPos!=f.startPos)||(e.charCnt!=f.charCnt)||(e.object!=f.object)){c.onEditorEvent(new CUI.rte.EditorEvent({type:"selectionchange"}))
}}this.lastKnownSelection=e
},500)
}}this.registerHandlers(d,{keydown:function(f){if(this.isEventingDisabled){return
}this.firePluginEvent("deferredkeydown",f,true)
}},this,{buffer:100});
this.registerHandlers(d,{keydown:function(g){if(a.ua.isTouch){if(a.isTag(b.win.frameElement,"iframe")){b.win.focus()
}}this.cleanupOnEvent(g);
if(this.isEventingDisabled){return
}if(g.isCtrl()){if(a.ua.isIE){var h=String.fromCharCode(g.getCharCode()).toLowerCase();
var f=this.keyboardShortcuts[h];
if(f){this.applyCommand(g);
return
}else{if((h=="b")||(h=="i")||(h=="u")||(h=="m")){g.stopEvent();
return
}}}}this.firePluginEvent("beforekeydown",g,false);
if(!g.cancelKey){this.firePluginEvent("keydown",g,false)
}if(g.cancelKey){g.stopEvent();
this.deferFocus()
}},keyup:function(f){this.cleanupOnEvent(f);
if(this.isEventingDisabled){return
}this.firePluginEvent("beforekeyup",f,false);
if(!f.cancelKey){this.firePluginEvent("keyup",f,false)
}if(f.cancelKey){f.stopEvent();
this.deferFocus()
}},keypress:function(f){this.cleanupOnEvent(f);
if(this.isEventingDisabled){return
}if(a.ua.isGecko){this.applyCommand(f)
}if(!f.cancelKey){this.firePluginEvent("beforekeypress",f,false)
}if(!f.cancelKey){this.firePluginEvent("keypress",f,false)
}if(f.cancelKey){f.stopEvent();
this.deferFocus()
}}},this);
if(a.ua.isTouch){this.registerHandlers(d,{touchstart:function(f){this.cleanupOnEvent(f);
if(this.isEventingDisabled){return
}this.firePluginEvent("mousedown",f,false)
},touchend:function(f){this.cleanupOnEvent(f);
if(this.isEventingDisabled){return
}this.firePluginEvent("mouseup",f,false)
}},this)
}else{this.registerHandlers(d,{mousedown:function(f){this.cleanupOnEvent(f);
if(this.isEventingDisabled){return
}this.firePluginEvent("mousedown",f,false)
},mouseup:function(f){this.cleanupOnEvent(f);
if(this.isEventingDisabled){return
}this.firePluginEvent("mouseup",f,false)
}},this)
}this.registerHandlers(this.getFocusDom(b),{focus:function(f){this.cleanupOnEvent(f);
this.onFocus(f)
},blur:function(f){this.cleanupOnEvent(f);
this.onBlur(f)
}},this);
this.registerHandlers(d.body,{paste:function(f){this.cleanupOnEvent(f);
this.onPaste(f)
}},this);
if(a.ua.isIE){this.registerHandlers(d,{selectionchange:function(f){this.cleanupOnEvent(f)
}},this,{buffer:10})
}this.initializeGeckoSpecific();
this.registerHandler(b.root,"contextmenu",function(e){if(this.isEventingDisabled){return false
}this.isEventingDisabled=true;
e.preventDefault();
if(!this.handleContextMenu(e)){this.isEventingDisabled=false
}return false
},this)
}},suspendEventHandling:function(){if(!this.isEventingEstablished){return
}this.unregisterHandlers();
if(this.selectionChangeTracker!==null){window.clearInterval(this.selectionChangeTracker);
this.selectionChangeTracker=null
}this.isEventingEstablished=false
},addFeatureClasses:function(c){var a=CUI.rte.Common;
function b(e,d){if(e){a.addClass(c,d)
}}b(a.ua.isIE,"ie");
b(a.ua.isIE6,"ie6");
b(a.ua.isIE7,"ie7");
b(a.ua.isIE8,"ie8");
b(a.ua.isIE9,"ie9");
b(a.ua.isIE10,"ie10");
b(a.ua.isGecko,"gecko");
b(a.ua.isWebKit,"webkit");
b(a.ua.isSafari,"safari");
b(a.ua.isChrome,"chrome")
},onFocus:function(f){var b=CUI.rte.Common;
if(!this.hasFocus){if(b.ua.isOldIE){var d=this.getEditContext();
var g=d.win;
var a=CUI.rte.Selection.getLeadRange(d);
var c;
if(a.item){c=a.item(0).ownerDocument.parentWindow
}else{c=a.parentElement().ownerDocument.parentWindow
}var h=(c==g);
if(!h){return
}}this.isEventingDisabled=false;
this.hasFocus=true;
if(!this.isFocusHandlingDisabled){this.fireUIEvent("focusgained");
this.enableToolbar();
this.updateToolbar()
}this.onEditorEvent(f);
if(this.focusGainActions.initializeCaret){this.initializeCaret(false);
this.focusGainActions.initializeCaret=false
}}},onBlur:function(a){if(this.hasFocus){this.isEventingDisabled=true;
this.isTemporaryBlur=false;
this.hasFocus=false;
if(!this.isFocusHandlingDisabled){this.fireUIEvent("focuslost");
CUI.rte.Utils.defer(function(){if(this.isEventingDisabled&&!this.isTemporaryBlur&&!this.isFocusHandlingDisabled){this.disableToolbar()
}},100,this)
}}},onPaste:function(a){if(this.isEventingDisabled){return
}this.firePluginEvent("paste",a,false)
},notifyBlur:function(){if(this.hasFocus){this.onBlur()
}},cleanupOnEvent:function(c){var a=CUI.rte.Common;
var b=CUI.rte.DomProcessor;
switch(c.getType()){case"mousedown":b.removeTempSpans(c.editContext,true);
break;
case"keydown":if(!a.ua.isWebKit){b.removeTempSpans(c.editContext,true)
}break;
case"keyup":if(a.ua.isWebKit){b.removeTempSpans(c.editContext,true)
}break
}},onEditorEvent:function(d){var a=CUI.rte.Common;
var c=false;
if(a.ua.isIE){if(d.getType()=="selectionchange"){c=true;
var b=this.getEditContext();
if(b.isInitialized()&&this.hasFocus){this.lastKnownBookmark=CUI.rte.Selection.createSelectionBookmark(b)
}}}else{c=(d.getType()=="mouseup")&&(d.getButton()==2)
}if(!c){if(this.contextMenu&&this.contextMenuBuilder.isVisible()){this.contextMenuBuilder.hideAll();
this.isEventingDisabled=false
}}if(this.isEventingDisabled){return
}this.fireUIEvent("updatestate",{origin:"event",event:d})
},getEmptyLinePlaceholderMarkup:function(){return"<p>&nbsp;</p>"
},setUnprocessedHtml:function(b){if(b.length<1){var c=this.execContentInterception("emptyContent",null);
if(c!=null){b=c
}else{b=this.getEmptyLinePlaceholderMarkup()
}}var a=this.getEditContext();
this.htmlRules.serializer.deserialize(a,b,a.root,this.htmlRules.docType);
CUI.rte.WhitespaceProcessor.process(a,a.root);
this.preProcessor.preprocess(this,a.root);
this.execContentInterception("postprocessDom",{editContext:a})
},getProcessedHtml:function(){var b=this.getEditContext();
var a=b.root.cloneNode(true);
this.execContentInterception("cleanDom",{editContext:this.getEditContext(),root:a});
this.postProcessor.postprocess(this,a);
return this.htmlRules.serializer.serialize(b,a,this.htmlRules.docType)
},getCustomCommand:function(d){var c=this.registeredCommands[d];
if(c){return c
}for(var b in this.registeredCommands){var a=this.registeredCommands[b];
if(a.isCommand(d)){return a
}}return null
},relayCmd:function(b,a){if(!this.isEnabled){return
}CUI.rte.Utils.defer(function(){var f=this.getEditContext();
var h=CUI.rte.Selection;
var c=CUI.rte.Common;
if(f.isInitialized()){this.focus(f)
}try{var g;
if(f.isInitialized()){g=(c.ua.isIE?null:h.getPreferredScrollOffset(f))
}var d=this.execCmd(b,a,f);
if(c.ua.isGecko&&d&&f.isInitialized()){if(d.geckoEnsureCaretVisibility){h.ensureCaretVisibility(f,g)
}if(d.bookmark){h.selectBookmark(f,d.bookmark)
}}}catch(i){if(i.message=="Cannot paste."){this.getDialogManager().alert(CUI.rte.Utils.i18n("kernel.alertTitlePaste"),CUI.rte.Utils.i18n("kernel.alertSecurityPaste"),CUI.rte.Utils.scope(this.deferFocus,this))
}else{if(i.message=="Cannot copy."){this.getDialogManager().alert(CUI.rte.Utils.i18n("kernel.alertTitleCopy"),CUI.rte.Utils.i18n("kernel.alertSecurityCopy"),CUI.rte.Utils.scope(this.deferFocus,this))
}else{if(i.message=="Cannot cut."){this.getDialogManager().alert(CUI.rte.Utils.i18n("kernel.alertTitleCut"),CUI.rte.Utils.i18n("kernel.alertSecurityCut"),CUI.rte.Utils.scope(this.deferFocus,this))
}else{if(i.message=="Could not insert html due to IE limitations."){this.getDialogManager().alert(CUI.rte.Utils.i18n("kernel.alertTitleError"),CUI.rte.Utils.i18n("kernel.alertIELimitation"),CUI.rte.Utils.scope(this.deferFocus,this))
}else{throw i
}}}}}this.fireUIEvent("updatestate",{origin:"command",cmd:b,value:a,ret:d})
},10,this)
},execCmd:function(f,k,a){var b=CUI.rte.Selection;
var l=CUI.rte.DomProcessor;
var d=CUI.rte.commands.Command;
var c=CUI.rte.Common;
if(!this.isEnabled){return null
}if(!a){a=this.getEditContext()
}var e=this.getCustomCommand(f);
if(!a.isInitialized()&&!e){return null
}if(!a.isInitialized()){if(e.requiresInitializedComponent(f)){return null
}}if(this.initialized){this.firePluginEvent("beforecommandexecuted",{cmd:f,cmdValue:k,customCommand:e},false)
}var i=null;
if(e){var m=e.getProcessingOptions();
var g={editContext:a,command:f,value:k,component:this};
if(a.isInitialized()){if((m&d.PO_SELECTION)>0){g.selection=this.createQualifiedSelection(a);
if(g.selection&&b.shouldNormalizePSel(a,g.selection)){b.normalizeProcessingSelection(a,g.selection)
}}if((m&d.PO_BOOKMARK)>0){if(g.selection){g.bookmark=b.bookmarkFromProcessingSelection(a,g.selection)
}else{g.bookmark=b.createSelectionBookmark(a)
}}if((m&d.PO_NODELIST)>0){if(!g.selection){g.selection=this.createQualifiedSelection(a)
}g.nodeList=l.createNodeList(a,g.selection)
}}var j=e.execute(g);
if(a.isInitialized()){var h=g.bookmark;
if(h&&j&&j.preventBookmarkRestore){h=null
}if(h&&j&&j.selOffset){if(j.selOffset.start){h.startPos+=j.selOffset.start
}if(j.selOffset.collapse){h.charCnt=0
}else{if(j.selOffset.cnt){h.charCnt+=j.selOffset.cnt
}}}if(h){b.selectBookmark(a,h)
}}if(j&&j.calleeRet){i=j.calleeRet
}}else{a.doc.execCommand(f,false,k===undefined?null:k);
if(c.ua.isGecko&&c.strStartsWith(f,"insert")&&c.strEndsWith(f,"list")){l.ensureBlockContent(a,"p",null,true,false)
}}if(a.isInitialized()){this.firePluginEvent("commandexecuted",{cmd:f,cmdValue:k,customCommand:e},false)
}return i
},queryState:function(d,a){if(!this.isEnabled){return false
}var b=this.getEditContext();
if(!b.isInitialized){return false
}var c=this.getCustomCommand(d);
if(!c){return b.doc.queryCommandState(d)
}if(!a){a=this.analyzeSelection()
}if(!a){return false
}return c.queryState(a,d)
},registerKeyboardShortcut:function(a,b){this.keyboardShortcuts[a.toLowerCase()]=b
},applyCommand:function(b){if(b.isCtrl()){var d=String.fromCharCode(b.getCharCode()).toLowerCase();
var a=this.keyboardShortcuts[d];
if(a){b.cancelKey=true;
b.stopEvent();
this.focus();
this.execCmd(a);
this.deferFocus()
}}},requestSourceEdit:function(a){this.isTemporaryBlur=true;
this.fireUIEvent((a?"enable":"disable")+"sourceedit")
},enable:function(){if(!this.isEnabled){this.isEnabled=true;
this.initializeEventHandling();
if(this.hasFocus){this.updateToolbar()
}}},disable:function(){if(this.isEnabled){this.suspendEventHandling();
this.disableToolbar(["sourceedit"]);
this.isEnabled=false
}},createQualifiedSelection:function(b){var c=CUI.rte.Selection.createProcessingSelection(b);
if(!c||(c.startNode==null)){return null
}for(var a in this.registeredPlugins){if(this.registeredPlugins.hasOwnProperty(a)){var d=this.registeredPlugins[a];
d.manipulateSelection(c)
}}return c
},createQualifiedRangeBookmark:function(b){var c=CUI.rte.Selection.createRangeBookmark(b);
for(var a in this.registeredPlugins){if(this.registeredPlugins.hasOwnProperty(a)){var d=this.registeredPlugins[a];
d.saveRangeBookmark(c)
}}return c
},selectQualifiedRangeBookmark:function(b,c){CUI.rte.Selection.selectRangeBookmark(b,c);
for(var a in this.registeredPlugins){if(this.registeredPlugins.hasOwnProperty(a)){var d=this.registeredPlugins[a];
d.restoreRangeBookmark(c)
}}},analyzeSelection:function(c,o){var e=CUI.rte.Selection;
var m=CUI.rte.DomProcessor;
if(!c){c=this.getEditContext()
}var b=[];
var d=[];
var a={};
var g=a;
var j=[];
var l=this.createQualifiedSelection(c);
if(!l){return(o?this.currentAnalyzedSelection:null)
}var k=e.isSelection(l);
if(e.shouldNormalizePSel(c,l)){e.normalizeProcessingSelection(c,l)
}var h=m.createNodeList(c,l);
h.getAnchors(c,b,true);
h.getNamedAnchors(c,d,true);
if(k){h.getStyles(c,a,true);
g={}
}var i=l.startNode;
m.getStyles(c,g,i);
var n=h.commonAncestor;
while(n){j.push(n);
n=CUI.rte.Common.getParentNode(c,n)
}var q=e.getSelectedDom(c,l);
var p=(a.styles?a.styles:[]);
var f=g.styles?g.styles:[];
this.currentAnalyzedSelection={selection:l,selectedDom:q,nodeList:h,isSelection:k,anchorCount:b.length,anchors:b,namedAnchorCount:d.length,namedAnchors:d,styleCount:p.length,styles:p,startStyleCount:f.length,startStyles:f,isContinuousStyle:a.isContinuousStyle,consistentFormatting:j,containerList:m.createContainerList(c,l),auxRoots:m.getAuxRoots(c,l),editContext:c};
return this.currentAnalyzedSelection
},addPluginListener:function(f,h,j,e,d,i){if(i==null){i=1000
}if(!this.internalListeners){this.internalListeners={}
}if(!this.internalListeners[f]){this.internalListeners[f]=[]
}var g=this.internalListeners[f];
var a=g.length;
var k={fn:j?CUI.rte.Utils.scope(h,j):h,plugin:e,deferred:d,priority:i};
for(var b=0;
b<a;
b++){var c=g[b];
if(c.priority>i){g.splice(b,0,k);
return
}}g.push(k)
},removePluginListener:function(b,e){if(!this.internalListeners||!this.internalListeners[b]){return
}var d=this.internalListeners[b];
var c=d.length;
for(var a=c-1;
a>=0;
a--){if(d[a].plugin==e){d.splice(a,1)
}}},firePluginEvent:function(b,g,f){if(!this.internalListeners||!this.internalListeners[b]){return
}var d;
if(g instanceof CUI.rte.EditorEvent){d=g
}else{d=new CUI.rte.plugins.PluginEvent(b,this.getEditContext(),g)
}var c=this.internalListeners[b].length;
for(var a=0;
a<c;
a++){var e=this.internalListeners[b][a];
if(e&&e.fn){if(e.deferred==f){e.fn(d)
}}}return d
},execContentInterception:function(e,a){for(var b in this.registeredPlugins){if(this.registeredPlugins.hasOwnProperty(b)){var c=this.registeredPlugins[b];
var d=c.interceptContent(e,a);
if(d!=null){return d
}}}return null
},addUIListener:function(a,c,b){if(!this.uiListeners){this.uiListeners={}
}if(!this.uiListeners[a]){this.uiListeners[a]=[]
}this.uiListeners[a].push({fn:b?CUI.rte.Utils.scope(c,b):c,idFn:c,idScope:b})
},removeUIListener:function(b,e,d){if(!this.uiListeners||!this.uiListeners[b]){return
}if(e){var c=this.uiListeners[b];
for(var a=c.length-1;
a>=0;
a--){var f=c[a];
if((f.idFn===e)&&(f.idScope===d)){c.splice(a,1)
}}}else{delete this.uiListeners[b]
}},fireUIEvent:function(b,f){if(!this.uiListeners||!this.uiListeners[b]){return
}var d=new CUI.rte.ui.UIEvent(b,this.getEditContext(),f);
var c=this.uiListeners[b].length;
for(var a=0;
a<c;
a++){var e=this.uiListeners[b][a];
if(e&&e.fn){e.fn(d)
}}return d
},getToolbarHeight:function(){return this.toolbar.getHeight()
},getToolbarItem:function(a){return this.toolbar.getItem(a)
},createToolbar:function(b){b=b||{};
b.editorKernel=this;
if(!this.tbBuilder){this.tbBuilder=this.createToolbarBuilder();
for(var a in this.registeredPlugins){if(this.registeredPlugins.hasOwnProperty(a)){var c=this.registeredPlugins[a];
c.initializeUI(this.tbBuilder,b)
}}}this.toolbar=this.tbBuilder.createToolbar(b)
},hasBackgroundToolbar:function(a){return this.backgroundToolbars[a]?true:false
},addBackgroundToolbar:function(a){if(!this.toolbar){return
}a=a||{};
a.editorKernel=this;
a.$editable=a.$editable||this.toolbar.$editable;
if(this.backgroundToolbars[a.tbType]){return
}this.backgroundToolbars[a.tbType]=this.tbBuilder.createToolbar(a)
},removeBackgroundToolbar:function(a){var b=this.backgroundToolbars[a];
if(b){b.destroy();
delete this.backgroundToolbars[a]
}},setActiveToolbar:function(b){if(this.backgroundToolbars[b]){var a=this.toolbar;
this.toolbar.finishEditing();
this.toolbar=this.backgroundToolbars[b];
delete this.backgroundToolbars[b];
this.toolbar.startEditing(this);
this.backgroundToolbars[a.tbType]=a;
this.tbBuilder.notifyToolbar(this.toolbar,true);
this.firePluginEvent("aftertoolbarswitch",{tbType:b},false)
}},createToolbarBuilder:function(){return null
},updateToolbar:function(){if(!this.isEnabled){return
}var b=this.analyzeSelection();
if(!b){return
}for(var a in this.registeredPlugins){if(this.registeredPlugins.hasOwnProperty(a)){var c=this.registeredPlugins[a];
c.updateState(b)
}}if(!this.contextMenu||!this.contextMenuBuilder.isVisible()){this.contextMenuBuilder.hideAll()
}},adjustToolbarToWidth:function(a){this.toolbar.adjustToWidth(a)
},enableToolbar:function(a){if(!a||this.toolbar.tbType==a){this.toolbar.enable()
}else{if(this.backgroundToolbars[a]){this.backgroundToolbars[a].enable()
}}},disableToolbar:function(a,b){if(!b||this.toolbar.tbType==b){this.toolbar.disable(a)
}else{if(this.backgroundToolbars[b]){this.backgroundToolbars[b].disable(a)
}}},destroyToolbar:function(){if(this.toolbar){this.toolbar.finishEditing();
this.toolbar.destroy()
}},destroyBackgroundToolbars:function(){var a,b;
for(a in this.backgroundToolbars){if(this.backgroundToolbars.hasOwnProperty(a)){b=this.backgroundToolbars[a];
b.finishEditing();
b.destroy();
delete this.backgroundToolbars[a]
}}},getToolbar:function(){return this.toolbar
},handleContextMenu:function(f){var e=CUI.rte.DomProcessor;
this.contextMenuBuilder.clear();
var c=this.getEditContext();
var d=this.createQualifiedSelection(c);
if(!d){return false
}var b=e.createNodeList(c,d);
var a={selection:d,nodeList:b};
for(var h in this.registeredPlugins){if(this.registeredPlugins.hasOwnProperty(h)){this.registeredPlugins[h].handleContextMenu(this.contextMenuBuilder,a,c)
}}this.contextMenu=this.contextMenuBuilder.build(a,c);
if(this.contextMenu){this.contextMenuSavedRange=this.createQualifiedRangeBookmark(c);
var g=this.calculateContextMenuPosition(f);
this.contextMenuBuilder.showAt(g[0],g[1]);
return true
}return false
}});
CUI.rte.EditorKernel.DEFAULT_TOOLKIT="ext";
CUI.rte.IFrameKernel=new Class({toString:"IFrameKernel",extend:CUI.rte.EditorKernel,contentPath:null,initializeEditContext:function(a,e,d,b){var c=CUI.rte.Common;
this.editContext=new CUI.rte.EditContext(a,e,d,b);
c.initializeTouchInIframe(this.editContext);
if(c.ua.isW3cIE){d.execCommand("AutoUrlDetect",false,false)
}this.addFeatureClasses(b);
if(this.toolbar){this.toolbar.startEditing(this)
}},initializeCaret:function(d){var a=CUI.rte.Common;
var c=CUI.rte.Selection;
if(this.hasFocus){var b=this.getEditContext();
c.resetSelection(b,"start");
if((a.ua.isGecko||a.ua.isWebKit)&&b.iFrame){c.ensureCaretVisibility(b,0)
}}else{if(d){this.focusGainActions.initializeCaret=true
}}},getContentPath:function(){return this.contentPath
},getFocusDom:function(a){if(!a){a=this.getEditContext()
}return a.win
},focus:function(a){if(!a){a=this.getEditContext()
}if(a.win){a.win.focus()
}},blurFocus:function(a){if(!a){a=this.getEditContext()
}if(a.win){a.win.blur()
}},calculateWindowPosition:function(b){var a=null;
switch(b){default:a=this.getEditorPosition();
break
}return a||[0,0]
},calculateContextMenuPosition:function(b){var a=this.getEditContext();
var g=this.getEditorPosition();
var c=[0,0];
var d=CUI.rte.Common;
if(!d.ua.isOldIE){c=[a.root.scrollLeft,a.root.scrollTop]
}else{var e=CUI.rte.Utils.getMainWindow();
var h=e.document;
var f=h.body;
c=[h.documentElement.scrollLeft||f.scrollLeft,h.documentElement.scrollTop||f.scrollTop]
}var i=b.getPos();
return[g[0]+i.x-c[0],g[1]+i.y-c[1]]
},createToolbarBuilder:function(){var a=CUI.rte.ui;
return a.ToolkitRegistry.get(this.uiToolkit).createToolbarBuilder(a.Toolkit.TBHINT_LOCAL)
},canEditSource:function(){return true
},setContentPath:function(a){this.contentPath=a
},getEditorPosition:function(){var a=this.getEditContext();
if(!a.iFrame){return null
}return CUI.rte.Utils.getPagePosition(a.iFrame)
}});
CUI.rte.DivKernel=new Class({toString:"DivKernel",extend:CUI.rte.EditorKernel,contentPath:null,initializeEditContext:function(d,c,a){var b=CUI.rte.Common;
this.editContext=new CUI.rte.EditContext(null,d,c,a);
b.initializeTouchInIframe(this.editContext);
if(b.ua.isW3cIE){c.execCommand("AutoUrlDetect",false,false)
}this.addFeatureClasses(a);
if(this.toolbar){this.toolbar.startEditing(this)
}},initializeCaret:function(e,a){var b=CUI.rte.Common;
var d=CUI.rte.Selection;
var c=this.getEditContext();
if(b.ua.isGecko||b.ua.isWebKit){this.deferFocus(CUI.rte.Utils.scope(function(){d.resetSelection(c,"start");
this.fireUIEvent("updatestate",{origin:"init"})
},this))
}else{if(b.ua.isIE){CUI.rte.Utils.defer(function(){this.focus();
CUI.rte.Utils.defer(function(){this.hasFocus=true
},1,this);
if(a!=null){d.selectNode(c,a,true)
}else{d.resetSelection(c,"start")
}},1,this)
}}},getContentPath:function(){return this.contentPath
},getFocusDom:function(a){if(!a){a=this.getEditContext()
}return a.root
},focus:function(a){if(!a){a=this.getEditContext()
}if(a.root){try{a.root.focus()
}catch(b){}}},blurFocus:function(a){if(!a){a=this.getEditContext()
}if(a.root){a.root.blur()
}},calculateWindowPosition:function(d){var b=this.getEditContext();
var a=null;
var c=b.doc.documentElement.scrollTop||b.doc.body.scrollTop;
switch(d){default:a=[0,c];
break
}return a||[0,0]
},calculateContextMenuPosition:function(a){var b=a.getPos();
return[b.x,b.y]
},createToolbarBuilder:function(){var a=CUI.rte.ui;
return a.ToolkitRegistry.get(this.uiToolkit).createToolbarBuilder(a.Toolkit.TBHINT_GLOBAL)
},setProcessors:function(b,a){if(CUI.rte.CUIDomCleanup){this.preProcessor=new CUI.rte.CUIDomCleanup(b);
this.postProcessor=new CUI.rte.CUIDomCleanup(a)
}else{this.preProcessor=new CUI.rte.DomCleanup(b);
this.postProcessor=new CUI.rte.DomCleanup(a)
}},canEditSource:function(){return CUI.rte._toolkit=="cui"
},setContentPath:function(a){this.contentPath=a
}});
CUI.rte.Common=function(){var m=window.document.documentMode,x=navigator.userAgent.toLowerCase(),C=function(D){return D.test(x)
},d=C(/\bedge\b/)&&C(/webkit/),k=!d&&C(/webkit/),t=!k&&(C(/msie/)||C(/trident/)),n=!t&&!k&&C(/gecko/),s=t&&((C(/msie 6/)&&m!=7&&m!=8&&m!=9&&m!=10)||(m===5)),r=t&&((C(/msie 7/)&&m!=5&&m!=8&&m!=9&&m!=10)||m==7),q=t&&((C(/msie 8/)&&m!=5&&m!=7&&m!=9&&m!=10)||m==8),p=t&&((C(/msie 9/)&&m!=5&&m!=7&&m!=8&&m!=10)||m==9),l=t&&((C(/msie 10/)&&m!=5&&m!=7&&m!=8&&m!=9)||m==10),j=t&&((C(/trident\/7\.0/)&&m!=5&&m!=7&&m!=8&&m!=9&&m!=10)||m==11),e=t&&(s||r||q),w=j,c=t&&!e,f=C(/macintosh|mac os x/),b=k&&C(/\bchrome\b/),B=k&&!b&&C(/safari/),i=(function(){if(/Windows NT 6\.[23];.*Chrome/.test(window.navigator.userAgent)){return false
}return"ontouchstart" in window
})(),z=i&&B&&C(/ipad/),A=i&&B&&C(/iphone/),a=(z||A?56:0),v=(z?354:(A?266:0)),h=(z?442:(A?246:0)),y=(z?32:(A?20:0));
var g=true;
var o=function(E,Q,I,L,T){var H=CUI.rte.Common;
function P(W){var V=H.getTagInPath(E,W,H.EDITBLOCK_TAGS);
return(H.getLastChild(V)===W)
}if(Q.nodeType==3){var J=H.getNodeCharacterCnt(Q);
var S=I.charPos+J;
if((L>=I.charPos)&&(L<S)){I.node={dom:Q,start:I.charPos,offset:L-I.charPos,nodeBefore:I.nodeBefore};
return
}else{if(L==S){if(P(Q)){I.node={dom:Q,start:I.charPos,offset:L-I.charPos,nodeBefore:I.nodeBefore};
return
}I.nodeBefore=Q;
I.startBefore=I.charPos
}}I.charPos+=J
}else{if(Q.nodeType==1){if(H.isOneCharacterNode(Q)){if(I.charPos==L){I.node={isNodeSelection:true,startOfElement:true,dom:Q};
return
}if((I.charPos+1)==L){if(P(Q)){I.node={isNodeSelection:true,startOfElement:false,dom:Q,offset:0}
}}I.charPos++
}else{if(H.isTag(Q,H.EDITBLOCK_UNREGNEST_TAGS)){if((H.getChildIndex(Q)==0)&&H.isFirstNestedList(E,Q.parentNode)){var D=Q;
do{D=H.getParentNode(E,D);
if(D&&H.isTag(D,H.EDITBLOCK_UNREGNEST_TAGS)){if(I.charPos==L){var M=I.nodeBefore;
var K=H.getNodeCharacterCnt(M);
var O=M.parentNode;
I.node={dom:M,offset:K,parentDom:O,isUnregularNestedIssue:true,nestedItemDom:Q};
return
}I.charPos++;
break
}}while(D)
}}var R=I.charPos;
var F=Q.childNodes.length;
for(var U=0;
U<F;
U++){o(E,Q.childNodes[U],I,L,T);
if(I.node){if(!I.node.parentDom){I.node.parentDom=Q;
I.node.parentStart=R;
I.node.parentOffset=L-R
}return
}}if(H.isTag(Q,H.EDITBLOCK_TAGS)){var G=true;
var N=null;
if(H.isTag(Q,H.EDITBLOCK_NESTED_TAGS)){N=H.EDITBLOCK_NESTED_TAGS
}else{if(H.isTag(Q,H.EDITBLOCK_UNREGNEST_TAGS)){N=H.EDITBLOCK_UNREGNEST_TAGS
}}if(N!=null){G=!H.isLastChildDeep(Q,N)
}if(G){var K=0;
if(T){if(H.isEmptyEditingBlock(Q,true)){K=1
}}if((I.charPos>=L)&&(I.charPos<=(L+K))){I.node={isNodeSelection:true,startOfElement:false,dom:Q};
return
}I.charPos+=K+1
}}}}}};
var u=function(E,G,H,L){var F=CUI.rte.Common;
if(F.isTag(L,F.EDITBLOCK_UNREGNEST_TAGS)){if((F.getChildIndex(L)==0)&&F.isFirstNestedList(E,L.parentNode)){var M=L;
do{M=F.getParentNode(E,M);
if(M&&F.isTag(M,F.EDITBLOCK_UNREGNEST_TAGS)){H++;
break
}}while(M)
}}if(L==G){return{isFound:true,charPos:H}
}if(L.nodeType==3){H+=F.getNodeCharacterCnt(L);
return{isFound:false,charPos:H}
}if(L.nodeType==1){if(F.isOneCharacterNode(L)){H++
}else{var K=L.childNodes.length;
for(var J=0;
J<K;
J++){var I=u(E,G,H,L.childNodes[J]);
if(I.isFound){return I
}H=I.charPos
}if(F.isTag(L,F.EDITBLOCK_TAGS)){var D=true;
if(F.isTag(L,F.EDITBLOCK_NESTED_TAGS)){D=!F.isLastElementOfNestingLevel(E,L)
}else{if(F.isTag(L,F.EDITBLOCK_UNREGNEST_TAGS)){D=!F.isLastChildDeep(L,F.EDITBLOCK_UNREGNEST_TAGS)
}}if(D){H++
}}}return{isFound:false,charPos:H}
}return{isFound:false,charPos:-1}
};
return{ua:{isWebKit:k,isGecko:n,isIE:t,isIE6:s,isIE7:r,isIE8:q,isIE9:p,isIE10:l,isIE11:j,isOldIE:e,isIEBRPlaceholder:w,isW3cIE:c,isMac:f,isEdge:d,isChrome:b,isSafari:B,isTouch:i,isIPad:z,isIPhone:A,calloutHeight:a,screenKeyHeightPortrait:v,screenKeyHeightLandscape:h,selectionHandlesHeight:y,isTouchInIframe:false},isRootNode:function(D,E){return(D.root==E)
},isTag:function(H,D){if(!H||(H.nodeType!=1)){return false
}var G=H.tagName.toLowerCase();
if(!CUI.rte.Utils.isArray(D)){return(G==D.toLowerCase())
}var E=D.length;
for(var F=0;
F<E;
F++){if(G==D[F].toLowerCase()){return true
}}return false
},getNamespace:function(G){var D=CUI.rte.Common;
if(G&&G.nodeType==1){if(D.ua.isIE&&G.scopeName){if(G.scopeName!="HTML"){return G.scopeName.toLowerCase()
}}else{var E=G.tagName;
var F=E.indexOf(":");
if(F>0){return E.substring(0,F).toLowerCase()
}}}return null
},insertBefore:function(E,F,D){if(D!=null){E.insertBefore(F,D)
}else{E.appendChild(F)
}},hasAttributes:function(G,F){if(!G||(G.nodeType!=1)){return false
}for(var D in F){if(F.hasOwnProperty(D)){if((D=="_class")||(D=="className")){D="class"
}var E=CUI.rte.Common.getAttribute(G,D);
if(E!=F[D]){return false
}}}return true
},isAttribDefined:function(F,E){var D=CUI.rte.Common.getAttribute(F,E,true);
return(D!=null)
},getAttribute:function(K,H,F){var E=CUI.rte.Common;
if(!K){return null
}var I=H.toLowerCase();
var D;
if((I=="style")&&E.ua.isOldIE){D=K.style.cssText
}else{var G=K.tagName.toLowerCase();
if((E.ua.isIE6||E.ua.isIE7)&&((I=="name")&&(G=="a"))){D=K.attributes.name.nodeValue
}else{D=K.getAttribute(CUI.rte.Common.getIEAttributeName(H))
}}if(F&&((D!=null)&&(D.length==0))){D=null
}if(F&&(D!=null)){if((I=="colspan")||(I=="rowspan")){try{if(parseInt(D)==1){D=null
}}catch(J){}}}return D
},setAttribute:function(H,F,E){var D=CUI.rte.Common,G=F.toLowerCase();
if(typeof E!=String){E=String(E)
}if((G=="style")&&D.ua.isOldIE){H.style.cssText=E;
return
}if((D.ua.isIE6||D.ua.isIE7)&&((G=="name")&&(H.tagName.toLowerCase()=="a"))){H.attributes.name.nodeValue=E;
return
}F=CUI.rte.Common.getIEAttributeName(F);
H.setAttribute(F,E)
},addInlineStyles:function(J,O){var I=CUI.rte.Common;
var H=I.getAttribute(J,"style");
H=(H?H:"").trim();
if(H.length>0&&H.lastIndexOf(";")!=H.length-1){H+=";"
}if(typeof O==="string"){O=O.trim();
var K=O.split(";");
for(var M=0;
M<K.length;
M++){var G=K[M];
G=G.trim();
var L=G.split(":");
if(L.length===2){var N=L[0].trim();
var F=L[1].trim();
var D=new RegExp(N+"[^;]+;");
H=H.replace(D,"").replace(/  +/," ").trim();
H+=N+": "+F+";"
}}}else{for(var E in O){if(O.hasOwnProperty(E)){var D=new RegExp(E+"[^;]+;");
H=H.replace(D,"").replace(/  +/," ").trim();
H+=E+": "+O[E]+";"
}}}if(H.length>0){I.setAttribute(J,"style",H)
}},removeInlineStyles:function(H,I){var D=CUI.rte.Common;
var E=D.getAttribute(H,"style");
if(E){for(var F=0;
F<I.length;
F++){var G=new RegExp(I[F]+"[^;]+;");
E=E.replace(G,"").replace(/  +/," ").trim()
}if(E.length>0){D.setAttribute(H,"style",E)
}else{D.removeAttribute(H,"style")
}}},removeAttribute:function(G,F){var D=CUI.rte.Common;
if(D.ua.isOldIE){if(F=="style"){G.style.cssText=null;
return
}}var E=G.tagName.toLowerCase();
if((D.ua.isIE6||D.ua.isIE7)&&((F.toLowerCase()=="name")&&(E=="a"))){G.attributes.name.nodeValue=""
}else{G.removeAttribute(CUI.rte.Common.getIEAttributeName(F))
}},copyAttribute:function(G,F,E){var D=G[E];
if(D!=null){F[E]=D
}},copyAttributes:function(P,O,E){var F=CUI.rte.Common;
var M,L,J,G;
if(F.ua.isIE6||F.ua.isIE7){var I=F.getIEAttributeNames(P,true);
L=I.length;
for(M=0;
M<L;
M++){G=I[M];
if((E==null)||!F.arrayContains(E,G)){var K;
var H=G.toLowerCase();
if(H=="style"){K=P.style.cssText
}else{if(H=="class"){K=P.getAttribute("className");
G="className"
}else{if(F.isTag(P,"a")&&(H=="name")){K=P.attributes.name.nodeValue
}else{K=P.getAttribute(G)
}}}if(K!=null){if(H=="style"){O.style.cssText=K
}else{if(F.isTag(O,"a")&&(H=="name")){O.attributes.name.nodeValue=K
}else{O.setAttribute(G,K)
}}}}}return
}var D=P.attributes;
L=D.length;
for(M=0;
M<L;
M++){J=D[M];
G=J.name;
G=(F.ua.isIE8?G.toLowerCase():G);
if((E==null)||!F.arrayContains(E,G)){var N=J.value;
if(F.ua.isIE8){if((G=="colspan")||(G=="rowspan")){if(N=="1"){N=null
}}}if(N!=null){O.setAttribute(G,J.value)
}}}},compareAttributes:function(N,M){var I=CUI.rte.Common;
var G,L,J;
var E=N.attributes;
var O=M.attributes;
var D=E.length;
for(var H=0;
H<D;
H++){G=E[H].name;
L=I.getAttribute(N,G,true);
if(L!=null){J=I.getAttribute(M,G,true);
if(J!=L){return false
}}}var K=O.length;
for(var F=0;
F<K;
F++){G=O[F].name;
L=I.getAttribute(M,G,true);
if(L!=null){J=I.getAttribute(N,G,true);
if(J!=L){return false
}}}return true
},getAttributeNames:function(I,M,D){var E=CUI.rte.Common;
if(E.ua.isOldIE){return CUI.rte.Common.getIEAttributeNames(I,M,D)
}var J=[];
var K=I.attributes.length;
for(var L=0;
L<K;
L++){var G=I.attributes.item(L).nodeName;
var H=G.toLowerCase();
var F=false;
if(D){F=D(I,G,H)
}if(!F){J.push(M?G:H)
}}return J
},getTags:function(H,F,E){if(!E){E=[]
}var D=CUI.rte.Common;
if(D.isTag(H,F)){E.push(H)
}if(H.nodeType==1){var G=H.childNodes.length;
for(var I=0;
I<G;
I++){D.getTags(H.childNodes[I],F,E)
}}return E
},containsTag:function(G,E){var D=CUI.rte.Common;
if(D.isTag(G,E)){return true
}if(G.nodeType==1){var F=G.childNodes.length;
for(var H=0;
H<F;
H++){if(D.containsTag(G.childNodes[H],E)){return true
}}}return false
},equals:function(F,E){var D=CUI.rte.Common;
if(F.nodeType!=E.nodeType){return false
}if(F.nodeType==3){return(F.nodeValue==E.nodeValue)
}if(F.tagName.toLowerCase()!=E.tagName.toLowerCase()){return false
}return D.compareAttributes(F,E)
},isNull:function(D){return(D===null)||(D===undefined)
},addTextNode:function(D,F,L){var K=D.nodeValue;
var J=K.length;
var G=F.childNodes.length;
if(G==0){F.appendChild(D);
return{dom:D,startPos:0,charCnt:J}
}var E=L;
if(E&&(E.nodeType!=3)){E=null
}var I;
if(L){I=L.previousSibling
}else{I=F.lastChild
}if(I&&(I.nodeType!=3)){I=null
}var H=(I?I.nodeValue.length:0);
if(E&&I){I.nodeValue+=K+E.nodeValue;
D=I;
F.removeChild(E)
}else{if(E){E.nodeValue=K+E.nodeValue;
D=E
}else{if(I){I.nodeValue+=K;
D=I
}else{if(L){F.insertBefore(D,L)
}else{F.appendChild(D)
}}}}return{dom:D,startPos:H,charCnt:J}
},getNodeText:function(E){if(E.nodeType!=3){return""
}var D=E.nodeValue;
if(D){D=D.replace(/[\n\t\r]/g,"")
}return D
},getInnerText:function(E){var D=CUI.rte.Common;
function F(H,I){if(D.isTag(H,["script","style"])){return I
}if(H.nodeType===3){I+=H.nodeValue
}else{if(H.nodeType===1){var G=H.childNodes;
for(var J=0;
J<G.length;
J++){I=F(G[J],I)
}}}return I
}return F(E,"")
},isOneCharacterNode:function(H){if(!H||(H.nodeType==3)){return false
}var D=CUI.rte.Common;
var G=D.ONE_CHARACTER_NODES;
for(var E=0;
E<G.length;
E++){var F=D.matchesTagDef(H,G[E]);
if(F){return true
}}return false
},isCharacterNode:function(D){if(!D){return false
}return(D.nodeType==3)||CUI.rte.Common.isOneCharacterNode(D)
},isEditableNode:function(E){if(!E){return false
}var D=CUI.rte.Common;
return D.isCharacterNode(E)||D.isEmptyEditingBlock(E,true)
},containsCharacterNode:function(G){var D=CUI.rte.Common;
if(D.isCharacterNode(G)){return true
}if(G.nodeType!=1){return false
}var E=G.childNodes;
var F=E.length;
for(var H=0;
H<F;
H++){if(D.containsCharacterNode(E[H])){return true
}}return false
},getCharacterNodes:function(G,I){var D=CUI.rte.Common;
if(!I){I=[]
}if(D.isCharacterNode(G)){I.push(G)
}if(G.nodeType==1){var E=G.childNodes;
var F=E.length;
for(var H=0;
H<F;
H++){D.getCharacterNodes(E[H],I)
}}return I
},isEmptyEditingBlock:function(F,E){var D=CUI.rte.Common;
if(F.nodeType==3){return false
}if(!D.isTag(F,D.EDITBLOCK_TAGS)){return false
}if(!E){return(F.childNodes.length==0)
}return !D.containsCharacterNode(F)
},getNodeCharacterCnt:function(F){var D=CUI.rte.Common;
if(F.nodeType==1){if(D.isOneCharacterNode(F)){return 1
}if(D.isEmptyEditingBlock(F,true)){return 1
}return 0
}var E=CUI.rte.Common.getNodeText(F);
if(E){return E.length
}return 0
},getNodeTextLength:function(H){var E=CUI.rte.Common;
if(H.nodeType==3){return E.getNodeCharacterCnt(H)
}else{if(H.nodeType==1){var D=E.getNodeCharacterCnt(H);
var G=H.childNodes.length;
for(var I=0;
I<G;
I++){var F=H.childNodes[I];
D+=E.getNodeTextLength(F)
}return D
}}return 0
},getNodeAtPosition:function(E,H,D){var G={node:null,charPos:0,nodeBefore:null};
o(E,E.root,G,H,D);
var F=G.node;
if(!F){if(!G.nodeBefore){return null
}F={dom:null,nodeBefore:G.nodeBefore}
}return F
},getCharacterOffsetForNode:function(D,E){return u(D,E,0,D.root).charPos
},getPreviousNode:function(D,F){if(F.previousSibling){F=F.previousSibling;
while(true){var E=F.childNodes.length;
if(E==0){return F
}F=F.childNodes[E-1]
}}return CUI.rte.Common.getParentNode(D,F)
},getPreviousTextNode:function(E,F,G){var D=CUI.rte.Common;
if(G&&D.isTag(F,G)){return null
}do{F=D.getPreviousNode(E,F);
if(G&&D.isTag(F,G)){F=null;
break
}}while(F&&(F.nodeType!=3));
return F
},getPreviousCharacterNode:function(E,F,G){var D=CUI.rte.Common;
if((G&&D.isTag(F,G))||(F===E.root)){return null
}do{F=D.getPreviousNode(E,F);
if(F===E.root){F=null;
break
}if(G&&D.isTag(F,G)){F=null;
break
}}while(F&&(D.getNodeCharacterCnt(F)===0));
return F
},getPreviousEditableNode:function(E,F,G){var D=CUI.rte.Common;
if(!F){return null
}if(G&&D.isTag(F,G)){return null
}do{F=D.getPreviousNode(E,F);
if(G&&D.isTag(F,G)){F=null;
break
}}while(F&&!D.isEditableNode(F));
return F
},getNextNode:function(D,E){if(E.childNodes.length>0){return E.childNodes[0]
}if(E.nextSibling){return E.nextSibling
}while(true){E=CUI.rte.Common.getParentNode(D,E);
if(!E||(E===D.root)){return null
}if(E.nextSibling){return E.nextSibling
}}},getNextTextNode:function(E,F,G){var D=CUI.rte.Common;
do{F=D.getNextNode(E,F);
if(G&&D.isTag(F,G)){F=null;
break
}}while(F&&(F.nodeType!=3));
return F
},getNextCharacterNode:function(E,F,G){var D=CUI.rte.Common;
do{F=D.getNextNode(E,F);
if(G&&D.isTag(F,G)){F=null;
break
}}while(F&&(D.getNodeCharacterCnt(F)==0));
return F
},getNextEditableNode:function(E,F,G){var D=CUI.rte.Common;
if(!F){return null
}do{F=D.getNextNode(E,F);
if(G&&D.isTag(F,G)){F=null;
break
}}while(F&&!D.isEditableNode(F));
return F
},isAncestor:function(D,F,E){if(!F||!E){return false
}do{E=CUI.rte.Common.getParentNode(D,E);
if(E){if(E==F){return true
}}}while(E);
return false
},isLastChildDeep:function(H,F){var E=CUI.rte.Common;
var D=H;
do{if(D.nodeType!=1){return false
}var G=D.childNodes;
if(G.length==0){return false
}D=G[G.length-1];
if(E.isTag(D,F)){return true
}}while(true)
},isLastElementOfNestingLevel:function(H,I){var F=CUI.rte.Common;
while(!F.isTag(I,F.EDITBLOCK_NESTED_TAGS)&&!F.isTag(I,F.EDITBLOCK_UNREGNEST_TAGS)){I=F.getParent(H,I);
if(!I){return false
}}var G=F.getParentNode(H,I);
if(!G){return false
}var E=G.childNodes.length-1;
if(F.getChildIndex(I)!=E){return false
}if(!F.containsTagInPath(H,G,F.EDITBLOCK_UNREGNEST_TAGS)&&!F.containsTagInPath(H,G,F.EDITBLOCK_NESTED_TAGS)){return false
}if(F.isTag(I,["td","th"])){var D=F.getParentNode(H,G);
if(!D){return false
}E=D.childNodes.length-1;
return(F.getChildIndex(G)==E)
}if(F.isTag(I,"li")){var J=I.parentNode;
return F.isLastNestedList(H,J)
}return true
},getChildIndex:function(E){if(!E.parentNode){return -1
}var D=E.parentNode.childNodes.length;
for(var F=0;
F<D;
F++){if(E.parentNode.childNodes[F]==E){return F
}}return -1
},getLastChild:function(F,G){var D=CUI.rte.Common;
if(F.nodeType==3){return F
}var E=F.childNodes.length;
if(E==0){return(G?F:null)
}return D.getLastChild(F.childNodes[E-1],true)
},getFirstChild:function(F,G){var D=CUI.rte.Common;
if(F.nodeType==3){return F
}var E=F.childNodes.length;
if(E==0){return(G?F:null)
}return D.getFirstChild(F.childNodes[0],true)
},hasTextChild:function(E,D){return(CUI.rte.Common.getFirstTextChild(E,D)!=null)
},getFirstTextChild:function(H,D,F){var E=CUI.rte.Common;
if(F){if(D){if(E.getNodeCharacterCnt(H)>0){return H
}}else{if(H.nodeType==3){return H
}}}var G=H.childNodes.length;
for(var J=0;
J<G;
J++){var I=E.getFirstTextChild(H.childNodes[J],D,true);
if(I){return I
}}return null
},getLastTextChild:function(H,D,F){var E=CUI.rte.Common;
if(F){if(D){if(E.getNodeCharacterCnt(H)>0){return H
}}else{if(H.nodeType==3){return H
}}}var G=H.childNodes.length;
for(var J=G-1;
J>=0;
J--){var I=E.getLastTextChild(H.childNodes[J],D,true);
if(I){return I
}}return null
},childNodesAsArray:function(E){var G=[];
if(E.nodeType==1){var D=E.childNodes.length;
for(var F=0;
F<D;
F++){G.push(E.childNodes[F])
}}return G
},getParentNode:function(D,E){if(E==D.root){return null
}return E.parentNode
},getWindowForDocument:function(D){return(CUI.rte.Common.ua.isIE?D.parentWindow:D.defaultView)
},getParentWindowRef:function(D){var E=D.win;
if(E.frameElement){return E.frameElement
}return undefined
},initializeTouchInIframe:function(E){var D=CUI.rte.Common;
D.ua.isTouchInIframe=D.ua.isTouch&&!!D.getParentWindowRef(E)
},isZombieNode:function(D,E){while(E){if(E==D.root){return false
}E=E.parentNode
}return true
},getBlockNode:function(E,F){var D=CUI.rte.Common;
while(F){if(D.getParentNode(E,F.parentNode)==null){return F
}F=F.parentNode
}return null
},isBlockNode:function(D,E){return(E&&E.parentNode&&CUI.rte.Common.isRootNode(D,E.parentNode))
},getLastBlockNode:function(D,F){while(!CUI.rte.Common.isRootNode(D,F)){F=F.parentNode
}var E=D.root.childNodes;
if(E.length==0){return null
}return E[E.length-1]
},hasContent:function(H){if(H.nodeType==3){return true
}var E=H.childNodes.length;
if(E==0){return false
}for(var I=0;
I<E;
I++){var D=H.childNodes[I];
if(D.nodeType==3){var G=D.nodeValue;
G=G.replace(/[\n\t\r \u00A0]/g,"");
if(G.length>0){return true
}}else{var F=CUI.rte.Common.hasContent(D);
if(F){return true
}}}return false
},getTagInPath:function(F,H,E,G){var D=CUI.rte.Common;
while(H){if(H.nodeType==1){if(H==F.root){return null
}if(D.isTag(H,E)){if(!G||D.hasAttributes(H,G)){return H
}}}H=D.getParentNode(F,H)
}return null
},containsTagInPath:function(E,G,D,F){return(CUI.rte.Common.getTagInPath(E,G,D,F)!=null)
},matchesTagDefs:function(H,D){var E=CUI.rte.Common;
if(!CUI.rte.Utils.isArray(D)){return E.matchesTagDef(H,D)
}var G=D.length;
for(var F=0;
F<G;
F++){if(CUI.rte.Common.matchesTagDef(H,D[F])){return true
}}return false
},matchesTagDef:function(K,I){var D=CUI.rte.Common;
if(!D.isTag(K,I.tagName)){return false
}var J,F,H;
if(I.attribsDefined){F=I.attribsDefined.length;
for(J=0;
J<F;
J++){H=I.attribsDefined[J];
if(!D.isAttribDefined(K,H)){return false
}}}if(I.attribsUndefined){F=I.attribsUndefined.length;
for(J=0;
J<F;
J++){H=I.attribsUndefined[J];
if(D.isAttribDefined(K,H)){return false
}}}if(I.attribValues){var G=I.attribValues;
for(var E in G){if(G.hasOwnProperty(E)){H=D.getAttribute(K,E,true);
if(!H){return false
}if(H!=G[E]){return false
}}}}if(I.empty){if(K.childNodes.length>0){return false
}}return true
},getListLevel:function(E,G){var D=CUI.rte.Common;
var F=0;
while(G){G=D.getParentNode(E,G);
if(G&&(D.isTag(G,"ul")||D.isTag(G,"ol"))){F++
}}return F
},isFirstNestedList:function(G,D){var E=CUI.rte.Common;
var F=E.getTagInPath(G,D,"li");
if(!F){return false
}var I=F.childNodes.length;
for(var J=0;
J<I;
J++){var H=F.childNodes[J];
if(H==D){return true
}if(E.isTag(H,E.LIST_TAGS)){return false
}}return false
},isLastNestedList:function(G,D){var E=CUI.rte.Common;
var F=E.getTagInPath(G,D,"li");
if(!F){return false
}var I=F.childNodes.length;
for(var J=I-1;
J>=0;
J--){var H=F.childNodes[J];
if(H==D){return true
}if(E.isTag(H,E.LIST_TAGS)){return false
}}return false
},getChildNodesByType:function(J,G,I,H,N){var F=CUI.rte.Common;
N=N||[];
var E=J.childNodes;
var M=E.length;
for(var K=0;
K<M;
K++){var D=E[K];
if(F.isTag(D,G)){N.push(D)
}if(I&&(D.nodeType==1)){var L=H&&F.isTag(D,H);
if(!L){F.getChildNodesByType(D,G,I,H,N)
}}}return N
},getConsistentStyle:function(D,H,E,I){var K=H.length;
var L;
for(var F=0;
F<K;
F++){var G=H[F];
var J=CUI.rte.Common.getStyleProp(D,G,E);
J=(J?J:I);
if(F==0){L=J
}else{if(J!=L){return null
}}}return L
},insertNode:function(H,G,I){var F=CUI.rte.Common;
if(G.nodeType==1){if(!I){G.parentNode.insertBefore(H,G)
}else{if(I>=G.childNodes.length){G.parentNode.append(H)
}else{var D=G.childNodes[I];
G.parentNode.insertBefore(H,D)
}}return
}if(I==0){G.parentNode.insertBefore(H,G)
}else{if(I>=F.getNodeCharacterCnt(G)){G.parentNode.insertBefore(H,G.nextSibling)
}else{var K=G.nodeValue;
G.nodeValue=K.substring(0,I);
var E=G.cloneNode(false);
E.nodeValue=K.substring(I,K.length);
var J=G.nextSibling;
var L=G.parentNode;
L.insertBefore(H,J);
L.insertBefore(E,J)
}}},replaceNode:function(D,G,F){var E=D.childNodes;
if(!F){F=G
}while(E.length>0){var H=E[0];
D.removeChild(H);
F.appendChild(H)
}D.parentNode.replaceChild(G,D)
},moveChildren:function(E,L,M,F){var G=CUI.rte.Common;
if(M==null){M=0
}var K=E.childNodes.length;
var H=0;
for(var I=K-1;
I>=M;
I--){var J=E.childNodes[I];
E.removeChild(J);
if(!F){G.insertBefore(L,J,L.firstChild)
}else{if(H==0){L.appendChild(J)
}else{var D=L.childNodes[L.childNodes.length-H];
G.insertBefore(L,J,D)
}H++
}}},removeAllChildren:function(D){if(D.nodeType!=1){return
}while(D.childNodes.length>0){D.removeChild(D.childNodes[0])
}},removeNodesWithoutContent:function(D,F){while(F&&!CUI.rte.Common.isRootNode(D,F)){if(F.childNodes.length>0){break
}var E=F.parentNode;
E.removeChild(F);
F=E
}},removeEmptyChildNodes:function(H,G){var F=CUI.rte.Common.getChildNodesByType(H,G);
var E=0,D;
while(E<F.length){D=F[E];
if(D.childNodes.length==0){H.removeChild(D)
}E++
}},getStyleProp:function(E,F,D){if(F==E.root){return null
}while(F){if(F.nodeType==1){if(F.style&&F.style[D]){return F.style[D]
}}F=CUI.rte.Common.getParentNode(E,F)
}return null
},parseCSS:function(E){if(E.nodeType!=1){return[]
}var D=CUI.rte.Common.getAttribute(E,"class");
if(!D){return[]
}return D.split(" ")
},hasCSS:function(G,E){if(G.nodeType!=1){return false
}var D=CUI.rte.Common.parseCSS(G);
var F=D.length;
for(var H=0;
H<F;
H++){if(D[H]==E){return true
}}return false
},addClass:function(G,E){var D=CUI.rte.Common;
if(!D.hasCSS(G,E)){var F=D.getAttribute(G,"class");
if(F){F+=" "+E
}else{F=E
}D.setAttribute(G,"class",F)
}},removeClass:function(J,H){var E=CUI.rte.Common;
var I=E.parseCSS(J);
var G="";
var D=false;
for(var F=0;
F<I.length;
F++){if(I[F]==H){D=true
}else{if(G.length>0){G+=" "
}G+=I[F]
}}if(D){if(G){E.setAttribute(J,"class",G)
}else{E.removeAllClasses(J)
}}},removeAllClasses:function(D){CUI.rte.Common.removeAttribute(D,"class")
},getIEAttributeName:function(F){var E=CUI.rte.Common;
if(E.ua.isOldIE){var G=F.toLowerCase();
if((G=="class")&&(E.ua.isIE6||E.ua.isIE7)){return"className"
}var D=CUI.rte.Common.IE_ATTRIB_NAMES[G];
if(D!=null){F=D
}}return F
},getIEAttributeNames:function(H,N,D){var E=[];
var K=H.outerHTML;
var M=K.indexOf(">");
K=K.substring(0,M+1);
var L=CUI.rte.HtmlProcessor.parseTag(K);
var I=L.attributes;
for(var G in I){var F=false;
var J=I[G];
if(D){F=D(H,J.originalName,G)
}if(!F){if(N){E.push(J.originalName)
}else{E.push(G)
}}}return E
},removeJcrData:function(E){for(var D in E){if(E.hasOwnProperty(D)){if(CUI.rte.Common.strStartsWith(D,"jcr:")){delete E[D]
}else{if(D=="xtype"){delete E[D]
}}}}},arrayContains:function(F,D,E){return(CUI.rte.Common.arrayIndex(F,D,E)>=0)
},arrayAdd:function(G,D){var E=D.length;
for(var F=0;
F<E;
F++){G.push(D[F])
}},arrayIndex:function(G,D,F){for(var E=0;
E<G.length;
E++){if(!F){if(G[E]==D){return E
}}else{if(F(G[E],D)){return E
}}}return -1
},arrayCopy:function(D){var G=[];
var F=D.length;
for(var E=0;
E<F;
E++){G.push(D[E])
}return G
},toArray:function(I,E,H){if(!I){return null
}if(CUI.rte.Utils.isArray(I)){return I
}if(typeof(I)=="object"){var J=[];
for(var D in I){if(I.hasOwnProperty(D)){if(!E||!H){J.push(I[D])
}else{var F=I[D];
if(!!F&&(F.constructor===Object)){J.push(I[D])
}else{var G={};
G[E]=D;
G[H]=F;
J.push(G)
}}}}return J
}return[I]
},strStartsWith:function(F,E){if(!F||!E){return false
}var D=E.length;
if(F.length>=D){return(F.substring(0,D)==E)
}return false
},strEndsWith:function(G,F){if(!G||!F){return false
}var E=G.length;
var D=F.length;
if(E>=D){return(G.substring(E-D,E)==F)
}return false
},strReplace:function(I,E,H,G){var D="";
if(E>0){D=I.substring(0,E)
}var F="";
if((H+1)<I.length){F=I.substring(H+1,I.length)
}return D+G+F
},createIndexPath:function(E,F){var D=CUI.rte.Common.getParentNode(E,F);
if(!D){return[]
}var H=CUI.rte.Common.getChildIndex(F);
var G=CUI.rte.Common.createIndexPath(E,D);
G.push(H);
return G
},getElementByIndexPath:function(F,E){if(F.childNodes.length==0){return null
}var G=F;
for(var D=0;
D<E.length&&G.childNodes.length>0;
D++){G=G.childNodes[E[D]]
}return G
},compareIndexPaths:function(H,F){var G=H.length;
var E=F.length;
var D=0;
while(true){if(D>=G){if(D>=E){return 0
}return 1
}if(D>=E){return -1
}if(H[D]<F[D]){return 1
}if(H[D]>F[D]){return -1
}D++
}},block:function(E,F){if((typeof F==="undefined")||F){var D=new Date().getTime()+E;
while(new Date().getTime()<D){}}},getOuterHTML:function(F,G){var E=CUI.rte.Common;
if(E.ua.isIE){return G.outerHTML
}var D=F.createElement("span");
D.appendChild(G.cloneNode(true));
return D.innerHTML
},isPortrait:function(){return(window.innerHeight>window.innerWidth)
},getScreenKeyboardHeight:function(){var D=CUI.rte.Common;
return(D.isPortrait()?D.ua.screenKeyHeightPortrait:D.ua.screenKeyHeightLandscape)
},dumpNode:function(D,F,G){var H=(F?F:"");
if(D){var E=CUI.rte.Common.getChildIndex(D);
if(D.nodeType==1){H+=D.tagName
}else{if(D.nodeType==3){H+='"'+D.nodeValue+'"'
}else{if(D.nodeType==8){H+="(comment) "+D.nodeValue
}else{H+="(nodeType #"+D.nodeType+")"
}}}H+=" (parentNode.childNodes["+E+"])"
}else{H+="[No node]"
}if(G){H+=G
}return H
},dumpNodeRecursively:function(F,D){if(!D){D=0
}var G="";
for(var I=0;
I<D;
I++){G+="   "
}G+=CUI.rte.Common.dumpNode(F)+"\n";
if(F&&(F.nodeType==1)){var E=F.childNodes.length;
for(var H=0;
H<E;
H++){G+=CUI.rte.Common.dumpNodeRecursively(F.childNodes[H],D+1)
}}return G
},dumpObject:function(H,G,F){var E=CUI.rte.Common;
var I="";
if(!G){G=0
}var J="";
for(var L=0;
L<G;
L++){J+=" "
}if(!H){return J+"---"
}if(H.hasOwnProperty){for(var D in H){if(H.hasOwnProperty(D)){var K=H[D];
I+=J+D+":";
if((K===null)||(K===undefined)){I+=" [undefined]\n"
}else{if(typeof(K)=="object"){if(K.nodeType&&(K.tagName||K.nodeValue)){if(F){I+="\n"+E.dumpNodeRecursively(K,G+2)
}else{I+=E.dumpNode(K)+"\n"
}}else{I+="\n"+E.dumpObject(K,G+2)
}}else{I+=" "+K+"\n"
}}}}}else{if(H.nodeType){if(F){I+=E.dumpNodeRecursively(H,G)
}else{I+=J+E.dumpNode(H)+"\n"
}}else{I+=J+"[native object]\n"
}}return I
},ieLog:function(G,I){if(!g){return
}var H=document.getElementById("cuiRTEdebug");
if(!H&&I){var E=window.document;
var D=E.body.clientWidth-310;
H=E.createElement("div");
H.id="cuiRTEdebug";
H.style.width="300px";
H.style.height="300px";
H.style.position="absolute";
H.style.top="10px";
H.style.left=D+"px";
H.style.zIndex=10000;
H.style.overflowY="scroll";
H.style.border="1px solid";
H.style.fontFamily="sans-serif";
H.style.fontSize="12px";
H.style.backgroundColor="#ffffff";
E.body.appendChild(H)
}if(H){if(!G){G=""
}G=CUI.rte.Utils.htmlEncode(G);
var F=true;
if((G.length>0)&&(G.charAt(G.length-1)=="\n")){F=false
}G=G.replace(/\n/g,"<br>");
G=G.replace(/ /g,"&nbsp;");
H.innerHTML=H.innerHTML+G+(F?"<br>":"")
}},setLogEnabled:function(D){g=D;
if(g){CUI.rte.Common.ieLog(null,true)
}},ONE_CHARACTER_NODES:[{tagName:"a",attribsDefined:["name"],attribsUndefined:["href"]},{tagName:"img"},{tagName:"br"}],BLOCK_TAGS:["p","h1","h2","h3","h4","h5","h6","div","ol","ul","pre","table","address","blockquote","center","dl","fieldset","form","hr","marquee","noscript","script"],EDITBLOCK_TAGS:["p","h1","h2","h3","h4","h5","h6","div","li","pre","td","th","address","blockquote","center","caption"],EDITBLOCK_NESTED_TAGS:["td","th"],EDITBLOCK_UNREGNEST_TAGS:["li"],RTE_ATTRIB_PREFIX:"_rte",HREF_ATTRIB:"_rte_href",SRC_ATTRIB:"_rte_src",BR_TEMP_ATTRIB:"_rte_temp_br",A_NAME_REPLACEMENT_ATTRIB:"_rte_a_name_repl",TEMP_EL_ATTRIB:"_rte_temp_el",TEMP_EL_IMMEDIATE_REMOVAL:"immediate",TEMP_EL_REMOVE_ON_SERIALIZE:"serialize",TABLE_CELLS:["td","th"],LIST_TAGS:["ul","ol"],IE_ATTRIB_NAMES:{cellpadding:"cellPadding",cellspacing:"cellSpacing",valign:"vAlign",bgcolor:"bgColor",rowspan:"rowSpan",colspan:"colSpan"},KEY_STROKES:{ARROW_LEFT:37,ARROW_UP:38,ARROW_RIGHT:39,ARROW_DOWN:40},VOID_TAGS:["area","base","br","col","embed","hr","img","input","keygen","link","menuitem","meta","param","source","track","wbr"],FILTER_GECKO_TEMPORARY_ATTRIBS:function(G,E,F){var D=CUI.rte.Common;
return D.strStartsWith(F,"_moz")||(D.isTag(G,"br")&&(F=="type"))
}}
}();
CUI.rte.HtmlProcessor=function(){return{replace:function(text,startPos,endPosIncl,replacement){return CUI.rte.Common.strReplace(text,startPos,endPosIncl,replacement)
},isBlockTag:function(tagName){var tags=CUI.rte.Common.BLOCK_TAGS;
var tagNameLC=tagName.toLowerCase();
var tagCnt=tags.length;
for(var tagIndex=0;
tagIndex<tagCnt;
tagIndex++){if(tags[tagIndex]==tagNameLC){return true
}}return false
},skipWhitespace:function(str,pos){while((pos<str.length)&&(str.charCodeAt(pos)<=32)){pos++
}if(pos>=str.length){return -1
}return pos
},stripSurroundingWhitespace:function(text,excludeSpace){var spaceIndex=0;
var lastValidChar=(excludeSpace?31:32);
while(spaceIndex<text.length){if(text.charCodeAt(spaceIndex)>lastValidChar){break
}spaceIndex++
}if(spaceIndex<text.length){text=text.substring(spaceIndex,text.length)
}else{text=""
}spaceIndex=text.length;
while(spaceIndex>0){spaceIndex--;
if(text.charCodeAt(spaceIndex)>=lastValidChar){break
}}if(spaceIndex>=0){text=text.substring(0,spaceIndex+1)
}else{text=""
}return text
},removeTrailingChars:function(text,chars){var pos=text.length-1;
while(pos>0){if(chars.indexOf(text.charAt(pos))<0){return text.substring(0,pos+1)
}pos--
}return""
},parseTag:function(tagStr){var hpr=CUI.rte.HtmlProcessor;
tagStr=tagStr.replace(/\r\n/g," ");
tagStr=tagStr.replace(/[\r\n\t]/g," ");
var tagDef={tagName:null,attributes:{}};
if(tagStr.length<3){return tagDef
}var firstChar=hpr.skipWhitespace(tagStr,0);
if(firstChar<0){return tagDef
}if(tagStr.charAt(firstChar)!="<"){return tagDef
}var closingBrace=tagStr.lastIndexOf(">");
if(closingBrace<=firstChar){return tagDef
}if(closingBrace>0){if(tagStr.charAt(closingBrace-1)=="/"){closingBrace--;
tagDef.isShortTag=true
}}var tagEnd=tagStr.indexOf(" ",firstChar);
if(tagEnd<0){tagDef.tagName=tagStr.substring(firstChar+1,closingBrace).toLowerCase();
return tagDef
}tagDef.tagName=tagStr.substring(firstChar+1,tagEnd).toLowerCase();
var processPos=tagEnd;
while(true){if(processPos>=closingBrace){return tagDef
}processPos=hpr.skipWhitespace(tagStr,processPos);
if(processPos<0){return tagDef
}var attribSepPos=tagStr.indexOf("=",processPos);
var shortAttrib=null;
var spaceSepPos=tagStr.indexOf(" ",processPos);
if((spaceSepPos>=0)&&((spaceSepPos<attribSepPos)||attribSepPos<0)){var endSpacePos=hpr.skipWhitespace(tagStr,spaceSepPos);
if(endSpacePos!=attribSepPos){shortAttrib=tagStr.substring(processPos,spaceSepPos);
processPos=endSpacePos
}}else{if(attribSepPos<0){if(processPos<(tagStr.length-1)){shortAttrib=tagStr.substring(processPos,tagStr.length);
shortAttrib=hpr.removeTrailingChars(shortAttrib," >")
}processPos=tagStr.length
}}var attributeName;
if(shortAttrib!=null){attributeName=shortAttrib.toLowerCase();
tagDef.attributes[attributeName]={name:attributeName,originalName:shortAttrib,shortAttrib:true,quoted:false}
}else{if(attribSepPos<0){return tagDef
}var originalAttributeName=tagStr.substring(processPos,attribSepPos);
originalAttributeName=hpr.removeTrailingChars(originalAttributeName," ");
attributeName=originalAttributeName.toLowerCase();
attribSepPos=hpr.skipWhitespace(tagStr,attribSepPos+1);
var spacePos=tagStr.indexOf(" ",attribSepPos);
var quotChar='"';
var quotPos=tagStr.indexOf('"',attribSepPos);
var aposPos=tagStr.indexOf("'",attribSepPos);
var attributeValue;
var valueStartIndex=-1;
var valueCharCnt=-1;
var isQuotedValue=true;
if(quotPos>closingBrace){quotPos=-1
}if(aposPos>closingBrace){aposPos=-1
}if(spacePos>closingBrace){spacePos=-1
}if(aposPos>=0){if((aposPos<quotPos)||(quotPos<0)){quotPos=aposPos;
quotChar="'"
}}if((quotPos>=0)&&((quotPos<spacePos)||(spacePos<0))){var endQuotPos=tagStr.indexOf(quotChar,quotPos+1);
if(endQuotPos<0){return tagDef
}attributeValue=tagStr.substring(quotPos+1,endQuotPos);
valueStartIndex=quotPos+1;
valueCharCnt=(endQuotPos-(quotPos+1));
processPos=endQuotPos+1
}else{var lastCharPos=(spacePos>=0?spacePos:closingBrace);
attributeValue=tagStr.substring(attribSepPos,lastCharPos);
isQuotedValue=false;
valueStartIndex=attribSepPos;
valueCharCnt=(lastCharPos-attribSepPos);
processPos=lastCharPos+1
}tagDef.attributes[attributeName]={name:attributeName,originalName:originalAttributeName,value:attributeValue,pos:valueStartIndex,cnt:valueCharCnt,shortAttrib:false,quoted:isQuotedValue}
}}},parseStyleDef:function(styleStr){styleStr=CUI.rte.Utils.htmlDecode(styleStr);
var processPos=0;
var styleDef={};
while(true){processPos=CUI.rte.HtmlProcessor.skipWhitespace(styleStr,processPos);
if(processPos<0){return styleDef
}var sepPos=styleStr.indexOf(":",processPos+1);
var styleName=styleStr.substring(processPos,sepPos);
styleName=CUI.rte.HtmlProcessor.stripSurroundingWhitespace(styleName);
if(styleName.length==0){return styleDef
}var defEndPos=styleStr.indexOf(";",sepPos+1);
if(defEndPos<0){defEndPos=styleStr.length
}var styleCode=styleStr.substring(sepPos+1,defEndPos);
styleCode=CUI.rte.HtmlProcessor.stripSurroundingWhitespace(styleCode);
styleDef[styleName.toLowerCase()]=styleCode;
processPos=defEndPos+1
}},createStyleAttrib:function(styleDef){var styleStr="";
for(var name in styleDef){if(styleDef.hasOwnProperty(name)){var value=styleDef[name];
if(styleStr.length>0){styleStr+=" "
}styleStr+=name+": "+value+";"
}}return(styleStr.length>0?styleStr:undefined)
},handleHtmlText:function(htmlStr,callback,startPos,endPos){var noReplacementRet={html:htmlStr,delta:0};
if(!callback.onHtmlText){return noReplacementRet
}if(endPos<=startPos){return noReplacementRet
}var text=htmlStr.substring(startPos,endPos);
var replaceStr=callback.onHtmlText(text);
if(replaceStr==null){return noReplacementRet
}var delta=replaceStr.length-(endPos-startPos);
htmlStr=CUI.rte.HtmlProcessor.replace(htmlStr,startPos,endPos-1,replaceStr);
return{html:htmlStr,delta:delta}
},getProcessingTagEndPos:function(htmlStr,dataPos){var strLen=htmlStr.length;
var charAtPos=htmlStr.charAt(dataPos);
if(charAtPos=="!"){if(strLen>dataPos+3){if(htmlStr.substring(dataPos,dataPos+3)=="!--"){return htmlStr.indexOf("-->",dataPos+3)+2
}}return htmlStr.indexOf(">",dataPos+1)
}return htmlStr.indexOf(">",dataPos)
},parseHtml:function(htmlStr,callback){var hpr=CUI.rte.HtmlProcessor;
var processingPos=0;
var textPos=0;
var textHandlerResult;
while((processingPos>=0)&&(processingPos<htmlStr.length)){var tagStartPos=htmlStr.indexOf("<",processingPos);
if(tagStartPos>=0){var dataPos=hpr.skipWhitespace(htmlStr,tagStartPos+1);
var firstCharOfTag=htmlStr.charAt(dataPos);
var tagName,tagEndPos,replaceStr;
if((firstCharOfTag=="?")||(firstCharOfTag=="!")){processingPos=hpr.getProcessingTagEndPos(htmlStr,dataPos);
if(processingPos>0){textHandlerResult=hpr.handleHtmlText(htmlStr,callback,textPos,tagStartPos);
htmlStr=textHandlerResult.html;
tagStartPos+=textHandlerResult.delta;
dataPos+=textHandlerResult.delta;
processingPos+=textHandlerResult.delta;
if(callback.onProcessingTag){var pTag=htmlStr.substring(tagStartPos,processingPos+1);
replaceStr=callback.onProcessingTag(pTag);
if(replaceStr!=null){htmlStr=hpr.replace(htmlStr,tagStartPos,processingPos,replaceStr);
processingPos+=replaceStr.length-pTag.length+1
}}else{processingPos++
}textPos=processingPos
}}else{if(firstCharOfTag=="/"){tagEndPos=htmlStr.indexOf(">",dataPos+1);
if(tagEndPos>0){textHandlerResult=hpr.handleHtmlText(htmlStr,callback,textPos,tagStartPos);
htmlStr=textHandlerResult.html;
tagStartPos+=textHandlerResult.delta;
dataPos+=textHandlerResult.delta;
tagEndPos+=textHandlerResult.delta;
tagName=htmlStr.substring(dataPos+1,tagEndPos);
tagName=hpr.stripSurroundingWhitespace(tagName);
if(callback.onTagEnd){var endTagLen=tagEndPos-tagStartPos+1;
replaceStr=callback.onTagEnd(tagName.toLowerCase(),false,tagStartPos,endTagLen);
if(replaceStr!=null){htmlStr=hpr.replace(htmlStr,tagStartPos,tagEndPos,replaceStr);
tagEndPos+=replaceStr.length-endTagLen
}}}else{tagEndPos=dataPos
}processingPos=tagEndPos+1;
textPos=processingPos
}else{tagEndPos=htmlStr.indexOf(">",tagStartPos);
if(tagEndPos>0){var includesClosingTag=false;
if(htmlStr.charAt(tagEndPos-1)=="/"){includesClosingTag=true
}textHandlerResult=hpr.handleHtmlText(htmlStr,callback,textPos,tagStartPos);
htmlStr=textHandlerResult.html;
tagStartPos+=textHandlerResult.delta;
dataPos+=textHandlerResult.delta;
tagEndPos+=textHandlerResult.delta;
var tag=htmlStr.substring(tagStartPos,tagEndPos+1);
var tagDef=hpr.parseTag(tag);
tagName=tagDef.tagName;
if(tagName&&callback.onTagStart){replaceStr=callback.onTagStart(tagName,tagDef.attributes,includesClosingTag,tagStartPos,tag.length,tagStartPos,tag.length);
if(replaceStr!=null){htmlStr=hpr.replace(htmlStr,tagStartPos,tagEndPos,replaceStr);
tagEndPos+=replaceStr.length-tag.length
}}if(tagName&&includesClosingTag&&callback.onTagEnd){replaceStr=callback.onTagEnd(tagName,includesClosingTag,tagStartPos,tag.length);
if(replaceStr!=null){htmlStr=hpr.replace(htmlStr,tagEndPos+1,tagEndPos,replaceStr);
tagEndPos+=replaceStr.length
}}}else{tagEndPos=dataPos
}processingPos=tagEndPos+1;
textPos=processingPos
}}}else{textHandlerResult=hpr.handleHtmlText(htmlStr,callback,processingPos,htmlStr.length);
htmlStr=textHandlerResult.html;
processingPos=-1
}}return htmlStr
},hasEqualAttributes:function(attribs,cmpAttribs){var attribCnt=0;
for(var attribToCheck in attribs){if(attribs.hasOwnProperty(attribToCheck)){if(!cmpAttribs.hasOwnProperty(attribToCheck)){return false
}if(attribs[attribToCheck].value!=cmpAttribs[attribToCheck].value){return false
}attribCnt++
}}for(attribToCheck in cmpAttribs){if(cmpAttribs.hasOwnProperty(attribToCheck)){attribCnt--;
if(attribCnt<0){return false
}}}return(attribCnt==0)
},parseStyleTag:function(tagStr){var tagReplacement=null;
var tagDef=CUI.rte.HtmlProcessor.parseTag(tagStr);
var styleDef=tagDef.attributes.style;
if(styleDef){styleDef=styleDef.value;
var styleDefs=CUI.rte.HtmlProcessor.parseStyleDef(styleDef);
if(styleDefs["font-weight"]=="bold"){if(!tagReplacement){tagReplacement=new Array()
}tagReplacement.push("b")
}if(styleDefs["font-style"]=="italic"){if(!tagReplacement){tagReplacement=new Array()
}tagReplacement.push("i")
}}return tagReplacement
},executeTagReplace:function(value,tagReplace){if(tagReplace){for(var srcTag in tagReplace){if(tagReplace.hasOwnProperty(srcTag)){var destTag=tagReplace[srcTag];
if(srcTag&&destTag){var srcStartTag="<"+srcTag+">";
var srcEndTag="<\\/"+srcTag+">";
var destStartTag="<"+destTag+">";
var destEndTag="</"+destTag+">";
var expStart=eval("/"+srcStartTag+"/gi");
var expEnd=eval("/"+srcEndTag+"/gi");
value=value.replace(expStart,destStartTag);
value=value.replace(expEnd,destEndTag)
}}}}return value
},executeStyleReplace:function(value){var tag,tagEndPos,tagsToReplace,replaceText;
var replacePos=0;
var spanEndTags=new Array();
while(replacePos>=0){var valueLC=value.toLowerCase();
tag=null;
var closingTagPos=valueLC.indexOf("</span>",replacePos);
var wholeTagPos=valueLC.indexOf("<span>",replacePos);
replacePos=valueLC.indexOf("<span ",replacePos);
if((wholeTagPos>=0)&&((wholeTagPos<replacePos)||(replacePos<0))){replacePos=wholeTagPos
}while((closingTagPos>=0)&&((closingTagPos<replacePos)||(replacePos<0))){tagsToReplace=spanEndTags.pop();
var replaceCnt=tagsToReplace.length;
if((replaceCnt>0)&&(tagsToReplace[0]!="span")){replaceText="";
for(var replaceIndex=replaceCnt-1;
replaceIndex>=0;
replaceIndex--){replaceText+="</"+tagsToReplace[replaceIndex]+">"
}value=CUI.rte.HtmlProcessor.replace(value,closingTagPos,closingTagPos+6,replaceText);
closingTagPos+=replaceText.length;
replacePos+=replaceText.length-7
}else{closingTagPos+=7
}valueLC=value.toLowerCase();
closingTagPos=valueLC.indexOf("</span>",closingTagPos)
}if(replacePos>=0){tagEndPos=valueLC.indexOf(">",replacePos);
if(tagEndPos>replacePos){tag=value.substring(replacePos,tagEndPos+1)
}}if(tag){tagsToReplace=CUI.rte.HtmlProcessor.parseStyleTag(tag);
if(tagsToReplace){replaceText="";
var tagCnt=tagsToReplace.length;
var closingTagInfo=new Array();
for(var tagIndex=0;
tagIndex<tagCnt;
tagIndex++){var tagToReplace=tagsToReplace[tagIndex];
closingTagInfo.push(tagToReplace);
replaceText+="<"+tagToReplace+">"
}value=CUI.rte.HtmlProcessor.replace(value,replacePos,tagEndPos,replaceText);
replacePos+=replaceText.length;
spanEndTags.push(closingTagInfo)
}else{replacePos+=tag.length;
spanEndTags.push(["span"])
}}}return value
},executeInternalizeLinks:function(value,linkInternalize){var valueLC=value.toLowerCase();
var replacePos,tagEndPos;
var tagCnt=linkInternalize.length;
for(var tagIndex=0;
tagIndex<tagCnt;
tagIndex++){var tag=linkInternalize[tagIndex];
var tagName=tag.tag;
var attribute=tag.attribute;
replacePos=0;
while((replacePos>=0)&&(replacePos<value.length)){replacePos=valueLC.indexOf("<"+tagName+" ",replacePos);
if(replacePos>=0){var tagStr=null;
tagEndPos=valueLC.indexOf(">",replacePos+1);
if(tagEndPos>replacePos){tagStr=value.substring(replacePos,tagEndPos+1)
}if(tagStr){var tagDef=CUI.rte.HtmlProcessor.parseTag(tagStr);
if(tagDef){var attribDef=tagDef.attributes[attribute];
if(attribDef&&!attribDef.shortAttrib){var attribValue=attribDef.value;
var attribPos=attribDef.pos;
var attribCharCnt=attribDef.cnt;
var isQuoted=attribDef.quoted;
var url=CUI.rte.HtmlRules.removePrefixForInternalLinks(attribValue,CUI.rte.Utils.URL_LINK);
if(url!=attribValue){if(!isQuoted){url='"'+url+'"'
}value=CUI.rte.HtmlProcessor.replace(value,replacePos+attribPos,replacePos+attribPos+attribCharCnt-1,url);
valueLC=value.toLowerCase();
replacePos+=tagStr.length+(url.length-attribValue.length)
}else{replacePos+=tagStr.length
}}else{replacePos+=tagStr.length
}}else{replacePos+=tagStr.length
}}else{replacePos+=tagName.length+2
}}}}return value
},createTag:function(tagName,attribs,isClosingTag,isShortTag,normalizeTag){if(isClosingTag&&isShortTag){return""
}var tag="<";
if(isClosingTag){tag+="/"
}tag+=(normalizeTag?tagName.toLowerCase():tagName);
if(attribs&&!isClosingTag){tag+=CUI.rte.HtmlProcessor.createAttributes(attribs,normalizeTag)
}if(isShortTag){tag+=" /"
}tag+=">";
return tag
},createAttributes:function(attribs,normalizeTag){var strRep="";
if(!attribs){return strRep
}for(var attribName in attribs){if(attribs.hasOwnProperty(attribName)){if(attribName!="classname"){var attribDef=attribs[attribName];
if(attribDef){strRep+=" "+(normalizeTag?attribName.toLowerCase():attribName);
if(attribDef.shortAttrib){if(normalizeTag){strRep+='="'+attribName.toLowerCase()+'"'
}}else{strRep+="=";
var value=attribDef.value;
var isQuoted=attribDef.quoted;
if(!isQuoted){isQuoted=(value.indexOf(" ")>=0)
}if(isQuoted||normalizeTag){strRep+='"'
}strRep+=value;
if(isQuoted||normalizeTag){strRep+='"'
}}}}}}return strRep
}}
}();
CUI.rte.HtmlProcessor.StripTags=new Class({toString:"HtmlProcessor.StripTags",ignoreContent:false,strip:function(a){return CUI.rte.HtmlProcessor.parseHtml(a,this)
},onTagStart:function(a){if((a=="style")||(a=="script")){this.ignoreContent=true
}if(a=="br"){return"\n"
}return""
},onTagEnd:function(a){if((a=="style")||(a=="script")){this.ignoreContent=false
}if(a=="tr"){return"\n"
}if(a=="p"){return"\n\n"
}if(a.match(/h[1-6]/)){return"\n\n"
}if(a=="li"){return"\n\n"
}return""
},onHtmlText:function(b){if(this.ignoreContent){return""
}var a=b.replace(/[\n\r]/g," ");
return(a!=b?a:null)
},onProcessingTag:function(a){return""
}});
CUI.rte.DomProcessor=function(){var a=CUI.rte.Common;
return{getTagType:function(f){var e=CUI.rte.DomProcessor;
var b=(f instanceof String?f:f.tagName).toLowerCase();
var c=e.STRUCTURE;
var d=e.TYPE_TABLE;
if(d.hasOwnProperty(b)){c=d[b];
if(typeof(c)!="string"){c=c.type
}}return c
},resolveTagType:function(f){var e=CUI.rte.DomProcessor;
var b=(f instanceof String?f:f.tagName).toLowerCase();
var c=e.STRUCTURE;
var d=e.TYPE_TABLE;
if(d.hasOwnProperty(b)){c=d[b];
if(typeof(c)!="string"){if(c.type==e.DYNAMIC){if(c.getDynamicType){c=c.getDynamicType(f)
}else{c=e.STRUCTURE
}}else{c=c.type
}}}return c
},createNodeList:function(c,d){var b=new CUI.rte.NodeList();
if(d.cellSelection&&d.cellSelection.cells){b.createFromDomNodes(c,d.cellSelection.cells)
}else{b.createFromDocument(c,d)
}return b
},getCommonAncestor:function(c,e,d){if((e==null)||(d==null)){return null
}if(a.isAncestor(c,e,d)){return e.parentNode
}if(a.isAncestor(c,d,e)){return d.parentNode
}while(e){var b=d;
while(b){if(b==e){return e
}b=a.getParentNode(c,b)
}e=a.getParentNode(c,e)
}return null
},splitTextNode:function(c,d,i){if(d.nodeType!=3){throw new Error("splitTextNode() may only operate on text nodes.")
}if(!CUI.rte.Utils.isArray(i)){i=[i]
}i.sort(function(o,n){return o-n
});
var j=[];
var g=0;
var e=d.nodeValue;
var m=i.length;
var f=d.parentNode;
var h,b;
for(var l=0;
l<m;
l++){var k=i[l];
h=e.substring(g,k);
b=c.createTextNode(h);
j.push(b);
f.insertBefore(b,d);
g=k
}h=e.substring(g,e.length);
b=c.createTextNode(h);
j.push(b);
f.insertBefore(b,d);
f.removeChild(d);
return j
},createNode:function(e,d,h){var b=(a.ua.isIE6||a.ua.isIE7)&&((d.toLowerCase()=="a")&&h.hasOwnProperty("name"));
var f=(b?null:e.createElement(d));
var i=null;
if(b){i="<"+d
}if(h){for(var c in h){if(h.hasOwnProperty(c)){var g=h[c];
if(b){g=CUI.rte.Utils.htmlEncode(g);
i+=" "+c+'="'+g+'"'
}else{c=(c=="className"?"class":c);
CUI.rte.Common.setAttribute(f,c,g)
}}}}if(b){i+="></"+d+">";
f=e.createElement(i)
}return f
},insertAsParent:function(e,g,d,h){var f=CUI.rte.DomProcessor;
var c=f.createNode(e,d,h);
var b=g.parentNode;
b.insertBefore(c,g);
b.removeChild(g);
c.appendChild(g);
return c
},removeWithoutChildren:function(b){var c=b.parentNode;
while(b.childNodes.length>0){var d=b.childNodes[0];
b.removeChild(d);
c.insertBefore(d,b)
}c.removeChild(b)
},restructureAsChild:function(e,f,d,g,c){var j=CUI.rte.DomProcessor;
var h=j.createNode(e,g,c);
f.insertBefore(h,d[0]);
var k=d.length;
for(var i=0;
i<k;
i++){var b=d[i];
f.removeChild(b);
h.appendChild(b)
}return h
},isPlaceholderObject:function(c){if(a.ua.isIE&&!a.ua.isIEBRPlaceholder){return((c.nodeType==3)&&(c.nodeValue==CUI.rte.DomProcessor.NBSP))
}else{var b=a.isTag(c,"br");
if(!b&&a.isTag(c.parentNode,["td","th"])){b=((c.nodeType==3)&&(c.nodeValue==CUI.rte.DomProcessor.NBSP))
}return b
}},getEmptyLinePlaceholder:function(b){if(b.nodeType!=1){return null
}if(b.childNodes.length!=1){return null
}var c=b.childNodes[0];
if(CUI.rte.DomProcessor.isPlaceholderObject(c)){return c
}return null
},isEmptyLinePlaceholder:function(b){return(CUI.rte.DomProcessor.getEmptyLinePlaceholder(b)!=null)
},createEmptyLinePlaceholder:function(c,f,d){var e;
if(!a.ua.isIE||a.ua.isIEBRPlaceholder){e=CUI.rte.DomProcessor.createGeckoPlaceholder(c)
}if(f){var b=c.createElement(d||"p");
if(e){b.appendChild(e)
}e=b
}return e
},createGeckoPlaceholder:function(b){var c=b.createElement("br");
if(a.ua.isGecko||a.ua.isWebKit||a.ua.isIEBRPlaceholder){a.setAttribute(c,a.BR_TEMP_ATTRIB,"brEOB")
}return c
},ensureValidEmptyEditBlock:function(b,c){if(!a.isTag(c,a.EDITBLOCK_TAGS)||(c.nodeType!=1)){throw new Error("No valid edit block provided")
}if(c.childNodes.length==0){var d=CUI.rte.DomProcessor;
if(!a.ua.isIE||a.ua.isIEBRPlaceholder){c.appendChild(d.createGeckoPlaceholder(b))
}d.fixEmptyEditingBlockIE(b,c)
}},ensureEmptyLinePlaceholders:function(c,e){if(e.nodeType==1){var d=CUI.rte.DomProcessor;
var f=CUI.rte.Selection;
if(d.getTagType(e)==d.CONTAINER){var b=a.getFirstTextChild(e,true);
if(b==null){var i=d.getEmptyLinePlaceholder(e);
if(!i){i=d.createEmptyLinePlaceholder(c,false);
if(i){var h=a.getFirstChild(e);
if(h==null){h=e
}else{while(f.isNoInsertNode(h,true)){h=h.parentNode;
if(h==e){break
}}}h.appendChild(i)
}}}else{if(d.isPlaceholderObject(b)){var g=a.getFirstChild(e);
if(!f.isNoInsertNode(g,true)){if(g!=b){b.parentNode.removeChild(b);
g.appendChild(b)
}}}}}}},isEmptyLineBlock:function(c){var b=CUI.rte.DomProcessor;
var f=b.isEmptyLinePlaceholder(c);
if(!f){var e=a.getCharacterNodes(c);
if(e.length==0){f=true
}else{if(e.length==1){var d=a.getNodeText(e[0]);
f=(d==b.NBSP)
}}}return f
},fixEmptyEditingBlockIE:function(d,c){if(a.ua.isIE&&!a.ua.isIEBRPlaceholder&&a.isEmptyEditingBlock(c,true)){if(a.isTag(c,a.TABLE_CELLS)){return
}var e=CUI.rte.DomProcessor;
var f=d.createTextNode(e.NBSP);
c.appendChild(f);
var g=d.createElement("span");
c.appendChild(g);
g.appendChild(d.createTextNode(e.NBSP));
d.win.focus();
d.doc.selection.empty();
var b=d.doc.selection.createRange();
b.moveToElementText(g);
b.pasteHTML("");
c.removeChild(f)
}},fixEmptyLinefeedIE:function(c,e){if(a.ua.isIE&&!a.ua.isIEBRPlaceholder){var d=CUI.rte.DomProcessor;
var g=c.createElement("span");
var f=e.nextSibling;
f?e.parentNode.insertBefore(g,f):e.parentNode.appendChild(g);
g.appendChild(c.createTextNode(d.NBSP));
c.win.focus();
var b=c.doc.selection.createRange();
b.moveToElementText(g);
b.pasteHTML("")
}},ensureMinimumContent:function(e){var g=CUI.rte.DomProcessor;
var c=CUI.rte.Common;
var h=CUI.rte.Selection;
var d=null;
if(e.root.childNodes.length==1){var b=e.root.childNodes[0];
if(c.isTag(b,"br")){e.root.removeChild(b)
}if(c.isTag(b,"p")){g.ensureEmptyLinePlaceholders(e,b)
}}var f=g.ensureBlockContent(e,"p",null,false,true);
if(f){h.selectBookmark(e,f)
}if(e.root.childNodes.length==0){d=e.createElement("p");
e.root.appendChild(d);
g.ensureEmptyLinePlaceholders(e,d);
h.selectNode(e,d,true)
}return d
},getEmptyLine:function(b,d){var f=CUI.rte.DomProcessor;
var e=f.getEditBlock(b,d.startNode);
if(!e){return null
}if(d.endNode){var c=f.getEditBlock(b,d.endNode);
if(e!=c){return null
}}return(f.isEmptyLineBlock(e)?e:null)
},isEmptyLine:function(b,c){return(CUI.rte.DomProcessor.getEmptyLine(b,c)!=null)
},isEmptyLineDeterminator:function(b,d){if(!a.isTag(d,"br")){return false
}var c=a.getPreviousCharacterNode(b,d,a.EDITBLOCK_TAGS);
return(((c==null)&&a.ua.isIE)||a.isTag(c,"br"))
},getEmptyBlockPlaceholder:function(b,d,f){while(d&&!a.isTag(d,a.EDITBLOCK_TAGS)){d=a.getParentNode(b,d)
}if(d){var e=a.getCharacterNodes(d);
if(e.length==1){var c=e[0];
if(a.isTag(c,"br")){if(!f||a.isAttribDefined(c,a.BR_TEMP_ATTRIB)){return c
}}}}return null
},removeEmptyBlockPlaceholder:function(b,d,f){var c=CUI.rte.DomProcessor;
var e=c.getEmptyBlockPlaceholder(b,d,f);
if(e&&e.parentNode){e.parentNode.removeChild(e)
}},adjustTables:function(c){var k=c.root;
var f=k.childNodes;
var g;
for(g=0;
g<f.length;
g++){var e=f[g];
if(a.isTag(e,"p")){if(e.childNodes.length==1){var b=e.childNodes[0];
if(a.isTag(b,"table")){k.insertBefore(b,e);
k.removeChild(e);
e=b
}}}if(a.isTag(e,"table")){var h=a.getChildNodesByType(e,"thead");
if(h.length==1){h=h[0];
var l=a.getChildNodesByType(e,"tbody");
if(l.length==0){l.push(c.createElement("tbody"))
}l=l[0];
var d=null;
if(l.childNodes.length>0){d=l.childNodes[0]
}for(g=h.childNodes.length-1;
g>=0;
g--){var j=h.childNodes[g];
h.removeChild(j);
l.insertBefore(j,d);
d=j
}e.removeChild(h)
}}}},removeNonTableBlocks:function(d){var b=d.root;
var e=b.childNodes;
for(var c=e.length-1;
c>=0;
c--){if(!a.isTag(e[c],"table")){b.removeChild(e[c])
}}},hasSimilarParent:function(b,e){var d=CUI.rte.DomProcessor;
if(!e||(e.nodeType!=1)){return false
}var c=a.getParentNode(b,e);
while(c){if(d.getTagType(c)==d.CONTAINER){return false
}if(c.nodeType==1){if(a.equals(e,c)){return true
}}c=a.getParentNode(b,c)
}return false
},removeDuplicateStructures:function(f,e,c){var h=CUI.rte.DomProcessor;
var g=e;
while(g){var d=false;
if(g.nodeType==1){if((h.getTagType(g)!=h.CONTAINER)&&h.hasSimilarParent(f,g)){var b=a.getNextNode(f,g);
if(g==e){e=b
}if(g==c){c=b
}h.removeWithoutChildren(g);
g=b;
d=true
}}if(!d){if(g==c){break
}g=a.getNextNode(f,g)
}}return{startNode:e,endNode:c}
},joinIdenticalStructures:function(c,e,f){var k=CUI.rte.DomProcessor;
if(e.nodeType==1){e=a.getFirstTextChild(e)||e
}var d=(f?a.getPreviousCharacterNode(c,e):a.getNextCharacterNode(c,e));
if(!e||!d){return
}var j=a.getParentNode(c,e);
var h=a.getParentNode(c,d);
var i=true;
var g=false;
while(k.getTagType(j)==k.STRUCTURE){if(!a.equals(j,h)){i=false;
break
}g=true;
j=a.getParentNode(c,j);
h=a.getParentNode(c,h);
if((j==null)||(h==null)){i=(j==h);
break
}}if(i){i=(j==h)
}if(i&&g){var b=e.parentNode;
var m=d.parentNode;
while(b!=m){var l=m.parentNode;
if(f){a.moveChildren(m,b,0,false)
}else{a.moveChildren(m,b,0,true)
}a.removeNodesWithoutContent(c,m);
m=l;
b=b.parentNode;
if(k.getTagType(b)==k.CONTAINER){break
}}}},splitToParent:function(l,f,h){var e=CUI.rte.Selection;
var o=e.isNoInsertNode(f,true)&&(h==null);
var p,i,n;
var b=[];
var d=true;
var g;
while(true){if(!f){return null
}if(o){g=a.getChildIndex(f);
h=g;
var c=f.parentNode.childNodes;
for(;
g<c.length;
g++){n=c[g];
b.push(n)
}f=f.parentNode;
o=false
}i=f.parentNode;
if(f.nodeType==3){if(h==0){b.push(f)
}else{if(h<a.getNodeCharacterCnt(f)){var k=f.nodeValue;
f.nodeValue=k.substring(0,h);
p=f.cloneNode(false);
p.nodeValue=k.substring(h,k.length);
b.push(p)
}}}else{if(d){for(g=h;
g<f.childNodes.length;
g++){b.push(f.childNodes[g])
}}p=f.cloneNode(false);
a.removeAttribute(p,"id");
var m=b.length;
for(var j=0;
j<m;
j++){n=b[j];
if(n.parentNode){n.parentNode.removeChild(n)
}p.appendChild(b[j])
}b.length=0;
b.push(p)
}if(f!=l){g=a.getChildIndex(f)+1;
while(g<i.childNodes.length){n=i.childNodes[g];
i.removeChild(n);
b.push(n)
}}else{if(f.nextSibling){i.insertBefore(p,f.nextSibling)
}else{i.appendChild(p)
}return p
}f=i;
d=false
}},removeUnwantedEmptyTags:function(d,e){if(a.matchesTagDefs(d,e)){if(!a.hasTextChild(d,true)){d.parentNode.removeChild(d);
return
}}if(d.nodeType==1){var b=d.childNodes.length;
for(var f=b-1;
f>=0;
f--){CUI.rte.DomProcessor.removeUnwantedEmptyTags(d.childNodes[f],e)
}}},insertParagraph:function(c,e,g){var m=CUI.rte.DomProcessor;
var d=CUI.rte.Selection;
var i;
if(a.isOneCharacterNode(e)&&(g==0)){var j=a.getNextCharacterNode(c,e,a.EDITBLOCK_TAGS);
if(j){e=j;
g=(e.nodeType==3?0:null)
}else{while(e&&!a.isTag(e,a.EDITBLOCK_TAGS)){g=a.getChildIndex(e)+1;
e=a.getParentNode(c,e)
}if(!e){throw new Error("Invalid insert position")
}}}if((e.nodeType==1)&&!a.isOneCharacterNode(e)&&((g==null)||(g==e.childNodes.length))){if(g==null){g=e.childNodes.length
}if(a.isRootNode(c,e)){i=e.childNodes[g-1].cloneNode(false);
e.appendChild(i);
e=e.childNodes[g-1]
}else{i=e.cloneNode(false);
e.parentNode.insertBefore(i,e.nextSibling)
}var h=null;
var l=a.getLastTextChild(e);
l=l?l:a.getLastChild(e);
l=l?l:e;
while(l!=e){if((l.nodeType==1)&&!d.isNoInsertNode(l,true)){var o=l.cloneNode(false);
if(h!=null){o.appendChild(h)
}h=o
}l=a.getParentNode(c,l)
}if(h!=null){i.appendChild(h)
}m.ensureEmptyLinePlaceholders(c,i);
m.fixEmptyEditingBlockIE(c,i)
}else{var b=m.getScopedBlockNode(c,e);
if(!b){throw new Error("Inserting paragraph outside an existing format scope")
}var f=b.dom;
if(b.isAuxiliaryRoot){var k=c.createElement("p");
a.moveChildren(f,k);
f.appendChild(k);
f=k
}i=m.splitToParent(f,e,g);
m.removeUnwantedEmptyTags(f,m.EMPTYTEXT_EXCLUSIONS);
var n=a.getLastTextChild(f,true,false);
if(a.isTag(n,"br")){n.parentNode.removeChild(n)
}m.removeUnwantedEmptyTags(i,m.EMPTYTEXT_EXCLUSIONS);
m.ensureEmptyLinePlaceholders(c,i);
m.ensureEmptyLinePlaceholders(c,f);
m.fixEmptyEditingBlockIE(c,i);
m.fixEmptyEditingBlockIE(c,f)
}return i
},isBlockStart:function(c,h,g,b){var d=CUI.rte.DomProcessor;
var f=d.getScopedBlockNode(c,h,b);
if(!f){return false
}f=f.dom;
if(h.nodeType==3){if(g>0){return false
}return(a.getFirstTextChild(f,true)==h)
}if(g!=null){if(g>0){return false
}}var e=f;
while((e.nodeType==1)&&(e.childNodes.length>0)){if(e.childNodes[0]==h){return true
}e=e.childNodes[0]
}return false
},isBlockEnd:function(c,h,g,b){var d=CUI.rte.DomProcessor;
var f=d.getScopedBlockNode(c,h,b);
if(!f){return false
}f=f.dom;
if(h.nodeType==3){if(g<h.nodeValue.length){return false
}return(a.getLastTextChild(f,true)==h)
}if(g!=null){if(g<h.childNodes.length-1){return false
}}var e=f;
while((e.nodeType==1)&&(e.childNodes.length>0)){if(e.childNodes[e.childNodes.length-1]==h){return true
}e=e.childNodes[e.childNodes.length-1]
}return false
},getContainerNode:function(b,d){var c=CUI.rte.DomProcessor;
while(d){if(d.nodeType==1){if(!a.isTag(d,c.AUXILIARY_ROOT_TAGS)){if(c.getTagType(d)==c.CONTAINER){return d
}}}d=a.getParentNode(b,d);
if(d===b.root){return null
}}return null
},getEditBlock:function(b,c){return a.getTagInPath(b,c,a.EDITBLOCK_TAGS)
},getEditBlocks:function(f,b){var e=CUI.rte.DomProcessor;
if(b===undefined){b=[]
}var d=f.childNodes.length;
for(var h=0;
h<d;
h++){var g=f.childNodes[h];
if(!a.isTag(g,e.AUXILIARY_ROOT_TAGS)){if(a.isTag(g,a.EDITBLOCK_TAGS)){b.push(g)
}e.getEditBlocks(g,b)
}}return b
},hasEditBlocks:function(e){var d=CUI.rte.DomProcessor;
var b=e.childNodes.length;
for(var g=0;
g<b;
g++){var f=e.childNodes[g];
if(!a.isTag(f,d.AUXILIARY_ROOT_TAGS)){if(a.isTag(f,a.EDITBLOCK_TAGS)||d.hasEditBlocks(f)){return true
}}}return false
},getAuxRootNode:function(b,c){while(c){if(a.isRootNode(b,c)){return c
}if(a.isTag(c,CUI.rte.DomProcessor.AUXILIARY_ROOT_TAGS)){return c
}c=a.getParentNode(b,c)
}return b.root
},getLastContainerNode:function(b,e){var d=CUI.rte.DomProcessor;
var c=a.getLastChild(e);
while(c&&(c!=e)){if(c.nodeType==1){if(d.getTagType(c)==d.CONTAINER){if(!a.isTag(c,d.AUXILIARY_ROOT_TAGS)){return c
}}}c=a.getPreviousNode(b,c)
}return null
},getSiblingContainerNode:function(b,f,e,c){var d=CUI.rte.DomProcessor;
while(f){if(f==e){return null
}if(f.nodeType==1){if(d.getTagType(f)==d.CONTAINER){if(!a.isTag(f,d.AUXILIARY_ROOT_TAGS)){return f
}}}f=c(b,f)
}return null
},getFormatTagInPath:function(d,f,b){while(f){if(f.nodeType==1){if(a.isRootNode(d,f)){return null
}var c=f.tagName.toLowerCase();
for(var e in b){if(b.hasOwnProperty(e)){var g=b[e];
if(g.tag&&(g.tag==c)){return f
}}}}f=f.parentNode
}return null
},createContainerList:function(e,f){var i=CUI.rte.Selection;
var h=CUI.rte.DomProcessor;
f=i.adaptToInclusiveEndNode(e,f);
var c=f.startNode;
var b=f.endNode;
var g;
if(!f.isEOT){g=h.getContainerNode(e,c)
}else{g=h.getLastContainerNode(e,c)
}if(!g&&b&&(b!=c)){g=h.getSiblingContainerNode(e,c,b,a.getNextNode)
}if(!g){return[]
}if(!b){return[g]
}b=h.getContainerNode(e,b);
if(!b){b=h.getLastContainerNode(e,f.endNode)
}if(!b){b=h.getSiblingContainerNode(e,f.endNode,c,a.getPreviousNode)
}if(!b){return[g]
}var d=[];
while(g){if(g.nodeType==1){if(!a.isTag(g,h.AUXILIARY_ROOT_TAGS)){if(h.getTagType(g)==h.CONTAINER){d.push(g)
}}}if(g==b){break
}g=a.getNextNode(e,g)
}return d
},createBlockList:function(e,f){var h=CUI.rte.Selection;
f=h.adaptToInclusiveEndNode(e,f);
var c=f.startNode;
var b=f.endNode;
var g;
if(!f.isEOT){g=a.getBlockNode(e,c)
}else{g=a.getLastBlockNode(e,c)
}if(!g){return[]
}if(!b){return[g]
}b=a.getBlockNode(e,b);
if(!b){return[g]
}var d=[];
while(g){if(g.nodeType==1){if(a.isBlockNode(e,g)){d.push(g)
}}if(g==b){break
}g=a.getNextNode(e,g)
}return d
},hasContainerChildNodes:function(e){var d=CUI.rte.DomProcessor;
var b=e.childNodes.length;
for(var g=0;
g<b;
g++){var f=e.childNodes[g];
if(f.nodeType==1){if(d.getTagType(f)==d.CONTAINER){return true
}}}return false
},getAuxRoots:function(b,j){var d=CUI.rte.Selection;
var i=CUI.rte.DomProcessor;
var g=[];
if(j.cellSelection){var k=j.cellSelection.cells;
if(k&&(k.length>0)){for(var h=0;
h<k.length;
h++){g.push(k[h])
}return g
}}j=d.adaptToInclusiveEndNode(b,j);
var e=j.startNode;
var f=j.endNode;
while(e){if(e.nodeType==1){if(i.getTagType(e)==i.CONTAINER){if(a.isTag(e,i.AUXILIARY_ROOT_TAGS)){g.push(e)
}break
}}e=a.getParentNode(b,e)
}if(!e){e=a.getTagInPath(b,j.startNode,a.BLOCK_TAGS);
if(!e){return g
}}if(f&&(f!=e)){e=a.getNextNode(b,e);
while(e){if(e.nodeType==1){if(a.isTag(e,i.AUXILIARY_ROOT_TAGS)){if(!i.hasContainerChildNodes(e)){g.push(e)
}}}if(e==f){break
}e=a.getNextNode(b,e)
}}return g
},changeContainerTag:function(b,i,k,d){var j=CUI.rte.DomProcessor;
var e=i.length;
var c=a.isTag(k,"pre");
for(var f=0;
f<e;
f++){var h=i[f];
var m=a.isTag(h,"pre");
var l=k.cloneNode(k);
var g=h.innerHTML;
a.replaceNode(h,l);
if(m!=c){if(m){g=g.replace(/\n\r/g,"\n");
g=g.replace(/\r\n/g,"\n");
g=g.replace(/\r/g,"\n");
g=g.replace(/\n/g,"<br>");
l.innerHTML=g
}}if(d){j.ensureEmptyLinePlaceholders(b,l)
}j.fixEmptyEditingBlockIE(b,l)
}},getStyles:function(c,b,e){var d=b.styles;
if(!d){d=[];
b.styles=d
}while(!a.isRootNode(c,e)){if(a.isTag(e,"span")){if(e.className){d.push({dom:e,className:e.className})
}}e=a.getParentNode(c,e)
}b.isContinuousStyle=(d.length==1)
},getScopedBlockNode:function(c,e,b){var d=CUI.rte.DomProcessor;
while(e){if(a.isTag(e,b?a.EDITBLOCK_TAGS:a.BLOCK_TAGS)){return{dom:e,isAuxiliaryRoot:false}
}if(a.isTag(e,d.AUXILIARY_ROOT_TAGS)){return{dom:e,isAuxiliaryRoot:true}
}if(a.isRootNode(c,e.parentNode)){return{dom:e,isAuxiliaryRoot:false}
}e=a.getParentNode(c,e)
}return null
},ensureBlockContent:function(d,g,c,o,n){var f=CUI.rte.Common;
var q=CUI.rte.DomProcessor;
var e=CUI.rte.Selection;
var j=null;
var r=null;
var m=d.root;
var p=null;
var b=m.childNodes;
for(var h=b.length-1;
h>=0;
h--){var i=b[h];
var l=f.isTag(i,"br");
var k=f.isTag(i,f.BLOCK_TAGS);
if((i.nodeType==3)||(l&&!o)||(!l&&!k)){if((j==null)&&n){j=e.createSelectionBookmark(d)
}if(!r){r=q.createNode(d,g,c);
m.insertBefore(r,p);
p=r
}if(i.parentNode){m.removeChild(i)
}r.insertBefore(i,r.firstChild)
}else{if(l){if((j==null)&&n){j=e.createSelectionBookmark(d)
}r=null;
m.removeChild(i)
}else{if(i.nodeType==1){p=i;
r=null
}}}}return j
},insertText:function(c,d,g,m){var j=c.root;
var b,f;
if(d.nodeType==1){if(g==null){f=d;
d=a.getFirstTextChild(d);
if(!d){var i=false;
b=a.getFirstChild(f);
if(!b){if(!a.isOneCharacterNode(f)){b=f;
i=true
}else{b=f
}}else{if(!a.isCharacterNode(b)){i=true
}}d=c.createTextNode("");
if(i){b.appendChild(d)
}else{b.parentNode.insertBefore(d,b)
}}g=0
}else{var h=d.childNodes.length;
if(h>0){if(g>=h){d=a.getLastChild(d);
if(d.nodeType==3){g=a.getNodeCharacterCnt(d)
}else{var l=d.parentNode;
d=c.createTextNode("");
l.appendChild(d);
g=0
}}else{d=d.childNodes[g];
if(d.nodeType==1){d=a.getPreviousCharacterNode(c,d);
if(!d){b=a.getFirstChild(j);
d=c.createTextNode("");
b.parentNode.insertBefore(d,b)
}else{if(d.nodeType==1){var e=c.createTextNode("");
d.parentNode.insertBefore(e,d.nextSibling);
d=e
}}}g=a.getNodeCharacterCnt(d)
}}else{d=a.getPreviousTextNode(c,d);
if(!d){b=a.getFirstChild(j);
d=c.createTextNode("");
b.parentNode.insertBefore(d,b)
}g=a.getNodeCharacterCnt(d)
}}}var k=d.nodeValue;
if(k.length<=g){k+=m
}else{if(g==0){k=m+k
}else{k=k.substring(0,g)+m+k.substring(g,k.length)
}}d.nodeValue=k;
return{node:d,offset:g+m.length}
},removeTagsFromHierarchy:function(f,h){var e=CUI.rte.DomProcessor;
var b=CUI.rte.Common;
var d=f.childNodes.length;
for(var g=d-1;
g>=0;
g--){var c=f.childNodes[g];
e.removeTagsFromHierarchy(c,h)
}if(f.nodeType==1){if(b.matchesTagDefs(f,h)){e.removeWithoutChildren(f)
}}},saveChildNodes:function(e){var b=[];
var d=e.childNodes;
for(var c=0;
c<d.length;
c++){var g=d[c];
var f={dom:g};
b.push(f);
if(g.nodeType==1){f.children=CUI.rte.DomProcessor.saveChildNodes(g)
}else{f.text=g.nodeValue
}}return b
},restoreChildNodes:function(f,b){while(f.childNodes.length>0){f.removeChild(f.childNodes[0])
}for(var d=0;
d<b.length;
d++){var g=b[d];
var e=g.dom;
if(g.text!==undefined){e.nodeValue=g.text
}var c=g.children;
f.appendChild(e);
if(c){CUI.rte.DomProcessor.restoreChildNodes(e,c)
}}},insertElement:function(e,h,d,g){var f=d.parentNode;
if(d.nodeType==3){if(g==0){f.insertBefore(h,d)
}else{if(g>=a.getNodeCharacterCnt(d)){f.insertBefore(h,d.nextSibling)
}else{var b=CUI.rte.DomProcessor.splitTextNode(e,d,g);
f.insertBefore(h,b[1])
}}return
}if(a.isOneCharacterNode(d)){if(g==null){a.insertBefore(f,h,d)
}else{a.insertBefore(f,h,d.nextSibling)
}}else{var c=d.childNodes;
if((g!=null)&&(g<c.length)){d.insertBefore(h,c[g])
}else{d.appendChild(h)
}}},createMarker:function(c,d,e){var b=c.createElement("span");
CUI.rte.DomProcessor.insertElement(c,b,d,e);
return b
},removeMarker:function(e,d){var c=d.previousSibling;
var b=d.nextSibling;
a.removeNodesWithoutContent(e,d);
if(c&&b){if((c.nodeType==3)&&(b.nodeType==3)){c.nodeValue+=b.nodeValue;
b.parentNode.removeChild(b)
}}},createTempSpan:function(d,f,h,b){var c=CUI.rte.Common;
var e=d.createElement("span");
var g=(f?c.TEMP_EL_IMMEDIATE_REMOVAL:c.TEMP_EL_REMOVE_ON_SERIALIZE);
if(h){g+=":keepChildren"
}if(b){g+=":adjustInner"
}c.setAttribute(e,c.TEMP_EL_ATTRIB,g);
return e
},removeTempSpans:function(e,d){var f=CUI.rte.Common;
var b=CUI.rte.DomProcessor;
var g=e.doc.getElementsByTagName("span");
var n=g.length;
var r=(d?f.TEMP_EL_IMMEDIATE_REMOVAL:f.TEMP_EL_REMOVE_ON_SERIALIZE);
var c=false;
var u,h,o;
if(f.ua.isWebKit){u=e.win.getSelection();
h=u.anchorNode;
o=u.anchorOffset
}for(var l=0;
l<n;
l++){var i=g[l];
var m=f.getAttribute(i,f.TEMP_EL_ATTRIB,true);
if(m&&f.strStartsWith(m,r)){if(i.parentNode){var p=m.split(":");
var t=f.arrayContains(p,"keepChildren");
var q=f.arrayContains(p,"adjustInner");
if(t){b.removeWithoutChildren(i)
}else{if(q){function j(y){if(y.nodeType===3){var x=y.nodeValue;
var v=false;
var s;
do{s=x.indexOf(b.ZERO_WIDTH_NBSP);
if(s>=0){x=f.strReplace(x,s,s,"");
if(f.ua.isWebKit&&(y===h)&&(s<o)){o--;
c=true
}v=true
}}while(s>=0);
if(v){y.nodeValue=x
}}else{if(y.nodeType===1){var w=y.childNodes.length;
for(var z=0;
z<w;
z++){j(y.childNodes[z])
}}}}j(i);
b.removeWithoutChildren(i)
}else{i.parentNode.removeChild(i)
}}}}}if(f.ua.isWebKit&&c){var k=e.doc.createRange();
k.setStart(h,o);
u.removeAllRanges();
u.addRange(k)
}},removeTempElements:function(b,h){var e=CUI.rte.Common;
var m=CUI.rte.DomProcessor;
if(!h){h=b.doc
}var k=h.length;
for(var l=0;
l<k;
l++){var d=h.childNodes[l];
if(d.nodeType===1){var g=e.getAttribute(d,e.TEMP_EL_ATTRIB,true);
if(g){var f=g.split(":");
var i=e.arrayContains(f,"keepChildren");
var j=e.arrayContains(f,"emptyOnly");
if(i){m.removeWithoutChildren(d)
}else{if(j){if(d.childNodes.length===0){d.parentNode.removeChild(d);
continue
}else{e.removeAttribute(d,e.TEMP_EL_ATTRIB)
}}else{d.parentNode.removeChild(d);
continue
}}}m.removeTempElements(b,d)
}}},isZeroSizePlaceholder:function(c){if(c.nodeType===1){if(c.childNodes.length!=1){return false
}c=c.childNodes[0]
}if(c.nodeType!==3){return false
}var b=a.getNodeText(c);
if(b.length!==1){return false
}return(b.charAt(0)===CUI.rte.DomProcessor.ZERO_WIDTH_NBSP)
},correctGeckoCopyBugs:function(c,d){var e=d.innerHTML;
var g=e.toLowerCase();
if(a.strStartsWith(g,"<tr>")||a.strStartsWith(g,"<tr ")){d.innerHTML="<table>"+e+"</table>"
}var j=a.getChildNodesByType(d,"tr",true);
var f=j.length;
for(var b=f-1;
b>=0;
b--){var i=j[b];
var h=a.getChildNodesByType(i,"tr",false);
if(h.length>0){CUI.rte.DomProcessor.removeWithoutChildren(i)
}}},checkNamedAnchor:function(c){if(a.isTag(c,"img")){var b=a.getAttribute(c,a.A_NAME_REPLACEMENT_ATTRIB);
if(b!=null){return{dom:c,name:b,isAnchorTag:false}
}}return null
},calcScreenEstate:function(d,v,t,n,g){var b=CUI.rte.DomProcessor,k,j;
if(!n){n=v;
g=t
}if(a.ua.isIE11){k=d.doc.createRange();
k.setStart(v,t);
k.setEnd(n,g);
j=k.getBoundingClientRect();
return{startY:j.top,endY:j.bottom}
}var h=a.getTagInPath(d,v,a.BLOCK_TAGS);
var f=a.getTagInPath(d,n,a.BLOCK_TAGS);
var q=h.cloneNode(true);
var r=f.cloneNode(true);
function e(y,x){var z=[];
while(y&&(y!==x)){z.splice(0,0,a.getChildIndex(y));
y=y.parentNode
}return z
}function m(B,y){var z=y;
var x=B.length;
for(var A=0;
A<x;
A++){z=z.childNodes[B[A]]
}return z
}var c=m(e(v,h),q);
var l=m(e(n,f),r);
var u=b.createMarker(d,c,t);
u.appendChild(d.createTextNode(b.ZERO_WIDTH_NBSP));
var i=u;
if((t!==g)||(v!==n)){i=b.createMarker(d,l,g);
i.appendChild(d.createTextNode(b.ZERO_WIDTH_NBSP))
}h.parentNode.insertBefore(q,h);
var w=CUI.rte.Utils.getPagePosition(u);
var p=CUI.rte.Utils.getHeight(u);
var s=w;
var o=p;
h.parentNode.removeChild(q);
if((t!==g)||(v!==n)){f.parentNode.insertBefore(r,f);
s=CUI.rte.Utils.getPagePosition(i);
o=CUI.rte.Utils.getHeight(i);
f.parentNode.removeChild(r)
}return{startY:w[1],endY:s[1]+o}
},TEXT_NODE:"text",DOM_NODE:"dom",CONTAINER:"container",STRUCTURE:"structure",DYNAMIC:"dynamic",IGNORE:"ignore",AUXILIARY_ROOT_TAGS:["td","th","caption"],NBSP_CODE:160,NBSP:String.fromCharCode(160),ZERO_WIDTH_NBSP_CODE:65279,ZERO_WIDTH_NBSP:String.fromCharCode(65279),EMPTYTEXT_EXCLUSIONS:[{tagName:"a",attribsDefined:["href"],attribsUndefined:["name"]},{tagName:"b"},{tagName:"i"},{tagName:"u"},{tagName:"sub"},{tagName:"sup"},{tagName:"span"}]}
}();
CUI.rte.DomProcessor.TYPE_TABLE={h1:CUI.rte.DomProcessor.CONTAINER,h2:CUI.rte.DomProcessor.CONTAINER,h3:CUI.rte.DomProcessor.CONTAINER,h4:CUI.rte.DomProcessor.CONTAINER,h5:CUI.rte.DomProcessor.CONTAINER,h6:CUI.rte.DomProcessor.CONTAINER,p:CUI.rte.DomProcessor.CONTAINER,div:CUI.rte.DomProcessor.CONTAINER,li:CUI.rte.DomProcessor.CONTAINER,ul:CUI.rte.DomProcessor.IGNORE,ol:CUI.rte.DomProcessor.IGNORE,table:CUI.rte.DomProcessor.IGNORE,tbody:CUI.rte.DomProcessor.IGNORE,thead:CUI.rte.DomProcessor.IGNORE,tfoot:CUI.rte.DomProcessor.IGNORE,tr:CUI.rte.DomProcessor.IGNORE,td:CUI.rte.DomProcessor.CONTAINER,th:CUI.rte.DomProcessor.CONTAINER,caption:CUI.rte.DomProcessor.CONTAINER,address:CUI.rte.DomProcessor.CONTAINER,blockquote:CUI.rte.DomProcessor.CONTAINER,pre:CUI.rte.DomProcessor.CONTAINER};
CUI.rte.WhitespaceProcessor=function(){var a=CUI.rte.Common;
var b=CUI.rte.DomProcessor;
return{normalizeWhitespace:function(g,f,c){var d=CUI.rte.WhitespaceProcessor;
g=g.replace(d.WHITESPACE_REGEX," ");
g=g.replace(d.MULTISPACE_REGEX," ");
var e;
if(f){e=0;
while((e<g.length)&&(g.charAt(e)==" ")){e++
}if(e<g.length){g=g.substring(e,g.length)
}else{g=""
}}if(c){e=g.length-1;
while((e>=0)&&(g.charAt(e)==" ")){e--
}if(e>=0){g=g.substring(0,e+1)
}else{g=""
}}return g
},handleTextBlock:function(l,d,j,g,k,e){var m=CUI.rte.WhitespaceProcessor;
var h=d.length;
var f=(j==0)&&e;
if(!f&&e){if(a.isTag(d[j-1],"br")){f=true
}}var i=(g==(h-1))&&e;
if(!i&&e){if(a.isTag(d[g+1],"br")){i=true
}}l=m.normalizeWhitespace(l,f,i);
d[j].nodeValue=l;
if(l.length==0){k.push(d[j])
}for(var c=j+1;
c<=g;
c++){k.push(d[c])
}},handleNoTextStructure:function(d,h,j){var l=CUI.rte.WhitespaceProcessor;
var f=h.childNodes;
var i=f.length;
for(var k=i-1;
k>=0;
k--){var e=f[k];
if(e.nodeType==3){h.removeChild(e)
}else{var g=a.isTag(e,a.EDITBLOCK_TAGS);
l.processStructure(d,e,g,j)
}}},cleanTextNodes:function(e,i,h,j){var o=CUI.rte.WhitespaceProcessor;
var g=i.childNodes;
var m="";
var n=0;
var l=[];
for(var k=0;
k<g.length;
k++){var f=g[k];
if(f.nodeType==3){m+=f.nodeValue;
if(k==(g.length-1)){o.handleTextBlock(m,g,n,k,l,h)
}}else{if(n<k){o.handleTextBlock(m,g,n,k-1,l,h)
}n=k+1;
m="";
o.processStructure(e,f,a.isTag(f,a.EDITBLOCK_TAGS),j)
}}for(var d=0;
d<l.length;
d++){i.removeChild(l[d])
}},normalizeSuperStructural:function(e,i){var q=CUI.rte.WhitespaceProcessor;
var g=i.childNodes;
var j=g.length;
var n=[];
var f;
for(var l=1;
l<j;
l++){f=g[l];
if(!a.isTag(f,q.AS_IS_TAGS)){var p=g[l-1];
var k=a.getFirstTextChild(f,false,true);
var h=a.getLastTextChild(p,false,true);
if(k&&h){var o=k.nodeValue;
var m=h.nodeValue;
if(a.strStartsWith(o," ")&&a.strEndsWith(m," ")){if((f.nodeType==3)&&(p.nodeType==1)){m=q.normalizeWhitespace(m,false,true);
h.nodeValue=m;
if(m.length==0){n.push(h)
}}else{o=q.normalizeWhitespace(o,true,false);
k.nodeValue=o;
if(o.length==0){n.push(k)
}}}}}}for(var d=0;
d<n.length;
d++){f=n[d];
f.parentNode.removeChild(f)
}},handleTextNodesBetweenBlocks:function(e,i){var p=CUI.rte.WhitespaceProcessor;
var g=i.childNodes;
var j=g.length;
for(var l=j-1;
l>=0;
l--){var f=g[l];
if(f.nodeType==3){var n=f.nodeValue;
var k=n.replace(p.WHITESPACEONLY_REGEX,"");
var o=false;
var m=false;
var h=f.previousSibling;
if(h){o=a.isTag(h,a.BLOCK_TAGS)||a.isTag(h,a.EDITBLOCK_TAGS)
}var d=f.nextSibling;
if(d){m=a.isTag(d,a.BLOCK_TAGS)||a.isTag(d,a.EDITBLOCK_TAGS)
}if(o||m){if(k.length==0){i.removeChild(f)
}else{n=p.normalizeWhitespace(n,o,m);
if(n.length>0){f.nodeValue=n
}else{i.removeChild(f)
}}}}}},removeUnsupportedNodes:function(e,m,p){if(!p){return
}var i=m.childNodes;
var o=i.length;
var k=p.length;
for(var q=o-1;
q>=0;
q--){var h=i[q];
for(var d=0;
d<k;
d++){var s=p[d];
var g=false;
if((s.tagName!=null)&&a.isTag(h,s.tagName)){g=true
}else{if((s.namespace!=null)){var l=a.getNamespace(h);
if(l!=null){var u=s.namespace;
if(!CUI.rte.Utils.isArray(u)){u=[u]
}var f=u.length;
for(var j=0;
j<f;
j++){var t=u[j];
if((t=="*")||(l==t)){g=true;
break
}}}}else{if((s.nodeType!=null)&&(h.nodeType==s.nodeType)){g=true
}else{if((s.fn!=null)&&(s.fn(h))){g=true
}}}}if(g){if(!s.keepChildren){m.removeChild(h)
}else{var v=h.childNodes.length;
b.removeWithoutChildren(h);
if(v>0){q+=v
}}break
}}}},processStructure:function(e,g,f,c){var d=CUI.rte.WhitespaceProcessor;
if(a.isTag(g,d.AS_IS_TAGS)){return
}d.removeUnsupportedNodes(e,g,c);
if(a.isTag(g,d.NO_TEXT_TAGS)){d.handleNoTextStructure(e,g,c);
return
}d.cleanTextNodes(e,g,f,c);
d.normalizeSuperStructural(e,g);
d.handleTextNodesBetweenBlocks(e,g)
},process:function(f,h,c,d){var e=CUI.rte.WhitespaceProcessor;
if(!d){if(c!=null){c=a.arrayCopy(c);
a.arrayAdd(c,e.DEFAULT_REMOVAL_RULES)
}else{c=e.DEFAULT_REMOVAL_RULES
}}if(a.isTag(h,a.EDITBLOCK_TAGS)){e.processStructure(f,h,true,c)
}else{if(!a.isTag(h,e.AS_IS_TAGS)){if(h.nodeType==1){e.processStructure(f,h,true,c)
}else{if(h.nodeType==3){var g=h.nodeValue;
h.nodeValue=e.normalizeWhitespace(g,true,true)
}else{h.parentNode.removeChild(h)
}}}}},AS_IS_TAGS:["pre"],NO_TEXT_TAGS:["table","tbody","thead","tr","ul","ol"],WHITESPACE_REGEX:/[ \n\r\t]/g,MULTISPACE_REGEX:/ {2,}/g,WHITESPACEONLY_REGEX:/ /g,DEFAULT_REMOVAL_RULES:[{nodeType:8},{nodeType:7},{tagName:["meta","link","style","script"],keepChildren:false},{namespace:["st1"],keepChildren:true},{namespace:["*"]}]}
}();
CUI.rte.NodeList=new Class({toString:"NodeList",nodes:null,commonAncestor:null,nodesChanged:null,removeExistingStructuresOnSurround:false,construct:function(a){a=a||{};
CUI.rte.Utils.applyDefaults(a,{removeExistingStructuresOnSurround:true});
CUI.rte.Utils.apply(this,a);
this.nodes=[];
this.nodesChanged=[]
},addChildNode:function(a,c,b){a.parentNode=null;
a.nodeList=c;
if(!b||(b>=this.nodes.length)){this.nodes.push(a)
}else{this.nodes.splice(b,0,a)
}},removeChildNode:function(b){var a=this.getTopLevelNodeIndex(b);
if(a<0){return -1
}this.nodes.splice(a,1);
return a
},createTextNode:function(h,e,c,b){var d=CUI.rte.Common.getNodeCharacterCnt(h);
if(d>0){var g=0;
var a=d;
if(e!=null){g=e;
a-=e
}if(c!=null){a-=(d-c)
}if((g+a)>d){a=d-g
}var f=new CUI.rte.DomProcessor.TextNode(h,g,a);
if(!b){this.addChildNode(f,this)
}else{b.addChildNode(f,this)
}}},createStructuralNode:function(c,a){var b=new CUI.rte.DomProcessor.StructuralNode(c);
if(!a){this.addChildNode(b,this)
}else{a.addChildNode(b,this)
}return b
},createAncestors:function(c,f,m,o){var d=CUI.rte.Common;
var k=d.isOneCharacterNode(f)&&(m==0);
var e=!k;
var n=[];
if(f==this.commonAncestor){if(e){n.push(f)
}}else{do{if(e){n.push(f)
}else{e=true
}f=d.getParentNode(c,f)
}while(f&&(f!=this.commonAncestor))
}var j=null;
var l=n.length;
var g=null;
for(var b=l-1;
b>=0;
b--){var h;
if(b==(l-1)){for(h=0;
h<this.nodes.length;
h++){if(this.nodes[h].dom==n[b]){g=this.nodes[h];
break
}}}else{if(g){var a=null;
for(h=0;
h<g.childNodes.length;
h++){if(g.childNodes[h].dom==n[b]){a=g.childNodes[h];
break
}}g=a
}}if(!g){if(n[b].nodeType==1){j=this.createStructuralNode(n[b],j)
}else{if(n[b].nodeType==3){this.createTextNode(n[b],m,o,j)
}}}else{j=g
}}return{parentNode:j,isInitialNodeSkipped:k}
},createList:function(a,l){var d=CUI.rte.Common;
var c=l.startNode;
var h=l.endNode;
if(h==null){h=c
}var j=l.startOffset;
var m=null;
var i=l.startNode;
if(i.nodeType==3){if(c==h){if(l.endOffset!=null){m=l.endOffset+1
}else{m=l.startOffset
}}}var e=this.createAncestors(a,i,j,m);
var g=e.parentNode;
if(c==h){return
}var f=e.isInitialNodeSkipped;
var k=true;
while(true){var b=i.childNodes;
if(b.length>0){i=i.firstChild
}else{if(!(f&&k)){if((i.nodeType==1)&&g){g=g.parentNode
}}if(i.nextSibling){i=i.nextSibling
}else{while(true){i=d.getParentNode(a,i);
g=g.parentNode;
if(!i){break
}if(i.nextSibling){i=i.nextSibling;
break
}}}}k=false;
j=null;
m=null;
if(i==h){if(h.nodeType==3){m=l.endOffset+1
}}if(i.nodeType==1){g=this.createStructuralNode(i,g)
}else{if(i.nodeType==3){this.createTextNode(i,j,m,g)
}}if(i==h){break
}}},createFromDocument:function(b,c){var d=CUI.rte.DomProcessor;
var e=CUI.rte.Selection;
this.nodes.length=0;
if(!c.startNode){return c
}c={startNode:c.startNode,startOffset:c.startOffset,endNode:c.endNode,endOffset:c.endOffset,isEOT:c.isEOT};
if(e.shouldNormalizePSelForNodeList(b,c)){e.normalizeProcessingSelection(b,c)
}if(c.isEOT){var a=b.root.childNodes;
this.commonAncestor=a[a.length-1];
return c
}c=e.adaptToInclusiveEndNode(b,c);
if((c.startNode==c.endNode)||(c.endNode==null)){this.commonAncestor=c.startNode.parentNode
}else{this.commonAncestor=d.getCommonAncestor(b,c.startNode,c.endNode)
}if(!this.commonAncestor){throw new Error("No common ancestor found, cannot continue.")
}this.createList(b,c);
return c
},createDomChildren:function(e,a){var c=e.childNodes;
for(var b=0;
b<c.length;
b++){var f=c[b];
if(f.nodeType==1){var d=this.createStructuralNode(f,a);
this.createDomChildren(f,d)
}else{if(f.nodeType==3){this.createTextNode(f,null,null,a)
}}}},createFromDomNodes:function(d,a){var e=CUI.rte.DomProcessor;
this.commonAncestor=a[0];
var b=a.length;
for(var c=1;
c<b;
c++){if(!CUI.rte.Common.isAncestor(d,this.commonAncestor,a[c])){this.commonAncestor=e.getCommonAncestor(d,this.commonAncestor,a[c])
}}if(!this.commonAncestor){throw new Error("No common ancestor found, cannot continue.")
}for(c=0;
c<b;
c++){var g=a[c];
var f=this.createAncestors(d,g,null,null);
this.createDomChildren(g,f.parentNode)
}},removeEmptySideStructures:function(){var d=CUI.rte.Common;
if(this.nodes.length>0){var b=this.nodes[0];
if(b.isEmptySideStructure()){this.nodes.splice(0,1)
}if(this.nodes.length>0){var h=this.nodes.length-1;
b=this.nodes[h];
if(b.isEmptySideStructure()){this.nodes.splice(h,1)
}}while(this.nodes.length==1){var g=this.nodes[0];
if(!d.isCharacterNode(g.dom)){this.commonAncestor=g.dom;
this.nodes.length=0;
if(g.childNodes){var e=g.childNodes.length;
for(var f=0;
f<e;
f++){var a=g.childNodes[f];
a.parentNode=null;
this.nodes.push(a)
}}}else{break
}}}},hasContainers:function(){var b=this.nodes.length;
for(var c=0;
c<b;
c++){var a=this.nodes[c];
if(a.hasContainers()){return true
}}return false
},isAligned:function(c){if(!c){c=function(e){return e.isAligned()
}
}var b=this.nodes.length;
for(var d=0;
d<b;
d++){var a=this.nodes[d];
if(!c(a)){return false
}}return true
},getEditBlocksByAuxRoots:function(c,j){var e=CUI.rte.Common;
var l=CUI.rte.DomProcessor;
var m=this.nodes.length;
var k,o;
var i=[];
var h=null;
for(var g=0;
g<m;
g++){this.nodes[g].execRecursively(function(n){var p=n.dom;
if(e.isTag(p,l.AUXILIARY_ROOT_TAGS)){o=[];
i.push(o);
o.push(p);
h=p
}else{if(e.isTag(p,e.EDITBLOCK_TAGS)){var b=l.getAuxRootNode(c,p);
if(b!=h){o=[];
i.push(o);
h=b
}o.push(p)
}}})
}if((i.length==0)&&j){var d=this.commonAncestor;
while(d){if(e.isTag(d,e.EDITBLOCK_TAGS)){i.push([d]);
break
}d=e.getParentNode(c,d)
}}for(k=i.length-1;
k>=0;
k--){var a=i[k];
var f=a.length;
if(f==0){i.splice(k,1)
}else{if(e.isTag(a[0],l.AUXILIARY_ROOT_TAGS)){if(f>1){a.splice(0,1)
}else{if(l.hasEditBlocks(a[0])){i.splice(k,1)
}}}}}return i
},normalize:function(){var e=[];
var d=this.nodes.length;
for(var f=0;
f<d;
f++){this.nodes[f].normalize(this,e)
}var a=e.length;
for(var b=0;
b<a;
b++){this.remove(e[b])
}},createTopLevelDomNodes:function(){var a=[];
var b=this.nodes.length;
for(var c=0;
c<b;
c++){a.push(this.nodes[c].dom)
}return a
},getTopLevelNodeIndex:function(c){var b=this.nodes.length;
for(var d=0;
d<b;
d++){var a=this.nodes[d];
if(a==c){return d
}}return -1
},surround:function(c,u,j){var a=CUI.rte.DomProcessor;
var f=CUI.rte.Common;
var m=CUI.rte.Selection;
this.removeEmptySideStructures();
this.nodesChanged.length=0;
var q,n;
var i=[];
this.normalize();
var p=true;
if(this.isAligned()&&!this.hasContainers()){var o=a.restructureAsChild(c,this.commonAncestor,this.createTopLevelDomNodes(),u,j);
var e=this.nodes;
this.nodes=[];
var h=this.createStructuralNode(o,null);
this.nodes.push(h);
q=e.length;
for(n=0;
n<q;
n++){h.addChildNode(e[n],this)
}this.nodesChanged.push(o);
p=false;
i.push(o)
}if(p){q=this.nodes.length;
var g=null;
for(n=0;
n<q;
n++){var l=this.nodes[n];
g=l.surround(c,g,u,j,i)
}}if(this.nodesChanged.length>0){var s=this.nodesChanged[0];
var k=this.nodesChanged[this.nodesChanged.length-1];
if(s==k){k=f.getLastChild(s)
}var t=a.removeDuplicateStructures(c,s,k);
a.joinIdenticalStructures(c,t.startNode,true);
a.joinIdenticalStructures(c,t.endNode,false);
if(p){if(t.cellSelection&&t.cellSelection.cells){this.createFromDomNodes(c,t.cellSelection.cells)
}else{var b=function(w,v){var x=null;
if(f.isOneCharacterNode(w)){x=(v?null:0)
}else{if(w.nodeType==3){x=(v?0:w.nodeValue.length)
}else{if(w.nodeType==1){var y=f.getFirstTextChild(w,true);
if(y){w=y;
x=(v?m.getFirstSelectionOffset(c,y):m.getLastSelectionOffset(c,y,true))
}}}}return{node:w,offset:x}
};
var d=b(t.startNode,true);
t.startNode=d.node;
t.startOffset=d.offset;
var r=b(t.endNode,false);
t.endNode=r.node;
t.endOffset=r.offset;
this.createFromDocument(c,t)
}}}return i
},removeUnnecessaryLinebreaks:function(b,m){var c;
var j=CUI.rte.DomProcessor;
var d=CUI.rte.Common;
if(m){var f=this.commonAncestor;
while(f){if(f.nodeType==1){if(d.isRootNode(b,f)){break
}if(j.getTagType(f)==j.CONTAINER){c=f;
break
}}f=d.getParentNode(b,f)
}}var k=this.nodes.length;
var l=[];
for(var e=0;
e<k;
e++){var g=this.nodes[e];
if(g.nodeType==j.DOM_NODE){g.getUnnecessaryLinebreaks(c,l)
}}var n=l.length;
for(var a=0;
a<n;
a++){var h=l[a];
var i=h.parentNode;
i=(i?i:this);
j.removeWithoutChildren(h.dom);
i.removeChildNode(h)
}},getByDomRec:function(d,e){if(d.dom==e){return d
}if(d.childNodes){var b=d.childNodes.length;
for(var f=0;
f<b;
f++){var a=this.getByDomRec(d.childNodes[f],e);
if(a){return a
}}}return null
},getByDom:function(e,d){var c=this.nodes.length;
for(var f=0;
f<c;
f++){var a=this.nodes[f];
if(a.dom==e){return a
}if(d){var b=this.getByDomRec(a,e);
if(b){return b
}}}return null
},contains:function(b,a){return(this.getByDom(b,a)!=null)
},isolateNode:function(b,d,h){var a=CUI.rte.Common;
var e=a.getChildIndex(b);
var i=b.parentNode;
var j,g;
for(g=0;
g<e;
g++){j=i.childNodes[0];
i.removeChild(j);
d.appendChild(j)
}var f=i.childNodes.length;
for(g=f-1;
g>=1;
g--){j=i.childNodes[g];
i.removeChild(j);
h.insertBefore(j,h.firstChild)
}},handleAlignment:function(e,b){var f=b[0];
var a=b[1];
var d=b[2];
CUI.rte.NodeList.moveToAdjacentParents(this.nodes,f,a,d);
var g=this.nodes.length;
for(var h=0;
h<g;
h++){this.nodes[h].split(e,a,d)
}},removeNodesByTag:function(f,r,e,p){var n=CUI.rte.DomProcessor;
var g=CUI.rte.Common;
this.normalize();
var m,l;
var o=null;
if(p){var h=this.commonAncestor;
var q=[];
var k,j,d,b;
while(h){var a=g.getParentNode(f,h);
if(h.nodeType==1){if(n.getTagType(h)==n.CONTAINER){break
}if(g.isTag(h,r)&&(!e||g.hasAttributes(h,e))){o=h.parentNode;
d=h.cloneNode(false);
o.insertBefore(d,h);
b=h.cloneNode(false);
o.insertBefore(b,h.nextSibling);
o=h;
while(q.length>0){o=q.pop();
this.isolateNode(o,d,b);
k=o.cloneNode(false);
d.appendChild(k);
d=k;
j=o.cloneNode(false);
b.insertBefore(j,b.firstChild);
b=j
}this.handleAlignment(f,[o,d,b]);
g.removeNodesWithoutContent(f,d);
g.removeNodesWithoutContent(f,b);
n.removeWithoutChildren(h);
break
}q.push(h)
}h=a
}}l=this.nodes.length;
for(m=l-1;
m>=0;
m--){var i=this.nodes[m];
if(i.nodeType==n.DOM_NODE){i.removeNodesByTag(f,r,e,this)
}}},remove:function(e){var c=this.getTopLevelNodeIndex(e);
if(c<0){e.parentNode.removeChild(e);
return
}if(!e.isInvalidatedByNormalization){CUI.rte.DomProcessor.removeWithoutChildren(e.dom)
}this.nodes.splice(c,1);
if(e.childNodes){var b=e.childNodes;
var d=b.length;
for(var f=0;
f<d;
f++){var a=b[f];
a.parentNode=this;
this.nodes.splice(c+f,0,a)
}}},getAnchors:function(c,a,b){var d=CUI.rte.Common;
if(b){var f=this.commonAncestor;
while(f){if(f.nodeType==1){if(d.isRootNode(c,f)){break
}var i=f.tagName.toLowerCase();
if(i=="a"){if(d.isAttribDefined(f,"href")){var g={dom:f,href:d.getAttribute(f,d.HREF_ATTRIB)||d.getAttribute(f,"href")};
if(f.className){g.cssClass=f.className
}if(f.target){g.target=f.target
}a.push(g)
}}}f=d.getParentNode(c,f)
}}var j=this.nodes.length;
for(var e=0;
e<j;
e++){var h=this.nodes[e];
if(h.nodeType==CUI.rte.DomProcessor.DOM_NODE){h.getAnchors(a)
}}},getNamedAnchors:function(b,c,a){var d=CUI.rte.Common;
if(a){var f=this.commonAncestor;
while(f){if(f.nodeType==1){if(d.isRootNode(b,f)){break
}var h=CUI.rte.DomProcessor.checkNamedAnchor(f);
if(h){c.push(h)
}}f=d.getParentNode(b,f)
}}var i=this.nodes.length;
for(var e=0;
e<i;
e++){var g=this.nodes[e];
if(g.nodeType==CUI.rte.DomProcessor.DOM_NODE){g.getNamedAnchors(c)
}}},getStyles:function(c,a,b){var d=CUI.rte.Common;
var m=a.styles;
if(!m){m=[];
a.styles=m
}var n=false;
if(b){var f=this.commonAncestor;
while(f){if(f.nodeType==1){if(d.isRootNode(c,f)){break
}var h=f.tagName.toLowerCase();
if(h=="span"){if(f.className){n=true;
m.push({dom:f,className:f.className})
}}}f=d.getParentNode(c,f)
}}var i=null;
var l=false;
var k=this.nodes.length;
for(var e=0;
e<k;
e++){var g=this.nodes[e];
if(g.nodeType==CUI.rte.DomProcessor.DOM_NODE){var j=g.getStyles(m);
i=CUI.rte.NodeList.calcNewContState(i,j)
}else{l=true
}}if(i==null){i="unstyled"
}a.isContinuousStyle=(n&&(i=="unstyled"))||(!n&&(i=="single")&&!l)
},containsTag:function(c){c=c.toLowerCase();
var b=this.nodes.length;
for(var d=0;
d<b;
d++){var a=this.nodes[d];
if(a.nodeType==CUI.rte.DomProcessor.DOM_NODE){if(a.containsTag(c)){return true
}}}return false
},executeMatcherOnDom:function(h,e){var c=CUI.rte.Common;
var d=false;
var b=e.length;
for(var g=0;
g<b;
g++){var f=e[g];
if(f.extMatcher){var a=f.extMatcher(h);
if(a.isMatching){d=true;
break
}}else{if(f.matcher){if(f.matcher(h)){d=true;
break
}}else{if(c.matchesTagDef(h,f)){d=true;
break
}}}}return d
},getTags:function(b,d,a,g){var h=CUI.rte.DomProcessor;
var c=CUI.rte.Common;
var j=[];
var i=this.nodes.length;
for(var e=0;
e<i;
e++){if(this.nodes[e].nodeType==h.DOM_NODE){this.nodes[e].getTags(d,j)
}}if(g&&(j.length>0)){if(this.executeMatcherOnDom(this.commonAncestor,d)){j.splice(0,0,{nodeType:null,isAncestor:true,dom:this.commonAncestor})
}return j
}if(a){var f=this.commonAncestor;
while(f){if(this.executeMatcherOnDom(f,d)){j.splice(0,0,{nodeType:null,isAncestor:true,dom:f});
if(g){return j
}}f=c.getParentNode(b,f)
}}return j
},hasContent:function(){var a=this.nodes.length;
for(var b=0;
b<a;
b++){if(this.nodes[b].nodeType==CUI.rte.DomProcessor.TEXT_NODE){return true
}else{if(this.nodes[b].hasContent()){return true
}}}return false
},hasCharacterNodes:function(){var a=this.nodes.length;
for(var b=0;
b<a;
b++){if(this.nodes[b].hasCharacterNodes()){return true
}}return false
},getFirstNode:function(){if(this.nodes.length==0){return null
}var a=this.nodes[0];
while(a.nodeType==CUI.rte.DomProcessor.DOM_NODE){if(!a.childNodes||(a.childNodes.length==0)){break
}a=a.childNodes[0]
}return a
},getLastNode:function(){var a=this.nodes.length;
if(a==0){return null
}var c=this.nodes[a-1];
while(c.nodeType==CUI.rte.DomProcessor.DOM_NODE){if(!c.childNodes){break
}var b=c.childNodes.length;
if(b==0){break
}c=c.childNodes[b-1]
}return c
},createDump:function(){var b=this.nodes.length;
var d="---";
if(this.commonAncestor.nodeType==1){d=this.commonAncestor.tagName
}else{d=this.commonAncestor.nodeValue
}var c="Common ancestor: "+d+"\n";
c+="Nodes in list: "+b+"\n";
for(var e=0;
e<b;
e++){var a=this.nodes[e];
c+=a.createDump()+"\n"
}return c
}});
CUI.rte.NodeList.calcNewContState=function(b,a){if(b==null){b=a
}else{if(b=="single"){if((a=="single")||(a=="multiple")){b="multiple"
}}else{if(b=="unstyled"){b=a
}}}return b
};
CUI.rte.NodeList.moveToAdjacentParents=function(d,e,f,a){var h=true;
var g=false;
var l=e.childNodes;
var k=d[0].dom;
var b=d[d.length-1].dom;
for(var i=l.length-1;
i>=0;
i--){var j=l[i];
if(h){if(j==b){h=false;
g=true
}else{e.removeChild(j);
a.insertBefore(j,a.firstChild)
}}if(g){if(j==k){g=false
}}else{if(!h){e.removeChild(j);
f.insertBefore(j,f.firstChild)
}}}};
CUI.rte.DomProcessor.TextNode=new Class({toString:"TextNode",nodeType:CUI.rte.DomProcessor.TEXT_NODE,nodeList:null,parentNode:null,dom:null,startPos:0,charCnt:0,nodeLength:0,isInvalidatedByNormalization:false,construct:function(c,b,a){this.dom=c;
this.startPos=b;
this.charCnt=a;
this.nodeLength=CUI.rte.Common.getNodeCharacterCnt(c)
},execRecursively:function(a){a(this)
},isStartAligned:function(){return(this.startPos==0)
},isEndAligned:function(){return((this.startPos+this.charCnt)==this.nodeLength)
},isAligned:function(){return this.isStartAligned()&&this.isEndAligned()
},hasAdjacentContent:function(){return false
},hasContainers:function(){return false
},getActualTextContent:function(){var a=this.dom.nodeValue;
if(this.startPos>=this.nodeLength){return""
}return a.substring(this.startPos,this.startPos+this.charCnt)
},getExcludedTextContent:function(){var a=this.dom.nodeValue;
if(this.startPos==0){return a.substring(this.charCnt)
}return a.substring(0,this.startPos)
},hasCharacterNodes:function(){return true
},isEmptySideStructure:function(){return(this.charCnt==0)
},normalize:function(c,e){if(this.isInvalidatedByNormalization){return
}var d;
while(true){var b=this.dom.previousSibling;
if(!b||(b.nodeType!=3)){break
}this.dom.nodeValue=b.nodeValue+this.dom.nodeValue;
this.startPos+=b.nodeValue.length;
d=c.getByDom(b,true);
if(d){if(this.startPos!=0){throw new Error("Trying to mormalize something that can't be normalized.")
}this.startPos-=d.charCnt;
this.charCnt+=d.charCnt;
d.isInvalidatedByNormalization=true;
e.push(d)
}b.parentNode.removeChild(b);
this.nodeLength=this.dom.nodeValue.length
}while(true){var a=this.dom.nextSibling;
if(!a||(a.nodeType!=3)){break
}this.dom.nodeValue+=a.nodeValue;
d=c.getByDom(a,true);
if(d){if((this.startPos+this.charCnt)<this.nodeLength){throw new Error("Trying to mormalize something that can't be normalized.")
}this.charCnt+=d.charCnt;
d.isInvalidatedByNormalization=true;
e.push(d)
}a.parentNode.removeChild(a);
this.nodeLength=this.dom.nodeValue.length
}},surround:function(a,i,b,d,h){var c=this.dom;
var e=0;
var g=[];
if(!this.isStartAligned()){g.push(this.startPos);
e=1
}if(!this.isEndAligned()){g.push(this.startPos+this.charCnt)
}if(g.length>0){var f=CUI.rte.DomProcessor.splitTextNode(a,this.dom,g);
c=f[e]
}if(i!=null){c.parentNode.removeChild(c);
i.appendChild(c)
}else{i=CUI.rte.DomProcessor.insertAsParent(a,c,b,d);
h.push(i);
this.nodeList.nodesChanged.push(i)
}this.dom=c;
this.nodeList.nodesChanged.push(c);
return i
},createNewTextNode:function(a){return a.createTextNode(this.getActualTextContent())
},split:function(b,d,e){var a=CUI.rte.Common;
var c=this.dom.nodeValue;
if(!this.isAligned()){this.dom.nodeValue=c.substring(this.startPos,this.startPos+this.charCnt);
var f;
if(!this.isStartAligned()){f=b.createTextNode(c.substring(0,this.startPos));
a.addTextNode(f,d)
}if(!this.isEndAligned()){f=b.createTextNode(c.substring(this.startPos+this.charCnt,c.length));
a.addTextNode(f,e,e.firstChild)
}this.startPos=0;
this.charCnt=this.dom.nodeValue.length
}},createDump:function(){var b;
var a=this.dom.nodeValue;
if(this.charCnt==0){if(this.startPos<(a.length-1)){b="("+a.substring(this.startPos,this.startPos+1)+")"
}else{b="(behind text)"
}}else{b=a.substring(this.startPos,this.startPos+this.charCnt)
}b=b.replace(/ /g,"*");
return"Text node (s:"+this.startPos+"/l:"+this.charCnt+"/tl:"+this.nodeLength+"): "+b
}});
CUI.rte.DomProcessor.StructuralNode=new Class({toString:"DomProcessor.StructuralNode",nodeType:CUI.rte.DomProcessor.DOM_NODE,parentNode:null,tagName:null,dom:null,nodeList:null,type:null,childNodes:null,isInvalidatedByNormalization:false,construct:function(a){this.dom=a;
this.tagName=a.tagName.toLowerCase();
this.type=CUI.rte.DomProcessor.getTagType(a)
},execRecursively:function(a){var d=a(this);
if(this.childNodes&&(d!==true)){var b=this.childNodes.length;
for(var e=0;
e<b;
e++){this.childNodes[e].execRecursively(a)
}}},addChildNode:function(a,c,b){if(!this.childNodes){this.childNodes=[]
}a.parentNode=this;
a.nodeList=c;
if(!b||(b>=this.childNodes.length)){this.childNodes.push(a)
}else{this.childNodes.splice(b,0,a)
}},removeChildNode:function(a){var b=this.getChildIndex(a);
if(b<0){return -1
}this.childNodes.splice(b,1);
if(this.childNodes.length==0){this.childNodes=null
}return b
},isStartAligned:function(){if(this.childNodes==null){return true
}var c=this.childNodes.length;
for(var d=0;
d<c;
d++){var b=this.childNodes[d];
var a=b.isStartAligned();
if(!a){return false
}}return true
},isEndAligned:function(){if(this.childNodes==null){return true
}var c=this.childNodes.length;
for(var d=0;
d<c;
d++){var b=this.childNodes[d];
var a=b.isEndAligned();
if(!a){return false
}}return true
},isAligned:function(){if(this.childNodes==null){return true
}var c=this.childNodes.length;
for(var d=0;
d<c;
d++){var b=this.childNodes[d];
var a=b.isAligned();
if(!a){return false
}}return true
},hasAdjacentContent:function(a){if(this.childNodes==null){return false
}var b=(a?this.dom.firstChild:this.dom.lastChild);
if(!this.getChildNodeForDom(b)){return true
}var c=this.childNodes.length;
return this.childNodes[a?0:c-1].hasAdjacentContent(a)
},hasContainers:function(e){var c=CUI.rte.DomProcessor;
var a;
if(this.type==c.DYNAMIC){a=true;
if(c.TYPE_TABLE.hasOwnProperty(this.tagName)){var d=c.TYPE_TABLE[this.tagName];
if(d&&d.getDynamicType){a=(d.getDynamicType(this.dom)==c.CONTAINER)
}}}else{a=(this.type==c.CONTAINER)
}if((e!==true)&&a){return true
}if(this.childNodes!=null){var b=this.childNodes.length;
for(var f=0;
f<b;
f++){if(this.childNodes[f].hasContainers()){return true
}}}return false
},containsTag:function(b){if(this.tagName==b){return true
}if(this.childNodes){var c=this.childNodes.length;
for(var d=0;
d<c;
d++){var a=this.childNodes[d];
if(a.nodeType==CUI.rte.DomProcessor.DOM_NODE){if(a.containsTag(b)){return true
}}}}return false
},getTags:function(e,k){var i=CUI.rte.DomProcessor;
var c=CUI.rte.Common;
var d=e.length;
var a=false;
for(var b=0;
b<d;
b++){var g=e[b];
if(g.extMatcher){var j=g.extMatcher(this.dom);
if(j.isMatching){k.push(this);
a=j.preventRecursionIfMatching;
break
}if(j.preventRecursion===true){a=true
}}else{if(g.matcher){if(g.matcher(this.dom)){k.push(this);
break
}}else{if(c.matchesTagDef(this.dom,g)){k.push(this);
break
}}}}if(this.childNodes&&!a){var h=this.childNodes.length;
for(var f=0;
f<h;
f++){if(this.childNodes[f].nodeType==i.DOM_NODE){this.childNodes[f].getTags(e,k)
}}}return k
},normalize:function(a,d){if(this.childNodes){var b=this.childNodes.length;
for(var e=0;
e<b;
e++){this.childNodes[e].normalize(a,d)
}}},hasContent:function(){if(!this.childNodes){return false
}var b=this.childNodes.length;
for(var c=0;
c<b;
c++){var a=this.childNodes[c];
if(a.nodeType==CUI.rte.DomProcessor.TEXT_NODE){return true
}else{if(a.hasContent()){return true
}}}return false
},hasCharacterNodes:function(){var a=CUI.rte.Common;
if(a.isCharacterNode(this.dom)){return true
}if(this.childNodes!=null){var b=this.childNodes.length;
for(var d=0;
d<b;
d++){if(this.childNodes[d].hasCharacterNodes()){return true
}}}},isEmptySideStructure:function(d){var a=CUI.rte.Common;
if(!d){if(a.isCharacterNode(this.dom)){return false
}if(a.isEmptyEditingBlock(this.dom)){return false
}}if(this.childNodes!=null){var b=this.childNodes.length;
for(var e=0;
e<b;
e++){if(!this.childNodes[e].isEmptySideStructure()){return false
}}}return true
},getAnchors:function(e){var a=CUI.rte.Common;
if((this.tagName=="a")&&!this.isEmptySideStructure(true)){if(a.isAttribDefined(this.dom,"href")){var b={dom:this.dom,href:a.getAttribute(this.dom,a.HREF_ATTRIB)||a.getAttribute(this.dom,"href")};
if(this.dom.target){b.target=this.dom.target
}e.push(b)
}}if(this.childNodes!=null){var d=this.childNodes.length;
for(var f=0;
f<d;
f++){var c=this.childNodes[f];
if(c.nodeType==CUI.rte.DomProcessor.DOM_NODE){c.getAnchors(e)
}}}},getNamedAnchors:function(d){var a=CUI.rte.DomProcessor.checkNamedAnchor(this.dom);
if(a){d.push(a)
}if(this.childNodes!=null){var c=this.childNodes.length;
for(var e=0;
e<c;
e++){var b=this.childNodes[e];
if(b.nodeType==CUI.rte.DomProcessor.DOM_NODE){b.getNamedAnchors(d)
}}}},getStyles:function(g){var d="unstyled";
if(this.tagName=="span"){if(this.dom.className){g.push({dom:this.dom,className:this.dom.className});
d="single"
}}if(this.childNodes!=null){var c=false;
var e=null;
var f=this.childNodes.length;
for(var h=0;
h<f;
h++){var b=this.childNodes[h];
if(b.nodeType==CUI.rte.DomProcessor.DOM_NODE){var a=b.getStyles(g);
e=CUI.rte.NodeList.calcNewContState(e,a)
}else{c=true
}}if(e==null){e="unstyled"
}if(d=="unstyled"){if(e!="unstyled"){d=(c?"multiple":e)
}}else{d=(e=="unstyled"?d:"multiple")
}}return d
},createChildDomNodes:function(){var a=[];
if(this.childNodes==null){return a
}var b=this.childNodes.length;
for(var c=0;
c<b;
c++){a.push(this.childNodes[c].dom)
}return a
},addChangedNodes:function(a){this.nodeList.nodesChanged.push(a);
if(a.nodeType==1){var b=a.childNodes.length;
for(var c=0;
c<b;
c++){this.addChangedNodes(a.childNodes[c])
}}},surroundStructure:function(d,h,i,b,f,e){var g=CUI.rte.DomProcessor;
var a=true;
if(e&&e.isApplicable){a=e.isApplicable(this.dom,i,b)
}if(!a){return null
}if(this.isAligned()){if(h!=null){this.dom.parentNode.removeChild(this.dom);
h.appendChild(this.dom);
this.nodeList.nodesChanged.push(this.dom)
}else{h=g.insertAsParent(d,this.dom,i,b);
f.push(h);
this.nodeList.nodesChanged.push(h);
this.nodeList.nodesChanged.push(this.dom)
}}else{var c;
if(!this.isStartAligned()){c=this.processLeftSubtree(d);
h=g.createNode(d,i,b);
f.push(h);
h.appendChild(c);
this.dom.parentNode.insertBefore(h,this.dom.nextSibling);
this.addChangedNodes(h)
}if(!this.isEndAligned()){c=this.processRightSubtree(d);
h.appendChild(c);
this.addChangedNodes(c)
}}return h
},surroundContainer:function(c,k,m,b,i,d){var j=CUI.rte.DomProcessor;
var a=true;
if(d&&d.isApplicable){a=d.isApplicable(this.dom,m,b)
}if(!a){return null
}if(this.childNodes==null){return k
}if(this.isAligned()){if(!this.hasContainers(true)){var l=this.createChildDomNodes();
var f=j.restructureAsChild(c,this.dom,l,m,b);
i.push(f);
this.addChangedNodes(f)
}else{if(this.childNodes!=null){var h=this.childNodes.length;
for(var e=0;
e<h;
e++){var g=this.childNodes[e];
g.surround(c,k,m,b,i)
}}}}else{k=j.createNode(c,m,b);
i.push(k);
if(!this.isStartAligned()){this.processLeftContainerSubtree(c,k,true);
this.dom.appendChild(k)
}if(!this.isEndAligned()){this.processRightContainerSubtree(c,k,true);
this.dom.insertBefore(k,this.dom.firstChild)
}this.addChangedNodes(k)
}return null
},surround:function(c,l,n,a,j){var k=CUI.rte.DomProcessor;
switch(this.type){case k.STRUCTURE:l=this.surroundStructure(c,l,n,a,j);
break;
case k.CONTAINER:l=this.surroundContainer(c,l,n,a,j);
break;
case k.DYNAMIC:var e=null;
var i=this.tagName;
var m=k.TYPE_TABLE;
if(m.hasOwnProperty(i)){var g=m[i];
if(typeof(g)=="object"){e=g
}}var b=true;
if(e&&e.getDynamicType){b=(e.getDynamicType(this.dom)==k.CONTAINER)
}if(b){l=this.surroundContainer(c,l,n,a,j,e)
}else{l=this.surroundStructure(c,l,n,a,j,e)
}break;
case k.IGNORE:if(this.childNodes){var h=this.childNodes.length;
for(var f=0;
f<h;
f++){var d=this.childNodes[f];
if(d.nodeType==k.DOM_NODE){l=d.surround(c,l,n,a,j)
}}}break
}return l
},processLeftSubtree:function(b,i){var n=CUI.rte.DomProcessor;
var c=CUI.rte.Common;
var o=this.dom.cloneNode(false);
if(!i){i=o
}else{i.appendChild(o)
}if(this.childNodes==null){return i
}var k=this.childNodes.length;
for(var h=0;
h<k;
h++){var j=this.childNodes[h];
var g=j.nodeType;
if(g==n.DOM_NODE){var f=j.dom;
if(c.isOneCharacterNode(f)){if(j.isAligned()){f.parentNode.removeChild(f);
o.appendChild(f)
}}else{j.processLeftSubtree(b,o)
}}else{if(g==n.TEXT_NODE){var m=j.dom;
if(j.isAligned()){var d=m.parentNode;
d.removeChild(m);
c.removeNodesWithoutContent(b,d);
c.addTextNode(m,o)
}else{o.appendChild(j.createNewTextNode(b));
var a=m.parentNode;
var l=m.nextSibling;
a.removeChild(m);
if(j.startPos>0){var e=j.getExcludedTextContent();
c.addTextNode(b.createTextNode(e),a,l)
}else{c.removeNodesWithoutContent(b,a)
}}}}}return i
},processRightSubtree:function(b,j){var o=CUI.rte.DomProcessor;
var c=CUI.rte.Common;
var p=this.dom.cloneNode(false);
if(!j){j=p
}else{j.appendChild(p)
}if(this.childNodes==null){return j
}var l=this.childNodes.length;
for(var i=0;
i<l;
i++){var k=this.childNodes[i];
var h=k.nodeType;
if(h==o.DOM_NODE){var g=k.dom;
if(c.isOneCharacterNode(g)){if(k.isAligned()){g.parentNode.removeChild(g);
p.appendChild(g)
}}else{k.processRightSubtree(b,p)
}}else{if(h==o.TEXT_NODE){var n=k.dom;
if(k.isAligned()){var d=n.parentNode;
d.removeChild(n);
c.removeNodesWithoutContent(b,d);
c.addTextNode(n,p)
}else{p.appendChild(k.createNewTextNode(b));
var a=n.parentNode;
var m=n.nextSibling;
a.removeChild(n);
var e=k.startPos+k.charCnt;
if(e<k.nodeLength){var f=k.getExcludedTextContent();
c.addTextNode(b.createTextNode(f),a,m)
}else{c.removeNodesWithoutContent(b,a)
}}}}}return j
},processLeftContainerSubtree:function(b,j,f){var o=CUI.rte.DomProcessor;
var c=CUI.rte.Common;
var e;
if(!f){if(this.isAligned()){this.dom.parentNode.removeChild(this.dom);
j.appendChild(this.dom);
return
}e=this.dom.cloneNode(false);
j.appendChild(e)
}else{e=j
}var l=this.childNodes.length;
for(var i=0;
i<l;
i++){var k=this.childNodes[i];
var h=k.nodeType;
if(h==o.DOM_NODE){k.processLeftContainerSubtree(b,e)
}else{if(h==o.TEXT_NODE){var n=k.dom;
if(k.isAligned()){var d=n.parentNode;
d.removeChild(n);
c.removeNodesWithoutContent(b,d);
c.addTextNode(n,e)
}else{e.appendChild(k.createNewTextNode(b));
var a=n.parentNode;
var m=n.nextSibling;
a.removeChild(n);
if(k.startPos>0){var g=n.nodeValue.substring(0,k.startPos);
c.addTextNode(b.createTextNode(g),a,m)
}else{c.removeNodesWithoutContent(b,a)
}}}}}},processRightContainerSubtree:function(b,k,g){var o=CUI.rte.DomProcessor;
var c=CUI.rte.Common;
var e;
if(!g){if(this.isAligned()){this.dom.parentNode.removeChild(this.dom);
k.appendChild(this.dom);
return
}e=this.dom.cloneNode(false);
k.appendChild(e)
}else{e=k
}var m=this.childNodes.length;
for(var j=0;
j<m;
j++){var l=this.childNodes[j];
var i=l.nodeType;
if(i==o.DOM_NODE){l.processRightContainerSubtree(b,e)
}else{if(i==o.TEXT_NODE){var n=l.dom;
if(l.isAligned()){var d=n.parentNode;
d.removeChild(n);
c.removeNodesWithoutContent(b,d);
c.addTextNode(n,e)
}else{e.appendChild(l.createNewTextNode(b));
var a=n.parentNode;
a.removeChild(n);
var f=l.startPos+l.charCnt;
if(f<l.nodeLength){var h=n.nodeValue.substring(f,l.nodeLength);
c.addTextNode(b.createTextNode(h),a,a.firstChild)
}else{c.removeNodesWithoutContent(b,a)
}}}}}},matches:function(a,c){var b=CUI.rte.Common;
if(b.isTag(this.dom,a)){if(!c||b.hasAttributes(this.dom,c)){return true
}}return false
},removeNodesByTag:function(b,j,a,e){var i=CUI.rte.DomProcessor;
if(this.childNodes){var g=this.childNodes.length;
for(var h=g-1;
h>=0;
h--){var f=this.childNodes[h];
if(f.nodeType==i.DOM_NODE){f.removeNodesByTag(b,j,a,e)
}}}if(this.matches(j,a)){var d;
if(!this.isStartAligned()){if(this.type==i.STRUCTURE){d=this.processLeftSubtree(b);
if(d){this.dom.parentNode.insertBefore(d,this.dom.nextSibling);
this.dom=d
}}}if(!this.isEndAligned()){if(this.type==i.STRUCTURE){d=this.processRightSubtree(b);
if(d){this.dom.parentNode.insertBefore(d,this.dom);
this.dom=d
}}}e.remove(this)
}},getUnnecessaryLinebreaks:function(b,a){var f=CUI.rte.DomProcessor;
var c=CUI.rte.Common;
if(this.tagName=="br"){if(b){if(c.getLastChild(b)==this.dom){a.push(this)
}}}else{if(this.type==f.CONTAINER){b=this.dom
}}if(this.childNodes){var e=this.childNodes.length;
for(var g=0;
g<e;
g++){var d=this.childNodes[g];
if(d.nodeType==f.DOM_NODE){d.getUnnecessaryLinebreaks(b,a)
}}}},getChildIndex:function(c){if(!this.childNodes){return -1
}var b=this.childNodes.length;
for(var d=0;
d<b;
d++){var a=this.childNodes[d];
if(a==c){return d
}}return -1
},getChildNodeForDom:function(b){if(this.childNodes){var a=this.childNodes.length;
for(var e=0;
e<a;
e++){var d=this.childNodes[e];
if(d.dom==b){return d
}}}return undefined
},removeChild:function(d){var f,e;
if(this.childNodes){var c=this.getChildIndex(d);
if(c>=0){if(!d.isInvalidatedByNormalization){CUI.rte.DomProcessor.removeWithoutChildren(d.dom)
}this.childNodes.splice(c,1);
if(d.childNodes){var b=d.childNodes;
e=b.length;
for(f=0;
f<e;
f++){var a=b[f];
a.parentNode=this;
this.childNodes.splice(c+f,0,a)
}}}}},split:function(a,e,l){var i=this.hasAdjacentContent(true);
var m=this.hasAdjacentContent(false);
var b=this.isStartAligned();
var g=this.isEndAligned();
var j=b&&g&&!(i||m);
if(!j&&this.childNodes){var h;
if(!this.isStartAligned()||i){h=this.dom.cloneNode(false);
e.appendChild(h);
e=h
}if(!this.isEndAligned()||m){h=this.dom.cloneNode(false);
l.insertBefore(h,l.firstChild);
l=h
}CUI.rte.NodeList.moveToAdjacentParents(this.childNodes,this.dom,e,l);
var f=this.childNodes.length;
for(var k=0;
k<f;
k++){var d=this.childNodes[k];
d.split(a,e,l)
}}},createDump:function(a){if(!this.childNodes){return"DOM node; tag name: "+this.tagName
}else{var b="";
if(a){for(var c=0;
c<a;
c++){b+="   "
}}else{a=0
}var f="DOM node; tag name: "+this.tagName;
b+="   ";
var d=this.childNodes.length;
for(var g=0;
g<d;
g++){var e=this.childNodes[g];
f+="\n"+b+e.createDump(a+1)
}return f
}}});
CUI.rte.Selection=function(){var c=CUI.rte.Common;
var i=CUI.rte.DomProcessor;
var f=function(k,m){var l=m.node;
var n=m.offset;
if(l&&(n==0)){var j=l.previousSibling;
if(j&&(j.nodeType==1)){if(c.getNodeCharacterCnt(j)==0){if(c.isTag(j,"a")&&c.isAttribDefined(j,"href")){return
}l=c.getPreviousCharacterNode(k,l);
if(l){m.node=l;
m.offset=(l.nodeType==3?l.nodeValue.length:0)
}}}else{if(!j&&(n==0)){l=c.getPreviousCharacterNode(k,l,c.EDITBLOCK_TAGS);
if(l){m.node=l;
m.offset=(l.nodeType==3?l.nodeValue.length:0)
}}}}};
var d=function(l,m){var k=CUI.rte.Common;
if((m.node.nodeType==1)&&(m.offset==null)){m.offset=k.getChildIndex(m.node);
m.node=k.getParentNode(l,m.node)
}else{if(m.offset==0){var j=(k.isTag(m.node,"img")&&k.isAttribDefined(m.node,k.A_NAME_REPLACEMENT_ATTRIB))||(k.isTag(m.node,"a")&&k.isAttribDefined(m.node,"name"));
if(j){m.offset=k.getChildIndex(m.node)+1;
m.node=k.getParentNode(l,m.node)
}}}};
var h=function(j,n){var m=n.node;
var k=0;
var l=0;
while(m){m=c.getNextNode(j,m);
if(!m){break
}if(a(m)){l++
}k+=c.getNodeCharacterCnt(m);
if(k>=n.offset){break
}}n.offset+=l
};
var a=function(j){return c.isTag(j,"a")&&c.isAttribDefined(j,"name")
};
var e=function(k,l){while(l){if(c.isTag(l,["td","th"])){return true
}var j=l.parentNode;
if(c.getChildIndex(l)!=(j.childNodes.length-1)){return false
}l=c.getParentNode(k,l)
}return false
};
var g=function(k,o,q,r){var m=CUI.rte.Selection;
if(o==null){return null
}var s=false;
if((o.nodeType==1)&&!c.isOneCharacterNode(o)){var n=o.childNodes;
var t=n.length;
var j,p,v,u;
if((q!=null)&&(q<t)){var l=n[q];
j=c.getFirstTextChild(l,true);
if(j){o=j;
q=m.getFirstSelectionOffset(k,j)
}else{if(c.isEmptyEditingBlock(l)){o=l;
q=null;
s=true
}else{v=c.getFirstChild(o);
if(v){o=v;
q=null
}}}}else{p=c.getLastTextChild(o,true);
if(p){o=p;
q=m.getLastSelectionOffset(k,p,r)
}else{u=c.getLastChild(o);
if(u){o=u;
q=null
}else{s=c.isEmptyEditingBlock(o)
}}}return{node:o,offset:q,isEmptyBlock:s}
}return null
};
var b={getScrollOffsets:function(j){return{scrollTop:j.root.scrollTop,scrollLeft:j.root.scrollLeft}
},setScrollOffsets:function(j,k){if((k.scrollTop!==undefined)&&(k.scrollLeft!==undefined)){j.root.scrollTop=k.scrollTop;
j.root.scrollLeft=k.scrollLeft
}},hasWhitespaceOnly:function(n){var l=" \n\r\t";
if(c.ua.isGecko){l+=String.fromCharCode(160)
}var k=n.length;
for(var m=0;
m<k;
m++){var j=n.charAt(m);
if(l.indexOf(j)<0){return false
}}return true
},bookmarkFromProcessingSelection:function(n,o){var j=CUI.rte.Common;
o={startNode:o.startNode,startOffset:o.startOffset,endNode:o.endNode,endOffset:o.endOffset,cellSelection:o.cellSelection};
CUI.rte.Selection.normalizeProcessingSelection(n,o);
var m=j.getCharacterOffsetForNode(n,o.startNode);
if(j.isOneCharacterNode(o.startNode)){if((o.startOffset!=null)&&(o.startOffset===0)){m++
}}else{if(o.startOffset){m+=o.startOffset
}}var l=m;
if(o.endNode){l=j.getCharacterOffsetForNode(n,o.endNode);
if(j.isOneCharacterNode(o.endNode)){if((o.endOffset!=null)&&(o.endOffset===0)){l++
}}else{if(o.endOffset){l+=o.endOffset
}}}if(j.ua.isGecko){var k=null;
if(o.cellSelection){k=o.cellSelection.cells
}return{startPos:m,charCnt:(l-m),object:null,insertObject:null,cells:k}
}return{startPos:m,charCnt:(l-m),object:null,insertObject:null}
},compareBookmarks:function(k,j){if(k==null){return(j==null)
}if(j==null){return false
}return(k.startPos==j.startPos)&&(k.charCnt==j.charCnt)&&(k.object==j.object)&&(k.insertObject==j.insertObject)
},isLineDelimiter:function(n){if(n.nodeType!=1){return false
}var m=CUI.rte.Selection.LINE_DELIMITING_TAGS;
var k=m.length;
var j=n.tagName.toLowerCase();
for(var l=0;
l<k;
l++){if(m[l]==j){return true
}}return false
},getLineDelimiter:function(j,k){while(k){if(k.nodeType==1){if(CUI.rte.Selection.isLineDelimiter(k)){return k
}}k=c.getParentNode(j,k)
}return null
},adaptToInclusiveEndNode:function(k,s){var l=CUI.rte.Selection;
var o={startNode:s.startNode,startOffset:s.startOffset};
if(c.isRootNode(k,s.startNode)&&(s.startOffset==s.startNode.childNodes.length)){o.isEOT=true;
return o
}var p=s.endNode;
var r=s.endOffset;
if(p){var j=function(){var t=c.getPreviousCharacterNode(k,p);
if(t){p=t;
r=l.getLastSelectionOffset(k,t,true)
}};
if(c.isOneCharacterNode(p)){if(r==0){r=null
}else{j()
}}else{if((p.nodeType==1)&&!c.isEmptyEditingBlock(p,true)){var m;
if((r==undefined)||(p.childNodes.length==r)){m=c.getLastTextChild(p,true);
if(m){p=m;
r=l.getLastSelectionOffset(k,p,true)
}else{j()
}}else{p=p.childNodes[r];
r=null;
m=c.getPreviousTextNode(k,p);
if(m){p=m;
r=l.getLastSelectionOffset(k,m,true)
}}}else{if(p.nodeType==3){if(r>0){r--
}else{j();
var q=(c.getNextCharacterNode(k,p,c.EDITBLOCK_TAGS)==null);
if(!q){if(c.isOneCharacterNode(p)){r=null
}else{r--
}}}}}}var n=s.endNode;
if(n!=p){n=c.getPreviousNode(k,n);
while(n&&(n!=p)){if(c.isEmptyEditingBlock(n)){if((s.startNode==n)&&(s.startOffset==null)){p=null
}else{p=n;
r=null
}break
}n=c.getPreviousNode(k,n)
}}if(p!=null){o.endNode=p;
o.endOffset=r
}}return o
},expandToLineBorders:function(k,t){var l=CUI.rte.Selection.isLineDelimiter;
var o=CUI.rte.Selection.getLineDelimiter;
var j,n;
var m=t.startNode;
var q=t.endNode;
if(q==null){q=m
}var s=o(k,m);
if(s==null){var u=m;
while(u){do{j=u;
u=c.getPreviousNode(k,u);
if(!u){break
}if(c.isRootNode(k,u)){u=null;
break
}if(o(k,u)!=null){u=null;
break
}}while(u.nodeType==3);
if(!u){s=j;
break
}n=u.tagName.toLowerCase();
if(n=="br"){s=j;
break
}}}var p=o(k,q);
if(p==null){if((q.nodeType==1)&&(q.tagName.toLowerCase()=="br")){p=q
}else{var r=q;
while(r){do{j=r;
r=c.getNextNode(k,r);
if(!r){break
}if(c.isRootNode(k,r)){r=null;
break
}}while(r.nodeType==3);
if(!r||l(r)){p=j;
break
}n=r.tagName.toLowerCase();
if(n=="br"){p=r;
break
}}}}if(l(s)){if(s.childNodes.length>0){s=s.childNodes[0]
}}if(l(p)){if(p.childNodes.length>0){p=c.getLastChild(p)
}}return{startNode:s,startOffset:(s.nodeType==3?0:null),endNode:p,endOffset:(p&&p.nodeType==3?c.getNodeCharacterCnt(p):null)}
},isNoInsertNode:function(l,o){if(l.nodeType==3){return false
}var m=CUI.rte.Selection;
var n=(o===true?m.NO_INSERT_TAGS_DOM:m.NO_INSERT_TAGS);
for(var j=0;
j<n.length;
j++){var k=c.matchesTagDef(l,n[j]);
if(k){return true
}}return false
},isSelection:function(j){return(j.endNode!=null)||(j.cellSelection!=null)
},getSelectedDom:function(j,k){var l=null;
if(k.startNode&&(k.startOffset==null)){if(!k.endNode){l=k.startNode
}}return l
},getFirstSelectionOffset:function(j,k){return(k.nodeType==3?0:null)
},getLastSelectionOffset:function(k,l,j){if(l.nodeType==3){return l.nodeValue.length
}if(c.isOneCharacterNode(l)){if(c.ua.isGecko&&c.isTag(l,"br")&&!j){var m=c.getNextCharacterNode(k,l,c.EDITBLOCK_TAGS);
if(m==null){return null
}}return 0
}return null
},shouldNormalizePSelForNodeList:function(l,m){var n=CUI.rte.Selection;
if(n.isSelection(m)){return true
}var k=m.startNode;
if(!k){return false
}var j=m.startOffset;
if(c.isOneCharacterNode(k)&&(j==0)){return true
}if((k.nodeType==3)&&(j>=k.nodeValue.length)){return true
}if(k.nodeType==1){return true
}return false
},shouldNormalizePSel:function(k,l){if(CUI.rte.Selection.isSelection(l)){return true
}var j=l.startNode;
return j&&(j.nodeType==1)&&!c.isOneCharacterNode(j)
},normalizeProcessingSelection:function(k,u){var l=CUI.rte.Selection;
var m=u.startNode;
var r=u.startOffset;
var o=u.endNode;
var s=u.endOffset;
if(m){var j=g(k,m,r,false);
if(j!=null){m=j.node;
r=j.offset
}var p=g(k,o,s,true);
if(p!=null){o=p.node;
s=p.offset
}if(c.isCharacterNode(m)){var q=false;
var n=false;
if(c.isOneCharacterNode(m)){q=(r==0)
}else{q=(r>=m.nodeValue.length);
n=(m==o)&&(r==s)
}if(q){var t=c.getNextCharacterNode(k,m,c.EDITBLOCK_TAGS);
if(t){m=t;
r=l.getFirstSelectionOffset(k,t);
if(!n){n=(m==o)&&(r==s)
}if(n){o=null;
s=null
}}}}u.startNode=m;
u.startOffset=r;
u.endNode=o;
u.endOffset=s
}},dumpPSel:function(m,E,z){function x(G){if(!G){return""
}if(z){var F=G.length;
if(G.charAt(F-1)=="\n"){G=G.substring(0,F-1)
}G=CUI.rte.Utils.htmlEncode(G);
G=G.replace(/\n/gi,"<br>")
}return G
}function p(H,F,G){if(H.nodeType!=1){return"[no tag]"
}if(F){return"<"+H.tagName+">"
}var I=H.innerText;
if(I.length>15){I=I.substring(0,12)+"..."
}return"<"+H.tagName+":"+I+(G===true?"|>":">")
}function y(G,J,K){if(G.nodeType==3){var N=G.nodeValue;
if(N.length>20){var O=Math.min(J+10,N.length);
var M=O-20;
if(M<0){O=Math.min(O-M,N.length);
M=0
}var H=(O<N.length);
N=N.substring(M,J)+"|"+N.substring(J,O);
if(H){N+="..."
}if(M>0){N="..."+N
}}else{N=N.substring(0,J)+"|"+N.substring(J)
}return N
}if(c.isOneCharacterNode(G)){var P=p(G,true);
if(K){return P
}return(J==null?"|"+P:P+"|")
}if(c.isTag(G,c.EDITBLOCK_TAGS||c.isTag(G,c.BLOCK_TAGS))){var L=G.childNodes;
if(c.isNull(J)){return p(G,false,true)
}var F=(J>0?L[J-1]:undefined);
var I=(J<L.length?L[J]:undefined);
if(F){if(F.previousSibling){N+="..."
}N+=p(F)
}N+="|";
if(I){N+=p(I);
if(I.nextSibling){N+="..."
}}return"#"+N
}return"[not yet implemented]"
}if(!E){return x("<invalid>")
}var v="";
var D=E.startNode;
var A=E.startOffset;
var B=E.endNode;
var l=E.endOffset;
if(D){var u=(c.isOneCharacterNode(D)&&c.isNull(A)&&!B);
v+=(u?"object: ":"start: ")+y(D,A,u)+"\n";
if(B){v+="end: "+y(B,l)+"\n"
}}if(E.cellSelection){var n="";
var s=E.cellSelection;
var o=s.cells;
var q=o.length;
for(var C=0;
C<q;
C++){if(C>0){n+="; "
}var w=o[C];
var k=w.innerText;
if(k.length>10){k=k.substring(0,7)+"..."
}var j=0;
var r=w;
while(r.previousSibling){r=r.previousSibling;
if(c.isTag(r,["td","th"])){j++
}}n+=j+"/";
r=c.getTagInPath(m,r,"tr");
if(r){var t=0;
while(r.previousSibling){r=r.previousSibling;
if(c.isTag(r,"tr")){t++
}}n+=t
}else{n+="?"
}n+=": "+k
}v+="cells (td/tr): "+n+"\n"
}return x(v)
},LINE_DELIMITING_TAGS:["p","li","h1","h2","h3","h4","h5","h6"],NO_INSERT_TAGS:[{tagName:"a",attribsDefined:["name"],attribsUndefined:["href"]},{tagName:"img"},{tagName:"span",empty:true}],NO_INSERT_TAGS_DOM:[{tagName:"a",attribsDefined:["name"],attribsUndefined:["href"]},{tagName:"img"}],SELECTION_INCLUSION_TAGS:[{tagName:"a",attribsDefined:["name"],attribsUndefined:["href"]}]};
return CUI.rte.Utils.merge(b,c.ua.isOldIE?{getRangePosition:function(j,n){if(n.item){return c.getCharacterOffsetForNode(j,n.item(0))
}n.collapse(true);
var k=n.parentElement();
if(k==j.root){if((n.htmlText.length==0)&&(n.text.length==0)){var u=n.duplicate();
if(u.move("character",1)==1){n=u;
k=n.parentElement()
}}}var o=k.childNodes.length;
var l=c.getCharacterOffsetForNode(j,k);
if(c.isTag(k,"a")&&c.isAttribDefined(k,"name")){return l+1
}var w=n.duplicate();
w.moveToElementText(k);
w.collapse(true);
w.setEndPoint("StartToEnd",n);
var s=0;
var q=0;
for(var m=0;
m<o;
m++){var r=k.childNodes[m];
if(r.nodeType==1){var t=w.duplicate();
t.moveToElementText(r);
t.collapse(false);
var p=(t.compareEndPoints("StartToStart",n));
if(p<=0){s=m+1;
w.setEndPoint("StartToStart",t);
l+=q;
if(p<0){l+=c.getNodeTextLength(r);
q=0
}else{if(!a(r)||!c.ua.isIE8){l+=c.getNodeTextLength(r)
}break
}}else{break
}}else{q+=c.getNodeTextLength(r)
}}var v=w.text.replace(/[\n\t\r]/g,"");
l+=v.length;
return l
},setRangePosition:function(k,n,u){var l=CUI.rte.Selection;
var r=k.doc.selection.createRange();
var t=c.getNodeAtPosition(k,n);
if(t==null){r.moveToElementText(k.root);
r.collapse(false);
return r
}if(t.isNodeSelection){var o=(k.root===t.dom);
if(t.startOfElement||(!o&&c.isEmptyEditingBlock(t.dom,true))){l.setNodeToRange(k,r,t.dom,true)
}else{if(l.isNoInsertNode(t.dom)){r.moveToElementText(t.dom.parentNode)
}else{r.moveToElementText(t.dom)
}r.collapse(false);
var v=r.parentElement();
var m=r.duplicate();
if(l.isNoInsertNode(v)){r.move("character",-1);
r.move("character",1)
}else{if(!e(k,v)&&(m.move("character",1)==1)&&(m.parentElement()!=k.root)){r.move("character",-1)
}}}return r
}var q=t.parentDom;
var j=t.parentOffset;
if(!q){var w=t.nodeBefore;
if(w){if(w.nodeType==3){r.moveToElementText(w.parentNode)
}else{r.moveToElementText(w)
}}else{r.moveToElementText(k.root)
}r.collapse(false);
return r
}var p=t.isUnregularNestedIssue;
var s;
if(p){s=t.nestedItemDom
}t={node:q,offset:j};
h(k,t);
l.setNodeToRange(k,r,t.node,true);
if(p){r.moveToElementText(s);
r.collapse(true);
if(u){r.move("character",-2);
r.moveEnd("character",1)
}return r
}if(t.offset>0){r.move("character",t.offset)
}return r
},getSelection:function(j){return j.doc.selection
},getLeadRange:function(j){return j.doc.selection.createRange()
},getCaretPos:function(k){var j=k.doc.selection.createRange();
return CUI.rte.Selection.getRangePosition(k,j)
},setCaretPos:function(k,l){var j=CUI.rte.Selection.setRangePosition(k,l);
if(j){j.select()
}},createRange:function(j){return j.doc.selection.createRange()
},selectRange:function(k,j){j.select()
},createRangeBookmark:function(j){return{single:true,bookmark:j.doc.selection.createRange()}
},selectRangeBookmark:function(j,k){if(k&&k.single&&k.bookmark){k.bookmark.select()
}},getRangeTextContent:function(k,j){return j.text
},createSelectionBookmark:function(k){var m=CUI.rte.Selection;
var o=k.doc.selection.createRange();
var r=null;
var j=null;
var q,l;
if(o.item){r=o.item(0);
q=c.getCharacterOffsetForNode(k,r);
l=q
}else{var s=o.duplicate();
s.collapse(true);
q=m.getRangePosition(k,s);
var n=o.duplicate();
n.collapse(false);
l=m.getRangePosition(k,n);
if(q==l){var p=o.parentElement();
if(p){if(p.childNodes.length==0){j=p;
if(m.isNoInsertNode(j)){j=null
}}}}}return CUI.rte.Utils.apply({startPos:q,charCnt:(l-q),object:r,insertObject:j},m.getScrollOffsets(k))
},selectBookmark:function(m,n){var p=CUI.rte.Selection;
var j=null;
var k=false;
if(n.object){j=n.object;
k=true
}else{if(n.insertObject){j=n.insertObject
}}var l;
if(j){try{if(k){l=m.root.createControlRange();
l.addElement(j)
}else{l=m.doc.selection.createRange();
l.moveToElementText(j);
l.collapse(true)
}}catch(q){if(n.startPos){j=undefined
}}}if(!j){l=p.setRangePosition(m,n.startPos);
if(n.charCnt>0){var o=p.setRangePosition(m,n.startPos+n.charCnt,true);
l.setEndPoint("EndToEnd",o)
}}if(l){l.select()
}p.setScrollOffsets(m,n)
},trimRangeWhitespace:function(n,l){var p=CUI.rte.Selection;
var k,j;
if(l.item){return l
}k=l.duplicate();
k.collapse(true);
var o=0;
while(true){j=k.duplicate();
j.moveEnd("character",o+1);
if(!p.hasWhitespaceOnly(j.text)){break
}o++
}k=l.duplicate();
k.collapse(false);
var m=0;
while(true){j=k.duplicate();
j.moveStart("character",-(m+1));
if(!p.hasWhitespaceOnly(j.text)){break
}m++
}j=l.duplicate();
if(o>0){j.moveStart("character",o)
}if(m>0){j.moveEnd("character",-m)
}if(j.text.length>0){l=j
}return l
},getRangeNodeAndOffset:function(ab,u,z,p){var q=CUI.rte.Common;
var J=CUI.rte.Selection;
var O;
var v=u.parentElement();
var o=(q.isRootNode(ab,v)?v:null);
if(J.isNoInsertNode(v)){var V=q.getTagInPath(ab,v,q.EDITBLOCK_TAGS);
var X=false;
v=q.getNextCharacterNode(ab,v);
if(!v){v=V;
X=true
}O=J.getFirstSelectionOffset(ab,v);
var Q=q.getTagInPath(ab,v,q.EDITBLOCK_TAGS);
if(!X&&(Q!=V)){v=V;
O=null
}return{dom:v,offset:O}
}var I=u.duplicate();
I.moveEnd("character",1);
var R=I.duplicate();
R.collapse(false);
var M=R.parentElement();
var r=u.duplicate();
var K=u.parentElement();
r.moveToElementText(K);
r.collapse(true);
if(r.move("character",1)==1){r.move("character",-1)
}var Y=(q.ua.isIE8&&!ab.iFrame);
var j=null;
var C=null;
var W=K.childNodes.length;
var n=false;
for(var y=0;
y<W;
y++){var aa=K.childNodes[y];
if(aa.nodeType==1){var H=r.duplicate();
r.moveToElementText(aa);
var N=r.duplicate();
r.collapse(true);
N.collapse(false);
if(r.compareEndPoints("StartToStart",I)==0){j=aa;
n=true;
break
}else{if(N.compareEndPoints("EndToEnd",I)==0){var U=r.parentElement();
var A=false;
var B=false;
var L=N.parentElement();
var T=I.parentElement();
if(q.isTag(aa,"img")&&a(U)){var Z=q.getPreviousCharacterNode(ab,aa,q.EDITBLOCK_TAGS);
if(Z!=U){n=true
}if(Y){if(T!=L){B=true
}}}else{if(a(U)){if(Y){if(T!=L){A=true
}}}else{if(q.isTag(T,"img")&&q.isTag(L,q.EDITBLOCK_TAGS)&&q.getTagInPath(ab,L,"table")){if(Y){n=true;
B=true
}}}}if(!A){j=aa;
var E=q.getLastTextChild(j,true,Y);
if(E){j=E;
C=B?undefined:J.getLastSelectionOffset(ab,j,!p)
}break
}}else{if(M==aa){if(q.isTag(M,"table")&&o){j=o;
C=q.getChildIndex(M)
}else{j=aa
}break
}}}var k=q.hasTextChild(aa);
if(q.isOneCharacterNode(aa)||k){r.moveToElementText(aa);
r.collapse(false)
}else{H.move("character",2);
r=H
}}}if(!j){var t;
var D=u.duplicate();
D.moveToElementText(v);
D.collapse(true);
D.setEndPoint("StartToEnd",u);
var m=0;
for(y=0;
y<W;
y++){var l=K.childNodes[y];
if(l.nodeType==1){var G=D.duplicate();
G.moveToElementText(l);
G.collapse(false);
var S=(G.compareEndPoints("StartToStart",u));
if(S<0){m=y+1;
D.setEndPoint("StartToStart",G)
}else{break
}}}var F=D.text.replace(/[\n\t\r]/g,"");
var x=F.length;
var w=0;
for(y=m;
y<W;
y++){l=K.childNodes[y];
var P=(q.isTag(l,"br")?0:q.getNodeTextLength(l));
if((w+P)>x){j=l;
C=x-w;
if((j.nodeType===3)&&(C===0)){t=q.getPreviousCharacterNode(ab,j,q.EDITBLOCK_TAGS);
if(t&&!q.isOneCharacterNode(t)){j=t;
C=q.getNodeCharacterCnt(j)
}}break
}w+=P
}}if(j&&(j.nodeType==1)&&!q.isRootNode(ab,j)){if(!q.isOneCharacterNode(j)){var ac=q.getFirstTextChild(j);
if(ac){t=q.getPreviousCharacterNode(ab,ac,q.EDITBLOCK_TAGS);
if(t&&!q.isOneCharacterNode(t)){j=t;
C=q.getNodeCharacterCnt(j)
}else{j=ac;
C=0
}}}else{if(q.isTag(j,"img")){if(!n){C=0
}}}}if(!j){if(o){j=o;
C=o.childNodes.length
}else{j=q.getLastTextChild(v,true);
if(j){if(z&&p&&((j.nodeType==3)||q.isTag(j,"br"))){var s=q.getNextCharacterNode(ab,j,q.EDITBLOCK_TAGS);
if(s){j=s;
C=J.getFirstSelectionOffset(ab,j)
}else{C=q.getNodeTextLength(j)
}}else{C=J.getLastSelectionOffset(ab,j,!p)
}}else{j=v
}}}return{dom:j,offset:C}
},createProcessingSelection:function(k){var l=CUI.rte.Selection;
var o=k.doc.selection.createRange();
if(o.item){var t=o.item(0);
if(!c.isAncestor(k,k.root,t)){return null
}return{startNode:t}
}var r=o.duplicate();
r.collapse(true);
var n=o.duplicate();
n.collapse(false);
var j;
var p={dom:null,offset:null};
var q=(r.compareEndPoints("StartToStart",n)==0);
if(q&&c.ua.isIE8&&!k.iFrame){q=(o.htmlText=="")&&(o.boundingWidth==0)
}if(q){j=l.getRangeNodeAndOffset(k,r,false)
}else{j=l.getRangeNodeAndOffset(k,r,true,true);
p=l.getRangeNodeAndOffset(k,n,true,false);
if(c.isEmptyEditingBlock(p.dom)){var m=c.getNextNode(k,p.dom);
while(m){var s=c.isEmptyEditingBlock(m)||c.isCharacterNode(m);
if(s){break
}m=c.getNextNode(k,m)
}if(!m){p.offset=c.getChildIndex(p.dom);
p.dom=c.getParentNode(k,p.dom)
}else{p.dom=m;
p.offset=l.getFirstSelectionOffset(k,m)
}}}if((j.dom==p.dom)&&(j.offset==p.offset)){p.dom=null;
p.offset=null
}if(!c.isAncestor(k,k.root,j.dom)){return null
}return{startNode:j.dom,startOffset:j.offset,endNode:p.dom,endOffset:p.offset}
},setNodeToRange:function(n,j,q,o){if(q.nodeType==3){throw new Error("Cannot select text node")
}try{j.moveToElementText(q);
var m=j.parentElement();
if(o){if(a(m)){j.collapse(true);
j.move("character",-1);
if(a(j.parentElement())){if(j.move("character",2)==2){j.move("character",-1)
}if(a(j.parentElement())){j.move("character",-1)
}}else{m=j.parentElement();
if((q!=m)&&!c.isAncestor(n,q,m)){if(!a(q)){j.moveToElementText(q);
j.collapse(true)
}}}}else{j.collapse(true);
var l=c.getPreviousCharacterNode(n,q);
var k=(c.isTag(q,c.EDITBLOCK_TAGS)&&a(l))||(c.isEmptyEditingBlock(q,true)&&c.isTag(q.previousSibling,c.LIST_TAGS));
if(k){if(j.move("character","-1")==-1){if(j.move("character","2")==2){if(c.getNextNode(n,q)!=null){j.move("character","-1")
}}}}else{if(!c.isEmptyEditingBlock(q,true)){if(j.move("character",1)==1){j.move("character",-1)
}}else{if(c.isTag(q,"li")){j.move("character",1)
}}}}}}catch(p){}},selectNode:function(k,m,l){if(m.nodeType==3){throw new Error("Selecting a text node is not supported.")
}var j=k.doc.selection.createRange();
CUI.rte.Selection.setNodeToRange(k,j,m,l);
j.select()
},selectEmptyNode:function(k,m){var l;
if(i.isZeroSizePlaceholder(m)){l=(m.nodeType===3?m.parentNode:m)
}else{l=i.createTempSpan(k,true,false,true);
l.appendChild(k.createTextNode(i.ZERO_WIDTH_NBSP));
m.appendChild(l)
}var j=k.doc.selection.createRange();
j.moveToElementText(l);
j.move("character",1);
j.select()
},selectBeforeNode:function(k,m){var l=i.createTempSpan(k,true,false,true);
l.appendChild(k.createTextNode(i.ZERO_WIDTH_NBSP));
m.parentNode.insertBefore(l,m);
var j=k.doc.selection.createRange();
j.moveToElementText(l);
j.collapse(true);
j.select()
},selectAfterNode:function(k,m){var j=k.doc.selection.createRange();
var l=i.createTempSpan(k,true,false,true);
l.appendChild(k.createTextNode(i.ZERO_WIDTH_NBSP));
m.parentNode.insertBefore(l,m.nextSibling);
j.moveToElementText(l);
j.collapse(false);
j.select()
},resetSelection:function(k,p){try{var m=CUI.rte.Selection;
var o=k.doc.selection.createRange();
var l=k.root;
if(p=="all"){o.moveToElementText(l)
}else{if(p=="start"){var j=c.getNextEditableNode(k,k.root);
if(j){l=j.parentNode
}m.setNodeToRange(k,o,l,true)
}else{if(p=="end"){var n=null;
var r=c.getLastChild(k.root);
if(r){if(c.isEditableNode(r)){n=r
}else{n=c.getPreviousEditableNode(k,k.root)
}if(n){l=n.parentNode
}}m.setNodeToRange(k,o,l,false);
o.collapse(false)
}}}o.select()
}catch(q){}},flushSelection:function(j,k){},isCollapsed:function(j){if(j.item){return false
}var l=j.duplicate();
l.collapse(true);
var k=j.duplicate();
k.collapse(false);
return l.isEqual(k)
},saveNativeSelection:function(j){return j.doc.selection.createRange()
},restoreNativeSelection:function(j,k){if(k){k.select()
}}}:{getNodeCharacters:function(k){var j=k.nodeValue;
if(j){return j
}return""
},getCharPosition:function(j,k,n){var l=0;
var r,o;
if((k.nodeType==1)&&!c.isOneCharacterNode(k)){if(!c.isRootNode(j,k)){l=c.getCharacterOffsetForNode(j,k)
}for(var m=0;
m<n;
m++){var p=k.childNodes[m];
l+=c.getNodeCharacterCnt(p);
r=j.doc.createTreeWalker(p,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT,null,false);
while(true){try{o=r.nextNode()
}catch(q){}if(!o){break
}l+=c.getNodeCharacterCnt(o);
if(c.isTag(o,c.EDITBLOCK_TAGS)){l++
}}if(c.isTag(p,c.EDITBLOCK_TAGS)){l++
}}return l
}if(k.nodeType==1){if(n==0){n=1
}}return c.getCharacterOffsetForNode(j,k)+n
},calcNodeAndOffsetForPosition:function(m,q,x,D,G){var C=CUI.rte.Selection;
if(!D){D=m.root;
if(c.ua.isWebKit){D.normalize()
}G=0
}var k,r;
if(!c.isRootNode(m,D)){var B=c.getNodeCharacterCnt(D);
var z=false;
if(c.isTag(D,c.EDITBLOCK_UNREGNEST_TAGS)){if((c.getChildIndex(D)==0)&&c.isFirstNestedList(m,D.parentNode)){var j=D;
do{j=c.getParentNode(m,j);
if(j&&c.isTag(j,c.EDITBLOCK_UNREGNEST_TAGS)){B++;
z=true;
break
}}while(j)
}}k=(B>0)&&(x?(q<=(G+B)):(q<(G+B)));
if((q>=G)&&k){if(z){if(c.ua.isIE&&(q!==G)){return{node:D,offset:null}
}r=null;
var p=c.getPreviousCharacterNode(m,D);
if(p){D=p;
r=C.getLastSelectionOffset(m,D,x)
}return{node:D,offset:r}
}r=q-G;
if(D.nodeType==1){r=(r==0?null:0);
if(c.isTag(D,"br")&&(r==0)&&x){var E=c.getNextCharacterNode(m,D);
if(E){D=E;
r=C.getFirstSelectionOffset(m,D)
}}}return{node:D,offset:r}
}G+=B
}var o=D.childNodes.length;
for(var F=0;
F<o;
F++){var t=D.childNodes[F];
var H=C.calcNodeAndOffsetForPosition(m,q,x,t,G);
if(typeof(H)=="object"){return H
}G=H;
if(c.isTag(t,c.EDITBLOCK_TAGS)){if(q==G){var s=c.getLastTextChild(t,true);
if(s){r=C.getLastSelectionOffset(m,s,x);
return{node:s,offset:r}
}r=null;
if(c.ua.isIE&&!c.ua.isIEBRPlaceholder){var I=c.getNextEditableNode(m,t);
if(I){t=I
}else{t=m.root;
r=m.root.length
}}return{node:t,offset:r}
}var n=true;
var v=false;
if(c.isTag(t,c.EDITBLOCK_UNREGNEST_TAGS)){var w=c.getParentNode(m,t);
var u=c.getChildIndex(t);
var y=(u==(w.childNodes.length-1));
var l=c.containsTagInPath(m,w,c.EDITBLOCK_UNREGNEST_TAGS);
n=!(y&&l&&c.isLastNestedList(m,w));
v=!n
}else{if(c.isTag(t,c.EDITBLOCK_NESTED_TAGS)){n=!c.isLastElementOfNestingLevel(m,t);
v=!n
}}if(c.ua.isIE&&!c.ua.isIEBRPlaceholder&&!v){n=!c.isEmptyEditingBlock(t,true)
}if(n){G++
}}}if(c.isRootNode(m,D)){var A=c.getLastChild(D);
r=C.getLastSelectionOffset(m,A,x);
return{node:A,offset:r}
}return G
},getSelectionObject:function(l){var k=l.anchorNode;
var n=l.anchorOffset;
var p=l.focusNode;
var j=l.focusOffset;
if(k!=p){return null
}if(Math.abs(n-j)!=1){return null
}var o=(n<j?n:j);
var m=k.childNodes[o];
if(!m){return null
}if(m.nodeType==3){return null
}if(c.isTag(m,c.BLOCK_TAGS)){return null
}return m
},getTableSelection:function(m){var o={cells:[],otherContent:false};
var n=m.win.getSelection();
for(var l=0;
l<n.rangeCount;
l++){var k=n.getRangeAt(l);
var j=null;
if(k.startContainer==k.endContainer){j=k.startContainer;
if(c.isTag(j,"tr")){if(k.startOffset==(k.endOffset-1)){j=j.childNodes[k.startOffset]
}else{j=null
}}else{if(!c.isTag(k.startContainer,["th","td"])){j=null
}}}if(j){o.cells.push(j)
}else{o.otherContent=true
}}return((o.cells.length>0)?o:null)
},getSelection:function(j){return j.win.getSelection()
},getLeadRange:function(j){return j.win.getSelection().getRangeAt(0)
},getCaretPos:function(j){var k=j.win.getSelection();
if((k.anchorNode!=k.focusNode)||(k.anchorOffset!=k.focusOffset)){return -1
}return CUI.rte.Selection.getCharPosition(j,k.anchorNode,k.anchorOffset)
},setCaretPos:function(j,k){if(k<0){k=0
}var r=j.win.getSelection();
var p=j.doc.createRange();
var n=CUI.rte.Selection.calcNodeAndOffsetForPosition(j,k);
f(j,n);
d(j,n);
var l=n.node;
var m=n.offset;
if(c.isTag(l,["img","br"])&&(m==0)){p.selectNode(l);
p.collapse(false)
}else{var q=false;
if(c.ua.isIE&&!c.ua.isIEBRPlaceholder){if((l.nodeType==1)&&!isNaN(m)){var o=l.childNodes[m];
if(o&&c.isEmptyEditingBlock(o,true)){l=o;
q=true
}}}if(!q){p.setStart(l,m);
p.setEnd(l,m)
}else{p.selectNodeContents(l)
}}r.removeAllRanges();
r.addRange(p)
},createRange:function(j){return j.doc.createRange()
},selectRange:function(k,j){var l=k.win.getSelection();
l.removeAllRanges();
l.addRange(j)
},createRangeBookmark:function(k){var l=k.win.getSelection();
if(l.rangeCount==1){return{single:true,bookmark:l.getRangeAt(0)}
}else{var j=[];
for(var m=0;
m<l.rangeCount;
m++){j.push(l.getRangeAt(m))
}return{single:false,bookmark:j}
}},selectRangeBookmark:function(k,m){if(m&&m.bookmark){var l=k.win.getSelection();
l.removeAllRanges();
if(m.single){l.addRange(m.bookmark)
}else{var j=m.bookmark;
for(var n=0;
n<j.length;
n++){l.addRange(j[n])
}}}},getRangeTextContent:function(n,l){var p=l.cloneContents();
var k=n.doc.createTreeWalker(p,NodeFilter.SHOW_TEXT,null,false);
var o="",j;
while(true){try{j=k.nextNode()
}catch(m){}if(!j){break
}o+=CUI.rte.Selection.getNodeCharacters(j)
}return o
},createSelectionBookmark:function(l){var n=CUI.rte.Selection;
var v=l.win.getSelection();
var u=CUI.rte.Selection.getSelectionObject(v);
var k=null;
var z=null;
var t,m,p;
var y=v.rangeCount;
if(y==1){t=n.getCharPosition(l,v.anchorNode,v.anchorOffset);
m=n.getCharPosition(l,v.focusNode,v.focusOffset)
}else{if(y>1){z=[];
for(var j=0;
j<y;
j++){p=v.getRangeAt(j);
var w=p.startContainer;
if(c.isTag(w,"tr")){z.push(w.childNodes[p.startOffset])
}var x=n.getCharPosition(l,p.startContainer,p.startOffset);
if((j==0)||(x<t)){t=x;
m=x
}}}else{if(y==0){t=0;
m=0
}}}if(m<t){var o=m;
m=t;
t=o
}if((t==m)&&!z&&(y==1)){p=v.getRangeAt(0);
var q=p.commonAncestorContainer;
if(q.nodeType==1){var s=q.childNodes.length;
if((s==0)||((s==1)&&c.isTag(q.childNodes[0],"br"))){k=q;
if(CUI.rte.Selection.isNoInsertNode(k)){k=null
}}}}return CUI.rte.Utils.apply({startPos:t,charCnt:m-t,object:u,insertObject:k,cells:z},CUI.rte.Selection.getScrollOffsets(l))
},selectBookmark:function(j,o){var t=CUI.rte.Selection;
var E=j.doc;
var B=null;
var r,D;
var k=o.cells;
if(k){D=j.win.getSelection();
D.removeAllRanges();
var w=false;
var l=k.length;
for(var y=0;
y<l;
y++){var v=k[y];
if(v&&v.ownerDocument==E){r=E.createRange();
var q=v.parentNode;
var n=c.getChildIndex(v);
try{r.setStart(q,n);
r.setEnd(q,n+1);
D.addRange(r);
w=true
}catch(x){}}}if(w){return
}}if(o.object){B=o.object
}else{if(o.insertObject){B=o.insertObject
}}r=E.createRange();
if(B){try{r.selectNode(B);
r.collapse(true)
}catch(x){if(o.startPos!=null){B=undefined
}}}var z=!!B;
if(!z){var C=t.calcNodeAndOffsetForPosition(j,o.startPos);
var p=C;
if(o.charCnt>0){p=t.calcNodeAndOffsetForPosition(j,o.startPos+o.charCnt,true)
}else{if(c.ua.isIE){if(c.isEmptyEditingBlock(C.node,true)){if(c.isTag(C.node,"li")||c.isTag(C.node,c.TABLE_CELLS)){r.setStart(C.node,0)
}else{r.selectNode(C.node);
r.collapse(true)
}z=true
}}}}if(!z){f(j,C);
if(c.ua.isGecko){d(j,C)
}if(o.charCnt>0){if(c.ua.isGecko){d(j,p)
}}var A=C.node;
var u=C.offset;
var s=p.node;
var m=p.offset;
if(!c.ua.isGecko&&(A.nodeType==1)){if(u==null){r.setStartBefore(A)
}else{r.setStartAfter(A)
}}else{r.setStart(A,u)
}if(!c.ua.isGecko&&(s.nodeType==1)){if(m==null){r.setEndBefore(s)
}else{r.setEndAfter(s)
}}else{r.setEnd(s,m)
}}D=j.win.getSelection();
D.removeAllRanges();
D.addRange(r)
},trimRangeWhitespace:function(k,p){var l=CUI.rte.Selection;
var s=l.getRangeTextContent(k,p);
var u=0;
var t=1;
var m;
while(t<s.length){m=s.substring(0,t++);
if(!l.hasWhitespaceOnly(m)){break
}u++
}var o=0;
t=s.length;
while(t>0){m=s.substring(--t,s.length);
if(!l.hasWhitespaceOnly(m)){break
}o++
}if((s.length-u-o)>0){if(u>0){var r=l.getCharPosition(k,p.startContainer,p.startOffset);
r+=u;
var n=l.calcNodeAndOffsetForPosition(k,r);
p.setStart(n.node,n.offset)
}if(o>0){var j=l.getCharPosition(k,p.endContainer,p.endOffset);
j-=o;
var q=l.calcNodeAndOffsetForPosition(k,j);
p.setEnd(q.node,q.offset)
}}return p
},createProcessingSelection:function(l){var B,A,w,q;
var D=l.win.getSelection();
var y=CUI.rte.Selection;
var t=null;
var n=false;
if((D.focusNode==D.anchorNode)&&(c.isTag(D.focusNode,"tr"))){n=true
}if((D.rangeCount>1)||n){t=y.getTableSelection(l);
var v=D.getRangeAt(0);
B=v.startContainer;
A=null;
if(B.nodeType==1){B=B.childNodes[v.startOffset]
}else{A=v.startOffset
}v=D.getRangeAt(D.rangeCount-1);
q=null;
w=v.endContainer;
if(w.nodeType==1){if(v.endOffset<w.childNodes.length){w=c.getPreviousNode(l,w.childNodes[v.endOffset])
}else{w=c.getLastChild(w)
}if(w.nodeType==3){q=c.getNodeCharacterCnt(w)
}}else{q=v.endOffset
}if(!c.isAncestor(l,l.root,B)){return null
}return{startNode:B,startOffset:A,endNode:w,endOffset:q,isDiscontinuousSelection:true,cellSelection:t}
}var z=y.getSelectionObject(D);
if(z){if(!c.isAncestor(l,l.root,z)){return null
}return{startNode:z}
}B=D.anchorNode;
A=D.anchorOffset;
w=D.focusNode;
q=D.focusOffset;
var o;
if(B&&!c.isOneCharacterNode(B)&&(B.nodeType==1)){o=B.childNodes.length;
if(o==0){A=null
}else{if(A<o){B=B.childNodes[A];
B=c.getFirstChild(B)||B;
if((B.nodeType===1)&&!c.isCharacterNode(B)){var j=c.getNextCharacterNode(l,B,c.EDITBLOCK_TAGS);
if(j){B=j
}}A=y.getFirstSelectionOffset(l,B)
}else{B=c.getLastChild(B);
if(B.nodeType==3){A=c.getNodeCharacterCnt(B)
}else{if(c.isOneCharacterNode(B)){A=0
}else{A=null
}}}}}var k=(B==w)&&(A==q);
if(k){if(c.ua.isW3cIE){if(B&&(B.nodeType===3)&&(A===0)&&!i.isZeroSizePlaceholder(B)){var C=c.getPreviousCharacterNode(l,B,c.EDITBLOCK_TAGS);
if(C&&!c.isOneCharacterNode(C)){B=C;
A=c.getNodeCharacterCnt(B)
}}}if(!c.isAncestor(l,l.root,B)){return null
}return{startNode:B,startOffset:A,cellSelection:t}
}if(!c.isOneCharacterNode(w)&&(w.nodeType==1)){o=w.childNodes.length;
if(o==0){q=null
}else{if(q<o){w=w.childNodes[q];
w=c.getFirstChild(w)||w;
q=((w.nodeType==1)&&!c.hasTextChild(w,false)?null:0)
}else{w=c.getLastChild(w);
if(w.nodeType==3){q=c.getNodeCharacterCnt(w)
}else{if(c.isOneCharacterNode(w)){q=0
}else{q=null
}}}}}var s=false;
if(B==w){if(A===q){w=null;
q=null
}else{s=(q<A)
}}else{var p=c.createIndexPath(l,B);
var m=c.createIndexPath(l,w);
s=(c.compareIndexPaths(p,m)<0)
}if(s){var x=w;
w=B;
B=x;
x=q;
q=A;
A=x
}if(c.ua.isW3cIE){var u=y.getNodeCharacters(B);
if(u.length>0){if(A===u.length){var r=c.getNextEditableNode(l,B,c.EDITBLOCK_TAGS);
if(c.isOneCharacterNode(r)){B=r;
A=null
}}}}if(!c.isAncestor(l,l.root,B)){return null
}return{startNode:B,startOffset:A,endNode:w,endOffset:q,cellSelection:t}
},selectNode:function(k,o,m){if(o.nodeType==3){throw new Error("Selecting a text node is not supported.")
}var l=k.win.getSelection();
var j=k.doc.createRange();
if(m){var n=c.getFirstTextChild(o);
if(n){j.setStart(n,0);
j.setEnd(n,0)
}else{if((o.childNodes.length==1)&&(o.childNodes[0].nodeType==1)){j.selectNode(o.childNodes[0]);
j.collapse(true)
}else{if(c.ua.isIE&&c.isEmptyEditingBlock(o,true)){j.selectNodeContents(o)
}else{j.selectNode(o);
j.collapse(true)
}}}}else{j.selectNode(o)
}l.removeAllRanges();
l.addRange(j)
},selectEmptyNode:function(k,n){var l=k.win.getSelection();
var j=k.doc.createRange();
if(!i.isZeroSizePlaceholder(n)){var m=i.createTempSpan(k,true,false,true);
m.appendChild(k.createTextNode(i.ZERO_WIDTH_NBSP));
n.appendChild(m)
}if(c.ua.isWebKit){j.selectNode(n);
j.collapse(false)
}else{j.setStart(n,0);
j.setEnd(n,0)
}l.removeAllRanges();
l.addRange(j)
},selectBeforeNode:function(k,n){var l=k.win.getSelection();
var j=k.doc.createRange();
var m=i.createTempSpan(k,true,false,true);
m.appendChild(k.createTextNode(i.ZERO_WIDTH_NBSP));
n.parentNode.insertBefore(m,n);
n=m;
if(c.ua.isWebKit){j.setStartAfter(n);
j.setEndAfter(n)
}else{j.setStartBefore(n);
j.setEndBefore(n)
}l.removeAllRanges();
l.addRange(j)
},selectAfterNode:function(k,o){var n=CUI.rte.DomProcessor;
var l=k.win.getSelection();
var j=k.doc.createRange();
var m=n.createTempSpan(k,true,false,true);
m.appendChild(k.createTextNode(n.ZERO_WIDTH_NBSP));
o.parentNode.insertBefore(m,o.nextSibling);
o=m;
if(c.ua.isWebKit){j.setStartAfter(o);
j.setEndAfter(o)
}else{j.setStartBefore(o);
j.setEndBefore(o)
}l.removeAllRanges();
l.addRange(j)
},getPreferredScrollOffset:function(j){return j.root.scrollTop
},ensureCaretVisibility:function(m,l){var o=CUI.rte.Selection;
var t=o.getLeadRange(m).cloneRange();
if(t.startContainer.nodeType==1){var r=t.startContainer.childNodes[t.startOffset];
if(c.isTag(r,["td","th"])){t.selectNodeContents(r)
}}if(m.iFrame){var q=m.createElement("span");
var x=m.createTextNode(i.NBSP);
q.appendChild(x);
t.insertNode(q);
var w=q.offsetTop;
var u=q;
while(u.offsetParent){u=u.offsetParent;
w+=u.offsetTop
}var z=q.offsetHeight;
var n=m.root.scrollTop;
var s=m.iFrame.clientHeight;
var k=n+s;
var j=w+z;
var v=m.root.scrollHeight;
if((v-j)<8){j=v
}if(l!=null){var p=l+s;
if((w>=l)&&(j<p)){m.root.scrollTop=l
}else{if(w<l){m.root.scrollTop=w
}else{m.root.scrollTop=j-s
}}}else{if(j>k){m.root.scrollTop=j-s
}else{if(w<n){m.root.scrollTop=w
}}}var y=q.parentNode;
y.removeChild(q);
y.normalize()
}},flushSelection:function(j,l){var k=j.win.getSelection();
var o;
if(l){o=[];
var n=k.rangeCount;
for(var m=0;
m<n;
m++){o.push(k.getRangeAt(m))
}}k.selectAllChildren(j.root);
k.collapseToStart();
if(l){k.removeAllRanges();
for(m=0;
m<n;
m++){k.addRange(o[m])
}}},resetSelection:function(k,o){try{var n;
var r=k.win.getSelection();
var l=k.root;
if(o=="all"){r.selectAllChildren(l)
}else{if(o=="start"){var j=c.getNextEditableNode(k,k.root);
if(j){l=j.parentNode
}if(c.ua.isIE&&c.isEmptyEditingBlock(j,true)){n=k.doc.createRange();
n.selectNodeContents(j);
r.removeAllRanges();
r.addRange(n)
}else{r.selectAllChildren(l);
r.collapseToStart()
}}else{if(o=="end"){var m=null;
var q=c.getLastChild(k.root);
if(q){if(c.isEditableNode(q)){m=q
}else{m=c.getPreviousEditableNode(k,k.root)
}if(m){l=m.parentNode
}}if(c.ua.isIE&&c.isEmptyEditingBlock(m,true)){n=k.doc.createRange();
n.selectNodeContents(m);
r.removeAllRanges();
r.addRange(n)
}else{r.selectAllChildren(l);
r.collapseToEnd()
}}}}}catch(p){}},saveNativeSelection:function(j){if(!CUI.rte.Common.ua.isIE){return null
}return j.win.getSelection().getRangeAt(0)
},restoreNativeSelection:function(j,k){if(k){j.win.getSelection().addRange(k)
}}})
}();
CUI.rte.UndoManager=new Class({toString:"UndoManager",undoHistory:null,maxUndoSteps:0,activeUndoStep:0,construct:function(a){this.undoHistory=[];
this.maxUndoSteps=a;
this.activeUndoStep=0
},addStep:function(a){var b;
if(this.activeUndoStep>0){b=this.undoHistory[this.activeUndoStep-1];
if(b.hasEqualSnapshot(a)){if(CUI.rte.Selection.compareBookmarks(b.bookmark,a.bookmark)==false){b.bookmark=a.bookmark
}return false
}}this.clearRedoHistory();
this.undoHistory.push(a);
if(this.undoHistory.length>this.maxUndoSteps){var c=this.undoHistory.length-this.maxUndoSteps;
this.undoHistory.splice(0,c);
this.activeUndoStep-=c
}this.activeUndoStep++;
return true
},canUndo:function(){return(this.activeUndoStep>1)
},canRedo:function(){return(this.activeUndoStep<this.undoHistory.length)
},undo:function(a){if(this.addStep(new CUI.rte.UndoManager.Step(a))){}if(this.canUndo()){this.activeUndoStep--;
this.undoHistory[this.activeUndoStep-1].set(a)
}},redo:function(a){if(this.addStep(new CUI.rte.UndoManager.Step(a))){}if(this.canRedo()){this.undoHistory[this.activeUndoStep].set(a);
this.activeUndoStep++
}},initialize:function(a){this.undoHistory.length=0;
this.activeUndoStep=0;
this.addStep(new CUI.rte.UndoManager.Step(a))
},clearRedoHistory:function(){var a=this.undoHistory.length-this.activeUndoStep;
if(a>0){this.undoHistory.splice(this.activeUndoStep,a)
}},cloneHistory:function(){var b=[];
for(var a=0;
a<this.undoHistory.length;
a++){b.push(this.undoHistory[a])
}return b
},createShortDump:function(){var a=this.undoHistory.length;
return"Undo history ("+a+" steps; active step: #"+this.activeUndoStep+"; maximum steps: "+this.maxUndoSteps+")"
},createDump:function(){var c=this.undoHistory.length;
var b=this.createShortDump()+":\n";
for(var a=0;
a<c;
a++){b+="#"+a+": "+this.undoHistory[a].createDump()
}return b
}});
CUI.rte.UndoManager.Step=new Class({toString:"UndoManager.Step",htmlSnapshot:null,bookmark:null,construct:function(b,c){var d=CUI.rte.Selection;
this.bookmark=(c?c:d.createSelectionBookmark(b));
this.bookmark.insertObject=undefined;
this.bookmark.object=undefined;
var a=b.root.cloneNode(true);
this.cleanup(a);
this.htmlSnapshot=a.innerHTML
},cleanup:function(d){var a=CUI.rte.Common;
if(d.nodeType==1){a.removeClass(d,CUI.rte.Theme.TABLESELECTION_CLASS);
var b=d.childNodes.length;
for(var e=0;
e<b;
e++){this.cleanup(d.childNodes[e])
}}},set:function(a){a.root.innerHTML=this.htmlSnapshot;
CUI.rte.Selection.selectBookmark(a,this.bookmark)
},hasEqualSnapshot:function(a){return this.htmlSnapshot==a.htmlSnapshot
},equals:function(b){var a=CUI.rte.Selection;
if(this.htmlSnapshot!=b.htmlSnapshot){return false
}return a.compareBookmarks(this.bookmark,b.bookmark)
},createDump:function(){var a="\n";
a+="Bookmark:\n"+CUI.rte.Common.dumpObject(this.bookmark,4);
a+="\nHTML-Snapshot:\n"+this.htmlSnapshot;
a+="\n\n";
return a
}});
CUI.rte.TableMatrix=new Class({toString:"TableMatrix",matrix:null,rows:null,fullMatrix:null,tableDom:null,getPreviousRowCellDef:function(e,d){while(e>0){e--;
var c=this.matrix[e][d];
if(c!=null){return{row:e,col:d,cell:c}
}var b=d-1;
while(b>=0){var a=this.matrix[e][b];
if(a){if((b+a.colSpan)>d){return{row:e,col:b,cell:a}
}break
}b--
}}return null
},createTableMatrix:function(i){var d=CUI.rte.Common;
this.tableDom=i;
this.matrix=[];
this.fullMatrix=null;
this.rows=d.getChildNodesByType(i,"tr",true,"table");
for(var a=0;
a<this.rows.length;
a++){var e=[];
this.matrix.push(e);
var p=d.getChildNodesByType(this.rows[a],["th","td"],false);
var o=0;
for(var m=0;
m<p.length;
m++){var n=p[m];
var h=d.getAttribute(n,"colspan");
var f=d.getAttribute(n,"rowspan");
var k=(h?parseInt(h):1);
var l=(f?parseInt(f):1);
while(true){var j=this.getPreviousRowCellDef(a,o);
if(j){var b=j.row;
var g=j.cell.rowSpan;
if((b+g)<=a){e[o]={col:o,row:a,colSpan:k,rowSpan:l,cellDom:n};
o+=k;
break
}}else{e[o]={col:o,row:a,colSpan:k,rowSpan:l,cellDom:n};
o+=k;
break
}o++
}}}},createFullMatrix:function(){if(this.matrix==null){throw new Error("No basic matrix calculated; use createTableMatrix() before.")
}this.fullMatrix=[];
for(var d=0;
d<this.matrix.length;
d++){for(var b=0;
b<this.matrix[d].length;
b++){if(this.matrix[d][b]!=null){var a=this.matrix[d][b];
for(var g=0;
g<a.colSpan;
g++){for(var e=0;
e<a.rowSpan;
e++){var f;
if(this.fullMatrix[e+d]){f=this.fullMatrix[e+d]
}else{f=[];
this.fullMatrix[e+d]=f
}f[g+b]={isOrigin:(g==0)&&(e==0),cellRef:a}
}}}}}},getTableSize:function(){if(this.matrix==null){throw new Error("No basic matrix calculated; use createTableMatrix() before.")
}var a=this.rows.length;
var b=0;
for(var d=0;
d<this.matrix[0].length;
d++){if(this.matrix[0][d]){b+=this.matrix[0][d].colSpan
}}return{cols:b,rows:a}
},getCellForCoords:function(b,c){if(this.fullMatrix==null){this.createFullMatrix()
}if(c>=this.fullMatrix.length){return null
}var a=this.fullMatrix[c];
if(b>=a.length){return null
}return a[b].cellRef
},getCellDef:function(b){if(this.matrix==null){throw new Error("No basic matrix calculated; use createTableMatrix() before.")
}for(var d=0;
d<this.matrix.length;
d++){for(var e=0;
e<this.matrix[d].length;
e++){var a=this.matrix[d][e];
if(a&&(a.cellDom==b)){return a
}}}return null
},getCellInfo:function(b){if(this.matrix==null){throw new Error("No basic matrix calculated; use createTableMatrix() before.")
}for(var d=0;
d<this.matrix.length;
d++){for(var g=0;
g<this.matrix[d].length;
g++){var a=this.matrix[d][g];
if(a&&(a.cellDom==b)){var f=d+a.rowSpan;
var e=g+a.colSpan;
return{isFirstCol:(g==0),isFirstRow:(d==0),isLastCol:(e>=this.matrix[d].length),isLastRow:(f>=this.matrix.length),cellDef:a}
}}}return null
},createSelection:function(d){if(!CUI.rte.Utils.isArray(d)){d=[d]
}var c=new CUI.rte.CellSelection(this);
for(var b=0;
b<d.length;
b++){var a=this.getCellDef(d[b]);
if(!a){throw new Error("Invalid cell")
}c.addCell(a)
}c.process();
return c
},getRowDom:function(a){return this.rows[a]
},getColumn:function(c){var b=CUI.rte.Common;
if(this.fullMatrix==null){this.createFullMatrix()
}var d=[];
for(var e=0;
e<this.fullMatrix.length;
e++){var f=this.fullMatrix[e];
if(f){var a=f[c];
if(a&&!b.arrayContains(d,a.cellRef)){d.push(a.cellRef)
}}}return d
},getRow:function(g){var b=CUI.rte.Common;
if(this.fullMatrix==null){this.createFullMatrix()
}var f=[];
var d=this.fullMatrix[g];
if(d){for(var e=0;
e<d.length;
e++){var a=d[e];
if(a&&!b.arrayContains(f,a.cellRef)){f.push(a.cellRef)
}}}return f
},getRowCellForCoords:function(a,e){if(this.matrix==null){throw new Error("No basic matrix calculated; use createTableMatrix() before.")
}var b=this.matrix[e];
if(!b){return null
}for(var d=a;
d<b.length;
d++){if(b[d]!=null){return b[d]
}}return null
},getFollowUpCell:function(b,f){if(this.fullMatrix==null){this.createFullMatrix()
}var d=this.fullMatrix[f];
if(!d){return null
}var a=d[b];
if(!a){return null
}a=a.cellRef;
for(var e=b+1;
e<d.length;
e++){if(d[e]&&(d[e].cellRef!=a)){return d[e].cellRef
}}return null
},extendBy:function(e,l,q){var n=CUI.rte.TableMatrix;
var b,g,h,f,k,a;
var p=this.getTableSize();
var m=this.rows[this.rows.length-1].parentNode;
for(a=0;
a<q;
a++){var d=e.createElement("tr");
var o=this.rows.length;
this.rows.push(d);
m.appendChild(d);
h=[];
this.matrix.push(h);
f=null;
if(this.fullMatrix){f=[];
this.fullMatrix.push(f)
}for(k=0;
k<p.cols;
k++){b=n.createEmptyCell(e);
d.appendChild(b);
g={col:k,row:o,colSpan:1,rowSpan:1,cellDom:b};
h.push(g);
if(f){f.push({isOrigin:true,cellRef:g})
}}}var i=this.matrix.length;
for(a=0;
a<i;
a++){h=this.matrix[a];
f=(this.fullMatrix?this.fullMatrix[a]:null);
var j=this.rows[a];
for(k=0;
k<l;
k++){b=n.createEmptyCell(e,j.lastChild);
j.appendChild(b);
g={col:k+p.cols,row:o,colSpan:1,rowSpan:1,cellDom:b};
h[k+p.cols]=g;
if(f){f[k+p.cols]={isOrigin:true,cellRef:g}
}}}},mergeToSingleCell:function(e,G,a,s,p){var f=CUI.rte.TableMatrix;
var g=CUI.rte.Common;
if(!this.fullMatrix){this.createFullMatrix()
}var A=G+s;
var t=a+p;
var B=A-1;
var u=t-1;
var o=this.matrix[a][G];
if(!o){throw new Error("Invalid table structure.")
}var z=this.fullMatrix[a][B];
if(!z.isOrigin){var v=z.cellRef;
if((v.row<a)&&((v.col+v.colSpan)>A)){throw new Error("Invalid table structure.")
}}var C=this.fullMatrix[u][G];
if(!C.isOrigin){var F=C.cellRef;
if((F.col<G)&&((F.row+F.rowSpan)>t)){throw new Error("Invalid table structure.")
}}var n=this.fullMatrix[u][B];
if(!n.isOrigin){var D=n.cellRef;
if(((D.col+D.colSpan)>A)&&(D.row+D.rowSpan>t)){throw new Error("Invalid table structure.")
}}for(var w=0;
w<p;
w++){var m=w+a;
var q=this.fullMatrix[m];
for(var E=0;
E<s;
E++){var i=E+G;
var d=q[i];
var H=d.cellRef;
var h=H.cellDom;
var l=false;
if(!d.isOrigin){if((E==0)&&(H.col<i)){g.setAttribute(h,"colspan",H.col+H.colSpan-i)
}if((w==0)&&(H.row<m)){g.setAttribute(h,"rowSpan",H.row+H.rowSpan-m)
}}else{l=(E!=0)||(w!=0);
if((H.col+H.colSpan)>A){l=false;
g.setAttribute(h,"colspan",H.col+H.colSpan-A);
g.removeAllChildren(h);
f.addCellPlaceholder(e,h)
}if((H.row+H.rowSpan)>t){l=false;
var j=H.row+H.rowSpan-t;
var b=H.rowSpan-j;
g.setAttribute(h,"rowspan",j);
h.parentNode.removeChild(h);
g.removeAllChildren(h);
f.addCellPlaceholder(e,h);
var y=this.getFollowUpCell(i,m+b);
var k=this.rows[m+b];
if(y){k.insertBefore(h,y.cellDom)
}else{k.appendChild(h)
}}}if(l){h.parentNode.removeChild(h)
}}}var x=o.cellDom;
g.setAttribute(x,"colspan",s);
g.setAttribute(x,"rowspan",p);
return x
},optimizeSpans:function(){if(this.matrix==null){throw new Error("No basic matrix calculated; use createTableMatrix() before.")
}var e=CUI.rte.Common;
var q=this.getTableSize();
var j=q.rows;
var k=q.cols;
var u,f,l,h,v;
var o=[];
for(l=0;
l<j;
l++){h=this.matrix[l];
for(u=0;
u<k;
u++){if(h[u]){o[u]=true
}}}u=0;
while(u<k){var b=u;
v=0;
while((u<k)&&!o[u++]){v++
}if(v>0){var p=this.getColumn(b);
for(l=0;
l<p.length;
l++){var a=p[l];
a.colSpan-=v;
if(a.colSpan>1){e.setAttribute(a.cellDom,"colspan",a.colSpan)
}else{e.removeAttribute(a.cellDom,"colspan")
}}}}var t=[];
for(u=0;
u<k;
u++){f=this.getColumn(u);
for(l=0;
l<f.length;
l++){t[f[l].row]=true
}}l=0;
while(l<j){var d=l;
v=0;
while((l<j)&&!t[l++]){v++
}if(v>0){var s=this.getRow(d);
for(u=0;
u<s.length;
u++){var n=s[u];
n.rowSpan-=v;
if(n.rowSpan>1){e.setAttribute(n.cellDom,"rowspan",n.rowSpan)
}else{e.removeAttribute(n.cellDom,"rowspan")
}}}}for(l=this.rows.length-1;
l>=0;
l--){var g=this.rows[l];
if(g.childNodes.length==0){g.parentNode.removeChild(g);
this.rows.splice(l,1);
this.matrix.splice(l,1);
var m,w,i;
for(m=l;
m<this.matrix.length;
m++){i=this.matrix[m];
for(w=0;
w<i.length;
w++){if(i[w]){i[w].row--
}}}if(this.fullMatrix){this.fullMatrix.splice(l,1)
}}}}});
CUI.rte.TableMatrix.createEmptyCell=function(c,a){var b="td";
if(typeof(a)=="string"){b=a
}else{if(a){b=a.tagName
}}var d=c.createElement(b);
var e=CUI.rte.DomProcessor.createEmptyLinePlaceholder(c,false);
if(e){d.appendChild(e)
}return d
};
CUI.rte.TableMatrix.addCellPlaceholder=function(b,a){a.appendChild(b.createTextNode(CUI.rte.DomProcessor.NBSP))
};
CUI.rte.TableMatrix.createEmptyCellMarkup=function(){var a=CUI.rte.Common;
if(a.ua.isIE&&!a.ua.isIE11){return"<td></td>"
}return"<td><br "+a.BR_TEMP_ATTRIB+'="brEOB"></td>'
};
CUI.rte.ListUtils=function(){var a=CUI.rte.Common;
var b=CUI.rte.DomProcessor;
return{postprocessSelectedItems:function(h){var l=h.length;
for(var f=l-1;
f>=0;
f--){var g=h[f];
if(!g.isAncestor){var d=true;
var e=g.childNodes;
if(e){var i=e.length;
for(var j=0;
j<i;
j++){var k=e[j].dom;
if(!a.isTag(k,a.LIST_TAGS)){d=false;
break
}}}else{d=false
}if(d){h.splice(f,1)
}}}},createList:function(e,n,s){var d=CUI.rte.ListUtils;
if((n.length==1)&&a.isTag(n[0],a.TABLE_CELLS)){var l=e.createElement("div");
a.moveChildren(n[0],l);
n[0].appendChild(l);
n[0]=l
}var p=n.length;
for(var u=0;
u<p;
u++){if(a.isTag(n[u],"li")){var i=n[u].parentNode;
n[u]=i;
for(var j=0;
j<u;
j++){if(n[j]==i){n[u]=null;
break
}}}}var q=e.createElement(s);
p=n.length;
for(u=0;
u<p;
u++){var r=n[u];
if(r){var f=a.isTag(r,b.AUXILIARY_ROOT_TAGS);
if(!f){if(q.childNodes.length==0){r.parentNode.insertBefore(q,r)
}if(!a.isTag(r,a.LIST_TAGS)){var m=e.createElement("li");
q.appendChild(m);
a.moveChildren(r,m,0,true);
r.parentNode.removeChild(r)
}else{a.moveChildren(r,q,0,true);
r.parentNode.removeChild(r)
}}else{var g=[];
var k=r.childNodes.length;
for(var t=0;
t<k;
t++){var v=r.childNodes[t];
if(a.isTag(v,a.EDITBLOCK_TAGS)){g.push(v)
}else{if(a.isTag(a.BLOCK_TAGS)){}}}if(g.length==0){g.push(r)
}d.createList(e,g,s);
q=e.createElement(s)
}}}var h=q.previousSibling;
if(h&&a.isTag(h,s)){a.moveChildren(q,h,0,true);
q.parentNode.removeChild(q);
q=h
}var o=q.nextSibling;
if(o&&a.isTag(o,s)){a.moveChildren(o,q,0,true);
o.parentNode.removeChild(o)
}},convertListItem:function(e,i,f,d){var c=a.getChildIndex(i);
var j=i.parentNode;
var h=j.childNodes.length;
var k=b.createNode(e,f,d);
a.moveChildren(i,k);
j.removeChild(i);
if(c==0){j.parentNode.insertBefore(k,j)
}else{if(c==(h-1)){j.parentNode.insertBefore(k,j.nextSibling)
}else{var g=j.cloneNode(false);
a.moveChildren(j,g,c);
j.parentNode.insertBefore(g,j.nextSibling);
j.parentNode.insertBefore(k,g)
}}return k
},getItemForDom:function(c,d){while(d){if(a.isTag(d,"li")){return d
}d=a.getParentNode(c,d)
}return null
},getListForItem:function(e,d){d=CUI.rte.ListUtils.getItemForDom(e,d);
var c=(d?a.getParentNode(e,d):null);
if(c&&!a.isTag(c,a.LIST_TAGS)){c=null
}return c
},getTopListForItem:function(d,e){var c=null;
while(e){if(a.isTag(e,a.LIST_TAGS)){c=e
}e=a.getParentNode(d,e)
}return c
},getNestingLevel:function(d,e){var c=-1;
while(e){if(a.isTag(e,a.LIST_TAGS)){c++
}e=a.getParentNode(d,e)
}return c
},isTopLevelList:function(c,d){return(CUI.rte.ListUtils.getNestingLevel(c,d)==0)
},isFirstListItem:function(e,g){var d=CUI.rte.ListUtils;
var f=d.getTopListForItem(e,g);
if(f==null){return false
}var c=d.getItemForDom(e,g);
return(f.childNodes.length>0)&&(f.childNodes[0]==c)
},isLastListItem:function(e,h){var d=CUI.rte.ListUtils;
var f=d.getTopListForItem(e,h);
var g=a.getLastChild(f);
if(g==null){return false
}var c=a.getTagInPath(e,g,"li");
return(c==h)
},moveItemContent:function(e,d){while(e.childNodes.length>0){var c=e.childNodes[0];
e.removeChild(c);
d.appendChild(c)
}},hasItemContent:function(e){var f=e.childNodes.length;
for(var g=0;
g<f;
g++){var d=e.childNodes[g];
if(!a.isTag(d,a.LIST_TAGS)){return true
}}return false
},isListEmpty:function(e,d){if(d.childNodes.length==0){return true
}var h=d.childNodes.length;
for(var g=0;
g<h;
g++){var l=d.childNodes[g];
if(a.isTag(l,"li")){var j=l.childNodes.length;
for(var k=0;
k<j;
k++){var f=l.childNodes[k];
if(a.isTag(f,a.LIST_TAGS)){var m=CUI.rte.ListUtils.isListEmpty(e,f);
if(!m){return false
}}else{return false
}}if((a.ua.isIE&&j==0)){return false
}}}return true
},isItemEmpty:function(f,h){var e=CUI.rte.ListUtils;
h=e.getItemForDom(f,h);
var g=h.childNodes.length;
for(var i=0;
i<g;
i++){var d=h.childNodes[i];
if(a.isTag(d,a.LIST_TAGS)){if(!e.isListEmpty(f,d)){return false
}}else{return false
}}return true
},cleanUpList:function(e,d,f){var m=CUI.rte.ListUtils;
var h=d.childNodes.length;
for(var g=h-1;
g>=0;
g--){var n=d.childNodes[g];
var k=n.childNodes.length;
for(var l=k-1;
l>=0;
l--){var j=n.childNodes[l];
if(a.isTag(j,a.LIST_TAGS)){m.cleanUpList(e,j,f)
}}if(m.isItemEmpty(e,n)&&(a.isAttribDefined(n,m.REMOVAL_MARKER)||a.isAttribDefined(n,m.CLONED_MARKER))){d.removeChild(n)
}else{if(f){a.removeAttribute(n,m.REMOVAL_MARKER);
a.removeAttribute(n,m.CLONED_MARKER)
}}}if(m.isListEmpty(e,d)){d.parentNode.removeChild(d)
}},isSameType:function(d,c){if(d&&c){if(a.isTag(d,a.LIST_TAGS)){return(d.tagName.toLowerCase()==c.tagName.toLowerCase())
}}return false
},getNestedLists:function(e){var d=[];
var g=e.childNodes.length;
for(var h=0;
h<g;
h++){var f=e.childNodes[h];
if(a.isTag(f,a.LIST_TAGS)){d.push(f)
}}return d
},unlistItems:function(ac,w,H){var f=CUI.rte.ListUtils;
var v=w.length;
if(v==0){return
}var d=w[0];
var N=w[v-1];
var n=f.getTopListForItem(ac,d.parentNode);
var g=f.isFirstListItem(ac,d);
var p=f.isLastListItem(ac,N);
var T=null;
var K=n;
for(var X=0;
X<v;
X++){var A=ac.createElement("p");
var F=w[X];
a.setAttribute(F,f.REMOVAL_MARKER,"true");
var U=F.childNodes.length;
for(var Z=U-1;
Z>=0;
Z--){var x=F.childNodes[Z];
if(!a.isTag(x,a.LIST_TAGS)){F.removeChild(x);
a.insertBefore(A,x,A.firstChild)
}}if(g){a.insertBefore(n.parentNode,A,n);
T=n
}else{a.insertBefore(n.parentNode,A,K.nextSibling);
K=A
}b.fixEmptyEditingBlockIE(ac,A)
}var M=N.parentNode;
var S=a.getChildIndex(M);
var R=[];
if(f.getNestingLevel(ac,M)>0){var o=M.parentNode;
for(var V=S+1;
V<o.childNodes.length;
V++){R.push(o.childNodes[V])
}}if(!p&&!g){var O=null;
var C=false;
while(M){var E=M.cloneNode(false);
var L=ac.createElement("li");
a.setAttribute(L,f.CLONED_MARKER,"true");
if(O==null){O=L;
if(N.childNodes.length==0){C=true
}else{f.moveItemContent(N,O)
}}E.appendChild(L);
if(T){L.appendChild(T)
}T=E;
M=a.getParentNode(ac,M);
if(a.isTag(M,"li")){M=M.parentNode
}else{M=null
}}var Y=O.parentNode;
for(V=0;
V<R.length;
V++){var P=R[V];
P.parentNode.removeChild(P);
a.insertBefore(Y.parentNode,P,Y.nextSibling);
Y=P
}a.insertBefore(A.parentNode,T,A.nextSibling);
var h=N;
var j=O;
while(h){var t=a.getChildIndex(h);
var ad=h.parentNode;
var ab=j.parentNode;
for(Z=ad.childNodes.length-1;
Z>t;
Z--){var B=ad.childNodes[Z];
ad.removeChild(B);
K=(ab.childNodes.length>1?ab.childNodes[1]:null);
a.insertBefore(ab,B,K)
}if((j==O)&&C){ab.removeChild(j)
}h=a.getParentNode(ac,ad);
if(!a.isTag(h,"li")){h=null
}j=a.getParentNode(ac,ab)
}}f.cleanUpList(ac,n,false);
if((T!=null)&&(T!=n)){f.cleanUpList(ac,T,false)
}if(!p&&(T!=null)){var k=a.getFirstChild(T);
k=a.getTagInPath(ac,k,"li");
if(k){if(f.isTopLevelList(ac,k)&&f.isItemEmpty(ac,k)&&a.isAttribDefined(k,f.CLONED_MARKER)){k.parentNode.removeChild(k);
f.cleanUpList(ac,T,true)
}else{if(H){while(k){if(!f.hasItemContent(k)){a.insertBefore(k,ac.createTextNode(b.NBSP),k.firstChild)
}k=a.getParentNode(ac,k);
while(k&&!a.isTag(k,"li")){k=a.getParentNode(ac,k)
}f.cleanUpList(ac,T,true)
}}else{var u=[T];
K=T;
var aa=f.getListForItem(ac,k);
var s=f.getItemForDom(ac,aa);
if(s==null){return
}var J,W,q,I;
var y=f.getNestedLists(s);
while(K){var Q=y.length;
var z=y[0];
var r=f.getNestingLevel(ac,z);
if(r==0){break
}var D=f.getNestingLevel(ac,K);
var e=f.getListForItem(ac,z);
if(r==D){q=(a.isTag(K,"li")?K.parentNode:K);
for(W=0;
W<Q;
W++){J=y[W];
I=false;
if(W==(Q-1)){if(f.isSameType(J,q)){I=true
}}if(I){a.moveChildren(J,q,0,true)
}else{J.parentNode.removeChild(J);
a.insertBefore(q.parentNode,J,q.nextSibling);
q=J
}}break
}else{var G=y[Q-1];
N=G.childNodes[G.childNodes.length-1];
if(a.isTag(K,"li")){for(W=0;
W<Q;
W++){J=y[W];
J.parentNode.removeChild(J);
K.appendChild(J)
}}else{q=K;
for(W=0;
W<Q;
W++){J=y[W];
I=false;
if(W==(Q-1)){if(f.isSameType(J,q)){I=true
}}if(I){a.moveChildren(J,q)
}else{J.parentNode.removeChild(J);
a.insertBefore(q.parentNode,J,q);
u.push(J)
}}}K=N
}if(f.getNestingLevel(ac,e)==0){y=[e]
}else{y=f.getNestedLists(f.getItemForDom(ac,e))
}}for(W=0;
W<u.length;
W++){f.cleanUpList(ac,u[W],true)
}}}}}},isPositionBeforeNestedList:function(e,f,h){var d=b.getEditBlock(e,f);
if(!a.isTag(d,"li")){return false
}if(f.nodeType==3){var c=a.getNodeCharacterCnt(f);
if(c>0){if(h<c){return false
}}}else{if(a.isOneCharacterNode(f)){if(h!=0){return false
}}}var g=a.getNextNode(e,f);
return a.isTag(g,a.LIST_TAGS)&&(b.getEditBlock(e,g)==d)
},REMOVAL_MARKER:CUI.rte.Common.RTE_ATTRIB_PREFIX+"_invalid",CLONED_MARKER:CUI.rte.Common.RTE_ATTRIB_PREFIX+"_cloned"}
}();
CUI.rte.ListRepresentation=new Class({toString:"ListRepresentation",parentList:null,listDom:null,items:null,isCorrectHierarchy:false,construct:function(a,b){this.parentList=a;
this.items=[];
this.isCorrectHierarchy=b!==false
},fromList:function(b){var e=CUI.rte.Common;
this.items.length=0;
this.listDom=b;
var d=b.childNodes;
var g=d.length;
var a=null;
for(var h=0;
h<g;
h++){var f=d[h];
if(e.isTag(f,e.LIST_TAGS)){if(a==null){a=new CUI.rte.ListRepresentation.Item(this,this.listDom);
this.items.push(a)
}var i=new CUI.rte.ListRepresentation(this,false);
i.fromList(f);
a.addSubList(i)
}else{if(e.isTag(f,"li")){var j=new CUI.rte.ListRepresentation.Item(this,f);
this.items.push(j);
j.detectSubLists();
a=j
}}}},fromItem:function(c,b){var a=CUI.rte.ListUtils.getTopListForItem(c,b);
if(a==null){throw new Error("Could not detect list node.")
}this.fromList(a)
},getItemByDom:function(b){var d=this.items.length;
for(var a=0;
a<d;
a++){var c=this.items[a].getItemByDom(b);
if(c!=null){return c
}}return null
},getItemIndex:function(a){return CUI.rte.Common.arrayIndex(this.items,a)
},removeItem:function(c){var a=CUI.rte.Common;
var b=a.arrayIndex(this.items,c);
if(b>=0){this.items.splice(b,1)
}},insertItemAfter:function(b,a){if(a==null){this.items.splice(0,0,b);
return
}var c=this.getItemIndex(a);
if(c<0){throw new Error("Invalid insert item; reference must be in 'this' list.")
}this.items.splice(c+1,0,b)
},removeSubList:function(b){var g=this.items.length;
var d=false;
for(var e=0;
(e<g)&&!d;
e++){var a=this.items[e].subLists;
var f=a.length;
for(var c=0;
c<f;
c++){if(a[c]==b){a.splice(c,1);
d=true;
break
}else{d=a[c].removeSubList(b);
if(d){break
}}}}return d
},indent:function(b,a){var c=this.getItemByDom(a);
if(c==null){throw new Error("Could not determine item to indent.")
}c.indent(b)
},outdent:function(b,k){var c=CUI.rte.Common;
var g=k.length;
for(var f=0;
f<g;
f++){var l=this.getItemByDom(k[f]);
if(l==null){throw new Error("Could not determine item to outdent.")
}var d=l.outdent(b);
for(var h=0;
h<d.length;
h++){var j=d[h].itemDom;
var a=c.arrayIndex(k,j);
if(a>f){k.splice(a,1);
g--
}}}},ensureHierarchy:function(b){var d=this.items.length;
for(var a=0;
a<d;
a++){var c=this.items[a];
c.ensureHierarchy(b)
}},flatten:function(b,c){if(c==null){c=CUI.rte.ListUtils.getTopListForItem(b,this.listDom)
}var e=this.items.length;
for(var a=0;
a<e;
a++){var d=this.items[a];
d.flatten(b,c)
}this.listDom.parentNode.removeChild(this.listDom)
},createDump:function(a){if(a==null){a=0
}var c;
var b="";
for(c=0;
c<a;
c++){b+="   "
}var d=b+"List, type "+this.listDom.tagName+"; "+(this.isCorrectHierarchy?"correct hierarchy":"invalid hierarchy")+"\n";
d+=b+" parent: "+(this.parentList?"yes":"no")+"\n";
for(c=0;
c<this.items.length;
c++){d+=b+" Item #"+(c+1)+":\n";
d+=this.items[c].createDump(a+1)
}return d
}});
CUI.rte.ListRepresentation.Item=new Class({toString:"ListRepresentation.Item",list:null,itemDom:null,subLists:null,construct:function(b,a){this.list=b;
this.itemDom=a;
this.subLists=[]
},addSubList:function(a){this.subLists.push(a)
},detectSubLists:function(f){var b=CUI.rte.Common;
if(!f){f=this.itemDom
}if(b.isTag(f,b.LIST_TAGS)){var a=new CUI.rte.ListRepresentation(this.list,true);
a.fromList(f);
this.subLists.push(a)
}else{if(f.nodeType==1){var d=f.childNodes.length;
for(var e=0;
e<d;
e++){this.detectSubLists(f.childNodes[e])
}}}},getItemByDom:function(d){if(this.itemDom==d){return this
}var b=this.subLists.length;
for(var a=0;
a<b;
a++){var c=this.subLists[a].getItemByDom(d);
if(c!=null){return c
}}return null
},getPreviousItem:function(){var a=this.list.items;
var d=a.length;
for(var b=0;
b<d;
b++){var c=a[b];
if(c==this){if(b>0){return a[b-1]
}return null
}}return null
},flattenChildNodes:function(){var a=this.subLists.length;
var h=this.itemDom.parentNode;
var f=this.itemDom.nextSibling;
for(var b=0;
b<a;
b++){var g=this.subLists[b];
var e=g.items;
for(var d=0;
d<e.length;
d++){var j=e[d];
this.list.insertItemAfter(j,this);
j.list=this.list;
var c=j.itemDom.parentNode;
c.removeChild(j.itemDom);
if(c.childNodes.length==0){c.parentNode.removeChild(c)
}if(f){h.insertBefore(j.itemDom,f)
}else{h.appendChild(j.itemDom)
}}}this.subLists.length=0
},indent:function(d){var b=this.getPreviousItem();
if(b==null){return
}var c=b.subLists.length;
var f=this.list.getItemIndex(this);
this.list.items.splice(f,1);
if(c>0){var a=b.subLists[c-1];
this.itemDom.parentNode.removeChild(this.itemDom);
a.listDom.appendChild(this.itemDom);
a.items.push(this);
this.list=a;
this.flattenChildNodes();
return
}var e=d.createElement(this.list.listDom.tagName);
b.itemDom.appendChild(e);
this.itemDom.parentNode.removeChild(this.itemDom);
e.appendChild(this.itemDom);
var g=new CUI.rte.ListRepresentation(b.list,true);
b.addSubList(g);
g.listDom=e;
g.items.push(this);
this.list=g;
this.flattenChildNodes()
},outdent:function(h){var o=CUI.rte.Common;
var g=CUI.rte.ListUtils;
var f,w,r,B,z;
var t=[];
var G=o.getListLevel(h,this.itemDom);
if(G==1){f=this.subLists.length;
if(f>0){var x=this.itemDom.nextSibling;
var p;
var e;
if(x){p=x.parentNode;
e=x
}else{z=this.list.listDom;
p=h.createElement(z.tagName);
o.insertBefore(z.parentNode,p,z.nextSibling);
e=null
}for(w=0;
w<f;
w++){var j=this.subLists[w].items;
r=j.length;
if(r>0){B=j[0].itemDom;
t.push(j[0]);
o.insertBefore(p,B,e);
var c=j[0].list.listDom;
if(r==1){c.parentNode.removeChild(c)
}else{B.appendChild(c)
}}}}var n=g.convertListItem(h,this.itemDom,"p");
z=this.list.listDom;
if(z.childNodes.length==0){z.parentNode.removeChild(z)
}if(n.nextSibling&&o.isTag(n.nextSibling,o.LIST_TAGS)){this.list.fromList(n.nextSibling)
}}else{z=this.list.listDom;
var l=z.parentNode;
var u=this.list.parentList.getItemByDom(l);
var D=u.list.getItemIndex(u)+1;
var k=l.nextSibling;
var b=l.parentNode;
this.itemDom.parentNode.removeChild(this.itemDom);
if(k){b.insertBefore(this.itemDom,k)
}else{b.appendChild(this.itemDom)
}var E=this.list.getItemIndex(this);
var q=[];
for(var y=E+1;
y<this.list.items.length;
y++){q.push(this.list.items[y])
}this.list.removeItem(this);
if(this.list.items.length==0){z.parentNode.removeChild(z);
this.list.parentList.removeSubList(this.list)
}this.list=this.list.parentList;
if(D<this.list.items.length){this.list.items.splice(D,0,this)
}else{this.list.items.push(this)
}f=this.subLists.length;
if(f>0){for(w=0;
w<f;
w++){var v=this.subLists[w];
r=v.items.length;
if(r>0){t.push(v.items[0])
}if(r>1){var d=[];
for(var C=1;
C<r;
C++){d.push(v.items[C])
}for(C=0;
C<(r-1);
C++){d[C].indent(h)
}}}}if(q.length>0){var F=null;
var A=null;
if(this.subLists.length==0){F=h.createElement(this.list.listDom.tagName);
this.itemDom.appendChild(F);
A=new CUI.rte.ListRepresentation(this.list,true);
A.listDom=F;
this.subLists.push(A)
}else{A=this.subLists[this.subLists.length-1];
F=A.listDom
}for(y=0;
y<q.length;
y++){B=q[y];
var a=B.itemDom;
b=a.parentNode;
b.removeChild(a);
B.list.removeItem(B);
if(b.childNodes.length==0){b.parentNode.removeChild(b);
B.list.parentList.removeSubList(B.list)
}B.list=A;
F.appendChild(a);
A.items.push(B)
}}}return t
},ensureHierarchy:function(d){var b=CUI.rte.Common;
var g=CUI.rte.DomProcessor;
var f=this.subLists.length;
for(var a=0;
a<f;
a++){var h=this.subLists[a];
if(!h.isCorrectHierarchy){var e=this.itemDom;
if(b.isTag(e,b.LIST_TAGS)){e=d.createElement("li");
e.appendChild(d.createTextNode(g.NBSP));
this.itemDom.appendChild(e);
this.itemDom=e
}var c=h.listDom;
c.parentNode.removeChild(c);
e.appendChild(c);
h.isCorrectHierarchy=true
}h.ensureHierarchy(d)
}},flatten:function(b,a){var d=CUI.rte.Common;
var g=b.createElement("p");
a.parentNode.insertBefore(g,a);
var f=this.itemDom.childNodes.length;
for(var h=f-1;
h>=0;
h--){var i=this.itemDom.childNodes[h];
if(!d.isTag(i,["ol","ul"])){i.parentNode.removeChild(i);
g.insertBefore(i,g.firstChild)
}}var j=this.subLists.length;
for(var e=0;
e<j;
e++){this.subLists[e].flatten(b,a)
}this.subLists.length=0;
this.itemDom.parentNode.removeChild(this.itemDom)
},flattenToParent:function(e){var g=CUI.rte.Common;
var b=this.list.listDom;
var d=CUI.rte.DomProcessor.getAuxRootNode(e,b);
if(d==b.parentNode){this.outdent(e);
return
}this.flattenChildNodes();
var i;
var h=null;
var a=null;
if(this.itemDom.previousSibling){h=this.itemDom.previousSibling;
while(true){i=h.childNodes.length;
if(i==0){break
}if(!g.isTag(h.childNodes[i-1],g.LIST_TAGS)){break
}h=h.childNodes[i-1].lastChild
}}else{h=g.getParentNode(e,b);
a=b
}h.insertBefore(e.createElement("br"),a);
var f=this.itemDom.childNodes;
i=f.length;
for(var j=i-1;
j>=0;
j--){var k=f[j];
k.parentNode.removeChild(k);
h.insertBefore(k,a);
a=k
}b.removeChild(this.itemDom);
if(b.childNodes.length==0){this.list.parentList.removeSubList(this.list);
b.parentNode.removeChild(b)
}this.list.removeItem(this);
this.list=null
},createDump:function(a){var d=CUI.rte.Common;
if(a==null){a=0
}var e;
var c="";
for(e=0;
e<a;
e++){c+="   "
}var f=d.dumpNodeRecursively(this.itemDom,a);
for(var b=0;
b<this.subLists.length;
b++){f+=c+" Sub list #"+(b+1)+":\n";
f+=this.subLists[b].createDump(a+1)
}return f
}});
CUI.rte.CellSelection=new Class({toString:"CellSelection",tableMatrix:null,cells:null,selectionProps:null,construct:function(a){this.cells=[];
this.tableMatrix=a
},addCell:function(a){this.cells.push(a)
},expand:function(p,o){if(this.selectionProps==null){this.process()
}if(this.selectionProps==null){return
}if(this.tableMatrix.fullMatrix==null){this.tableMatrix.createFullMatrix()
}var m=CUI.rte.Common;
var B=[];
var f=this.selectionProps.minCol;
var j=this.selectionProps.minRow;
var n=this.selectionProps.maxColExcl;
var q=this.selectionProps.maxRowExcl;
var u,A,y,h,b;
if(p>0){for(u=0;
u<this.selectionProps.rows;
u++){for(h=0;
h<p;
h++){b=this.tableMatrix.fullMatrix[j+u][n+h];
if(b){b=b.cellRef;
if(!m.arrayContains(B,b)){B.push(b)
}}}}}if(o>0){for(A=0;
A<this.selectionProps.cols;
A++){for(y=0;
y<o;
y++){b=this.tableMatrix.fullMatrix[q+y][f+A];
if(b){b=b.cellRef;
if(!m.arrayContains(B,b)){B.push(b)
}}}}}var e=f;
var i=j;
var w=n+p;
var x=q+o;
var C=e;
var a=i;
var s=w;
var t=x;
var z=false;
while(!z){var l=B.length;
for(A=0;
A<l;
A++){var d=B[A];
var g=d.col+d.colSpan;
var k=d.row+d.rowSpan;
if(d.col<C){C=d.col
}if(g>s){s=g
}if(d.row<a){a=d.row
}if(k>t){t=k
}}if((C!=e)||(a!=i)||(s!=w)||(t!=x)){for(u=a;
u<t;
u++){for(A=C;
A<s;
A++){var v=this.tableMatrix.matrix[u][A];
if(v){if(!m.arrayContains(B,v)){B.push(v)
}}}}i=a;
e=C;
x=t;
w=s
}else{z=true
}}for(A=0;
A<B.length;
A++){this.cells.push(B[A])
}this.process()
},process:function(){if(!this.cells||(this.cells.length==0)){return
}var b={row:-1,col:-1};
var k={row:-1,col:-1};
var e=null;
var a=0;
for(var i=0;
i<this.cells.length;
i++){var g=this.cells[i];
if((g.col<b.col)||(b.col<0)){b.col=g.col
}if((g.row<b.row)||(b.row<0)){b.row=g.row
}var f=g.col+g.colSpan;
var h=g.row+g.rowSpan;
if(f>k.col){k.col=f
}if(h>k.row){k.row=h
}if((g.col==b.col)&&(g.row==b.row)){e=g
}a+=g.colSpan*g.rowSpan
}var j=k.col-b.col;
var l=k.row-b.row;
var d=j*l;
this.selectionProps={minRow:b.row,minCol:b.col,maxRowExcl:k.row,maxColExcl:k.col,cols:j,rows:l,isRect:(d==a),anchorCell:e}
}});
CUI.rte.SearchableDocument=new Class({toString:"SearchableDocument",plainText:null,plainTextLC:null,refs:null,findPos:0,currentSearch:0,config:null,createInternally:function(e){var a=CUI.rte.Common;
if(e.nodeType==3){var d=a.getNodeText(e);
if(d){this.refs.push({textPos:this.plainText.length,charCnt:d.length,nodeRef:e});
this.plainText+=d
}}else{if(e.nodeType==1){var f=(a.isTag(e,CUI.rte.SearchableDocument.WHITESPACE_TAGS)||a.isTag(e,a.EDITBLOCK_TAGS))&&(!a.strEndsWith(this.plainText," "));
if((this.plainText.length>0)&&f){this.refs.push({textPos:this.plainText.length,charCnt:1,nodeRef:e});
this.plainText+=" "
}var c=e.childNodes;
for(var b=0;
b<c.length;
b++){this.createInternally(c[b])
}}}},create:function(a){this.plainText="";
this.refs=[];
this.createInternally(a);
this.plainTextLC=this.plainText.toLowerCase()
},getRefForPosition:function(b){for(var c=0;
c<this.refs.length;
c++){var a=this.refs[c];
if((a.textPos>=b)&&((a.textPos+a.charCnt)<b)){return a
}}return null
},createMatch:function(d,b){var a=[];
var h=d+b-1;
var c=this.refs.length;
for(var e=0;
e<c;
e++){var f=this.refs[e];
var g=f.textPos+f.charCnt-1;
if(((f.textPos>=d)&&(f.textPos<=h))||((g>=d)&&(g<=h))||((f.textPos>=d)&&(g<=h))||((f.textPos<=d)&&(g>=h))){a.push({matchPos:d,matchChars:b,nodePos:f.textPos,nodeCharCnt:f.charCnt,node:f.nodeRef})
}else{if(a.length>0){return a
}}}return a
},getRefForNode:function(b){for(var a=0;
a<this.refs.length;
a++){if(this.refs[a].nodeRef==b){return this.refs[a]
}}return null
},find:function(b,a){this.config=a;
this.currentSearch=b;
this.findPos=a.startPos||0;
return this.findNext()
},findNext:function(){var a=(this.config.ignoreCase?this.plainTextLC:this.plainText);
var c=(this.config.ignoreCase?this.currentSearch.toLowerCase():this.currentSearch);
var b=a.indexOf(c,this.findPos);
if(b<0){this.findPos=0;
return null
}this.findPos=b+c.length;
return this.createMatch(b,c.length)
},adjustToReplace:function(a){this.findPos+=a.length-this.currentSearch.length
},createDump:function(){var a="Searchable text:\n"+this.plainText+"\n\n";
a+="References:\n"+CUI.rte.Common.dumpObject(this.refs);
return a
}});
CUI.rte.SearchableDocument.WHITESPACE_TAGS=["br","img"];
CUI.rte.Compatibility=function(){var a=CUI.rte.Common;
return{moveDeprecatedPluginConfig:function(c){var b=CUI.rte.Compatibility;
b.correctConfigOption(c,"defaultPasteMode","rtePlugins.edit.defaultPasteMode");
b.correctConfigOption(c,"stripHtmlTags","rtePlugins.edit.stripHtmlTags");
b.correctConfigOption(c,"tabSize","rtePlugins.keys.tabSize");
b.correctConfigOption(c,"trimLinkSelection","rtePlugins.links.trimLinkSelection");
b.correctConfigOption(c,"anchordialogConfig","rtePlugins.links.anchorDialogConfig");
b.correctConfigOption(c,"indentSize","rtePlugins.lists.indentSize");
b.correctConfigOption(c,"specialCharsConfig","rtePlugins.misctools.specialCharsConfig");
b.correctConfigOption(c,"formats","rtePlugins.paraformat.formats");
b.correctConfigOption(c,"cssStyles","rtePlugins.styles.styles");
b.correctConfigOption(c,"editMode","rtePlugins.table.editMode");
b.correctConfigOption(c,"rtePlugins.table.tablePropConfig.tableStyles","rtePlugins.table.tableStyles");
var e=b.getConfigValue(c,"rtePlugins.table.tableStyles");
if(e){e=b.convertToArray(e,"cssName","text");
b.changeDeprecatedPropertyName(e,"className","cssName");
b.setConfigValue(c,"rtePlugins.table.tableStyles",e)
}b.correctConfigOption(c,"rtePlugins.table.tablePropConfig.defaultValues","rtePlugins.table.defaultValues");
b.correctConfigOption(c,"rtePlugins.table.cellPropConfig.cellStyles","rtePlugins.table.cellStyles");
var d=b.getConfigValue(c,"rtePlugins.table.cellStyles");
if(d){d=b.convertToArray(d,"cssName","text");
b.changeDeprecatedPropertyName(d,"className","cssName");
b.setConfigValue(c,"rtePlugins.table.cellStyles",d)
}},moveDeprecatedHtmlRules:function(d){var c=CUI.rte.Compatibility;
var b=c.createFilteredConfig(d,"linkbrowseConfig",["cssInternal","cssExternal","protocols","defaultProtocol","targetConfig"],true);
var f=b[0];
if(f!=null){c.setConfigValue(d,"htmlRules.links",new CUI.rte.HtmlRules.Links(f))
}var e=b[1];
if(e!=null){c.setConfigValue(d,"rtePlugins.links.linkDialogConfig",e)
}c.correctConfigOption(d,"removeSingleParagraphContainer","htmlRules.blockHandling.removeSingleParagraphContainer");
c.correctConfigOption(d,"singleParagraphContainerReplacement","htmlRules.blockHandling.singleParagraphContainerReplacement")
},createFilteredConfig:function(b,j,h,f){var i=CUI.rte.Compatibility;
var d=i.getConfigValue(b,j);
if(d==null){return[null,null]
}if(h==null){return[d,null]
}if(f){i.filterJcrLeftovers(d)
}var g={};
var c=null;
for(var e in d){if(a.arrayContains(h,e)){g[e]=d[e]
}else{if(c==null){c={}
}c[e]=d[e]
}}return[g,c]
},filterJcrLeftovers:function(b){if(b["jcr:primaryType"]){delete b["jcr:primaryType"]
}if(b.xtype&&(b.xtype=="nt:unstructured")){delete b.xtype
}},correctConfigOption:function(c,f,e){var b=CUI.rte.Compatibility;
var d=b.getConfigValue(c,f);
if(d!=null){b.setConfigValue(c,e,d);
b.removeConfigValue(c,f)
}},getConfigValue:function(b,f){var e=b;
var d=f.split(".");
for(var c=0;
c<d.length;
c++){e=e[d[c]];
if(e==null){return null
}}return e
},setConfigValue:function(b,i,d){var h=b;
var g=i.split(".");
var c=g.length;
if(c==0){return
}for(var f=0;
f<(c-1);
f++){var e=h;
h=h[g[f]];
if(h==null){h={};
e[g[f]]=h
}}h[g[c-1]]=d
},removeConfigValue:function(b,g){var f=b;
var e=g.split(".");
var c=e.length;
if(c==0){return
}for(var d=0;
d<(c-1);
d++){f=f[e[d]];
if(f==null){return
}}delete f[e[c-1]]
},configurePlugins:function(g,b,c){var o=function(s,q){var f=false;
var r=null;
if(s=="format"){f=g.enableFormat;
r=g.formatButtons
}else{if(s=="alignments"){f=g.enableAlignments;
r=g.alignmentButtons
}else{if(s=="lists"){f=g.enableLists;
r=g.listButtons
}else{if(s=="links"){f=g.enableLinks;
r=g.linkButtons
}else{if(s=="edit"){f=g.enableEditTools;
r=g.editToolButtons
}}}}}var p=(f===undefined?undefined:false);
if(f){if(r){p=!!r[q]
}else{p=true
}}return p
};
var h=function(f,q){var p=f;
switch(f){case"format":break;
case"justify":p="alignments";
q=q.substring(7,q.length);
break;
case"lists":break;
case"subsuperscript":return g.enableSubSuperScript;
case"links":if(q=="modifylink"){q="createlink"
}break;
case"paraformat":return g.enableParagraphFormat;
case"styles":return g.enableStyle;
case"misctools":if(q=="sourceedit"){return g.enableSourceEdit
}if(q=="specialchars"){return g.enableSpecialChars
}break
}return o(p,q)
};
var l=g.rtePlugins;
for(var i in b.registeredPlugins){if(b.registeredPlugins.hasOwnProperty(i)){var j=b.registeredPlugins[i];
var e={};
var d=j.getFeatures();
var n=d.length;
for(var k=0;
k<n;
k++){var m=undefined;
if(c){m=c(i,d[k])
}if(m===undefined){m=h(i,d[k])
}if(m!==undefined){if(!e.features){e.features=[]
}if(m){e.features.push(d[k])
}}}if(l&&l[i]){CUI.rte.Utils.apply(e,l[i])
}if(g.externalStyleSheets&&j.pluginId=="fullscreen"){e.externalStyleSheets=g.externalStyleSheets
}j.notifyPluginConfig(e)
}}},convertToArray:function(g,b,d){if(!g){return null
}a.removeJcrData(g);
if(CUI.rte.Utils.isArray(g)){return g
}var h=[];
var e;
for(var c in g){if(g.hasOwnProperty(c)){var f=g[c];
if(typeof(f)=="object"){if(f[b]&&f[d]){h.push(f)
}else{e={};
e[b]=c;
e[d]=f;
h.push(e)
}}else{e={};
e[b]=c;
e[d]=f;
h.push(e)
}}}return h
},changeDeprecatedPropertyName:function(g,c,b){if(g==null){return
}var f=g.length;
for(var d=0;
d<f;
d++){var e=g[d];
if(e.hasOwnProperty(c)){if(!e.hasOwnProperty(b)){e[b]=e[c];
delete e[c]
}}}},adjustRegExp:function(e,g,b){if(e[g]==null){e[g]=b
}else{if(CUI.rte.Utils.isString(e[g])){var f=e[g];
var d=undefined;
if(a.strStartsWith(f,"/")){var c=f.lastIndexOf("/");
if(c>0){if(c<(f.length-1)){d=f.substring(c+1,f.length)
}f=f.substring(1,c)
}}e[g]=(f.length==0?null:new RegExp(f,d))
}}}}
}();
CUI.rte.HtmlRules=new Class({toString:"HtmlRules",links:null,serializer:null,docType:null,blockHandling:null,construct:function(b){b=b||{};
var a=CUI.rte.HtmlRules;
this.links=new a.Links(b.links);
this.serializer=new a.Serializer(b.serializer);
this.docType=new a.DocType(b.docType);
this.blockHandling=new a.BlockHandling(b.blockHandling);
delete b.links;
delete b.serializer;
delete b.docType;
delete b.blockHandling;
CUI.rte.Utils.apply(this,b)
}});
CUI.rte.HtmlRules.removePrefixForInternalLinks=function(c,f){var h=location.href;
var d=CUI.rte.Utils.getServerPrefix(h)+"/";
var b=d.length;
if(c.length>b){if(c.substring(0,b)==d){var e=false;
var a=false;
if(c.length>h.length){if(c.substring(0,h.length)==h){var g=c.charAt(h.length);
switch(g){case"?":a=true;
e=true;
break;
case"#":e=true;
break
}}}if(e&&!a){c=c.substring(h.length,c.length)
}else{c=c.substring(b-1,c.length)
}}}return c
};
CUI.rte.HtmlRules.Links=new Class({toString:"HtmlRules.Links",cssMode:null,cssInternal:null,cssExternal:null,protocols:null,defaultProtocol:null,targetConfig:null,ensureInternalLinkExt:false,relativeLinkRegExp:null,construct:function(a){a=a||{};
var b={cssMode:"auto",protocols:["http://","https://","ftp://","mailto:"],targetConfig:{mode:"blank"},ensureInternalLinkExt:true};
CUI.rte.Utils.applyDefaults(a,b);
CUI.rte.Utils.apply(this,a);
CUI.rte.Compatibility.adjustRegExp(this,"relativeLinkRegExp",CUI.rte.HtmlRules.Links.REL_LINK_DEFAULT_REGEXP)
},getProtocol:function(a){if(this.protocols){var b=this.protocols.length;
for(var c=0;
c<b;
c++){var d=this.protocols[c];
if(CUI.rte.Common.strStartsWith(a,d)){return d
}}}return null
},hasProtocol:function(a){return CUI.rte.HtmlRules.Links.hasProtocol(a)
},isInternalLink:function(a){return CUI.rte.HtmlRules.Links.isInternalLink(a)
},isRelativeLink:function(a){return CUI.rte.HtmlRules.Links.isRelativeLink(a,this.relativeLinkRegExp)
},validateHref:function(a){var b=this.getProtocol(a);
if(b){return true
}if(this.isInternalLink(a)){return true
}if(this.isRelativeLink(a)){return true
}if(this.hasProtocol(a)){return false
}return !!(a&&(a.length>0))
},applyToObject:function(i){var d=CUI.rte.Common;
var o=(i.nodeType&&(i.nodeType==1));
var c;
if(o){c=CUI.rte.HtmlRules.Links.getLinkHref(i)
}else{c=i.href||""
}var n=this.cssMode;
if(n=="auto"){if((this.cssInternal!=null)||(this.cssExternal!=null)){n="replace"
}else{n="keep"
}}if(n=="remove"){if(o){d.removeAttribute(i,"class")
}else{i.cssClass=null
}}else{if(n=="replace"){var q=null;
if(this.cssInternal&&this.isInternalLink(c)){q=this.cssInternal
}if(this.cssExternal&&!this.isInternalLink(c)){q=this.cssExternal
}if(o){if(q!=null){d.setAttribute(i,"class",q)
}else{d.removeAttribute(i,"class")
}}else{i.cssClass=q
}}}if(this.targetConfig){switch(this.targetConfig.mode){case"none":if(o){d.removeAttribute(i,"target")
}else{i.target=null
}break;
case"auto":var k=(this.isInternalLink(c)?this.targetConfig.targetInternal:this.targetConfig.targetExternal);
if(o){if(k!=null){d.setAttribute(i,"target",k)
}else{d.removeAttribute(i,"target")
}}else{i.target=k
}break
}}if(this.isInternalLink(c)||this.isRelativeLink(c)){var b=c.indexOf("#");
if(b==0){return
}if(this.ensureInternalLinkExt&&this.isPage(c)){var h="";
if(b>0){h=c.substring(b,c.length);
c=c.substring(0,b)
}var l="";
var j=c.indexOf("?");
if(j>0){l=c.substring(j,c.length);
c=c.substring(0,j)
}var e=c.lastIndexOf(".");
var g=c.lastIndexOf("/");
var a=(g==(c.length-1));
if(((e<=0)||(e<g))&&!a){i.href=c+CUI.rte.Constants.EXTENSION_HTML+l+h
}}}else{if((this.getProtocol(c)==null)&&!this.hasProtocol(c)){if(this.isPage(c)){}else{var f=c.indexOf("/");
var m=(f>0?c.substring(0,f):c);
if(CUI.rte.HtmlRules.Links.PROBABLE_HOST_REGEXP.test(m)){var p=this.defaultProtocol||"http://";
i.href=p+c
}else{}}}}},isPage:function(a){var b;
if(this.isRelativeLink(a)){b=CUI.rte.Utils.resolveRelativePath(a)
}else{if(this.isInternalLink(a)){b=a
}}if(!b){return false
}else{if(b.indexOf("?")>=0){b=b.substring(0,b.indexOf("?"))
}else{if(b.indexOf("#")>=0){b=b.substring(0,b.indexOf("#"))
}}}return CUI.rte.Utils.isExistingPage(b)
}});
CUI.rte.HtmlRules.Links.PROBABLE_HOST_REGEXP=/^(localhost)|([\w\d\-\u0081-\uffff]+\.[\w\d\-\u0081-\uffff]+\.[\w\d\-\u0081-\uffff]+)$/;
CUI.rte.HtmlRules.Links.hasProtocol=function(a){return/^[A-Za-z][A-Za-z\d+\-.]*:(\/\/)?([^\d]|[\d]+@|$)/.test(a)
};
CUI.rte.HtmlRules.Links.isInternalLink=function(a){return a&&(a.length>0)&&((a.charAt(0)=="/")||(a.charAt(0)=="#"))
};
CUI.rte.HtmlRules.Links.isRelativeLink=function(a,b){if(!b){return false
}return b.test(a)
};
CUI.rte.HtmlRules.Links.REL_LINK_DEFAULT_REGEXP=/^\.{1,2}\/(.*)/;
CUI.rte.HtmlRules.Links.getLinkHref=function(c){var b=CUI.rte.Common;
var a;
if(b.isAttribDefined(c,b.HREF_ATTRIB)){a=b.getAttribute(c,b.HREF_ATTRIB)
}else{a=b.getAttribute(c,"href");
if(a){a=CUI.rte.HtmlRules.removePrefixForInternalLinks(a,CUI.rte.Utils.URL_LINK)
}}return a
};
CUI.rte.HtmlRules.Links.removePrefixForInternalLinks=function(a){return CUI.rte.HtmlRules.removePrefixForInternalLinks(a,CUI.rte.Utils.URL_LINK)
};
CUI.rte.HtmlRules.Serializer=new Class({toString:"HtmlRules.Serializer",mode:null,config:null,serializer:null,deserializer:null,construct:function(a){a=a||{};
CUI.rte.Utils.applyDefaults(a,{mode:"auto",config:null,serializer:null,deserializer:null});
CUI.rte.Utils.apply(this,a)
},serialize:function(a,b,c){if(this.serializer==null){switch(this.mode){case"auto":if(c.baseType=="html"){this.serializer=new CUI.rte.HtmlSerializer(this.config)
}else{if(c.baseType=="xhtml"){this.serializer=new CUI.rte.XhtmlSerializer(this.config)
}}break;
case"customized":throw new Error("Using 'customized' serialization, but no custonized serializing object configured (use 'serializer' config option)");
break;
default:throw new Error("Invalid serialization mode: '"+this.mode+"'");
break
}}return this.serializer.serialize(a,b)
},deserialize:function(b,a,c,d){if(this.deserializer==null){switch(this.mode){case"auto":if(d.baseType=="html"){this.deserializer=new CUI.rte.HtmlDeserializer(this.config)
}else{if(d.baseType=="xhtml"){this.deserializer=new CUI.rte.XhtmlDeserializer(this.config)
}}break;
case"customized":throw new Error("Using 'customized' serialization, but no custonized deserializing object configured (use 'deserializer' config option)");
break;
default:throw new Error("Invalid serialization mode: '"+this.mode+"'");
break
}}return this.deserializer.deserialize(b,a,c)
}});
CUI.rte.HtmlRules.DocType=new Class({toString:"HtmlRules.DocType",baseType:null,version:null,typeConfig:null,tagBlacklist:null,construct:function(a){a=a||{};
CUI.rte.Utils.applyDefaults(a,{baseType:"html",version:"4.0",typeConfig:{useSemanticMarkup:false,semanticMarkupMap:{b:"strong",i:"em"}}});
CUI.rte.Utils.apply(this,a);
if((this.baseType!="html")&&(this.baseType!="xhtml")){throw new Error("Invalid doctype; must be 'html' or 'xhtml'")
}this.tagBlackList=[];
if(this.baseType=="html"){if(this.version!="4.0"){throw new Error("Invalid version; must be '4.0' for doctype 'html'.")
}}if(this.baseType=="xhtml"){if(this.version!="1.0"){throw new Error("Invalid version; must be '1.0' for doctype 'xhtml'.")
}if(this.typeConfig.isXhtmlStrict){this.tagBlackList.push("u")
}}},isAllowed:function(a){return !CUI.rte.Common.arrayContains(this.tagBlackList,a.toLowerCase())
},convertToPhysicalStyle:function(c){var b=this.typeConfig.semanticMarkupMap;
if(!b){return null
}c=c.toLowerCase();
for(var a in b){if(b.hasOwnProperty(a)){if(b[a]==c){return a
}}}return null
},convertToSemanticMarkup:function(a){if(!this.typeConfig.semanticMarkupMap){return null
}a=a.toLowerCase();
if(this.typeConfig.semanticMarkupMap.hasOwnProperty(a)){return this.typeConfig.semanticMarkupMap[a]
}return null
},adjustToDocType:function(a){if(this.typeConfig.useSemanticMarkup){var b=this.convertToSemanticMarkup(a);
if(b!=null){return(this.isAllowed(b)?b:"")
}}if(!this.isAllowed(a)){return""
}return null
},adjustToRaw:function(a){return this.convertToPhysicalStyle(a)
}});
CUI.rte.HtmlRules.BlockHandling=new Class({toString:"HtmlRules.BlockHandling",defaultEditBlockType:null,removeSingleParagraphContainer:false,singleParagraphContainerReplacement:null,construct:function(a){a=a||{};
CUI.rte.Utils.applyDefaults(a,{defaultEditBlockType:"p",removeSingleParagraphContainer:false,singleParagraphContainerReplacement:"div"});
CUI.rte.Utils.apply(this,a)
}});
CUI.rte.Serializer=new Class({toString:"Serializer",serialize:function(a,b){return""
}});
CUI.rte.HtmlSerializer=new Class({toString:"HtmlSerializer",extend:CUI.rte.Serializer,context:null,deepestChildAddHtml:null,nonClosingTags:null,tagCase:null,attribNameCase:null,styleAttribNameCase:null,idAttribMode:null,beautifier:null,construct:function(a){this._init(a)
},_init:function(a){a=a||{};
CUI.rte.Utils.applyDefaults(a,{nonClosingTags:CUI.rte.HtmlSerializer.NON_CLOSING_TAGS,tagCase:"lower",attribNameCase:"lower",styleAttribNameCase:"lower",idAttribMode:"keep",beautifier:CUI.rte.HtmlSerializer.defaultBeautifier});
CUI.rte.Utils.apply(this,a)
},getAttribValue:function(d,c){var a=CUI.rte.Common;
if(a.ua.isIE6||a.ua.isIE7){var b=c.toLowerCase();
if(CUI.rte.Common.isTag(d,"a")&&(b=="name")){return d.attributes.name.nodeValue
}}return a.ua.isOldIE?d.getAttribute(c,2):d.getAttribute(c)
},ignoreAttribute:function(c){var a=CUI.rte.Common;
var b=c.nodeName.toLowerCase();
if((b=="id")&&(this.idAttribMode=="remove")){return true
}return a.arrayContains(CUI.rte.HtmlSerializer.HELPER_ATTRIBUTES,b)
},adjustCase:function(b,a){switch(a){case"upper":b=b.toUpperCase();
break;
case"lower":b=b.toLowerCase();
break
}return b
},createTagStr:function(a){return this.adjustCase(a.tagName,this.tagCase)
},serializeAttribute:function(c,f){c=this.adjustCase(c,this.attribNameCase);
var b=c.toLowerCase();
if((b=="style")&&(this.styleAttribNameCase!="keep")){var e=CUI.rte.HtmlProcessor.parseStyleDef(f);
f="";
for(var d in e){if(e.hasOwnProperty(d)){var a=e[d];
if(a&&(a.length>0)){if(f.length>0){f+=" "
}d=this.adjustCase(d,this.styleAttribNameCase);
f+=d+": "+a+";"
}}}}if((f==null)||(f.length==0)){return""
}if((b=="colspan")||(b=="rowspan")){if(parseInt(f)==1){return""
}}return c+'="'+CUI.rte.Utils.htmlEncode(f)+'"'
},serializeAttributes:function(g){var c=CUI.rte.Common;
var s=(c.ua.isGecko?c.FILTER_GECKO_TEMPORARY_ATTRIBS:null);
var b=c.getAttributeNames(g,true,s);
var q=b.length;
var l="";
var e=true;
for(var r=0;
r<q;
r++){var h=g.attributes.getNamedItem(b[r]);
if(!this.ignoreAttribute(h)){var o=h.nodeName;
var n=o.toLowerCase();
var j=this.getAttribValue(g,o);
if(!j){if(n=="style"){j=g.style.cssText
}else{if(n=="class"){j=g.className
}}}var d=g.tagName.toLowerCase();
var k=CUI.rte.HtmlSerializer.HELPER_ATTRIB_MAPPINGS[d];
if(k){for(var f=0;
f<k.length;
f+=2){var i=k[f];
if(n==i){j=this.getAttribValue(g,k[f+1]);
break
}}}var p=this.serializeAttribute(o,j);
if(p.length>0){if(!e){l+=" "
}else{e=false
}l+=p
}}}return l
},serializeTextNode:function(b){var a=CUI.rte.Utils.htmlEncode(b.nodeValue);
return a.replace(/\u00A0/g,"&nbsp;")
},serializeNodeEnter:function(d){var a=CUI.rte.Common;
if(d.nodeType==3){return this.serializeTextNode(d)
}var b="<"+this.createTagStr(d);
var c=this.serializeAttributes(d);
if(c.length>0){b+=" "+c
}b+=">";
if(a.isTag(d,"pre")){b+="\n"
}if(a.isEmptyEditingBlock(d,true)){this.deepestChildAddHtml="&nbsp;"
}if(this.deepestChildAddHtml!=null){if(d.childNodes.length==0){b+=this.deepestChildAddHtml;
this.deepestChildAddHtml=null
}}return b
},serializeNodeLeave:function(c){if(c.nodeType==3){return""
}var a=CUI.rte.Common;
var b="";
if(!a.isTag(c,this.nonClosingTags)){b="</"+this.createTagStr(c)+">";
if(a.isTag(c,"pre")){b="\n"+b
}}return b
},serializeSubTree:function(g){var e=this.beautifier(this.context,g,true);
var b="";
var a=this.serializeNodeEnter(g);
if(e){if(e.before){b=e.before
}b+=a;
if(e.after){b+=e.after
}}else{b=a
}var d=g.childNodes.length;
for(var h=0;
h<d;
h++){b+=this.serializeSubTree(g.childNodes[h])
}a=this.serializeNodeLeave(g);
var f=this.beautifier(this.context,g,false);
if(f){if(f.before){b+=f.before
}b+=a;
if(f.after){b+=f.after
}}else{b+=a
}return b
},serialize:function(b,e){this.context=b;
this.deepestChildAddHtml=null;
var a="";
var d=e.childNodes.length;
for(var f=0;
f<d;
f++){a+=this.serializeSubTree(e.childNodes[f])
}return a
}});
CUI.rte.HtmlSerializer.NON_CLOSING_TAGS=["br","hr","img","area","input","col"];
CUI.rte.HtmlSerializer.HELPER_ATTRIBUTES=[CUI.rte.Common.HREF_ATTRIB,CUI.rte.Common.SRC_ATTRIB];
CUI.rte.HtmlSerializer.HELPER_ATTRIB_MAPPINGS={a:["href",CUI.rte.Common.HREF_ATTRIB],img:["src",CUI.rte.Common.SRC_ATTRIB]};
CUI.rte.HtmlSerializer.defaultBeautifier=function(c,f,d){var a=CUI.rte.Common;
if(a.isTag(f,a.BLOCK_TAGS)){if(d){if(!a.isTag(f,a.EDITBLOCK_TAGS)){return{before:null,after:"\n"}
}}else{return{before:null,after:"\n"}
}return null
}if(a.isTag(f,a.EDITBLOCK_TAGS)){if(!d){return{before:null,after:"\n"}
}return null
}if(a.isTag(f,"br")){if(!d){if(!a.ua.isIE){var b=a.getTagInPath(c,f,a.EDITBLOCK_TAGS);
if(b){var e=a.getCharacterNodes(b);
if(e.length==1){return null
}}}return{before:null,after:"\n"}
}}return null
};
CUI.rte.XhtmlSerializer=new Class({toString:"XhtmlSerializer",extend:CUI.rte.HtmlSerializer,useShortTags:false,_init:function(a){a=a||{};
delete a.tagCase;
delete a.attribNameCase;
delete a.nonClosingTags;
CUI.rte.Utils.applyDefaults(a,{tagCase:"lower",attribNameCase:"lower",useShortTags:false,nonClosingTags:[]});
this.inherited(arguments)
},isShortTag:function(b){var a=CUI.rte.Common;
if(a.isTag(b,"a")&&a.isAttribDefined(b,"name")){return false
}return(b.childNodes.length==0)
},serializeNodeEnter:function(e){var a=CUI.rte.Common;
if(e.nodeType==1){if(this.useShortTags&&this.isShortTag(e)){var d=a.getNamespace(e);
if(a.isTag(e,a.VOID_TAGS)||d==="math"||d==="svg"){var b="<"+this.createTagStr(e);
var c=this.serializeAttributes(e);
if(c.length>0){b+=" "+c
}if(this.deepestChildAddHtml!=null){b+=">"+this.deepestChildAddHtml;
b+="</"+this.createTagStr(e)+">"
}else{b+=" />"
}return b
}}}return this.inherited(arguments)
},serializeNodeLeave:function(c){var a=CUI.rte.Common;
if(c.nodeType==1){var b=a.getNamespace(c);
if(a.isTag(c,a.VOID_TAGS)||b==="math"||b==="svg"){if(this.useShortTags&&this.isShortTag(c)){return""
}}}return this.inherited(arguments)
}});
CUI.rte.Deserializer=new Class({toString:"Deserializer",deserialize:function(b,a,c){}});
CUI.rte.HtmlDeserializer=new Class({toString:"HtmlDeserializer",extend:CUI.rte.Deserializer,construct:function(a){this._init(a)
},_init:function(){},duplicateReferences:function(b){var e=CUI.rte.HtmlDeserializer.DUPLICATE_RULES;
var a=e.length;
for(var c=0;
c<a;
c++){var d=e[c];
b=b.replace(d[0],d[1])
}return b
},deserialize:function(b,a,c){a=this.duplicateReferences(a);
c.innerHTML=a
}});
CUI.rte.HtmlDeserializer.DUPLICATE_RULES=[[/(<a[^>]*?href=")([^"]*?)(")((.|\n|\r)*?>)/gi,"$1$2$3 "+CUI.rte.Common.HREF_ATTRIB+'="$2"$4'],[/(<a[^>]*?href=')([^']*?)(')((.|\n|\r)*?>)/gi,"$1$2$3 "+CUI.rte.Common.HREF_ATTRIB+'="$2"$4'],[/(<img[^>]*?src=")([^"]*?)(")((.|\n|\r)*?>)/gi,"$1$2$3 "+CUI.rte.Common.SRC_ATTRIB+'="$2"$4']];
CUI.rte.XhtmlDeserializer=new Class({toString:"XhtmlDeserializer",extend:CUI.rte.HtmlDeserializer,_init:function(){this.inherited(arguments);
var b=CUI.rte.HtmlSerializer.NON_CLOSING_TAGS;
var a="<\\/(";
for(var c=0;
c<b.length;
c++){if(c>0){a+="|"
}a+=b[c]
}a+=")>";
this.regExp=new RegExp(a,"gi")
},expandShortTags:function(c){var a=CUI.rte.XhtmlDeserializer;
var b=c.replace(a.EXPAND_SHORT_XHTML,a.XHTML_EXPANSION_REPLACEMENT);
return b.replace(this.regExp,"")
},deserialize:function(a,c,b){c=this.expandShortTags(c);
c=this.duplicateReferences(c);
b.innerHTML=c
}});
CUI.rte.XhtmlDeserializer.EXPAND_SHORT_XHTML=/<([^\/][^\n\r\t >]*)([^>]*)(\/>)/gi;
CUI.rte.XhtmlDeserializer.XHTML_EXPANSION_REPLACEMENT="<$1$2></$1>";
CUI.rte.DomCleanup=new Class({toString:"DomCleanup",tagsToRemove:null,pasteRules:null,editorKernel:null,context:null,htmlRules:null,processingMode:null,elementsToRemove:null,subTreesToRemove:null,elementsToChange:null,elementsToInsert:null,emptyBlocksIE:null,construct:function(a){CUI.rte.Utils.apply(this,a)
},markForRemoval:function(a){if(!CUI.rte.Common.arrayContains(this.elementsToRemove,a)){this.elementsToRemove.push(a)
}},markSubTreeForRemoval:function(a){this.subTreesToRemove.push(a)
},markForInsertion:function(c,b,a){this.elementsToInsert.push({domToInsert:c,parentDom:b,refDom:a})
},isPreProcessing:function(){var a=CUI.rte.DomCleanup;
return(this.processingMode==a.PASTE_PREPARE)||(this.processingMode==a.PRE)
},flattenNestedStructure:function(i,l,k){var e=CUI.rte.Common;
var b=null;
var d=i.parentNode;
var a=i.nextSibling;
var j=this.pasteRules.fallbackBlockTag||"p";
var p=e.getTags(i,l);
var o=p.length;
for(var f=0;
f<o;
f++){var g=p[f];
var h=this.context.createElement(j);
if(b==null){b=h
}e.insertBefore(d,h,a);
var c=g.childNodes;
while(c.length>0){var m=c[0];
if(!e.isTag(m,k)){h.appendChild(m)
}}}i.parentNode.removeChild(i);
return b
},isValidSubTree:function(g){var b=CUI.rte.Common;
var f=true;
var h=b.getAttribute(g,b.TEMP_EL_ATTRIB,true);
if(h){var a=h.split(":");
var e=b.arrayContains(a,"keepChildren");
var d=b.arrayContains(a,"emptyOnly");
if(!e){if(d){function c(k){if(k.nodeType===3){return false
}var j=k.childNodes.length;
if(j===0){return true
}for(var n=0;
n<j;
n++){var m=k.childNodes[n];
var l=b.getAttribute(k,b.TEMP_EL_ATTRIB,true);
if(!l){return false
}var i=l.split(":");
if(b.arrayContains(i,"emptyOnly")){if(!c(m)){return false
}}else{return false
}}return true
}if(c(g)){f=false
}else{b.removeAttribute(g,b.TEMP_EL_ATTRIB)
}}else{f=false
}}}return f
},isValidElement:function(f){var b=CUI.rte.Common;
var c=f.tagName.toLowerCase();
var d=b.getNamespace(f);
if(d!=null){return false
}if((f.nodeType===1)&&b.strStartsWith(f.tagName,"/")){return false
}if(this.tagsToRemove){if(b.arrayContains(this.tagsToRemove,c)){return false
}}if(b.isTag(f,"span")&&b.isAttribDefined(f,"_rtetemp")){return false
}var g=b.getAttribute(f,b.TEMP_EL_ATTRIB,true);
if(g){var a=g.split(":");
var e=b.arrayContains(a,"keepChildren");
if(e){return false
}}return true
},handlePreformattedSection:function(f){var c=this.context;
var b=CUI.rte.Common;
if(this.isPreProcessing()){if(b.isTag(f,"pre")){var e=function(j){var g=j.parentNode;
if(j.nodeType==3){var h=j.nodeValue;
h=h.replace(/\r\n/g,"\n");
h=h.replace(/\r/g,"\n");
do{var l=h.indexOf("\n");
if(l>=0){if(l>0){g.insertBefore(c.createTextNode(h.substring(0,l)),j)
}g.insertBefore(c.createElement("br"),j);
h=h.substring(l+1,h.length)
}}while(l>=0);
if(h.length==0){g.removeChild(j)
}else{j.nodeValue=h
}}else{if(j.nodeType==1){var i=j.childNodes.length;
for(var k=i-1;
k>=0;
k--){e(j.childNodes[k])
}}}};
e(f);
var a=b.getLastTextChild(f,true,false);
if(b.isTag(a,"br")){var d=b.getPreviousCharacterNode(c,a,b.EDITBLOCK_TAGS);
if(b.isTag(d,"br")){if(b.ua.isGecko||b.ua.isWebKit||b.ua.isIEBRPlaceholder){b.setAttribute(a,b.BR_TEMP_ATTRIB,"brEOB")
}else{if(b.ua.isIE){a.parentNode.removeChild(a);
CUI.rte.DomProcessor.fixEmptyLinefeedIE(c,d)
}}}else{a.parentNode.removeChild(a)
}}}}else{if(b.isTag(f,"br")&&b.getTagInPath(this.context,f,"pre")){this.elementsToChange.push({domToChange:f,changedDom:this.context.createTextNode("\n")})
}}},handleEmptyLinesAtEOB:function(d){var b=CUI.rte.Common;
var i=CUI.rte.DomProcessor;
var j;
if(this.isPreProcessing()){var k=b.getNodeText(d);
if((k==i.NBSP)&&i.isBlockEnd(this.context,d)){if(b.ua.isWebKit||b.ua.isGecko||b.ua.isIEBRPlaceholder){j=this.context.createElement("br");
b.setAttribute(j,b.BR_TEMP_ATTRIB,"brEOB");
this.elementsToChange.push({domToChange:d,changedDom:j})
}else{if(b.ua.isIE){var a=b.getPreviousCharacterNode(this.context,d,b.EDITBLOCK_TAGS);
if(b.isTag(a,"br")){this.markForRemoval(d);
i.fixEmptyLinefeedIE(this.context,a)
}else{if(!a){this.markForRemoval(d);
var c=i.getEditBlock(this.context,d);
this.emptyBlocksIE.push(c)
}}}}}}else{if(b.ua.isGecko||b.ua.isWebKit||b.ua.isIEBRPlaceholder){if(b.isTag(d,"br")&&!b.getTagInPath(this.context,d,"pre")){var g=b.getTagInPath(this.context,d,b.EDITBLOCK_TAGS);
var e=g&&(b.getCharacterNodes(g).length==1);
if(e){this.markForRemoval(d)
}else{var f=b.isAttribDefined(d,b.BR_TEMP_ATTRIB)||b.hasAttributes(d,{type:"_moz"});
if(f&&i.isBlockEnd(this.context,d)){this.elementsToChange.push({domToChange:d,changedDom:this.context.createTextNode(i.NBSP)})
}}}}else{if(b.ua.isIE){if(b.isTag(d,"br")&&i.isBlockEnd(this.context,d)){var h=this.context.createTextNode(i.NBSP);
this.markForInsertion(h,d.parentNode)
}}}}},applyHtmlRules:function(f){var d=CUI.rte.Common;
var e=f.tagName.toLowerCase();
var b=(this.isPreProcessing()?this.htmlRules.docType.adjustToRaw(e):this.htmlRules.docType.adjustToDocType(e));
var a;
if(b!=null){if(b.length>0){a=this.context.createElement(b);
this.elementsToChange.push({domToChange:f,changedDom:a})
}else{this.elementsToRemove.push(f);
return true
}return false
}if(this.isPreProcessing()){if(d.isTag(f,"a")){var c=d.getAttribute(f,"href");
if(c){if(this.htmlRules.links.validateHref(c)){this.htmlRules.links.applyToObject(f);
return false
}else{this.markForRemoval(f);
return true
}}}}return false
},handleAlignment:function(d){var b=CUI.rte.Common;
var c=["p","div"];
if(b.isTag(d,c)){if(this.isPreProcessing()){var a=b.getAttribute(d,"align",true);
if(a){b.removeAttribute(d,"align");
d.style.textAlign=a
}}}},handleAnchor:function(f){var c=CUI.rte.Common;
var d=CUI.rte.DomCleanup;
var m;
if(c.isTag(f,"a")){m=c.getAttribute(f,"name",true);
var j=CUI.rte.HtmlRules.Links.getLinkHref(f);
var k=this.editorKernel.registeredPlugins.links;
var l;
if(k){l=k.getConfig().anchorEditingStyle
}if(m){if(this.isPreProcessing()){var b=f.childNodes;
var e=f.parentNode;
var a=f.nextSibling;
while(b.length>0){c.insertBefore(e,b[0],a)
}var g=this.context.createElement("img");
c.setAttribute(g,"src",CUI.rte.Utils.getBlankImageUrl());
c.setAttribute(g,c.A_NAME_REPLACEMENT_ATTRIB,m);
if(l){c.setAttribute(g,"style",l)
}else{c.addClass(g,CUI.rte.Theme.ANCHOR_CLASS)
}this.elementsToChange.push({domToChange:f,changedDom:g})
}else{if(this.processingMode==d.POST){if(l){c.removeAttribute(f,"style")
}else{c.removeClass(f,CUI.rte.Theme.ANCHOR_CLASS)
}}}}if(j){if(this.processingMode==d.PASTE_PREPARE){var h=c.getAttribute(f,c.HREF_ATTRIB);
if(!h){c.setAttribute(f,c.HREF_ATTRIB,j)
}}}}else{if(c.isTag(f,"img")&&c.isAttribDefined(f,c.A_NAME_REPLACEMENT_ATTRIB)){if(!this.isPreProcessing()){var i=this.context.createElement("a");
m=c.getAttribute(f,c.A_NAME_REPLACEMENT_ATTRIB);
c.setAttribute(i,"name",m);
this.elementsToChange.push({domToChange:f,changedDom:i})
}}}},handleImage:function(d){var b=CUI.rte.Common;
var c=CUI.rte.DomCleanup;
var j=CUI.rte.HtmlRules;
var g=CUI.rte.HtmlProcessor;
if(b.isTag(d,"img")){var k=CUI.rte.Utils.URL_IMAGE;
var e;
if(this.processingMode==c.PRE){e=b.getAttribute(d,b.SRC_ATTRIB,true);
e=(e?e:b.getAttribute(d,"src",true));
b.setAttribute(d,"src",CUI.rte.Utils.processUrl(e,k))
}if(this.processingMode==c.PASTE_PREPARE){e=b.getAttribute(d,"src",true);
if(e){var f=b.getAttribute(d,b.SRC_ATTRIB,true);
if(!f){b.setAttribute(d,b.SRC_ATTRIB,j.removePrefixForInternalLinks(e,k))
}}}if(this.processingMode==c.POST){var a=b.getAttribute(d,"style");
if(a){var i=g.parseStyleDef(a);
if(i.width){b.setAttribute(d,"width",parseInt(i.width));
delete i.width
}if(i.height){b.setAttribute(d,"height",parseInt(i.height));
delete i.height
}var h=g.createStyleAttrib(i);
if(h){b.setAttribute(d,"style",h)
}else{b.removeAttribute(d,"style")
}}}}},handleTable:function(l){var f=CUI.rte.Common;
var h=CUI.rte.DomCleanup;
if(f.isTag(l,"table")){var c=f.getAttribute(l,"border",true);
var m=false;
if(c){try{m=(parseInt(c)>0)
}catch(p){}}if(!m){if(this.isPreProcessing()){f.addClass(l,CUI.rte.Theme.TABLE_NOBORDER_CLASS)
}else{if(this.processingMode==h.POST){f.removeClass(l,CUI.rte.Theme.TABLE_NOBORDER_CLASS)
}}}this.handleCellSpacingAttribute(l)
}else{if(f.isTag(l,["td","th"])){if(this.processingMode==h.POST){f.removeClass(l,CUI.rte.Theme.TABLESELECTION_CLASS);
if(f.isTag(l,"th")&&f.getAttribute(l,"hiddenheader")){var a=this.context.createElement("div");
f.setAttribute(a,"hiddenheader","true");
f.removeAttribute(l,"hiddenheader");
var b=this.editorKernel.registeredPlugins.table;
if(b){var d=b.getHiddenHeaderConfig();
if(d.hiddenHeaderClassName){f.addClass(a,d.hiddenHeaderClassName)
}else{if(d.hiddenHeaderStyle){f.setAttribute(a,"style",d.hiddenHeaderStyle)
}}if(d.hiddenHeaderEditingCSS){f.removeClass(l,d.hiddenHeaderEditingCSS)
}else{var g=[];
var q=d.hiddenHeaderEditingStyle;
q=q.trim();
var k=q.split(";");
for(var n=0;
n<k.length;
n++){var j=k[n].split(":");
if(j.length==2){var o=j[0].trim();
if(o.length){g.push(o)
}}}f.removeInlineStyles(l,g)
}}while(l.firstChild){a.appendChild(l.firstChild)
}l.appendChild((a))
}}}}},handleCellSpacingAttribute:function(a){return
},handleList:function(d){var a=CUI.rte.Common;
var c=CUI.rte.ListUtils;
if(a.isTag(d,a.LIST_TAGS)){if(c.isTopLevelList(this.context,d)){var b=new CUI.rte.ListRepresentation();
b.fromItem(this.context,d);
b.ensureHierarchy(this.context)
}}},handleSpanStyles:function(f){var b=CUI.rte.Common;
if(this.isPreProcessing()){if(b.isTag(f,"span")){var a,c;
if(f.style.fontWeight=="bold"){a=this.context.createElement("b");
c={domToChange:f,changedDom:a}
}if(f.style.fontStyle=="italic"){var d=this.context.createElement("i");
if(a){a.appendChild(d);
c.childDom=d
}else{a=d;
c={domToChange:f,changedDom:a}
}}if(f.style.textDecoration=="underline"){var e=this.context.createElement("u");
if(a){if(c.childDom){c.childDom.appendChild(e)
}else{a.appendChild(e)
}c.childDom=e
}else{a=e;
c={domToChange:f,changedDom:a}
}}if(c){this.elementsToChange.push(c)
}}}},handleDiv:function(d){var a=CUI.rte.Common;
var b=CUI.rte.DomProcessor;
if(this.isPreProcessing()){if(a.isTag(d,"div")&&a.getAttribute(d,"hiddenheader")==="true"){var e=this.editorKernel.registeredPlugins.table;
if(e){var c=e.getHiddenHeaderConfig();
if(c.hiddenHeaderEditingCSS){a.addClass(d.parentNode,c.hiddenHeaderEditingCSS)
}else{a.addInlineStyles(d.parentNode,c.hiddenHeaderEditingStyle)
}}a.setAttribute(d.parentNode,"hiddenheader","true");
b.removeWithoutChildren(d)
}}},handleFont:function(b){var a=CUI.rte.Common;
if(!this.isPreProcessing()){if(a.isTag(b,"font")){if(!a.hasTextChild(b,true)){this.elementsToRemove.push(b)
}}}},handleSpecificTags:function(d){this.handleAlignment(d);
this.handleAnchor(d);
this.handleImage(d);
this.handleTable(d);
this.handleSpanStyles(d);
this.handleDiv(d);
this.handleList(d);
this.handlePreformattedSection(d);
this.handleFont(d);
var a=CUI.rte.DomCleanup.pluggableDomProcessors;
if(a!==null){for(var b=0;
b<a.length;
b++){var c=a[b];
if(c){c.call(this,d)
}}}},handleEmptyContent:function(f){var a=CUI.rte.Common;
var e=CUI.rte.DomProcessor;
var h=CUI.rte.DomCleanup;
if(this.processingMode==h.PRE){if(f.childNodes.length==0){var g=e.createEmptyLinePlaceholder(this.context,true,this.htmlRules.blockHandling.defaultEditBlockType);
f.appendChild(g)
}else{if(f.childNodes.length==1){var d=f.childNodes[0];
var c=a.getCharacterNodes(d);
if((c.length==1)&&a.isTag(c[0],"br")){a.setAttribute(c[0],a.BR_TEMP_ATTRIB,"brEOB")
}}}}else{if(this.processingMode==h.POST){if(f.childNodes.length==1){var b=f.childNodes[0];
if(a.isTag(b,a.EDITBLOCK_TAGS)){if(e.isEmptyLineBlock(b)){f.removeChild(b)
}}}}}},handleContainerRules:function(g){var a=CUI.rte.Common;
var l=CUI.rte.DomProcessor;
var b=CUI.rte.DomCleanup;
var e=this.htmlRules.blockHandling;
var k=e.defaultEditBlockType;
var c=e.singleParagraphContainerReplacement;
if(this.processingMode==b.PRE){l.ensureBlockContent(this.context,k,null,false,false);
l.adjustTables(this.context);
var f=this.emptyBlocksIE.length;
for(var h=0;
h<f;
h++){l.fixEmptyEditingBlockIE(this.context,this.emptyBlocksIE[h])
}}else{if(this.processingMode==b.POST){if(e.removeSingleParagraphContainer){var d=g.childNodes.length;
if(d==1){var m=g.childNodes[0];
if(a.isTag(m,k)){var o=m.style;
var j=a.getAttribute(m,"class",true);
if(j||o.textAlign||o.marginLeft){if(k!=c){var n=this.context.createElement(c);
if(j){a.setAttribute(n,"class",j)
}if(o.textAlign){n.style.textAlign=o.textAlign
}if(o.marginLeft){n.style.marginLeft=o.marginLeft
}a.replaceNode(m,n)
}}else{l.removeWithoutChildren(m)
}}}}}}},checkAllowedForPaste:function(g){var e=CUI.rte.Common;
var d=true;
var c=["br"];
var f={b:"bold",i:"italic",u:"underline",a:"anchor",img:"image",sub:"subscript",sup:"superscript"};
var b=null;
if(this.pasteRules.allowBasics){var a=g.tagName.toLowerCase();
if(f.hasOwnProperty(a)){b=f[a]
}}if(this.pasteRules.table){if((this.pasteRules.table.allow)||(this.pasteRules.table.ignoreMode=="paragraph")){c.push("table");
c.push("tbody");
c.push("tr");
c.push("td");
c.push("th")
}}if(this.pasteRules.list){if((this.pasteRules.list.allow)||(this.pasteRules.list.ignoreMode=="paragraph")){c.push("ul");
c.push("ol");
c.push("li")
}}if(b!=null){d=(this.pasteRules.allowBasics[b]!==true)
}else{if(e.isTag(g,c)){d=false
}else{if(e.isTag(g,e.BLOCK_TAGS)){d=false
}else{if(e.isTag(g,"span")&&(e.parseCSS(g).length>0)){d=false
}}}}if(d){this.elementsToRemove.push(g);
return null
}return g
},handleTablesOnPaste:function(c){var a=CUI.rte.Common;
var b=this.pasteRules.table;
if(b.allow){return c
}if(b.ignoreMode=="remove"){a.removeAllChildren(c);
this.markForRemoval(c);
return c
}return this.flattenNestedStructure(c,a.TABLE_CELLS,"table")
},handleListsOnPaste:function(c){var a=CUI.rte.Common;
var b=this.pasteRules.list;
if(b.allow){return c
}if(b.ignoreMode=="remove"){a.removeAllChildren(c);
this.markForRemoval(c);
return c
}return this.flattenNestedStructure(c,"li",a.LIST_TAGS)
},handleBlockTagsOnPaste:function(f){var c=CUI.rte.Common;
if(c.isTag(f,c.BLOCK_TAGS)){var b=f.tagName.toLowerCase();
if(c.isTag(f,"table")&&this.pasteRules.table){return this.handleTablesOnPaste(f)
}if(c.isTag(f,c.LIST_TAGS)&&this.pasteRules.list){return this.handleListsOnPaste(f)
}var d=true;
if(this.pasteRules.allowBlockTags){d=!c.arrayContains(this.pasteRules.allowBlockTags,b)
}if(d){var e=this.pasteRules.fallbackBlockTag||"p";
var a=this.context.createElement(e);
this.elementsToChange.push({domToChange:f,changedDom:a})
}}},handleCssClassesOnPaste:function(d){var b=CUI.rte.Common;
var l=(this.pasteRules.cssMode||"remove");
var g=b.parseCSS(d);
if(g&&(g.length>0)){switch(l){case"remove":b.removeAttribute(d,"class");
break;
case"whitelist":var m=this.pasteRules.allowedCssNames||[];
if(this.editorKernel.registeredPlugins.styles){var a,f=this.editorKernel.registeredPlugins.styles.getStyles()||[];
for(var e=0;
e<f.length;
e++){m.push(f[e].cssName)
}}var k=g.length;
for(var h=0;
h<k;
h++){var j=g[h];
if(!b.arrayContains(m,j)){b.removeClass(d,j)
}}break
}}},manageRegEx:function(regex){if(typeof(regex)=="string"){regex=eval(regex)
}return regex
},handleSecurity:function(d){var a=CUI.rte.Common;
if(a.isTag(d,"a")){var c=a.getAttribute(d,"href",true);
if(c&&this.pasteRules.linkRemoveRegEx){var b=this.manageRegEx(this.pasteRules.linkRemoveRegEx);
if(b){if(c.search(b)>=0){this.markForRemoval(d);
return null
}}}}return d
},handleAttributes:function(h){var c=CUI.rte.Common;
var b=c.getAttributeNames(h);
var g=null;
var i=null;
var d=h.tagName.toLowerCase();
if(this.pasteRules.allowedAttributes){g=this.pasteRules.allowedAttributes["*"];
i=this.pasteRules.allowedAttributes[d]
}var j=b.length;
for(var k=0;
k<j;
k++){var f=b[k];
var e=false;
if(g&&c.arrayContains(g,f)){e=true
}if(i&&c.arrayContains(i,f)){e=true
}if(!e){c.removeAttribute(h,f)
}}},handlePasteProcessing:function(b){var c=CUI.rte.DomCleanup;
var a=b;
if((this.mode=c.PASTE_PREPARE)&&(this.pasteRules!=null)){if(b){b=this.handleSecurity(b)
}if(b){this.handleBlockTagsOnPaste(b);
this.handleCssClassesOnPaste(b);
this.handleAttributes(b)
}b=this.checkAllowedForPaste(b)
}return b||a
},optimizeTree:function(a){var b=CUI.rte.Common;
function c(h,g){if(b.isTag(h,g)){var e=false;
do{var f=h.nextSibling;
if(f){if(b.equals(h,f)){b.moveChildren(f,h,0,true);
f.parentNode.removeChild(f)
}else{e=true
}}else{e=true
}}while(!e)
}if(h.nodeType===1){for(var i=0;
i<h.childNodes.length;
i++){c(h.childNodes[i],g)
}}}if(!this.isPreProcessing()){var d=["b","i","u","big","small","strong","em","sub","sup","span"];
c(a,d)
}},traverse:function(f,d){var b=false;
if(!d){if(f.nodeType==1){if(!this.isValidSubTree(f)){this.markSubTreeForRemoval(f);
b=true
}else{if(!this.isValidElement(f)){this.markForRemoval(f)
}else{f=this.handlePasteProcessing(f);
var a=false;
if(this.htmlRules){a=this.applyHtmlRules(f)
}if(!a){this.handleSpecificTags(f)
}}}}this.handleEmptyLinesAtEOB(f)
}if(!b){var e=f.childNodes;
for(var g=0;
g<e.length;
g++){this.traverse(e[g],false)
}}},removeElements:function(){var d=CUI.rte.DomProcessor;
var a=this.elementsToRemove.length;
for(var c=0;
c<a;
c++){d.removeWithoutChildren(this.elementsToRemove[c])
}this.elementsToRemove.length=0;
a=this.subTreesToRemove.length;
for(c=0;
c<a;
c++){var b=this.subTreesToRemove[c];
if(b.parentNode){b.parentNode.removeChild(b)
}}this.subTreesToRemove.length=0
},replaceElements:function(){var b=CUI.rte.Common;
var f=this.elementsToChange.length;
for(var d=0;
d<f;
d++){var c=this.elementsToChange[d];
var a=c.domToChange;
b.replaceNode(a,c.changedDom,c.childDom);
for(var e=0;
e<this.elementsToRemove.length;
e++){if(this.elementsToRemove[e]==a){this.elementsToRemove.splice(e,1);
break
}}}},insertElements:function(){var c=CUI.rte.Common;
var g=this.elementsToInsert.length;
for(var e=0;
e<g;
e++){var d=this.elementsToInsert[e];
var b=d.domToInsert;
var f=d.parentDom;
var a=d.refDom;
if(a){f.insertBefore(b,a)
}else{f.appendChild(b)
}}},execute:function(c,b){this.editorKernel=c;
this.context=c.getEditContext();
this.htmlRules=c.getHtmlRules();
function a(d){if(d){d.length=0;
return d
}return[]
}this.elementsToRemove=a(this.elementsToRemove);
this.subTreesToRemove=a(this.subTreesToRemove);
this.elementsToChange=a(this.elementsToChange);
this.elementsToInsert=a(this.elementsToInsert);
this.emptyBlocksIE=a(this.emptyBlocksIE);
this.traverse(b,true);
this.insertElements();
this.replaceElements();
this.removeElements();
this.optimizeTree(b);
this.handleContainerRules(b);
this.handleEmptyContent(b)
},preprocess:function(b,a){this.processingMode=CUI.rte.DomCleanup.PRE;
this.execute(b,a)
},postprocess:function(b,a){this.processingMode=CUI.rte.DomCleanup.POST;
this.execute(b,a)
},prepareHtmlPaste:function(c,b,a){this.processingMode=CUI.rte.DomCleanup.PASTE_PREPARE;
this.pasteRules=a;
this.execute(c,b)
}});
CUI.rte.DomCleanup.PRE=0;
CUI.rte.DomCleanup.POST=1;
CUI.rte.DomCleanup.PASTE_PREPARE=2;
CUI.rte.DomCleanup.pluggableDomProcessors=null;
CUI.rte.DomCleanup.addDomProcessor=function(a){var b=CUI.rte.DomCleanup;
if(b.pluggableDomProcessors===null){b.pluggableDomProcessors=[]
}b.pluggableDomProcessors.push(a)
};
CUI.rte.commands.Command=new Class({toString:"Command",isCommand:function(a){return false
},isUndoable:function(a){return true
},requiresInitializedComponent:function(a){return true
},getProcessingOptions:function(){return CUI.rte.commands.Command.PO_NONE
},execute:function(a){},queryState:function(a,b){return false
}});
CUI.rte.commands.Command.PO_NONE=0;
CUI.rte.commands.Command.PO_SELECTION=1;
CUI.rte.commands.Command.PO_BOOKMARK=2;
CUI.rte.commands.Command.PO_NODELIST=4;
CUI.rte.commands.CommandRegistry=function(){var a={};
return{register:function(c,b){a[c]=b
},createRegisteredCommands:function(){var c={};
for(var b in a){if(a.hasOwnProperty(b)){c[b]=new a[b]()
}}return c
}}
}();
CUI.rte.commands.Delete=new Class({toString:"Delete",extend:CUI.rte.commands.Command,isCommand:function(b){var a=b.toLowerCase();
return(a=="delete")
},execute:function(a){CUI.rte.commands.Delete.executeDelete(a.editContext)
}});
CUI.rte.commands.Delete.executeDelete=function(a){a.doc.execCommand("delete",false,null);
CUI.rte.DomProcessor.ensureMinimumContent(a)
};
CUI.rte.commands.CommandRegistry.register("delete",CUI.rte.commands.Delete);
CUI.rte.commands.SurroundBase=new Class({toString:"SurroundBase",extend:CUI.rte.commands.Command,tagName:null,attributes:null,construct:function(b,a){this.tagName=b;
this.attributes=a
},containsTag:function(d,c){var a=CUI.rte.Common;
for(var b in d){var e=d[b];
if(a.isTag(e,c)){return true
}}return false
},isCommand:function(a){return(a.toLowerCase()==this.tagName.toLowerCase())
},getProcessingOptions:function(){var a=CUI.rte.commands.Command;
return a.PO_SELECTION|a.PO_BOOKMARK|a.PO_NODELIST
},execute:function(e){var a=CUI.rte.Common;
var b=e.nodeList;
var c=e.editContext;
var d=a.containsTagInPath(c,b.commonAncestor,this.tagName);
if(!d){b.surround(e.editContext,this.tagName,this.attributes)
}else{b.removeNodesByTag(e.editContext,this.tagName,null,true)
}},queryState:function(a,c){var b=a.consistentFormatting;
return this.containsTag(b,this.tagName)
}});
CUI.rte.commands.DefaultFormatting=new Class({toString:"DefaultFormatting",extend:CUI.rte.commands.Command,containsTag:function(d,c){var a=CUI.rte.Common;
for(var b in d){var e=d[b];
if(a.isTag(e,c)){return true
}}return false
},_getTagNameForCommand:function(c){var b=c.toLowerCase();
var a=null;
switch(b){case"bold":a="b";
break;
case"italic":a="i";
break;
case"underline":a="u";
break;
case"subscript":a="sub";
break;
case"superscript":a="sup";
break
}return a
},_getParamsFromExecDef:function(e){var c=e.command.toLowerCase();
var d=(c==="style");
var b,a;
if(d){b=e.value.tag;
a=e.value.attributes
}else{b=this._getTagNameForCommand(c);
a=e.value
}return{tag:b,attributes:a,isStyle:d}
},isStrucStart:function(b,c,d){var a=c.parentNode;
if(!a){return false
}if(c!==a.firstChild){return false
}if(c.nodeType===3){return(d===0)
}if(CUI.rte.Common.isOneCharacterNode(c)){return(d===undefined)||(d===null)
}return true
},isStrucEnd:function(c,d,e){var b=CUI.rte.Common;
var a=d.parentNode;
if(!a){return false
}if(d!==a.lastChild){return false
}if(d.nodeType===3){return(e===b.getNodeCharacterCnt(d))
}if(b.isOneCharacterNode(d)){return(e===0)
}return true
},_clean:function(e,d){var c=CUI.rte.DomProcessor;
var a=false;
while(!a){var b=e.parentNode;
if((e.nodeType!==1)||(e.childNodes.length!==0)||(c.getTagType(e)!==c.STRUCTURE)){break
}b.removeChild(e);
a=(e===d);
e=b
}},cleanLeft:function(b){var a=b;
while(a.firstChild){a=a.lastChild
}this._clean(a,b)
},cleanRight:function(b){var a=b;
while(a.firstChild){a=a.firstChild
}this._clean(a,b)
},split:function(c,b,a){CUI.rte.DomProcessor.splitToParent(c,b,a)
},clean:function(b,a){if(b){this.cleanLeft(b)
}if(a){this.cleanRight(a)
}},setCaretTo:function(d){var f=CUI.rte.Common;
var q=CUI.rte.Selection;
var a=CUI.rte.DomProcessor;
function b(){if(j){x=j.parentNode;
s=f.getChildIndex(j);
j.parentNode.removeChild(j)
}}var k=this._getParamsFromExecDef(d);
var y=k.tag;
var l=k.attributes;
if(y){var e=d.editContext;
var z=d.selection;
var x=z.startNode;
var s=z.startOffset;
var u=a.isZeroSizePlaceholder(x);
var j;
if(u){j=(x.nodeType===3?x.parentNode:x)
}var m=f.getTagInPath(e,x,y,l);
if(!m){if(j){x=j.parentNode;
s=f.getChildIndex(j)
}var c=a.createNode(e,y,l);
f.setAttribute(c,f.TEMP_EL_ATTRIB,f.TEMP_EL_REMOVE_ON_SERIALIZE+":emptyOnly");
a.insertElement(e,c,x,s);
q.selectEmptyNode(e,c);
if(j){j.parentNode.removeChild(j)
}}else{var o=[];
var t=x;
var g;
while(t&&(t!==m)){if((t.nodeType===1)&&!a.isZeroSizePlaceholder(t)){o.push(t)
}t=f.getParentNode(e,t)
}var r=o.length;
var i;
if(r===0){i=f.getParentNode(e,x);
if(!u&&this.isStrucStart(e,x,s)){q.selectBeforeNode(e,i)
}else{if(!u&&this.isStrucEnd(e,x,s)){q.selectAfterNode(e,i)
}else{b();
if(f.isCharacterNode(x)){this.split(i,x,s);
this.clean(i,i.nextSibling);
q.selectAfterNode(e,i)
}else{this.split(m,x,s);
g=m.nextSibling;
var v=a.createTempSpan(e,true,false,true);
v.appendChild(e.createTextNode(a.ZERO_WIDTH_NBSP));
m.parentNode.insertBefore(v,g);
this.clean(m,g);
q.selectEmptyNode(e,v)
}}}}else{var w;
for(var n=r-1;
n>=0;
n--){var h=o[n].cloneNode(false);
if(!i){w=h
}else{i.appendChild(h)
}i=h
}b();
this.split(m,x,s);
g=m.nextSibling;
m.parentNode.insertBefore(w,g);
this.clean(m,g);
q.selectEmptyNode(e,h)
}}return{preventBookmarkRestore:true}
}return undefined
},isCommand:function(b){var a=b.toLowerCase();
return(a=="bold")||(a=="italic")||(a=="underline")||(a=="subscript")||(a=="superscript")||(a=="style")
},getProcessingOptions:function(){var a=CUI.rte.commands.Command;
return a.PO_SELECTION|a.PO_BOOKMARK|a.PO_NODELIST
},execute:function(e){var c=CUI.rte.Common;
var f=e.nodeList;
var h=e.selection;
var a=e.editContext;
var b=this._getParamsFromExecDef(e);
if(b.isStyle&&b.attributes.hasOwnProperty("class")){var j=CUI.rte.Selection.getSelectedDom(a,h);
var g=CUI.rte.plugins.StylesPlugin.STYLEABLE_OBJECTS;
var d=b.attributes["class"];
if(j&&c.isTag(j,g)){if(c.hasCSS(j,d)){c.removeClass(j,d)
}else{c.addClass(j,d)
}return undefined
}}if(!CUI.rte.Selection.isSelection(h)){return this.setCaretTo(e)
}var k=c.getTagInPath(a,h.startNode,b.tag,b.attributes);
var i=(k!=null);
if(!i){f.surround(e.editContext,b.tag,b.attributes)
}else{f.removeNodesByTag(e.editContext,b.tag,b.attributes,true)
}return undefined
},queryState:function(b,f){var a=CUI.rte.Common;
var d=this._getTagNameForCommand(f);
if(!d){return undefined
}var c=b.editContext;
var e=b.selection;
return(a.getTagInPath(c,e.startNode,d)!=null)
}});
CUI.rte.commands.CommandRegistry.register("_defaultfmt",CUI.rte.commands.DefaultFormatting);
CUI.rte.commands.Anchor=new Class({toString:"Anchor",extend:CUI.rte.commands.Command,addAnchorToDom:function(f){var d=CUI.rte.Common;
var m=CUI.rte.DomProcessor;
var g=f.nodeList;
var b=f.value.anchorValue;
var n=f.value.pluginConfig.anchorEditingStyle;
var c=f.editContext;
var a=[];
g.getNamedAnchors(c,a,false);
if(a.length>0){for(var k=0;
k<a.length;
k++){this.applyAnchorProperties(a[k].dom,b,n)
}}else{var e;
var j={};
if(n){j.style=n
}else{j["class"]=CUI.rte.Theme.ANCHOR_CLASS
}e="img";
j[d.A_NAME_REPLACEMENT_ATTRIB]=b;
var l=f.selection;
var h=m.createNode(c,e,j);
m.insertElement(c,h,l.startNode,l.startOffset)
}},applyAnchorProperties:function(c,b,d){var a=CUI.rte.Common;
if(!a.isTag(c,"a")){a.setAttribute(c,a.A_NAME_REPLACEMENT_ATTRIB,b)
}else{a.setAttribute(c,"name",b)
}if(d){a.setAttribute("style",d)
}else{a.setAttribute(c,"class",CUI.rte.Theme.ANCHOR_CLASS)
}},removeAnchorFromDom:function(f){var e=CUI.rte.DomProcessor;
var c=f.editContext;
var a=f.nodeList;
var d=[];
a.getNamedAnchors(c,d,true);
for(var b=0;
b<d.length;
b++){e.removeWithoutChildren(d[b].dom)
}},isCommand:function(b){var a=b.toLowerCase();
return(a=="anchor")
},getProcessingOptions:function(){var a=CUI.rte.commands.Command;
return a.PO_BOOKMARK|a.PO_SELECTION|a.PO_NODELIST
},execute:function(c){var b=c.value;
var a=b.anchorValue;
if(a){this.addAnchorToDom(c)
}else{this.removeAnchorFromDom(c)
}},queryState:function(a,b){return(a.namedAnchorCount>0)
}});
CUI.rte.commands.CommandRegistry.register("anchor",CUI.rte.commands.Anchor);
CUI.rte.commands.CutCopy=new Class({toString:"CutCopy",extend:CUI.rte.commands.Command,isCommand:function(b){var a=b.toLowerCase();
return(a=="cut")||(a=="copy")
},execute:function(f){var i=f.command;
var h=f.editContext.doc;
var b=false;
try{var a=false;
var c=function(){a=true
};
var d=CUI.rte.Common.ua.isIE;
if(d){CUI.rte.Eventing.on(this.editContext,h,i,c)
}b=h.execCommand(i,false,null);
if(d){b=a;
CUI.rte.Eventing.un(this.editContext,h,i,c)
}}catch(g){}if(!b){throw new Error("Cannot "+i+".")
}}});
CUI.rte.commands.CommandRegistry.register("_cutcopy",CUI.rte.commands.CutCopy);
CUI.rte.commands.Format=new Class({toString:"Format",extend:CUI.rte.commands.Command,isCommand:function(a){return(a.toLowerCase()=="format")
},getProcessingOptions:function(){var a=CUI.rte.commands.Command;
return a.PO_BOOKMARK|a.PO_SELECTION
},execute:function(d){var h=CUI.rte.DomProcessor;
var c=CUI.rte.Common;
var f;
var i=d.selection;
var b=d.editContext;
var g=h.createContainerList(b,i);
if(g.length==0){var e=d.nodeList;
if(!e){e=h.createNodeList(b,i)
}var a=c.getTagInPath(b,e.commonAncestor,h.AUXILIARY_ROOT_TAGS);
if(a){f=h.createNode(d.editContext,d.value.tag);
c.moveChildren(a,f);
a.appendChild(f)
}}else{f=h.createNode(d.editContext,d.value.tag);
h.changeContainerTag(d.editContext,g,f,true)
}},queryState:function(a,b){return false
}});
CUI.rte.commands.CommandRegistry.register("format",CUI.rte.commands.Format);
CUI.rte.commands.Indent=new Class({toString:"Indent",extend:CUI.rte.commands.Command,isCommand:function(a){return(a.toLowerCase()=="indent")
},getProcessingOptions:function(){var a=CUI.rte.commands.Command;
return a.PO_SELECTION|a.PO_BOOKMARK|a.PO_NODELIST
},execute:function(c){var g=CUI.rte.Common;
var b=CUI.rte.DomProcessor;
var s=c.selection;
var p=c.nodeList;
var d=c.editContext;
var q=CUI.rte.commands.Indent.TAGEXCL;
var o=p.getTags(d,[{matcher:function(r){if(g.isRootNode(d,r)){return false
}if(g.isTag(r,g.BLOCK_TAGS)&&!g.isTag(r,q)){return true
}return g.isTag(r,"li")
}}],true,true);
var f=b.getAuxRoots(d,s);
var i=f.length;
for(var j=0;
j<i;
j++){var t=f[j];
var a=d.createElement("p");
g.moveChildren(t,a);
t.appendChild(a);
o.push({dom:a})
}var n=o.length;
for(var m=0;
m<n;
m++){var e=o[m];
var l=e.dom;
if(g.isTag(l,g.BLOCK_TAGS)){var k=0;
if(l.style.marginLeft){k=parseInt(l.style.marginLeft)
}k+=c.value||CUI.rte.commands.Indent.DEFAULT_INDENT_SIZE;
l.style.marginLeft=k+"px"
}else{var h=new CUI.rte.ListRepresentation();
h.fromItem(d,l);
h.ensureHierarchy(d);
h.indent(d,l)
}}},queryState:function(c,f){var b=CUI.rte.Common;
var d=c.editContext;
var a=CUI.rte.commands.Indent.TAGEXCL;
var e=c.nodeList.getTags(d,[{matcher:function(g){if(b.isRootNode(d,g)){return false
}if(b.isTag(g,b.BLOCK_TAGS)&&!b.isTag(g,a)){return !!g.style.marginLeft
}return b.isTag(g,"li")
}}],true,true);
return(e.length>0)
}});
CUI.rte.commands.Indent.TAGEXCL=["ul","ol","table"];
CUI.rte.commands.Indent.DEFAULT_INDENT_SIZE=40;
CUI.rte.commands.CommandRegistry.register("indent",CUI.rte.commands.Indent);
CUI.rte.commands.InsertHtml=new Class({toString:"InsertHtml",extend:CUI.rte.commands.Command,isCommand:function(a){return(a.toLowerCase()=="inserthtml")
},getProcessingOptions:function(){var a=CUI.rte.commands.Command;
return a.PO_SELECTION
},execute:function(d){var c=CUI.rte.Common;
var g=d.value;
if(g&&(g.length>0)){if(c.ua.isIE){try{var h=CUI.rte.Selection.saveNativeSelection(d.editContext);
if(h.pasteHTML){h.pasteHTML(g)
}else{var f=d.editContext.doc.createElement("div");
f.innerHTML=g;
var j=d.editContext.doc.createDocumentFragment();
var a,b;
while((a=f.firstChild)){b=j.appendChild(a)
}h.deleteContents();
h.insertNode(j);
h.setStartAfter(b)
}}catch(i){throw new Error("Could not insert html due to IE limitations.")
}}else{d.editContext.doc.execCommand("inserthtml",false,g)
}}},queryState:function(a,b){return false
}});
CUI.rte.commands.CommandRegistry.register("inserthtml",CUI.rte.commands.InsertHtml);
CUI.rte.commands.Justify=new Class({toString:"Justify",extend:CUI.rte.commands.Command,isCommand:function(b){var a=CUI.rte.Common;
return a.strStartsWith(b.toLowerCase(),"justify")
},getProcessingOptions:function(){var a=CUI.rte.commands.Command;
return a.PO_SELECTION|a.PO_BOOKMARK
},alignTableCells:function(a,d,g){var b=CUI.rte.Common;
var j=d.cells;
var f=j.length;
for(var h=0;
h<f;
h++){var i=j[h];
var e=b.getStyleProp(a,i.parentNode,"textAlign");
e=(e?e:"left");
if(e!=g){i.style.textAlign=g
}else{i.style.textAlign=""
}}},execute:function(d){var a=CUI.rte.DomProcessor;
var h=CUI.rte.Common;
var t=d.selection;
var p=d.command;
var f=d.editContext;
var i=p.substring(7,p.length);
if(t.cellSelection){this.alignTableCells(f,t.cellSelection,i)
}else{var c;
var l=a.createContainerList(f,t);
var s=h.getConsistentStyle(f,l,"textAlign","left");
var b=(s!=null);
var o=l.length;
for(var e=0;
e<o;
e++){var q=l[e];
c=h.getStyleProp(f,q.parentNode,"textAlign");
c=(c?c:"left");
var j=(c==i);
if(b){if(j){q.style.textAlign=""
}else{q.style.textAlign=i
}}else{q.style.textAlign=(j?"":i)
}}var g=a.getAuxRoots(f,t);
var n=g.length;
for(var m=0;
m<n;
m++){var k=g[m];
if(h.isTag(k,["td","th"])){c=h.getStyleProp(f,k.parentNode,"textAlign");
c=(c?c:"left");
if(i!=c){k.style.textAlign=i
}else{k.style.textAlign=""
}}}}},queryState:function(j,e){var c=CUI.rte.Common;
var b=j.editContext;
var h=c.arrayCopy(j.containerList);
var f=j.auxRoots;
var d=f.length;
for(var a=0;
a<d;
a++){var i=f[a];
if(c.isTag(i,["td","th"])){h.push(i)
}}var g=e.substring(7,e.length);
var k=c.getConsistentStyle(b,h,"textAlign","left");
return(g==k)
}});
CUI.rte.commands.CommandRegistry.register("_justify",CUI.rte.commands.Justify);
CUI.rte.commands.Link=new Class({toString:"Link",extend:CUI.rte.commands.Command,addLinkToDom:function(d){var b=d.editContext;
var f=d.nodeList;
var a=d.value.url;
var e=d.value.css;
var l=d.value.target;
var g=d.value.attributes||{};
var o=[];
f.getAnchors(b,o,true);
if(o.length>0){for(var h=0;
h<o.length;
h++){this.applyLinkProperties(o[h].dom,a,e,l,g)
}}else{var c=CUI.rte.Selection;
var m=CUI.rte.DomProcessor;
if(d.value.trimLinkSelection===true){var j=c.getLeadRange(b);
j=c.trimRangeWhitespace(b,j);
c.selectRange(b,j);
f=m.createNodeList(b,c.createProcessingSelection(b))
}var p=b.createElement("span");
p.innerHTML='<a href="'+a+'"></a>';
g.href=p.childNodes[0].href;
g[CUI.rte.Common.HREF_ATTRIB]=a;
if(e){g.className=e
}if(l){g.target=l
}else{delete g.target
}for(var n in g){if(g.hasOwnProperty(n)){var k=g[n];
if((k==null)||(k.length==0)||(k==CUI.rte.commands.Link.REMOVE_ATTRIBUTE)){delete g[n]
}}}f.surround(b,"a",g)
}},applyLinkProperties:function(h,c,d,f,g){var b=CUI.rte.Common;
h.href=c;
h.setAttribute(CUI.rte.Common.HREF_ATTRIB,c);
if(f){b.setAttribute(h,"target",f)
}else{b.removeAttribute(h,"target")
}if(d){b.setAttribute(h,"class",d)
}else{b.removeAttribute(h,"class")
}for(var e in g){if(g.hasOwnProperty(e)){var a=g[e];
if(a&&(a.length>0)&&(a!=CUI.rte.commands.Link.REMOVE_ATTRIBUTE)){b.setAttribute(h,e,a)
}else{b.removeAttribute(h,e)
}}}},removeLinkFromDom:function(f){var e=CUI.rte.DomProcessor;
var d=f.editContext;
var b=f.nodeList;
var a=[];
b.getAnchors(d,a,true);
for(var c=0;
c<a.length;
c++){e.removeWithoutChildren(a[c].dom)
}},isCommand:function(b){var a=b.toLowerCase();
return(a=="modifylink")||(a=="unlink")
},getProcessingOptions:function(){var a=CUI.rte.commands.Command;
return a.PO_BOOKMARK|a.PO_SELECTION|a.PO_NODELIST
},execute:function(a){switch(a.command.toLowerCase()){case"modifylink":this.addLinkToDom(a);
break;
case"unlink":this.removeLinkFromDom(a);
break
}},queryState:function(a,b){return(a.anchorCount>0)
}});
CUI.rte.commands.Link.REMOVE_ATTRIBUTE=new Object();
CUI.rte.commands.CommandRegistry.register("_link",CUI.rte.commands.Link);
CUI.rte.commands.List=new Class({toString:"List",extend:CUI.rte.commands.Command,isCommand:function(b){var a=b.toLowerCase();
return(a=="insertorderedlist")||(a=="insertunorderedlist")
},getProcessingOptions:function(){var a=CUI.rte.commands.Command;
return a.PO_SELECTION|a.PO_BOOKMARK|a.PO_NODELIST
},getListItems:function(b){var a=b.editContext;
return b.nodeList.getTags(a,[{extMatcher:function(c){return{isMatching:CUI.rte.Common.isTag(c,"li"),preventRecursionIfMatching:true}
}}],true,true)
},getAllListItems:function(c){var a=c.editContext;
var b=c.nodeList.getTags(a,[{matcher:function(d){return CUI.rte.Common.isTag(d,"li")
}}],true,true);
CUI.rte.ListUtils.postprocessSelectedItems(b);
return b
},getDefiningListDom:function(d,c){var b=CUI.rte.Common;
var e=c.getFirstNode();
if(e==null){return null
}var a=e.dom;
while(a){if(b.isTag(a,b.LIST_TAGS)){return a
}a=b.getParentNode(d,a)
}return null
},splitToTopLevelLists:function(e,f){var b=e.editContext;
var c=[];
var j=[];
var h=f.length;
for(var g=0;
g<h;
g++){var k=f[g];
var a=CUI.rte.ListUtils.getTopListForItem(b,k.dom);
var d=CUI.rte.Common.arrayIndex(j,a);
if(d<0){j.push(a);
c.push([k])
}else{c[d].push(k)
}}return c
},changeItemsListType:function(f,g,p){var d=CUI.rte.Common;
var b=f.editContext;
var n=g.length;
for(var m=0;
m<n;
m++){var q=g[m].dom;
var o=q.parentNode;
if(!d.isTag(o,p)){var h=o.previousSibling;
var a=o.nextSibling;
var k=(d.getChildIndex(q)==0);
var l=(d.getChildIndex(q)==(o.childNodes.length-1));
if(k&&h&&d.isTag(h,p)){o.removeChild(q);
h.appendChild(q);
if(o.childNodes.length==0){o.parentNode.removeChild(o)
}}else{if(l&&a&&d.isTag(a,p)){o.removeChild(q);
d.insertBefore(a,q,a.firstChild);
if(o.childNodes.length==0){o.parentNode.removeChild(o)
}}else{var c=b.createElement(p);
if(q==o.firstChild){d.insertBefore(o.parentNode,c,o)
}else{if(q==o.lastChild){d.insertBefore(o.parentNode,c,o.nextSibling)
}else{var j=o.cloneNode(false);
d.insertBefore(o.parentNode,j,o);
d.insertBefore(o.parentNode,c,o);
while(o.childNodes[0]!=q){var e=o.childNodes[0];
o.removeChild(e);
j.appendChild(e)
}}}o.removeChild(q);
c.appendChild(q);
if(o.childNodes.length==0){o.parentNode.removeChild(o)
}}}}}},createListFromSelection:function(g,e){var c=g.nodeList;
var d=g.editContext;
var b=c.getEditBlocksByAuxRoots(d,true);
var f=b.length;
for(var a=0;
a<f;
a++){CUI.rte.ListUtils.createList(d,b[a],e)
}},unlistItems:function(e,d,a){if(!d){d=this.getAllListItems(e)
}var c=e.editContext;
var g=d.length;
var f=[];
for(var b=0;
b<g;
b++){f.push(d[b].dom)
}CUI.rte.ListUtils.unlistItems(c,f,a)
},execute:function(c){var b=CUI.rte.Common;
var a=c.editContext;
var f=c.nodeList;
var h=c.command;
var j=c.value;
var i=null;
switch(h.toLowerCase()){case"insertorderedlist":i="ol";
break;
case"insertunorderedlist":i="ul";
break
}if(i){var e;
var m=this.getDefiningListDom(a,f);
if(m==null){this.createListFromSelection(c,i)
}else{if(!b.isTag(m,i)){e=this.getListItems(c);
this.changeItemsListType(c,e,i)
}else{e=this.getAllListItems(c);
if(e.length>0){var g=this.splitToTopLevelLists(c,e);
var k=g.length;
for(var d=0;
d<k;
d++){e=g[d];
this.unlistItems(c,e,j===true)
}}}}}},queryState:function(c,f){var a=CUI.rte.Common;
var e=c.editContext;
var b=c.nodeList;
var d;
switch(f.toLowerCase()){case"insertorderedlist":d="ol";
break;
case"insertunorderedlist":d="ul";
break
}var g=this.getDefiningListDom(e,b);
return((g!=null)&&a.isTag(g,d))
}});
CUI.rte.commands.List.NO_LIST_AVAILABLE=new Object();
CUI.rte.commands.CommandRegistry.register("_list",CUI.rte.commands.List);
CUI.rte.commands.Outdent=new Class({toString:"Outdent",extend:CUI.rte.commands.Command,isCommand:function(a){return(a.toLowerCase()=="outdent")
},getProcessingOptions:function(){var a=CUI.rte.commands.Command;
return a.PO_SELECTION|a.PO_BOOKMARK|a.PO_NODELIST
},execute:function(f){var d=CUI.rte.Common;
var j=f.nodeList;
var c=f.editContext;
var o=CUI.rte.commands.Indent.TAGEXCL;
var b=j.getTags(c,[{matcher:function(l){if(d.isRootNode(c,l)){return false
}if(d.isTag(l,d.BLOCK_TAGS)&&!d.isTag(l,o)){return !!l.style.marginLeft
}return d.isTag(l,"li")
}}],true,true);
CUI.rte.ListUtils.postprocessSelectedItems(b);
var q=b.length;
var r=[];
var n=[];
for(var i=0;
i<q;
i++){var m=b[i];
var k=m.dom;
if(d.isTag(k,d.BLOCK_TAGS)){var h=0;
if(k.style.marginLeft){h=parseInt(k.style.marginLeft);
h-=f.value||CUI.rte.commands.Indent.DEFAULT_INDENT_SIZE;
if(h<=0){k.style.marginLeft=null
}else{k.style.marginLeft=h+"px"
}}}else{var a=CUI.rte.ListUtils.getTopListForItem(c,k);
var e=d.arrayIndex(r,a);
if(e<0){r.push(a);
n.push([k])
}else{n[e].push(k)
}}}for(var g=0;
g<r.length;
g++){var p=new CUI.rte.ListRepresentation();
p.fromList(r[g]);
p.ensureHierarchy(c);
p.outdent(c,n[g])
}}});
CUI.rte.commands.CommandRegistry.register("outdent",CUI.rte.commands.Outdent);
CUI.rte.commands.Paste=new Class({toString:"Paste",extend:CUI.rte.commands.Command,domPreProcessor:null,handleLineFeedsPlaceholders:function(f,g){var d=CUI.rte.Common;
var e=g.length;
for(var i=0;
i<e;
i++){var a=d.getLastTextChild(g[i],true,false);
if(d.isTag(a,"br")){if(d.isAttribDefined(a,d.BR_TEMP_ATTRIB)){var b=d.getPreviousCharacterNode(f,a,d.EDITBLOCK_TAGS);
if(b&&!d.isTag(b,"br")){var h=d.getNodeText(b);
if(!d.ua.isGecko||!h||!d.strEndsWith(h," ")){a.parentNode.removeChild(a)
}}}}}},pasteAsPlainText:function(c){var i=CUI.rte.HtmlProcessor;
var a=CUI.rte.DomProcessor;
var w=CUI.rte.Selection;
var j=CUI.rte.Common;
var q=c.value.html;
var s=c.value.text;
var d=c.editContext;
var t;
if(s!==null&&s!==undefined){t=s
}else{var n=d.doc.createElement("div");
n.innerHTML=q;
t=j.getInnerText(n);
t=i.stripSurroundingWhitespace(t,true);
if(c.value.stripHtmlTags){t=CUI.rte.Utils.htmlDecode(t);
t=CUI.rte.Utils.stripTags(t)
}}var h=[];
var v=w.createProcessingSelection(d);
var k=v.startNode;
var A=v.startOffset;
var y=j.containsTagInPath(d,k,"li");
t=t.replace(/\r\n/g,"\n");
t=t.replace(/\r/g,"\n");
t=t.replace(/\t/g," ");
var z=(y?"\n":"\n\n");
var f=t.split(z);
var o=f.length;
if(j.isRootNode(d,k)){k=a.ensureMinimumContent(d);
A=null
}h.push(a.getEditBlock(d,k));
for(var m=0;
m<o;
m++){if(m>0){if(A==null){var x=j.getFirstTextChild(k,true);
if(x&&!j.isOneCharacterNode(x)){k=x
}A=0
}k=a.insertParagraph(d,k,A);
A=null;
h.push(k)
}var b=f[m].split("\n");
var l=b.length;
for(var u=0;
u<l;
u++){var p=b[u];
if(u>0){var g=d.createElement("br");
var e=(A==null?0:A);
a.insertElement(d,g,k,e);
k=g.parentNode;
A=j.getChildIndex(g)+1
}if(p!=""){var r=a.insertText(d,k,A,p);
k=r.node;
A=r.offset
}}}this.handleLineFeedsPlaceholders(d,h);
return{startNode:k,startOffset:A}
},cleanUpDom:function(c,g,f,d){var b=CUI.rte.Common;
var a=CUI.rte.HtmlProcessor;
var e=[{fn:function(k){if(k.nodeType!=1){return false
}if(b.isTag(k,"img")){var j=k.src;
if(k[b.SRC_ATTRIB]){j=k[b.SRC_ATTRIB]
}if(!j||b.strStartsWith(j,"file://")){return true
}var h=b.getAttribute(k,"style");
if(h){var i=a.parseStyleDef(h);
if(i.width){b.setAttribute(k,"width",parseInt(i.width))
}if(i.height){b.setAttribute(k,"height",parseInt(i.height))
}}}return false
},keepChildren:false},{tagName:["font"],keepChildren:true}];
CUI.rte.WhitespaceProcessor.process(c,f,e,false);
this.domPreProcessor.prepareHtmlPaste(g,f,d)
},pasteTableToTable:function(k){var i=CUI.rte.Common;
var M=k.editContext;
var w;
var z=k.value.dom;
var h=i.getTags(z,"table");
if(h.length!=1){this.insertHtml(k);
return
}var f=M.root.innerHTML;
var l=k.selection;
var g=k.nodeList;
var F=i.getTagInPath(M,g.commonAncestor,"table");
var s=new CUI.rte.TableMatrix();
s.createTableMatrix(h[0]);
s.createFullMatrix();
var j=new CUI.rte.TableMatrix();
j.createTableMatrix(F);
var B=null;
var p=null;
var m=k.component;
var C,L,n,I,K,E;
if(l.cellSelection){p=l.cellSelection.cells;
if(p&&(p.length==1)){B=p[0]
}}else{if(g.nodes&&(g.nodes.length==1)){var b=g.nodes[0].dom;
if(i.isTag(b,i.TABLE_CELLS)&&(b.childNodes.length==0)){B=b
}}if(B==null){B=i.getTagInPath(M,g.commonAncestor,i.TABLE_CELLS)
}}if(B){var t=j.getCellDef(B);
var G=s.getTableSize();
var A=j.getTableSize();
var o=t.col;
var v=t.row;
var a=(o+G.cols)-A.cols;
var y=(v+G.rows)-A.rows;
a=(a>=0?a:0);
y=(y>=0?y:0);
j.extendBy(M,a,y);
var u=null;
try{u=j.mergeToSingleCell(M,o,v,G.cols,G.rows)
}catch(J){M.root.innerHTML=f;
if(J.message=="Invalid table structure."){m.getDialogManager().alert(CUI.rte.Utils.i18n("commands.paste.alertTitle"),CUI.rte.Utils.i18n("commands.paste.alertTableError"));
return
}throw J
}j.createTableMatrix(F);
j.createFullMatrix();
u.parentNode.removeChild(u);
for(C=0;
C<G.rows;
C++){for(L=0;
L<G.cols;
L++){n=s.fullMatrix[C][L];
if(n.isOrigin){I=j.getFollowUpCell(L+o,C+v);
K=(I?I.cellDom:null);
E=j.getRowDom(C+v);
var H=n.cellRef.cellDom;
var x=M.createElement("span");
x.innerHTML="<table><tr><td></td></tr></table>";
var d=CUI.rte.Query.selectNode("td:first",x);
var D=d.parentNode;
i.replaceNode(d,H);
w=D.innerHTML;
if(!w){w="<td>"+(i.ua.isIE?"&nbsp;":"<br>")+"</td>"
}if(i.ua.isIE){i.removeAllChildren(x);
x.innerHTML="<table><tr>"+w+"</tr></table>";
D=CUI.rte.Query.selectNode("tr:first",x)
}else{D.innerHTML=w
}E.insertBefore(D.childNodes[0],K)
}}}}else{if(p){var q=j.createSelection(l.cellSelection.cells);
if(!q.selectionProps.isRect){m.getDialogManager().alert(CUI.rte.Utils.i18n("commands.paste.alertTitle"),CUI.rte.Utils.i18n("commands.paste.alertCellSelectionError"));
return
}try{u=j.mergeToSingleCell(M,q.selectionProps.minCol,q.selectionProps.minRow,q.selectionProps.cols,q.selectionProps.rows)
}catch(J){M.root.innerHTML=f;
if(J.message=="Invalid table structure."){m.getDialogManager().alert(CUI.rte.Utils.i18n("commands.paste.alertTitle"),CUI.rte.Utils.i18n("commands.paste.alertTableError"));
return
}throw J
}i.removeAllChildren(u);
u.innerHTML=z.innerHTML
}}},preprocessDiv:function(f){var b=CUI.rte.Common;
var g,d,e;
d=f.childNodes.length;
for(g=d-1;
g>=0;
g--){e=f.childNodes[g];
if(b.isTag(e,"div")){this.preprocessDiv(e)
}}var a=false;
d=f.childNodes.length;
for(g=d-1;
g>=0;
g--){e=f.childNodes[g];
if(b.isTag(e,b.BLOCK_TAGS)){if(!b.hasTextChild(e)){f.removeChild(e)
}else{a=true
}}}if(a){d=f.childNodes.length;
for(g=d-1;
g>=0;
g--){e=f.childNodes[g];
f.removeChild(e);
if(f.nextSibling){f.parentNode.insertBefore(e,f.nextSibling)
}else{f.parentNode.appendChild(e)
}}f.parentNode.removeChild(f)
}else{if(!b.hasTextChild(f,true)){f.parentNode.removeChild(f)
}}},insertInExistingNode:function(f,k,c){var h=CUI.rte.Common;
var a=CUI.rte.DomProcessor;
var q=CUI.rte.Selection;
var j=k.startNode;
var u=k.startOffset;
if(u==q.getLastSelectionOffset(f,j,false)){var b=j;
while(b){b=h.getTagInPath(f,b,"a");
if(b&&h.isAttribDefined(b,"href")){var e=h.getNextNode(f,b);
var v=null;
if(e!=null){v=h.getNextCharacterNode(f,e,h.EDITBLOCK_TAGS)
}if(v){j=v;
u=q.getFirstSelectionOffset(f,v)
}else{j=b.parentNode;
u=null
}break
}}}var t,d;
if(j.nodeType==3){if(u==0){t=false;
d=false
}else{if(u==h.getNodeCharacterCnt(j)){t=true;
d=false
}else{var l=a.splitTextNode(f,j,u);
j=l[l.length-1];
t=false;
d=false
}}}else{if(h.isOneCharacterNode(j)){t=(u==0)||h.isTag(j,"br");
d=false
}else{if(j.nodeType==1){if((u==undefined)||(u==j.childNodes.length)){t=false;
d=true
}else{j=j[u];
t=false;
d=true
}}}}var o=h.childNodesAsArray(c);
var n=o.length;
for(var s=0;
s<n;
s++){var g=o[s];
c.removeChild(g);
if(d){j.appendChild(g)
}else{if(t){h.insertBefore(j.parentNode,g,j.nextSibling);
j=g
}else{h.insertBefore(j.parentNode,g,j)
}}}var p=o[n-1];
var r=h.getLastChild(p);
if(r!=null){p=r
}var m=a.removeDuplicateStructures(f,o[0],p);
return{startNode:m.endNode,startOffset:CUI.rte.Selection.getLastSelectionOffset(f,m.endNode,false)}
},insertAsSingleLine:function(e,a,b){var c=CUI.rte.Common;
var f=CUI.rte.DomProcessor;
var d=f.getEmptyLine(e,a);
if(d!=null){c.removeAllChildren(d);
c.moveChildren(b,d);
return{startNode:d,startOffset:undefined}
}return this.insertInExistingNode(e,a,b)
},ensureBlockStructure:function(b,g){var f=CUI.rte.Common;
var e=g.childNodes;
var i=e.length;
for(var j=i-1;
j>=0;
j--){var h=e[j];
if(!f.isTag(h,f.BLOCK_TAGS)){var d=b.createElement("p");
var a=h.nextSibling;
g.removeChild(h);
d.appendChild(h);
while(j>0){j--;
var k=e[j];
if(f.isTag(k,f.BLOCK_TAGS)){j++;
break
}g.removeChild(k);
d.insertBefore(k,d.firstChild)
}f.insertBefore(g,d,a);
h=d
}}},preprocessPastedDom:function(a,g,j){var e=CUI.rte.Common;
var b=a.getEditContext();
var f=g.childNodes.length;
var d=g.childNodes;
for(var h=f-1;
h>=0;
h--){var i=d[h];
if(e.isTag(i,e.BLOCK_TAGS)){if(e.isTag(i,"div")){this.preprocessDiv(i)
}}}this.ensureBlockStructure(b,g)
},splitExistingNode:function(b,g,h){var e=CUI.rte.Common;
var k=CUI.rte.DomProcessor;
var d=CUI.rte.Selection;
var i=e.getTagInPath(b,g,e.EDITBLOCK_TAGS);
if(!i){throw new Error("No edit block found. Cannot split node.")
}var j=e.getFirstChild(i);
if(j==g){if(h==d.getFirstSelectionOffset(b,g)){return{insertPoint:i,insertBehind:false}
}}var a=e.getLastChild(i);
if(a==g){if(h==d.getLastSelectionOffset(b,g,false)){return{insertPoint:i,insertBehind:true}
}}if(e.isOneCharacterNode(g)){if(h==0){g=e.getNextNode(b,g);
h=null
}}var f=k.splitToParent(i,g,h);
var c=false;
return{insertPoint:f,insertBehind:c}
},insertHtml:function(l){var y=CUI.rte.DomProcessor;
var v=CUI.rte.Selection;
var g=CUI.rte.Common;
var n=CUI.rte.commands.Paste.ATOMIC_PROCESSING_BLOCKS;
var N=l.editContext;
var x=l.value.dom;
var j=v.createProcessingSelection(N);
if(j.cellSelection&&j.cellSelection.cells){if(j.cellSelection.cells.length>0){var H=j.cellSelection.cells[0];
var b=null;
var h=g.getFirstTextChild(H,true);
if(h){H=h;
b=v.getFirstSelectionOffset(N,h)
}j.startNode=H;
j.startOffset=b;
j.endNode=null;
j.endOffset=null
}}var K,d,L;
var B=false;
var e=false;
this.preprocessPastedDom(l.component,x,l.value.pasteRules);
var o=x.childNodes;
var F=o.length;
if(F==0){return null
}var I=j.startNode;
var k=g.getTagInPath(N,I,["ul","ol"]);
if(F==1){if(g.isTag(o[0],["ul","ol"])){if(k){x=o[0];
o=x.childNodes;
F=o.length
}}}if(k){var q=N.createElement("li");
for(L=F-1;
L>=0;
L--){var f=o[L];
if(g.isTag(f,["ul","ol"])){var p=f.childNodes;
while(p.length>0){var s=p[0];
x.insertBefore(s,f)
}x.removeChild(f)
}else{if(!g.isTag(f,"li")){y.changeContainerTag(N,[f],q,false)
}}}F=o.length
}if(F==1){K=g.isTag(o[0],n);
if(!K){return this.insertAsSingleLine(N,j,o[0])
}}var E=g.getTagInPath(N,I,["td","th"]);
if(E!=null){this.ensureBlockStructure(N,E)
}o=g.childNodesAsArray(x);
var J=y.getEmptyLine(N,j);
var m=(J!=null)&&!g.isTag(J,["td","th"]);
var t=false;
if(m){d=J;
B=false;
t=true
}if((J!=null)&&!m){g.removeAllChildren(J);
d=J;
e=true;
t=true
}var z=null;
for(L=0;
L<F;
L++){var D=o[L];
K=g.isTag(D,n)||t;
var C=(L==(F-1));
var i,a,r,M;
var A=false;
if((L==0)&&!K){i=this.insertInExistingNode(N,j,D);
r=i.startNode;
M=i.startOffset;
a=this.splitExistingNode(N,r,M);
d=a.insertPoint;
B=a.insertBehind
}else{if((L==0)&&K){if(!e){a=this.splitExistingNode(N,j.startNode,j.startOffset);
d=a.insertPoint;
B=a.insertBehind
}A=true
}else{if(C&&!K&&!m){if(B){if(d.nextSibling){r=g.getFirstTextChild(d.nextSibling,true)
}else{r=null;
A=true
}}else{r=g.getFirstTextChild(d,true)
}if(r!=null){M=v.getFirstSelectionOffset(N,r);
i={startNode:r,startOffset:M};
i=this.insertInExistingNode(N,i,D);
z=i
}}else{A=true
}}}if(A){if(B){g.insertBefore(d.parentNode,D,d.nextSibling);
d=D
}else{if(e){d.appendChild(D)
}else{g.insertBefore(d.parentNode,D,d)
}}if(g.ua.isIE){y.fixEmptyEditingBlockIE(N,D)
}else{var w=g.getCharacterNodes(D);
if(w==0){var u=y.createEmptyLinePlaceholder(N,false);
if(u){var G=g.getFirstChild(D);
if(G==null){G=D
}G.appendChild(u)
}}}if(C){z={startNode:D,startOffset:null}
}}}if(m){J.parentNode.removeChild(J)
}return z
},pasteAsWordHtml:function(d){var b=CUI.rte.Selection;
var c=CUI.rte.Common;
var a=d.editContext;
var h=d.value.dom;
this.cleanUpDom(a,d.component,h,d.value.pasteRules);
h.innerHTML=h.innerHTML;
c.removeEmptyChildNodes(h,"p");
var l;
var g=c.containsTag(h,"table");
var f=d.nodeList;
var k=c.containsTagInPath(a,f.commonAncestor,"table");
if(k&&g){try{this.pasteTableToTable(d)
}catch(j){if(j.message!="Invalid paste structure."){throw j
}}}else{l=this.insertHtml(d)
}var i;
if(l){i=b.bookmarkFromProcessingSelection(a,l)
}else{i=b.createSelectionBookmark(a)
}d.bookmark=i
},isCommand:function(a){return(a.toLowerCase()=="paste")
},getProcessingOptions:function(){var a=CUI.rte.commands.Command;
return a.PO_BOOKMARK
},execute:function(g){var j=CUI.rte.Common;
var p=CUI.rte.Selection;
var a=CUI.rte.DomProcessor;
var l=CUI.rte.commands.Paste;
var h=g.editContext;
var o=g.value;
var m=o.mode;
var f=o.pasteRange;
var r=g.component;
var q=r.htmlRules.serializer.cleanup?r.htmlRules.serializer.cleanup.paste:undefined;
q=q?q:{tagsToRemove:["font"]};
this.domPreProcessor=new CUI.rte.DomCleanup(q);
if(m==l.MODE_BROWSER){try{h.doc.execCommand("paste",false,null)
}catch(s){throw new Error("Cannot paste.")
}return
}try{g.component.selectQualifiedRangeBookmark(h,f);
var v=p.getSelection(h);
var b=(j.ua.isOldIE?p.isCollapsed(f.bookmark):v.isCollapsed)&&!f.cells;
if(!b){var n=g.component.createQualifiedSelection(h);
var i=(n.cellSelection?n.cellSelection.cells:undefined);
if(!i||i.length==0){CUI.rte.commands.Delete.executeDelete(h)
}else{for(var t=0;
t<i.length;
t++){var d=i[t];
j.removeAllChildren(d);
a.ensureEmptyLinePlaceholders(h,d)
}}}g.selection=g.component.createQualifiedSelection(h);
g.nodeList=a.createNodeList(h,g.selection);
var u;
switch(m){case l.MODE_PLAINTEXT:u=this.pasteAsPlainText(g);
break;
case l.MODE_WORDHTML:u=this.pasteAsWordHtml(g);
break;
default:throw new Error("Invalid paste mode: "+m);
break
}var k=g.bookmark;
if(u){k=p.bookmarkFromProcessingSelection(h,u)
}g.bookmark=k;
return{calleeRet:{bookmark:k,geckoEnsureCaretVisibility:true}}
}catch(s){try{console.log(s)
}catch(s){}}return{calleeRet:{bookmark:g.bookmark,geckoEnsureCaretVisibility:true}}
}});
CUI.rte.commands.Paste.MODE_BROWSER="browser";
CUI.rte.commands.Paste.MODE_PLAINTEXT="plaintext";
CUI.rte.commands.Paste.MODE_WORDHTML="wordhtml";
CUI.rte.commands.Paste.ATOMIC_PROCESSING_BLOCKS=["table","ul","ol"];
CUI.rte.commands.CommandRegistry.register("paste",CUI.rte.commands.Paste);
CUI.rte.commands.Style=new Class({toString:"Style",extend:CUI.rte.commands.Command,addStyle:function(d){var b=CUI.rte.Selection;
var c=CUI.rte.Common;
var e=d.value;
var h=d.selection;
var a=d.editContext;
var i=b.getSelectedDom(a,h);
var g=CUI.rte.plugins.StylesPlugin.STYLEABLE_OBJECTS;
if(i&&c.isTag(i,g)){c.removeAllClasses(i);
c.addClass(i,e);
return
}var f=d.nodeList;
if(f){f.surround(d.editContext,"span",{className:e})
}},removeStyle:function(b){var e=CUI.rte.Common;
var a=CUI.rte.DomProcessor;
var p=CUI.rte.Selection;
var w=b.selection;
var c=b.editContext;
var u=b.value;
var d,n,j;
var h=p.getSelectedDom(c,w);
var o=CUI.rte.plugins.StylesPlugin.STYLEABLE_OBJECTS;
if(h&&e.isTag(h,o)){if(u&&!u.styles){e.removeClass(h,u)
}else{if(u&&u.styles){n=u.styles.length;
for(j=0;
j<n;
j++){d=u.styles[j];
if((typeof(d)=="object")&&d.cssName){d=d.cssName
}if(e.hasCSS(h,d)){e.removeClass(h,d)
}}}else{e.removeAllClasses(h)
}}return
}var v=b.nodeList;
var q=v.getTags(c,[{matcher:function(r){return e.isTag(r,"span")
}}],true);
var g=[];
var m=q.length;
for(var k=0;
k<m;
k++){var f=q[k].dom;
if(u&&!u.styles){if(e.hasCSS(f,u)){g.push(f)
}}else{if(u&&u.styles){n=u.styles.length;
for(j=0;
j<n;
j++){d=u.styles[j].cssName;
if(e.hasCSS(f,d)){g.push(f);
break
}}}else{if(f.className){g.push(f)
}}}}var t=g.length;
for(var l=0;
l<t;
l++){var i=g[l];
if(w.endNode){v.removeNodesByTag(b.editContext,i.tagName,{"class":i.getAttribute("class")},true)
}else{a.removeWithoutChildren(i)
}}},isCommand:function(b){var a=b.toLowerCase();
return(a=="applystyle")||(a=="removestyle")
},getProcessingOptions:function(){var a=CUI.rte.commands.Command;
return a.PO_BOOKMARK|a.PO_SELECTION|a.PO_NODELIST
},execute:function(a){switch(a.command.toLowerCase()){case"applystyle":this.addStyle(a);
break;
case"removestyle":this.removeStyle(a);
break
}},queryState:function(a,b){return false
}});
CUI.rte.commands.CommandRegistry.register("_style",CUI.rte.commands.Style);
CUI.rte.commands.Table=new Class({toString:"Table",extend:CUI.rte.commands.Command,getTable:function(c){var a=CUI.rte.Common;
var b=c.editContext;
return a.getTagInPath(b,c.nodeList.commonAncestor,"table")
},createEmptyCell:function(b,a){return CUI.rte.TableMatrix.createEmptyCell(b.editContext,a)
},transferConfigToTable:function(f,e){var c=CUI.rte.Common;
var d=e.value;
var h=CUI.rte.commands.Table.CONFIG_NONE;
var b=e.editContext;
var j=c.getChildNodesByType(f,"caption");
var k=CUI.rte.DomProcessor;
if(d.cellpadding){c.setAttribute(f,"cellpadding",d.cellpadding)
}else{c.removeAttribute(f,"cellpadding")
}this.handleCellspacing(f,e);
if(d.cellspacing){c.setAttribute(f,"cellspacing",d.cellspacing)
}else{c.removeAttribute(f,"cellspacing")
}if(d.border){f.border=d.border;
if(d.border==0){c.addClass(f,CUI.rte.Theme.TABLE_NOBORDER_CLASS)
}else{c.removeClass(f,CUI.rte.Theme.TABLE_NOBORDER_CLASS)
}}else{c.removeAttribute(f,"border");
c.addClass(f,CUI.rte.Theme.TABLE_NOBORDER_CLASS)
}if(d.width){c.setAttribute(f,"width",d.width)
}else{c.removeAttribute(f,"width")
}if(d.height){c.setAttribute(f,"height",d.height)
}else{c.removeAttribute(f,"height")
}if(d.caption){if(j.length>0){j=j[0]
}else{j=b.createElement("caption");
k.insertElement(b,j,f,0)
}j.innerHTML=d.caption
}else{if(j.length>0){j[0].parentNode.removeChild(j[0])
}}var a=c.parseCSS(f);
for(var g=0;
g<a.length;
g++){if(a[g]!=CUI.rte.Theme.TABLE_NOBORDER_CLASS){c.removeClass(f,a[g])
}}if(d.tableStyle&&(d.tableStyle!=h)){c.addClass(f,d.tableStyle)
}},handleCellspacing:function(b,a){return
},createTable:function(m){var a=CUI.rte.DomProcessor;
var z=CUI.rte.Selection;
var p=CUI.rte.Common;
var n=m.editContext;
var F=m.selection;
var q=F.startNode;
var D=F.startOffset;
var G=a.getScopedBlockNode(n,q);
if(!G){return
}var g=G.isAuxiliaryRoot;
G=G.dom;
var h=false;
var C=null;
if(a.isEmptyLineBlock(G)&&!g){C=G;
q=G
}else{if(p.isTag(G,p.TABLE_CELLS)){q=G;
h=true;
p.removeAllChildren(q)
}else{if(a.isBlockStart(n,q,D)){q=G
}else{if(a.isBlockEnd(n,q,D)){if(G.nextSibling){q=G.nextSibling
}else{q=G.parentNode;
h=true
}}else{q=a.insertParagraph(n,q,D);
if(!q){return
}}}}}var E=m.value;
var w;
var u=null;
var d=null;
if(E.html){d=n.createElement("span");
d.innerHTML=E.html;
w=d
}else{u=n.createElement("table");
w=u
}if(!h){q.parentNode.insertBefore(w,q)
}else{q.appendChild(w)
}if(C){C.parentNode.removeChild(C)
}if(E.html){var s=CUI.rte.Query.select("table",d);
for(var y=0;
y<s.length;
y++){if(s[y].border==0){p.addClass(s[y],CUI.rte.Theme.TABLE_NOBORDER_CLASS)
}}a.removeWithoutChildren(d);
return
}var f=E.header;
var v=(f.indexOf("top")>=0);
var x=(f.indexOf("left")>=0);
this.transferConfigToTable(u,m);
var b=n.createElement("tbody");
u.appendChild(b);
var l=null;
for(var B=0;
B<E.rows;
B++){var c=n.createElement("tr");
b.appendChild(c);
for(var A=0;
A<E.columns;
A++){var k="td";
var o=null;
if((B==0)&&v){k="th";
o="col"
}else{if((A==0)&&x){k="th";
o="row"
}}var e=n.createElement(k);
if(o){p.setAttribute(e,"scope",o)
}if(!l){l=e
}c.appendChild(e);
var r=a.createEmptyLinePlaceholder(n);
if(r){e.appendChild(r)
}}}m.bookmark=z.bookmarkFromProcessingSelection(n,{startNode:l,startOffset:null})
},modifyTable:function(e){var d=CUI.rte.Selection;
var a=CUI.rte.Common;
var c=this.getTable(e);
var b=e.value;
if(c&&b){this.transferConfigToTable(c,e)
}if(a.ua.isGecko){d.flushSelection(e.editContext)
}else{e.bookmark=null
}},removeTable:function(d){var b=CUI.rte.Selection;
var c=CUI.rte.Common;
var h=CUI.rte.DomProcessor;
var a=d.editContext;
var i=this.getTable(d);
if(i){var g=b.bookmarkFromProcessingSelection(a,{startNode:i,startOffset:0});
var e=i.parentNode;
e.removeChild(i);
var f=c.getTagInPath(a,e,["td","th"]);
if(f){h.ensureEmptyLinePlaceholders(a,f)
}if((e==a.root)&&(e.childNodes.length==0)){a.root.appendChild(h.createEmptyLinePlaceholder(a,true))
}b.flushSelection(a);
d.bookmark=g
}},getTableBody:function(d){var a=CUI.rte.Common;
var b=this.getTable(d);
var c=a.getChildNodesByType(b,"tr",true);
if(c.length>0){b=c[0].parentNode
}return b
},isEmptyCell:function(a){return CUI.rte.DomProcessor.isEmptyLineBlock(a)
},getSelectedRows:function(c){var a=CUI.rte.Common;
var b=c.editContext;
return c.nodeList.getTags(b,[{matcher:function(d){return a.isTag(d,"tr")
}}],true,true)
},getEntireRowForCell:function(b,j){var g=this.getTable(b);
var d=new CUI.rte.TableMatrix();
d.createTableMatrix(g);
var e=d.getCellDef(j);
var f=e.row;
var a=[];
if(e){var k=d.getRow(f);
if(k){for(var i=0;
i<k.length;
i++){var h=k[i];
if(h.row==f){a.push(h.cellDom)
}}}}return a
},getEntireColumnForCell:function(a,k){var g=this.getTable(a);
var e=new CUI.rte.TableMatrix();
e.createTableMatrix(g);
var f=e.getCellDef(k);
var j=f.col;
var b=[];
if(f){var d=e.getColumn(j);
if(d){for(var i=0;
i<d.length;
i++){var h=d[i];
if(h.col==j){b.push(h.cellDom)
}}}}return b
},insertRow:function(e,g,r){var q=CUI.rte.Selection;
var f=e.editContext;
var m=this.getSelectedRows(e);
if(m.length==1){if(!r){r="default"
}var h=this.getSelectedCells(e);
var k=this.getTable(e);
var p=new CUI.rte.TableMatrix();
p.createTableMatrix(k);
var s=p.getCellDef(h[0].dom);
var d=(g?s.row:s.row+s.rowSpan-1);
var n=p.getRow(d);
var j=f.createElement("tr");
var l=p.getRowDom(d);
var a=(g?l:l.nextSibling);
l.parentNode.insertBefore(j,a);
var v;
for(var t=0;
t<n.length;
t++){var b=n[t];
var i=b.cellDom;
var o=this.createEmptyCell(e,i);
if(i.colSpan>1){o.colSpan=i.colSpan
}if(r=="default"){if(b==s){v=o
}}else{if(r=="firstCell"){if(t==0){v=o
}}}if(b.rowSpan==1){j.appendChild(o)
}else{var u=(g?(b.row!=s.row):((b.row+b.rowSpan-1)>d));
if(!u){j.appendChild(o)
}else{if(r=="default"){if(b==s){v=i
}}else{if(r=="firstCell"){if(t==0){v=i
}}}i.rowSpan++
}}}q.flushSelection(f);
if(v){e.bookmark=q.bookmarkFromProcessingSelection(f,{startNode:v,startOffset:null})
}else{e.bookmark=null
}}},removeRow:function(b){var o=CUI.rte.Selection;
var a=CUI.rte.DomProcessor;
var d=b.editContext;
var q=this.getTable(b);
var j=this.getSelectedRows(b);
if(j.length==1){var k=new CUI.rte.TableMatrix();
k.createTableMatrix(q);
var p=k.getTableSize();
if(p.rows==1){this.removeTable(b);
return
}var e=this.getSelectedCells(b);
var s=k.getCellDef(e[0].dom);
var n=k.getRow(s.row);
var t;
if(s.rowSpan>1){t=s.cellDom
}else{if(s.row<(p.rows-1)){t=k.getCellForCoords(s.col,s.row+1)
}else{t=k.getCellForCoords(s.col,s.row-1)
}if(t){t=t.cellDom
}else{t=q
}}var f;
for(var r=0;
r<n.length;
r++){var h=n[r];
f=h.cellDom;
if(h.rowSpan==1){f.parentNode.removeChild(f)
}else{if(h.row==s.row){while(f.childNodes.length>0){f.removeChild(f.childNodes[0])
}f.appendChild(d.createTextNode(a.NBSP));
f.parentNode.removeChild(f);
var m=k.getRowCellForCoords(r,s.row+1);
var l=(m?m.cellDom:null);
var i=(l?l.parentNode:k.getRowDom(s.row+1));
i.insertBefore(f,l)
}f.rowSpan--
}}var g=j[0].dom;
g.parentNode.removeChild(g);
k.createTableMatrix(q);
k.optimizeSpans();
o.flushSelection(d);
if(t){b.bookmark=o.bookmarkFromProcessingSelection(d,{startNode:t,startOffset:null})
}else{b.bookmark=null
}}},getSelectedCells:function(g){var d=g.editContext;
var e=g.selection.cellSelection;
if(e){var f=[];
for(var i=0;
i<e.cells.length;
i++){f.push({dom:e.cells[i]})
}return f
}var b=g.nodeList;
var a=CUI.rte.Common;
var h=false;
return b.getTags(d,[{matcher:function(c){if(h){return false
}if(a.isTag(c,["td","th"])){h=true;
return true
}return false
}}],true,true)
},insertCol:function(f,l){var d=CUI.rte.Selection;
var c=f.editContext;
var p=this.getSelectedCells(f);
if(p.length==1){var k=this.getTable(f);
var i=new CUI.rte.TableMatrix();
i.createTableMatrix(k);
var e=i.getCellDef(p[0].dom);
var n=(l?e.col:e.col+e.colSpan-1);
var q=i.getColumn(n);
var h;
for(var b=0;
b<q.length;
b++){var o=q[b];
var m=o.cellDom;
var j=this.createEmptyCell(f,m);
if(m.rowSpan>1){j.rowSpan=m.rowSpan
}var a=(l?m:m.nextSibling);
if(o==e){h=j
}if(o.colSpan==1){m.parentNode.insertBefore(j,a)
}else{var g=(l?(o.col!=e.col):((o.col+o.colSpan-1)>n));
if(!g){m.parentNode.insertBefore(j,a)
}else{if(o==e){h=m
}m.colSpan++
}}}d.flushSelection(c);
if(h){f.bookmark=d.bookmarkFromProcessingSelection(c,{startNode:h,startOffset:null})
}else{f.bookmark=null
}}},removeCol:function(e){var c=CUI.rte.Selection;
var k=CUI.rte.DomProcessor;
var b=e.editContext;
var m=this.getTable(e);
var n=this.getSelectedCells(e);
if(n.length==1){var g=new CUI.rte.TableMatrix();
g.createTableMatrix(m);
var j=g.getTableSize();
if(j.cols==1){this.removeTable(e);
return
}var h=g.getCellDef(n[0].dom);
var d=g.getColumn(h.col);
var f;
if(h.colSpan>1){f=h.cellDom
}else{f=g.getFollowUpCell(h.col,h.row);
if(!f&&(h.col>0)){f=g.getCellForCoords(h.col-1,h.row)
}if(f){f=f.cellDom
}else{f=m
}}var i;
for(var a=0;
a<d.length;
a++){var l=d[a];
i=l.cellDom;
if(l.colSpan==1){i.parentNode.removeChild(i)
}else{if(l.col==h.col){while(i.childNodes.length>0){i.removeChild(i.childNodes[0])
}i.appendChild(b.createTextNode(k.NBSP))
}i.colSpan--
}}g.createTableMatrix(m);
g.optimizeSpans();
c.flushSelection(b);
if(f){e.bookmark=c.bookmarkFromProcessingSelection(b,{startNode:f,startOffset:null})
}else{e.bookmark=null
}}},transferConfigToCell:function(a,h,d){var b=CUI.rte.Common;
var m=CUI.rte.commands.Table.CONFIG_NONE;
var l="false";
if(d.cellType&&(d.cellType!=m)){if(!b.isTag(h,d.cellType)){l="true";
var e=a.createElement(d.cellType);
b.copyAttributes(h,e);
b.replaceNode(h,e);
h=e
}}var n=b.isTag(h,"td")?"td":"th";
if(d.width){b.setAttribute(h,"width",d.width)
}else{b.removeAttribute(h,"width",d.height)
}if(d.height){b.setAttribute(h,"height",d.height)
}else{b.removeAttribute(h,"height")
}if(d.align){if(d.align!=m){h.style.textAlign=d.align
}else{h.style.textAlign=""
}}if(d.valign){if(d.valign!=m){b.setAttribute(h,"valign",d.valign)
}else{b.removeAttribute(h,"valign")
}}if(d.scope&&d.scope!=m&&n=="th"){b.setAttribute(h,"scope",d.scope)
}else{b.removeAttribute(h,"scope")
}if(d.headers&&n=="td"){b.setAttribute(h,"headers",d.headers)
}else{b.removeAttribute(h,"headers")
}if(d.id&&n=="th"){b.setAttribute(h,"id",d.id)
}else{b.removeAttribute(h,"id")
}b.removeAttribute(h,"class");
if(d.cellStyle&&(d.cellStyle!=m)){b.addClass(h,d.cellStyle)
}if(d.hiddenheader&&n=="th"){if(d.hiddenHeaderEditingCSS){b.addClass(h,d.hiddenHeaderEditingCSS)
}else{b.addInlineStyles(h,d.hiddenHeaderEditingStyle)
}b.setAttribute(h,"hiddenheader","true")
}else{if(l==="true"||d.handleHiddenHeader==="true"){if(d.hiddenHeaderEditingCSS){b.removeClass(h,d.hiddenHeaderEditingCSS)
}else{var c=[];
var o=d.hiddenHeaderEditingStyle;
o=o.trim();
var g=o.split(";");
for(var j=0;
j<g.length;
j++){var f=g[j].split(":");
if(f.length==2){var k=f[0].trim();
if(k.length){c.push(k)
}}}b.removeInlineStyles(h,c)
}b.removeAttribute(h,"hiddenheader")
}}},modifyCell:function(g){var f=CUI.rte.Selection;
var a=CUI.rte.Common;
var e=g.editContext;
var d=this.getSelectedCells(g);
var b=g.value;
for(var h=0;
h<d.length;
h++){this.transferConfigToCell(e,d[h].dom,b)
}if(a.ua.isGecko){f.flushSelection(e)
}else{g.bookmark=null
}},getExecDefValue:function(a){return a.value
},mergeCells:function(d){var h=CUI.rte.Common;
var p=CUI.rte.Selection;
var e=d.editContext;
var a=this.getExecDefValue(d);
var m=a?a.selectionProps:null;
var b=(m?m.anchorCell:null);
if(b){var r=this.getTable(d);
var t=b.cellDom;
var l=m.cols;
var g=m.rows;
var f=a.cells;
var o=[];
for(var s=0;
s<f.length;
s++){var k=f[s].cellDom;
if(k!=t){if(!this.isEmptyCell(k)){o.push(e.createTextNode(" "));
var j=k.childNodes;
for(var q=0;
q<j.length;
q++){o.push(j[q])
}}k.parentNode.removeChild(k)
}}if(l>1){h.setAttribute(t,"colspan",l)
}else{h.removeAttribute(t,"colspan")
}if(g>1){h.setAttribute(t,"rowspan",g)
}else{h.removeAttribute(t,"rowspan")
}for(q=0;
q<o.length;
q++){t.appendChild(o[q])
}var n=new CUI.rte.TableMatrix();
n.createTableMatrix(r);
n.optimizeSpans();
p.flushSelection(e);
d.bookmark=p.bookmarkFromProcessingSelection(e,{startNode:t,startOffset:null})
}},splitCellHorizontally:function(e){var b=CUI.rte.Selection;
var a=e.editContext;
var l=this.getTable(e);
var m=this.getSelectedCells(e);
if(l&&m.length==1){var k=m[0].dom;
var h=this.createEmptyCell(e);
if(k.rowSpan&&k.rowSpan>1){h.rowSpan=k.rowSpan
}if(k.colSpan&&k.colSpan>1){k.colSpan=k.colSpan-1;
k.parentNode.insertBefore(h,k.nextSibling)
}else{var f=new CUI.rte.TableMatrix();
f.createTableMatrix(l);
f.createFullMatrix();
var g=f.getCellDef(k);
var d=f.getColumn(g.col);
k.parentNode.insertBefore(h,k.nextSibling);
for(var j=0;
j<d.length;
j++){if(d[j]!=g){var i=d[j].cellDom.colSpan;
i=i||1;
d[j].cellDom.colSpan=++i
}}}b.flushSelection(a);
e.bookmark=b.bookmarkFromProcessingSelection(a,{startNode:h,startOffset:null})
}},splitCellVertically:function(b){var o=CUI.rte.Selection;
var d=b.editContext;
var q=this.getTable(b);
var g=this.getSelectedCells(b);
if(q&&g.length==1){var a=g[0].dom;
var j=this.createEmptyCell(b);
if(a.colSpan&&a.colSpan>1){j.colSpan=a.colSpan
}var l=new CUI.rte.TableMatrix();
l.createTableMatrix(q);
l.createFullMatrix();
var s=l.getCellDef(a);
if(a.rowSpan&&a.rowSpan>1){var k=s.row+s.rowSpan-1;
var n=l.getRowCellForCoords(s.col+1,k);
var m=(n?n.cellDom:null);
var i=(m?m.parentNode:l.getRowDom(k));
i.insertBefore(j,m);
a.rowSpan=a.rowSpan-1
}else{var h=l.getRow(s.row);
var p=a.parentNode;
var e=d.createElement("tr");
e.appendChild(j);
p.parentNode.insertBefore(e,p.nextSibling);
for(var r=0;
r<h.length;
r++){if(h[r]!=s){var f=h[r].cellDom.rowSpan;
f=f||1;
h[r].cellDom.rowSpan=++f
}}}o.flushSelection(d);
b.bookmark=o.bookmarkFromProcessingSelection(d,{startNode:j,startOffset:null})
}},ensureParagraph:function(d,i){var j=CUI.rte.DomProcessor;
var c=CUI.rte.Common;
var b=CUI.rte.Selection;
var a=d.editContext;
var f=null;
var g=this.getTable(d);
if(!g){return
}var e=g.parentNode;
if(!c.isRootNode(a,e)){return
}if(i){f=g
}else{f=g.nextSibling
}var h=j.createEmptyLinePlaceholder(a,true);
e.insertBefore(h,f);
j.fixEmptyEditingBlockIE(a,h);
b.flushSelection(a);
d.bookmark=b.bookmarkFromProcessingSelection(a,{startNode:h,startOffset:0})
},isCommand:function(c){var a=CUI.rte.Common;
var b=c.toLowerCase();
return a.strEndsWith(b,"table")||a.strEndsWith(b,"column")||a.strEndsWith(b,"row")||a.strEndsWith(b,"cell")||a.strEndsWith(b,"cells")||b=="ensureparagraph"
},getProcessingOptions:function(){var a=CUI.rte.commands.Command;
return a.PO_BOOKMARK|a.PO_SELECTION|a.PO_NODELIST
},execute:function(c){var b=undefined;
var a;
switch(c.command.toLowerCase()){case"createtable":this.createTable(c);
break;
case"modifytable":this.modifyTable(c);
break;
case"removetable":this.removeTable(c);
break;
case"insertrow":var d="default";
if(typeof(c.value)=="string"){a=c.value
}else{a=c.value.position;
d=c.value.caret
}this.insertRow(c,!a||(a=="before"),d);
b={calleeRet:{geckoEnsureCaretVisibility:true}};
break;
case"removerow":this.removeRow(c);
break;
case"insertcolumn":a=c.value;
this.insertCol(c,!a||(a=="before"));
break;
case"removecolumn":this.removeCol(c);
break;
case"modifycell":this.modifyCell(c);
break;
case"mergecells":this.mergeCells(c);
break;
case"splitcell":if(c.value=="horizontal"){this.splitCellHorizontally(c)
}else{if(c.value=="vertical"){this.splitCellVertically(c)
}}break;
case"ensureparagraph":a=c.value;
this.ensureParagraph(c,!a||(a=="before"));
b={calleeRet:{geckoEnsureCaretVisibility:true}};
break
}return b
},queryState:function(b,d){var a=CUI.rte.Common;
var c=b.editContext;
if(d=="table"){return a.getTagInPath(c,b.nodeList.commonAncestor,"table")
}else{if(d=="modifycell"){return CUI.rte.commands.Table.getCellFromNodeList(c,b.nodeList)
}}return false
}});
CUI.rte.commands.Table.getCellFromSelection=function(c,e){var b=CUI.rte.Common;
if(e.cellSelection&&e.cellSelection.cells){if(e.cellSelection.cells.length==1){return e.cellSelection.cells[0]
}return null
}var a=b.getTagInPath(c,e.startNode,b.TABLE_CELLS);
if(a&&e.endNode){var d=b.getTagInPath(c,e.endNode,b.TABLE_CELLS);
if(d!=a){a=null
}}return a
};
CUI.rte.commands.Table.getCellFromNodeList=function(d,c){var b=CUI.rte.Common;
var a=b.getTagInPath(d,c.commonAncestor,b.TABLE_CELLS);
if(a==null){if(c.nodes.length==1){var e=c.nodes[0].dom;
if(b.isTag(e,b.TABLE_CELLS)){a=e
}}}return a
};
CUI.rte.commands.Table.getCellsFromNodeList=function(e,d){var b=CUI.rte.Common;
var a=b.getTagInPath(e,d.commonAncestor,b.TABLE_CELLS);
var c=[];
if(a==null){for(var g=0;
g<d.nodes.length;
g++){var f=d.nodes[g].dom;
if(b.isTag(f,b.TABLE_CELLS)){c.push(f)
}}}else{c.push(a)
}return c
};
CUI.rte.commands.Table.CONFIG_NONE=new Object();
CUI.rte.commands.CommandRegistry.register("_table",CUI.rte.commands.Table);
CUI.rte.commands.Image=new Class({toString:"Image",extend:CUI.rte.commands.Command,createImage:function(f){var e=f.value;
var b=null;
if(e.path){b=CUI.rte.Utils.processUrl(e.path,CUI.rte.Utils.URL_IMAGE)
}var g=(e.alt?e.alt:"");
var d=(e.width?e.width:null);
var a=(e.height?e.height:null);
if(b){var c='<img src="'+b+'" alt="'+g+'"';
c+=" "+CUI.rte.Common.SRC_ATTRIB+'="'+e.path+'"';
if(d){c+=' width="'+d+'"'
}if(a){c+=' height="'+a+'"'
}c+=">";
f.component.execCmd("inserthtml",c)
}},applyProperties:function(h){var d=h.value;
var a=CUI.rte.Common;
var c=h.selection;
if(c.startNode&&(c.startOffset==undefined)&&!c.endNode){var f=c.startNode;
if(!a.isTag(f,"img")){return
}var e="style.";
for(var g in d){if(d.hasOwnProperty(g)){if(a.strStartsWith(g,e)){var b=g.substring(e.length,g.length);
if(b=="float"){if(a.ua.isIE6||a.ua.isIE7||a.ua.isIE8){b="styleFloat"
}else{b="cssFloat"
}}f.style[b]=d[g]
}else{f.setAttribute(g,d[g])
}}}if(a.ua.isGecko){CUI.rte.Selection.flushSelection(h.editContext)
}}},isCommand:function(b){var a=b.toLowerCase();
return(a=="image")||(a=="insertimg")
},getProcessingOptions:function(){var a=CUI.rte.commands.Command;
return a.PO_BOOKMARK|a.PO_SELECTION
},execute:function(a){switch(a.command.toLowerCase()){case"insertimg":this.createImage(a);
break;
case"image":this.applyProperties(a);
break
}},queryState:function(a,b){if(b.toLowerCase()=="image"){return(CUI.rte.commands.Image.getSelectedImage(a)!=null)
}return false
}});
CUI.rte.commands.Image.getSelectedImage=function(b){var a=CUI.rte.Common;
var c=b.selection;
if(c.startNode&&(c.startOffset==undefined)&&!c.endNode){var d=c.startNode;
return(a.isTag(d,"img")?d:null)
}return null
};
CUI.rte.commands.CommandRegistry.register("_image",CUI.rte.commands.Image);
CUI.rte.commands.UndoRedo=new Class({toString:"UndoRedo",extend:CUI.rte.commands.Command,undoManager:null,construct:function(){this.undoManager=new CUI.rte.UndoManager(50)
},isCommand:function(b){var a=b.toLowerCase();
return(a=="undo")||(a=="redo")||(a=="undoconfig")||(a=="initializeundo")||(a=="addundostep")||(a=="clearredohistory")||(a=="getundoconfig")||(a=="dumpundohistory")
},isUndoable:function(a){return false
},requiresInitializedComponent:function(a){return(a!="undoconfig")
},getProcessingOptions:function(){return CUI.rte.commands.Command.PO_NONE
},execute:function(c){var b=c.command.toLowerCase();
var a=c.editContext;
var d=undefined;
switch(b){case"undo":this.undoManager.undo(a);
break;
case"redo":this.undoManager.redo(a);
break;
case"undoconfig":if(c.value.maxUndoSteps!==undefined){this.undoManager.maxUndoSteps=c.value.maxUndoSteps
}if(c.value.history){this.undoManager.undoHistory=c.value.history
}if(c.value.activeStep!==undefined){this.undoManager.activeUndoStep=c.value.activeStep
}break;
case"getundoconfig":d={calleeRet:{maxUndoSteps:this.undoManager.maxUndoSteps,history:this.undoManager.cloneHistory(),activeStep:this.undoManager.activeUndoStep}};
break;
case"initializeundo":this.undoManager.initialize(a);
break;
case"addundostep":this.undoManager.addStep(new CUI.rte.UndoManager.Step(a));
break;
case"clearredohistory":this.undoManager.clearRedoHistory();
break;
case"dumpundohistory":console.log(this.undoManager.createDump());
break
}return d
},queryState:function(a,d){var b=d.toLowerCase();
var c=false;
switch(b){case"undo":c=this.undoManager.canUndo();
break;
case"redo":c=this.undoManager.canRedo();
break
}return c
}});
CUI.rte.commands.CommandRegistry.register("_undoredo",CUI.rte.commands.UndoRedo);
CUI.rte.plugins.Plugin=new Class({features:null,pluginId:null,editorKernel:null,config:null,isFeatureEnabled:function(b){if(!this.config||!this.config.features||(this.config.features=="-")){return false
}if(this.config.features==="*"){return true
}var c=this.config.features.length;
for(var d=0;
d<c;
d++){var a=this.config.features[d];
if(a==b){return true
}}return false
},isAnyFeatureEnabled:function(){if(!this.config||!this.config.features||(this.config.features=="-")){return false
}if(this.config.features==="*"){return true
}return(this.config.features.length>0)
},construct:function(b,a){this._init(b,a)
},_init:function(b,a){this.editorKernel=b;
this.pluginId=a
},getFeatures:function(){return[]
},reportStyles:function(){return null
},notifyPluginConfig:function(a){this.config=a
},initializeUI:function(a,b){},execute:function(a,b,c){},updateState:function(a){},handleContextMenu:function(b,c,a){},manipulateSelection:function(a){},saveRangeBookmark:function(a){},restoreRangeBookmark:function(a){},interceptContent:function(b,a){return null
},getTooltip:function(a){return(this.config.tooltips?this.config.tooltips[a]:null)
},isHeadless:function(b,a){return true
}});
CUI.rte.plugins.Plugin.SORT_TABLE_TABLEMODE=0;
CUI.rte.plugins.Plugin.SORT_EDIT=110;
CUI.rte.plugins.Plugin.SORT_UNDO=120;
CUI.rte.plugins.Plugin.SORT_FORMAT=130;
CUI.rte.plugins.Plugin.SORT_JUSTIFY=140;
CUI.rte.plugins.Plugin.SORT_LINKS=150;
CUI.rte.plugins.Plugin.SORT_LISTS=160;
CUI.rte.plugins.Plugin.SORT_IMAGE=170;
CUI.rte.plugins.Plugin.SORT_TABLE=180;
CUI.rte.plugins.Plugin.SORT_STYLES=350;
CUI.rte.plugins.Plugin.SORT_PARAFORMAT=360;
CUI.rte.plugins.Plugin.SORT_SPELLCHECK=370;
CUI.rte.plugins.Plugin.SORT_FONT=370;
CUI.rte.plugins.Plugin.SORT_MISC=1000;
CUI.rte.plugins.Plugin.SORT_MAX=100000;
CUI.rte.plugins.PluginRegistry=function(){var a={};
return{register:function(c,b){a[c]=b
},createRegisteredPlugins:function(e){var c={};
for(var b in a){if(a.hasOwnProperty(b)){var d=new a[b](e,b);
d=CUI.rte.Utils.onPluginCreated(d);
c[b]=d
}}return c
}}
}();
CUI.rte.plugins.PluginEvent=new Class({toString:"PluginEvent",type:null,editContext:null,construct:function(a,b,c){c=c||{};
this.type=a;
this.editContext=b;
CUI.rte.Utils.apply(this,c)
},getType:function(){return this.type
}});
CUI.rte.plugins.KeyPlugin=new Class({toString:"KeyPlugin",extend:CUI.rte.plugins.Plugin,mustEnsureBlocks:false,mustHandleAdditionalBR:false,isInsideListItem:false,parentList:null,_init:function(a){this.inherited(arguments);
a.addPluginListener("beforekeydown",this.handleKeyDown,this,this,false);
a.addPluginListener("keyup",this.handleKeyUp,this,this,false)
},isEOB:function(b,c){var a,d;
if(CUI.rte.Selection.isSelection(c)){a=c.endNode;
d=c.endOffset
}else{a=c.startNode;
d=c.startOffset
}return CUI.rte.DomProcessor.isBlockEnd(b,a,d)
},isTempBR:function(b){var a=CUI.rte.Common;
return !a.isNull(b)&&(a.isAttribDefined(b,a.BR_TEMP_ATTRIB)||(a.isAttribDefined(b,"type")&&(a.getAttribute(b,"type",false)==="_moz")))
},handleKeyDown:function(L){if(L.cancelKey){return
}var O=L.editContext;
var x=CUI.rte.DomProcessor;
var t=CUI.rte.Selection;
var i=CUI.rte.Common;
var c=CUI.rte.ListUtils;
var J=this.editorKernel;
if(i.ua.isGecko&&i.ua.isMac){if(L.isCtrl()&&(L.getCharCode()===i.KEY_STROKES.ARROW_LEFT)){L.cancelKey=true;
return
}}var j=(i.ua.isIE?J.createQualifiedSelection(O):null);
if(i.ua.isIE&&!j){if(!L.isCaretKey()){L.cancelKey=true
}return
}function a(){if(j==null){j=J.createQualifiedSelection(O)
}return j
}var K=false;
if(L.isTab()){var F="";
var s=this.config.tabSize;
for(var d=0;
d<s;
d++){F+="&nbsp;"
}J.execCmd("InsertHTML",F);
K=true
}this.mustHandleAdditionalBR=false;
if(i.ua.isGecko&&(L.isSpace()||L.isBackSpace())){j=a();
if(this.isEOB(O,j)){this.mustHandleAdditionalBR=true
}}this.mustEnsureBlocks=false;
if(L.isEnter()&&!K){if(!L.isShift()){var o=false;
var f=false;
try{j=a();
if(t.isSelection(j)){CUI.rte.commands.executeDelete(O)
}j=J.createQualifiedSelection(O);
var v=j.startNode;
var B=j.startOffset;
var Q=x.getEditBlock(O,v);
var G;
if(i.isTag(Q,"li")){this.parentList=Q.parentElement;
this.isInsideListItem=true;
o=true;
G=c.getNestedLists(Q);
if(i.ua.isGecko){f=c.isPositionBeforeNestedList(O,v,B);
o=!f
}}if(!o){B=(x.isEmptyLineDeterminator(O,v)?0:B);
var q=x.insertParagraph(O,v,B);
if(f){var r=x.createGeckoPlaceholder(O);
i.insertBefore(q,r,G[0])
}var y;
if(i.ua.isGecko){y=i.getFirstChild(q);
if(!y){y=q
}else{if(y.nodeType==3){y=y.parentNode
}}}else{y=q
}t.selectNode(O,y,true);
if(!i.isOldIE&&O.iFrame){var P=O.root.scrollTop;
t.ensureCaretVisibility(O,P)
}K=true
}}catch(D){o=true
}if(o){if(i.ua.isGecko){this.mustEnsureBlocks=true
}}}else{if(i.ua.isWebKit||i.ua.isGecko||i.ua.isIEBRPlaceholder){j=a();
if(t.isSelection(j)){CUI.rte.commands.executeDelete(O)
}j=J.createQualifiedSelection(O);
var k=j.startNode;
var N=j.startOffset;
var p=k;
var M=N;
if(i.isTag(k.parentNode,"a")){p=k.parentNode.parentNode;
M=i.getChildIndex(k.parentNode)+1
}var E=O.createElement("br");
var b=t.getCaretPos(O);
if(x.isBlockEnd(O,k,N)&&!x.isEmptyLineDeterminator(O,k)){var I=x.isBlockStart(O,k,N);
if(!I){var R=O.createElement("br");
i.setAttribute(R,i.BR_TEMP_ATTRIB,"brEOB");
x.insertElement(O,R,p,M)
}x.insertElement(O,E,p,M)
}else{x.insertElement(O,E,p,M)
}var w=i.getNextCharacterNode(O,E);
if(w.nodeType==1){t.selectNode(O,w,true)
}else{t.setCaretPos(O,b+1)
}K=true
}}}this.auxRootParaNodeCnt=0;
if((L.isBackSpace()||L.isDelete())&&!K){j=a();
if(i.ua.isOldIE){var H=x.getEmptyLine(O,j);
if((H!=null)&&!i.isTag(H,i.TABLE_CELLS)){var u=t.getCaretPos(O);
H.parentNode.removeChild(H);
if(L.isBackSpace()&&(u>0)){u--;
t.setCaretPos(O,u)
}K=true
}}var h=x.createNodeList(O,j);
var g=i.getTagInPath(O,h.commonAncestor,x.AUXILIARY_ROOT_TAGS);
if(g){this.auxRootParaNodeCnt=i.getChildNodesByType(g,"p").length
}}function A(X){if(!X){return null
}var Z=i.getAttribute(X,"style");
if(!Z){return null
}var aa=Z.split(";");
var Y={};
var V={large:"+1","x-large":"+2","xx-large":"+3","-webkit-xxx-large":"+4",small:"-1","x-small":"-2"};
for(var U=0;
U<aa.length;
U++){var S=aa[U];
if(S==""){continue
}var W=S.split(":");
var e=W[0].trim();
var T=W[1].trim();
if(e=="font-size"){Y.size=V[T]
}else{if(e=="font-family"){Y.face=T
}else{return{}
}}}return Y
}if(i.ua.isChrome&&!K&&(L.isBackSpace()||L.isDelete())){var I=x.isBlockStart(O,j.startNode,j.startOffset,true);
var m=x.isBlockEnd(O,j.startNode,j.startOffset,true);
var Q=x.getEditBlock(O,j.startNode);
var l=i.isTag(Q,"li");
var C;
if(!l){if(L.isBackSpace()&&I){C=i.getBlockNode(O,j.startNode).previousSibling
}else{if(L.isDelete()&&m){C=i.getBlockNode(O,j.startNode)
}}}else{var n=i.getBlockNode(O,j.startNode);
var z=Q;
if(L.isBackSpace()&&I){if(n.children[0]==Q){C=n.previousSibling
}else{C=z.previousSibling
}}else{if(L.isDelete()&&m){C=z
}}}if(C){CUI.rte.Utils.defer(function(){var T=i.getChildNodesByType(C,"span",true);
for(var S=0;
S<T.length;
S++){var U=T[S];
var e=A(U);
var V=U;
if(e){if(e.size){V=x.insertAsParent(O,V,"font",{size:e.size})
}if(e.face){x.insertAsParent(O,V,"font",{face:e.face})
}x.removeWithoutChildren(U)
}}},10,this)
}}L.cancelKey=K
},handleKeyUp:function(w){var u=CUI.rte.Selection;
var i=CUI.rte.Common;
var b=CUI.rte.DomProcessor;
var d=w.editContext;
var c=this.editorKernel;
var s,y;
if(i.ua.isGecko||i.ua.isWebKit){this.handleBRPlaceholders(d)
}if(i.ua.isWebKit){this.handleJunkSpans(d)
}if(i.ua.isOldIE){CUI.rte.Utils.defer(this.handleIEAutoLinks,1,this,[d])
}if(this.isInsideListItem&&i.ua.isWebKit){if(i.isTag(this.parentList.nextSibling,"div")){var k=c.htmlRules.blockHandling.defaultEditBlockType;
var h=b.createEmptyLinePlaceholder(d,true,k);
this.parentList.parentElement.insertBefore(h,this.parentList.nextSibling);
u.selectNode(d,h,true);
this.parentList.nextSibling.nextSibling.remove()
}}b.ensureMinimumContent(d);
if(this.mustEnsureBlocks){y=u.getSelection(d);
if(y.focusNode&&(y.focusNode.nodeType==1)){s=y.focusNode.childNodes[y.focusOffset];
if(i.isRootNode(d,s.parentNode)&&i.isTag(s,"br")){var a=b.insertAsParent(d,s,"p",null);
u.selectNode(d,a,true)
}}}var m,g;
if(this.mustHandleAdditionalBR){y=u.getSelection(d);
m=y.focusNode;
if(m){g=m.nextSibling;
if(i.isTag(g,"br")){i.setAttribute(g,i.BR_TEMP_ATTRIB,"brEOB")
}}}else{if(w.isDelete()){y=u.getSelection(d);
m=y.focusNode;
if(m&&(m.nodeType==3)){var q=m.nodeValue;
var j=(q.length>0?(q.charAt(q.length-1)==" "):false);
if(j){g=m.nextSibling;
if(i.isTag(g,"br")&&b.isBlockEnd(d,g,null)){i.setAttribute(g,i.BR_TEMP_ATTRIB,"brEOB")
}}}}}if(w.isBackSpace()||w.isDelete()){if(i.ua.isIE){try{var r=u.getLeadRange(d);
var p=r.duplicate();
if(r.move("character",1)==1){u.selectRange(d,r)
}else{if(r.move("character",-1)==-1){u.selectRange(d,r)
}}u.selectRange(d,p)
}catch(v){}}y=this.editorKernel.createQualifiedSelection(d);
if(y&&!u.isSelection(y)){s=y.startNode;
var f=b.getScopedBlockNode(d,s);
if(f){if(!f.isAuxiliaryRoot){var x=f.dom.parentNode;
if(i.isTag(x,b.AUXILIARY_ROOT_TAGS)){var t=i.getChildNodesByType(x,"p");
var o=t.length;
if((o==1)&&(o<this.auxRootParaNodeCnt)){var n=t[0];
if(!n.style.textAlign&&!n.style.marginLeft){var l;
if(i.ua.isIE){l=u.createSelectionBookmark(d)
}b.removeWithoutChildren(n);
if(i.ua.isIE){u.selectBookmark(d,l)
}}}}}}}}},handleIEAutoLinks:function(b){var d=CUI.rte.Common;
var c=CUI.rte.Selection;
var e=false;
var g;
var i=b.root.getElementsByTagName("A");
var j=i.length;
for(var h=j-1;
h>=0;
h--){var f=i[h];
if(d.isAttribDefined(f,"href")&&!d.isAttribDefined(f,d.HREF_ATTRIB)){CUI.rte.DomProcessor.removeWithoutChildren(f);
if(!e&&d.ua.isOldIE){g=c.getCaretPos(b);
e=true
}}}if(e&&d.ua.isOldIE){c.setCaretPos(b,g)
}},handleBRPlaceholders:function(b){var c=CUI.rte.Common;
var k=CUI.rte.DomProcessor;
var g=b.root.getElementsByTagName("BR");
var n=g.length;
for(var f=0;
f<n;
f++){var h=g[f];
if(this.isTempBR(h)){var j=c.getPreviousCharacterNode(b,h,c.EDITBLOCK_TAGS);
var e=c.getNextCharacterNode(b,h,c.EDITBLOCK_TAGS);
if((!c.isTag(j,"br")&&!c.isNull(j))||!c.isNull(e)){var m=0;
var a=false;
if(j){var d=c.getNodeText(j);
m=d.length;
a=c.ua.isGecko&&(k.checkNamedAnchor(j)!=null)
}var l=(m>0?d.charAt(m-1):"");
if((l!==" ")&&!a){h.parentNode.removeChild(h)
}}}}},handleJunkSpans:function(b){var a=CUI.rte.Common;
var c=this.editorKernel.createQualifiedSelection(b);
if(c&&!c.isSelection){var e=c.startNode;
e=(e.nodeType===3?a.getParentNode(b,e):e);
if(a.isTag(e,"span")){var d=a.getAttribute(e,"style",true);
if(d){if(d.indexOf("font-size")>=0){var f=CUI.rte.Selection;
var g=f.createSelectionBookmark(b);
CUI.rte.DomProcessor.removeWithoutChildren(e);
f.selectBookmark(b,g)
}}}}},notifyPluginConfig:function(a){a=a||{};
CUI.rte.Utils.applyDefaults(a,{tabSize:4});
this.config=a
}});
CUI.rte.plugins.PluginRegistry.register("keys",CUI.rte.plugins.KeyPlugin);
CUI.rte.plugins.SimpleFormatPlugin=new Class({toString:"SimpleFormatPlugin",extend:CUI.rte.plugins.Plugin,commands:null,commandsUI:null,groupDef:null,getFeatures:function(){return this.commands
},_init:function(d,c,b,a){this.inherited(arguments);
this.groupDef={id:c,sort:b};
this.commands=a
},initializeUI:function(c){this.commandsUI=[];
var d=this.commands.length;
for(var e=0;
e<d;
e++){var f=this.commands[e];
var a=null;
if(typeof(f)=="object"){a=f.shortcut;
f=f.command;
this.commands[e]=f
}if(this.isFeatureEnabled(f)){var b=c.createElement(f,this,true,this.getTooltip(f));
this.commandsUI.push(b);
c.addElement(this.groupDef.id,this.groupDef.sort,b,(e+1)*10);
if(a){this.editorKernel.registerKeyboardShortcut(a,f)
}}}},execute:function(a){this.editorKernel.relayCmd(a)
},updateState:function(a){var b=this.commandsUI.length;
for(var c=0;
c<b;
c++){var d=this.commandsUI[c];
d.setSelected(this.editorKernel.queryState(d.id,a))
}}});
CUI.rte.plugins.EditToolsPlugin=new Class({toString:"EditToolsPlugin",extend:CUI.rte.plugins.Plugin,isPasteOperation:false,pasteRange:null,clipboard:null,geckoPreferredScrollingOffset:null,cutUI:null,copyUI:null,pasteDefaultUI:null,pastePlainTextUI:null,pasteAsWordUI:null,pasteDefaultDialog:null,pastePlainTextDialog:null,pasteWordHtmlDialog:null,prePasteBodyStyle:null,_pageXOffsetBeforePaste:null,_pageYOffsetBeforePaste:null,_editorHeightBeforePaste:null,_init:function(a){this.inherited(arguments);
if(!CUI.rte.Common.ua.isWebKit){a.addPluginListener("beforekeydown",this.handleKeyDown,this,this,false)
}else{a.addPluginListener("paste",this.handlePaste,this,this,false)
}},handleKeyDown:function(d){if(d.cancelKey){return
}var a=CUI.rte.Common;
var c=d.getKey();
if(this.config.defaultPasteMode!="browser"){var b=false;
if(a.ua.isMac){b=(d.isMeta()&&(d.getCharCode()==118))||(d.isCtrl()&&(c==86))
}else{b=(d.isCtrl()&&(c==86))||(d.isShift()&&(c==45))
}if(b){this.beforePaste(d.editContext)
}}},handlePaste:function(a){if(this.config.defaultPasteMode!="browser"){this.beforePaste(a.editContext)
}},beforePaste:function(c){if(this.isPasteOperation){return
}var b=CUI.rte.Common;
this.isPasteOperation=true;
this.pasteRange=this.editorKernel.createQualifiedRangeBookmark(c);
this.clipboard=c.createElement("div");
this.clipboard.style.position="absolute";
this.clipboard.style.left="-10000px";
this.clipboard.style.width="9000px";
this.clipboard.style.top="0px";
c.root.appendChild(this.clipboard);
this.clipboard.appendChild(c.createElement("br"));
var f;
if(b.ua.isOldIE){f=c.doc.selection.createRange();
var a=f.boundingWidth;
f.moveToElementText(this.clipboard);
f.select()
}else{this.geckoPreferredScrollingOffset=CUI.rte.Selection.getPreferredScrollOffset(c);
f=c.doc.createRange();
f.selectNodeContents(this.clipboard);
var e=c.win.getSelection();
e.removeAllRanges();
e.addRange(f)
}if(b.ua.isChrome){var d=$(c.doc.body);
this.prePasteBodyStyle=d.attr("style");
d.attr("style","")
}this._pageXOffsetBeforePaste=c.win.pageXOffset;
this._pageYOffsetBeforePaste=c.win.pageYOffset;
this._editorHeightBeforePaste=c.root.offsetHeight;
CUI.rte.Utils.defer(this.afterPaste,1,this,[c])
},afterPaste:function(c){var f=CUI.rte.Selection;
var a=CUI.rte.Common;
if(a.ua.isChrome){var e=$(c.doc.body);
e.attr("style",this.prePasteBodyStyle)
}CUI.rte.DomProcessor.correctGeckoCopyBugs(c,this.clipboard);
var d=this.clipboard.innerHTML;
this.clipboard.parentNode.removeChild(this.clipboard);
if(a.ua.isSafari){CUI.rte.Selection.resetSelection(c,"start")
}var b=this.editorKernel.execCmd("paste",{html:d,dom:this.clipboard,mode:this.config.defaultPasteMode,pasteRange:this.pasteRange,stripHtmlTags:this.config.stripHtmlTags,htmlRules:this.editorKernel.htmlRules,pasteRules:this.config.htmlPasteRules});
if(a.ua.isGecko){if(b.geckoEnsureCaretVisibility&&c.iFrame){f.ensureCaretVisibility(c,c.iframe,this.geckoPreferredScrollingOffset)
}if(b.bookmark){f.selectBookmark(c,b.bookmark)
}}else{if(a.ua.isWebKit){if(b.geckoEnsureCaretVisibility&&c.iFrame){CUI.rte.Utils.defer(function(){f.ensureCaretVisibility(c,c.iframe,this.geckoPreferredScrollingOffset)
},1,this)
}if(!c.iFrame){c.win.scrollTo(this._pageXOffsetBeforePaste,this._pageYOffsetBeforePaste+c.root.offsetHeight-this._editorHeightBeforePaste)
}}}this.clipboard=null;
this.pasteRange=null;
this.isPasteOperation=false;
this.geckoPreferredScrollingOffset=null
},createPasteDialog:function(d,c,b,e){var a={type:d,editContext:c,pasteFn:CUI.rte.Utils.scope(b,this),cancelFn:CUI.rte.Utils.scope(function(){this.pasteRange=null
},this),parameters:{command:this.pluginId+"#"+e}};
return this.editorKernel.getDialogManager().create(CUI.rte.ui.DialogManager.DLG_PASTE,a)
},showPasteDialog:function(c,b){c.setValue("");
var a=this.editorKernel.getDialogManager();
a.prepareShow(c);
this.pasteRange=this.editorKernel.createQualifiedRangeBookmark(b);
a.show(c)
},pasteDefault:function(d){var a=CUI.rte.commands.Paste;
var e=this.config.defaultPasteMode;
var c;
switch(e){case a.MODE_BROWSER:this.editorKernel.relayCmd("paste",{mode:e});
return;
case a.MODE_WORDHTML:c="iframe";
break;
case a.MODE_PLAINTEXT:c="plaintext";
break;
default:throw new Error("Invalid default paste mode: '"+e+"'.")
}var b=this.editorKernel.getDialogManager();
if(b.isShown(this.pasteDefaultDialog)&&b.toggleVisibility(this.pasteDefaultDialog)){b.hide(this.pasteDefaultDialog);
return
}if(!this.pasteDefaultDialog||b.mustRecreate(this.pasteDefaultDialog)){this.pasteDefaultDialog=this.createPasteDialog(c,d,this.execPasteDefault,"paste-default")
}this.showPasteDialog(this.pasteDefaultDialog,d)
},execPasteDefault:function(a,c,b,d){if(b){this.execPasteWordHtml(a,c,b,d)
}else{this.execPastePlainText(a,c)
}},pastePlainText:function(b){var a=this.editorKernel.getDialogManager();
if(a.isShown(this.pastePlainTextDialog)&&a.toggleVisibility(this.pastePlainTextDialog)){a.hide(this.pastePlainTextDialog);
return
}if(!this.pastePlainTextDialog||a.mustRecreate(this.pastePlainTextDialog)){this.pastePlainTextDialog=this.createPasteDialog("plaintext",b,this.execPastePlainText,"paste-plaintext")
}this.showPasteDialog(this.pastePlainTextDialog,b)
},execPastePlainText:function(b,c){var a=CUI.rte.commands.Paste;
this.editorKernel.relayCmd("paste",{mode:a.MODE_PLAINTEXT,text:c,pasteRange:this.pasteRange,stripHtmlTags:this.config.stripHtmlTags});
this.pasteRange=null
},pasteWordHtml:function(b){var a=this.editorKernel.getDialogManager();
if(a.isShown(this.pasteWordHtmlDialog)&&a.toggleVisibility(this.pasteWordHtmlDialog)){a.hide(this.pasteWordHtmlDialog);
return
}if(!this.pasteWordHtmlDialog||a.mustRecreate(this.pasteWordHtmlDialog)){this.pasteWordHtmlDialog=this.createPasteDialog("iframe",b,this.execPasteWordHtml,"paste-wordhtml")
}this.showPasteDialog(this.pasteWordHtmlDialog,b)
},execPasteWordHtml:function(b,d,c,e){var a=CUI.rte.commands.Paste;
this.editorKernel.relayCmd("paste",{mode:a.MODE_WORDHTML,html:d,dom:e,pasteRange:this.pasteRange,htmlRules:this.editorKernel.htmlRules,pasteRules:this.config.htmlPasteRules});
this.pasteRange=null
},getFeatures:function(){return["cut","copy","paste-default","paste-plaintext","paste-wordhtml"]
},initializeUI:function(a){var b=CUI.rte.plugins;
var c=CUI.rte.ui;
if(this.isFeatureEnabled("cut")){this.cutUI=a.createElement("cut",this,false,this.getTooltip("cut"));
a.addElement("edit",b.Plugin.SORT_EDIT,this.cutUI,10)
}if(this.isFeatureEnabled("copy")){this.copyUI=a.createElement("copy",this,false,this.getTooltip("copy"));
a.addElement("edit",b.Plugin.SORT_EDIT,this.copyUI,10)
}if(this.isFeatureEnabled("paste-default")){this.pasteDefaultUI=a.createElement("paste-default",this,false,this.getTooltip("paste-default"));
a.addElement("edit",b.Plugin.SORT_EDIT,this.pasteDefaultUI,30)
}if(this.isFeatureEnabled("paste-plaintext")){this.pastePlainTextUI=a.createElement("paste-plaintext",this,false,this.getTooltip("paste-plaintext"));
a.addElement("edit",b.Plugin.SORT_EDIT,this.pastePlainTextUI,40)
}if(this.isFeatureEnabled("paste-wordhtml")){this.pasteAsWordUI=a.createElement("paste-wordhtml",this,false,this.getTooltip("paste-wordhtml"));
a.addElement("edit",b.Plugin.SORT_EDIT,this.pasteAsWordUI,50)
}},notifyPluginConfig:function(b){b=b||{};
var a=false;
if(b.htmlPasteRules){a=(b.htmlPasteRules.linkRemoveRegEx==="")
}CUI.rte.Utils.applyDefaults(b,{defaultPasteMode:"wordhtml",stripHtmlTags:true,htmlPasteRules:{allowBasics:{bold:true,italic:true,underline:true,anchor:true,image:true,subscript:true,superscript:true},allowBlockTags:["p","h1","h2","h3","h4","h5","h6"],allowedAttributes:{"*":["class"],table:["width","height","cellspacing","cellpadding","border"],td:["width","height","colspan","rowspan","valign"],a:["href","name","title","alt"],img:["src","title","alt","width","height"],span:["class"]},list:{allow:true},table:{allow:true},linkRemoveRegEx:null},tooltips:{cut:{title:CUI.rte.Utils.i18n("plugins.editTools.cutTitle"),text:CUI.rte.Utils.i18n("plugins.editTools.cutText")},copy:{title:CUI.rte.Utils.i18n("plugins.editTools.copyTitle"),text:CUI.rte.Utils.i18n("plugins.editTools.copyText")},"paste-default":{title:CUI.rte.Utils.i18n("plugins.editTools.pasteDefaultTitle"),text:CUI.rte.Utils.i18n("plugins.editTools.pasteDefaultText")},"paste-plaintext":{title:CUI.rte.Utils.i18n("plugins.editTools.pastePlainTextTitle"),text:CUI.rte.Utils.i18n("plugins.editTools.pastePlainTextText")},"paste-wordhtml":{title:CUI.rte.Utils.i18n("plugins.editTools.pasteWordHtmlTitle"),text:CUI.rte.Utils.i18n("plugins.editTools.pasteWordHtmlText")}}});
this.config=b;
if(a){delete this.config.htmlPasteRules.linkRemoveRegEx
}if(b.htmlPasteRules.table.allowed!==undefined){this.config.htmlPasteRules.table.allow=this.config.htmlPasteRules.table.allowed;
delete this.config.htmlPasteRules.table.allowed
}},execute:function(e,d,b){var a=b.editContext;
this.pasteRange=this.editorKernel.createQualifiedRangeBookmark(a);
var c=e.toLowerCase();
switch(c){case"cut":case"copy":this.editorKernel.relayCmd(c);
break;
case"paste-default":this.pasteDefault(a);
break;
case"paste-plaintext":this.pastePlainText(a);
break;
case"paste-wordhtml":this.pasteWordHtml(a);
break
}},updateState:function(a){if(this.cutUI){this.cutUI.setDisabled(!(a.isSelection||a.selectedDom))
}if(this.copyUI){this.copyUI.setDisabled(!(a.isSelection||a.selectedDom))
}},isHeadless:function(b,a){return false
}});
CUI.rte.plugins.PluginRegistry.register("edit",CUI.rte.plugins.EditToolsPlugin);
CUI.rte.plugins.FindReplacePlugin=new Class({toString:"FindReplacePlugin",extend:CUI.rte.plugins.Plugin,findUI:null,replaceUI:null,findDialog:null,replaceDialog:null,operationDialog:null,currentSearchDef:null,savedRange:null,find:function(d){var b=CUI.rte.Common;
var a=this.editorKernel.getDialogManager();
var e=CUI.rte.Selection;
if(a.isShown(this.findDialog)&&a.toggleVisibility(this.findDialog)){a.hide(this.findDialog);
return
}this.savedRange=e.saveNativeSelection(d);
if(!this.findDialog||a.mustRecreate(this.findDialog)){var c={editContext:d,title:CUI.rte.Utils.i18n("plugins.findReplace.findTitle"),isReplace:false,findFn:CUI.rte.Utils.scope(this.execFind,this),cancelFn:CUI.rte.Utils.scope(this.execCancel,this),parameters:{command:this.pluginId+"#find"}};
this.findDialog=a.create(CUI.rte.ui.DialogManager.DLG_FINDREPLACE,c)
}this.findDialog.setMode(true,false);
this.operationDialog=this.findDialog;
a.show(this.findDialog)
},execFind:function(e,f,w){var g=CUI.rte.Common;
var s=CUI.rte.Selection;
var a=CUI.rte.DomProcessor;
var A=false;
s.restoreNativeSelection(e,this.savedRange);
var d=f.findText;
var v=f.matchCase;
if(this.currentSearchDef&&((this.currentSearchDef.findText!=d)||(this.currentSearchDef.matchCase!=v))){this.currentSearchDef=null
}var k,D;
if(!this.currentSearchDef){D=s.createProcessingSelection(e);
var C=D.startNode;
var u=D.startOffset;
if(g.getNodeCharacterCnt(C)==0){C=g.getFirstTextChild(C,true);
if(!C){C=g.getNextCharacterNode(e,D.startNode)
}if(C){u=(C.nodeType==1?null:0)
}else{u=null
}}var y=new CUI.rte.SearchableDocument();
y.create(e.root);
var B={ignoreCase:!v};
this.currentSearchDef={findText:d,matchCase:v,doc:y};
var r=y.getRefForNode(C);
if(r){r=r.textPos+u;
B.startPos=r
}k=y.find(d,B)
}else{k=this.currentSearchDef.doc.findNext()
}if(!k){w.setMode(false,false);
this.editorKernel.getDialogManager().alert(CUI.rte.Utils.i18n("plugins.findReplace.findReplaceTitle"),CUI.rte.Utils.i18n("plugins.findReplace.alertNoMoreResults",[d]),CUI.rte.Utils.scope(this.operationDialog.focusFindField,this.operationDialog),{dialog:this.operationDialog});
this.currentSearchDef.doc.create(e.root)
}if(k&&(k.length>0)){w.setMode(false,true);
var h=k[0];
var z=k[k.length-1];
D={startNode:h.node,startOffset:h.matchPos-h.nodePos,endNode:z.node,endOffset:(z.matchPos-z.nodePos)+z.matchChars};
if(g.ua.isIE){this.editorKernel.focus(e)
}var j=s.bookmarkFromProcessingSelection(e,D);
s.selectBookmark(e,j);
A=true;
if(!g.ua.isOldIE&&e.iFrame){var o=s.getLeadRange(e);
var l=o.commonAncestorContainer;
while(l.nodeType==3){l=l.parentNode
}var x=a.saveChildNodes(l);
var t=e.createElement("span");
o.surroundContents(t);
var p=t.offsetTop;
var n=t.offsetParent;
while(n){p+=n.offsetTop;
n=n.offsetParent
}var i=p+t.offsetHeight;
var b=e.root.scrollTop;
var m=e.iFrame.clientHeight;
var q=b+m;
if(i<b){e.root.scrollTop=p
}else{if(i>q){var c=e.root.scrollHeight;
if((c-i)<8){i=c
}if(i>q){e.root.scrollTop=i-m
}}}a.removeWithoutChildren(t);
l.normalize();
a.restoreChildNodes(l,x);
s.selectBookmark(e,j)
}this.savedRange=s.saveNativeSelection(e)
}return A
},replace:function(d){var b=CUI.rte.Common;
var a=this.editorKernel.getDialogManager();
var e=CUI.rte.Selection;
if(a.isShown(this.replaceDialog)&&a.toggleVisibility(this.replaceDialog)){a.hide(this.replaceDialog);
return
}this.savedRange=e.saveNativeSelection(d);
if(!this.replaceDialog||a.mustRecreate(this.replaceDialog)){var c={editContext:d,isReplace:true,findFn:CUI.rte.Utils.scope(this.execFind,this),replaceFn:CUI.rte.Utils.scope(this.execReplace,this),cancelFn:CUI.rte.Utils.scope(this.execCancel,this),parameters:{command:this.pluginId+"#replace"}};
this.replaceDialog=a.create(CUI.rte.ui.DialogManager.DLG_FINDREPLACE,c)
}this.replaceDialog.setMode(true,false);
this.operationDialog=this.replaceDialog;
a.show(this.replaceDialog)
},execReplace:function(c,q,o){var f=CUI.rte.Common;
var k=this.editorKernel.getDialogManager();
var d=CUI.rte.Selection;
d.restoreNativeSelection(c,this.savedRange);
if(q.replaceAll){this.editorKernel.focus(c);
var h=new CUI.rte.SearchableDocument();
h.create(c.root);
var g={ignoreCase:!q.matchCase};
var b=0;
var j=h.find(q.findText,g);
while(j){var a=j[0];
var l=j[j.length-1];
var p={startNode:a.node,startOffset:a.matchPos-a.nodePos,endNode:l.node,endOffset:(l.matchPos-l.nodePos)+l.matchChars};
var n=d.bookmarkFromProcessingSelection(c,p);
d.selectBookmark(c,n);
if(q.replaceText){this.editorKernel.execCmd("inserthtml",CUI.rte.Utils.htmlEncode(q.replaceText))
}else{this.editorKernel.execCmd("delete")
}h.adjustToReplace(q.replaceText);
b++;
h.create(c.root);
j=h.findNext()
}k.hide(o);
if(b>0){this.editorKernel.getDialogManager().alert(CUI.rte.Utils.i18n("plugins.findReplace.replaceAllTitle"),CUI.rte.Utils.i18n("plugins.findReplace.alertReplaceResults",[q.findText,b]),CUI.rte.Utils.scope(this.editorKernel.focus,this.editorKernel))
}else{this.editorKernel.getDialogManager().alert(CUI.rte.Utils.i18n("plugins.findReplace.replaceAllTitle"),CUI.rte.Utils.i18n("plugins.findReplace.alertNotFound",[q.findText]),CUI.rte.Utils.scope(this.editorKernel.focus,this.editorKernel))
}this.editorKernel.focus(c)
}else{var i=false;
try{this.editorKernel.focus(c);
if(q.replaceText){this.editorKernel.execCmd("inserthtml",CUI.rte.Utils.htmlEncode(q.replaceText))
}else{this.editorKernel.execCmd("delete")
}this.currentSearchDef.doc.adjustToReplace(q.replaceText);
this.currentSearchDef.doc.create(c.root)
}catch(m){if(m.message=="Could not insert html due to IE limitations."){this.editorKernel.getDialogManager().alert(CUI.rte.Utils.i18n("plugins.findReplace.replaceTitle"),CUI.rte.Utils.i18n("plugins.findReplace.alertIEProblems"));
i=true
}else{throw m
}this.editorKernel.focus(c)
}this.editorKernel.updateToolbar();
if(!i){if(f.ua.isIE){this.savedRange=null
}this.execFind(c,q,o)
}else{d.restoreNativeSelection(c,this.savedRange);
o.setMode(false,false)
}}},execCancel:function(){this.currentSearchDef=null
},getFeatures:function(){return["find","replace"]
},initializeUI:function(a){var b=CUI.rte.plugins;
if(this.isFeatureEnabled("find")){this.findUI=a.createElement("find",this,false,this.getTooltip("find"));
a.addElement("findreplace",b.Plugin.SORT_EDIT+5,this.findUI,100)
}if(this.isFeatureEnabled("replace")){this.replaceUI=a.createElement("replace",this,false,this.getTooltip("replace"));
a.addElement("findreplace",b.Plugin.SORT_EDIT+5,this.replaceUI,110)
}},notifyPluginConfig:function(a){a=a||{};
CUI.rte.Utils.applyDefaults(a,{tooltips:{find:{title:CUI.rte.Utils.i18n("plugins.findReplace.findTitle"),text:CUI.rte.Utils.i18n("plugins.findReplace.tooltipFind")},replace:{title:CUI.rte.Utils.i18n("plugins.findReplace.replaceTitle"),text:CUI.rte.Utils.i18n("plugins.findReplace.tooltipReplace")}}});
this.config=a
},execute:function(c,b,a){switch(c){case"find":this.find(a.editContext);
break;
case"replace":this.replace(a.editContext);
break
}},updateState:function(a){},isHeadless:function(b,a){return false
}});
CUI.rte.plugins.PluginRegistry.register("findreplace",CUI.rte.plugins.FindReplacePlugin);
CUI.rte.plugins.FormatPlugin=new Class({toString:"FormatPlugin",extend:CUI.rte.plugins.SimpleFormatPlugin,_init:function(b){var a=CUI.rte.plugins;
a.FormatPlugin.prototype.superClass._init.call(this,b,"format",a.Plugin.SORT_FORMAT,[{command:"bold",shortcut:"b"},{command:"italic",shortcut:"i"},{command:"underline",shortcut:"u"}])
},notifyPluginConfig:function(a){a=a||{};
CUI.rte.Utils.applyDefaults(a,{features:"*",tooltips:{bold:{title:CUI.rte.Utils.i18n("plugins.format.boldTitle"),text:CUI.rte.Utils.i18n("plugins.format.boldText")},italic:{title:CUI.rte.Utils.i18n("plugins.format.italicTitle"),text:CUI.rte.Utils.i18n("plugins.format.italicText")},underline:{title:CUI.rte.Utils.i18n("plugins.format.underlineTitle"),text:CUI.rte.Utils.i18n("plugins.format.underlineText")}}});
this.config=a
}});
CUI.rte.plugins.PluginRegistry.register("format",CUI.rte.plugins.FormatPlugin);
CUI.rte.plugins.JustifyPlugin=new Class({toString:"JustifyPlugin",extend:CUI.rte.plugins.SimpleFormatPlugin,_init:function(b){var a=CUI.rte.plugins;
a.JustifyPlugin.prototype.superClass._init.call(this,b,"justify",a.Plugin.SORT_JUSTIFY,["justifyleft","justifycenter","justifyright"])
},notifyPluginConfig:function(a){a=a||{};
CUI.rte.Utils.applyDefaults(a,{features:"*",tooltips:{justifyleft:{title:CUI.rte.Utils.i18n("plugins.justify.leftTitle"),text:CUI.rte.Utils.i18n("plugins.justify.leftText")},justifycenter:{title:CUI.rte.Utils.i18n("plugins.justify.centerTitle"),text:CUI.rte.Utils.i18n("plugins.justify.centerText")},justifyright:{title:CUI.rte.Utils.i18n("plugins.justify.rightTitle"),text:CUI.rte.Utils.i18n("plugins.justify.rightText")}}});
this.config=a
}});
CUI.rte.plugins.PluginRegistry.register("justify",CUI.rte.plugins.JustifyPlugin);
CUI.rte.plugins.LinkPlugin=new Class({toString:"LinkPlugin",extend:CUI.rte.plugins.Plugin,linkDialog:null,anchorDialog:null,linkUI:null,removeLinkUI:null,anchorUI:null,getFeatures:function(){return["modifylink","unlink","anchor"]
},modifyLink:function(c){var f=CUI.rte.Common;
var p=this.editorKernel.getDialogManager();
if(p.isShown(this.linkDialog)&&p.toggleVisibility(this.linkDialog)){p.hide(this.linkDialog);
return
}var s=CUI.rte.ui.DialogHelper;
if(!this.linkDialog||p.mustRecreate(this.linkDialog)){var r=p.createDialogHelper();
var n=this.editorKernel.htmlRules.links;
var e={configVersion:1,defaultDialog:{dialogClass:{type:s.TYPE_DIALOG}},parameters:{linkRules:n,editorKernel:this.editorKernel,command:this.pluginId+"#modifylink"},dialogProperties:{pathbrowserPicker:this.hasPathPicker()}};
if(this.config.linkDialogConfig){var l=this.config.linkDialogConfig;
if(l.linkAttributes){f.removeJcrData(l.linkAttributes);
var o=f.toArray(l.linkAttributes);
e.additionalFields=[];
var m=o.length;
for(var t=0;
t<m;
t++){var i=o[t];
var d=i.type||i.xtype;
var b=i.attribute;
var h=i.label||i.fieldLabel;
var q={item:r.createItem(d,b,h),fromModel:function(w,v){if(r.getItemType(v)==s.TYPE_HIDDEN){return
}var u=r.getItemName(v);
var a=f.getAttribute(w.dom,u);
if(a){r.setItemValue(v,a)
}else{r.setItemValue(v,"")
}},toModel:function(w,v){var a=r.getItemName(v);
if(!w.attributes){w.attributes={}
}var u=r.getItemValue(v);
if(u&&(u.length>0)){w.attributes[a]=u
}else{w.attributes[a]=CUI.rte.commands.Link.REMOVE_ATTRIBUTE
}}};
delete i.attribute;
delete i.type;
delete i.xtype;
delete i.label;
delete i.fieldLabel;
CUI.rte.Utils.applyDefaults(q.item,i);
e.additionalFields.push(q)
}delete l.linkAttributes
}CUI.rte.Utils.applyDefaults(e.dialogProperties,l)
}if(n.targetConfig){if(n.targetConfig.mode!="blank"){e.disabledDefaultFields=["targetBlank"]
}if(n.targetConfig.mode=="manual"){if(!e.additionalFields){e.additionalFields={}
}var j=r.createItem(s.TYPE_TEXTFIELD,"target",CUI.rte.Utils.i18n("plugins.link.anchorTitle"));
e.additionalFields.push({item:j,fromModel:function(u,a){if(u.dom&&u.dom.target){r.setItemValue(a,u.dom.target)
}},toModel:function(v,u){if(!v.attributes){v.attributes={}
}var a=r.getItemValue(u);
if(a&&(a.length>0)){v.attributes.target=a
}else{v.attributes.target=null
}}})
}}CUI.rte.Utils.applyDefaults(e,this.config.linkDialogConfig||{});
r.configure(e);
this.linkDialog=r.create();
r.calculateInitialPosition()
}var g=null;
var k=this.editorKernel.analyzeSelection();
if(k.anchorCount==1){g=k.anchors[0]
}g=g||{};
if(typeof g.attributes==="undefined"){g.attributes={}
}this.linkDialog.initializeEdit(this.editorKernel,g,CUI.rte.Utils.scope(this.applyLink,this));
this.savedRange=CUI.rte.Selection.saveNativeSelection(c);
p.show(this.linkDialog)
},applyLink:function(d){var c=CUI.rte.Common;
var e=this.linkDialog.objToEdit;
if(e){var b=e.href;
var a=e.cssClass;
var f=e.target;
CUI.rte.Selection.restoreNativeSelection(d,this.savedRange);
this.editorKernel.relayCmd("modifylink",{url:b,css:a,target:f,trimLinkSelection:this.config.trimLinkSelection,attributes:e.attributes})
}},modifyAnchor:function(f){var c=CUI.rte.Common;
var b=this.editorKernel.getDialogManager();
if(b.isShown(this.anchorDialog)&&b.toggleVisibility(this.anchorDialog)){b.hide(this.anchorDialog);
return
}if(!this.anchorDialog||b.mustRecreate(this.anchorDialog)){var h=this.editorKernel;
var g=this;
var a={execute:function(i){CUI.rte.Selection.restoreNativeSelection(f,g.savedRange);
h.relayCmd("anchor",{anchorValue:i,pluginConfig:g.config})
}};
var e;
if(this.config.anchorDialogConfig){e=CUI.rte.Utils.copyObject(this.config.anchorDialogConfig)
}else{e={}
}e.parameters={command:this.pluginId+"#anchor"};
CUI.rte.Utils.applyDefaults(e,a);
this.anchorDialog=b.create(CUI.rte.ui.DialogManager.DLG_ANCHOR,e)
}else{this.anchorDialog.resetValues()
}b.prepareShow(this.anchorDialog);
var d=this.editorKernel.analyzeSelection(f);
if(d.namedAnchorCount==1){this.anchorDialog.setAnchor(d.namedAnchors[0])
}this.savedRange=CUI.rte.Selection.saveNativeSelection(f);
b.show(this.anchorDialog)
},initializeUI:function(a){var b=CUI.rte.plugins;
var c=CUI.rte.ui;
if(this.isFeatureEnabled("modifylink")){this.linkUI=a.createElement("modifylink",this,false,this.getTooltip("modifylink"));
a.addElement("links",b.Plugin.SORT_LINKS,this.linkUI,10)
}if(this.isFeatureEnabled("unlink")){this.removeLinkUI=a.createElement("unlink",this,false,this.getTooltip("unlink"));
a.addElement("links",b.Plugin.SORT_LINKS,this.removeLinkUI,20)
}if(this.isFeatureEnabled("anchor")){this.anchorUI=a.createElement("anchor",this,true,this.getTooltip("anchor"));
a.addElement("links",b.Plugin.SORT_LINKS,this.anchorUI,30)
}},notifyPluginConfig:function(a){a=a||{};
CUI.rte.Utils.applyDefaults(a,{features:"*",trimLinkSelection:true,linkDialogConfig:{targetConfig:{mode:"manual"}},anchorDialogConfig:{},tooltips:{modifylink:{title:CUI.rte.Utils.i18n("plugins.link.linkTitle"),text:CUI.rte.Utils.i18n("plugins.link.linkText")},unlink:{title:CUI.rte.Utils.i18n("plugins.link.unlinkTitle"),text:CUI.rte.Utils.i18n("plugins.link.unlinkText")},anchor:{title:CUI.rte.Utils.i18n("plugins.link.anchorTitle"),text:CUI.rte.Utils.i18n("plugins.link.anchorText")}}});
this.config=a
},execute:function(c,b,a){if(c=="modifylink"){this.modifyLink(a.editContext)
}else{if(c=="anchor"){this.modifyAnchor(a.editContext)
}else{this.editorKernel.relayCmd(c)
}}},updateState:function(g){var b=g.anchorCount==1;
var e=g.anchorCount==0;
var f=g.selectedDom;
var d=false;
if(f){d=CUI.rte.Common.isTag(f,CUI.rte.plugins.LinkPlugin.LINKABLE_OBJECTS)
}var a=b||((g.isSelection||d)&&e);
if(this.linkUI){this.linkUI.setDisabled(!a)
}if(this.removeLinkUI){this.removeLinkUI.setDisabled(!b)
}if(this.anchorUI){var c=(g.namedAnchorCount==1);
this.anchorUI.setSelected(c)
}},isHeadless:function(b,a){return(b==="unlink")
},hasPathPicker:function(){return false
},getConfig:function(){return this.config
}});
CUI.rte.plugins.LinkPlugin.LINKABLE_OBJECTS=["img"];
CUI.rte.plugins.PluginRegistry.register("links",CUI.rte.plugins.LinkPlugin);
CUI.rte.plugins.ListPlugin=new Class({toString:"ListPlugin",extend:CUI.rte.plugins.Plugin,orderedListUI:null,unorderedListUI:null,indentUI:null,outdentUI:null,_init:function(a){this.inherited(arguments);
a.addPluginListener("beforekeydown",this.handleOnKey,this,this,false)
},handleOnKey:function(g){var e,b,a,d,c;
if(g.isEnter()&&g.isCtrl()){try{if(window.getSelection){e=CUI.rte.Selection.getLeadRange(g.editContext)
}else{if(document.selection){e=document.selection.createRange()
}}b=e.commonAncestorContainer?e.commonAncestorContainer:e.parentElement?e.parentElement():e.item(0);
a=b.parentNode?b.parentNode:b.parentElement();
while(b!==a&&a.tagName!=="LI"){b=b.parentNode?b.parentNode:b.parentElement();
a=b.parentNode?b.parentNode:b.parentElement()
}if(b.tagName&&b.tagName!=="LI"&&a.tagName==="LI"){d=a.parentNode?a.parentNode:a.parentElement();
c=g.editContext.doc.createElement("li");
c.appendChild(b);
if(a.nextSibling){d.insertBefore(c,a.nextSibling)
}else{d.appendChild(c)
}CUI.rte.Selection.selectNode(g.editContext,c,1)
}}catch(f){}}},getFeatures:function(){return["ordered","unordered","indent","outdent"]
},initializeUI:function(a){var b=CUI.rte.plugins;
var c=CUI.rte.ui;
if(this.isFeatureEnabled("unordered")){this.unorderedListUI=a.createElement("unordered",this,true,this.getTooltip("unordered"));
a.addElement("lists",b.Plugin.SORT_LISTS,this.unorderedListUI,10)
}if(this.isFeatureEnabled("ordered")){this.orderedListUI=a.createElement("ordered",this,true,this.getTooltip("ordered"));
a.addElement("lists",b.Plugin.SORT_LISTS,this.orderedListUI,20)
}if(this.isFeatureEnabled("indent")){this.indentUI=a.createElement("indent",this,false,this.getTooltip("indent"));
a.addElement("lists",b.Plugin.SORT_LISTS,this.indentUI,40)
}if(this.isFeatureEnabled("outdent")){this.outdentUI=a.createElement("outdent",this,false,this.getTooltip("outdent"));
a.addElement("lists",b.Plugin.SORT_LISTS,this.outdentUI,30)
}},notifyPluginConfig:function(a){a=a||{};
CUI.rte.Utils.applyDefaults(a,{features:"*",indentSize:40,keepStructureOnUnlist:false,tooltips:{unordered:{title:CUI.rte.Utils.i18n("plugins.list.ulTitle"),text:CUI.rte.Utils.i18n("plugins.list.ulText")},ordered:{title:CUI.rte.Utils.i18n("plugins.list.olTitle"),text:CUI.rte.Utils.i18n("plugins.list.olText")},indent:{title:CUI.rte.Utils.i18n("plugins.list.indentTitle"),text:CUI.rte.Utils.i18n("plugins.list.indentText")},outdent:{title:CUI.rte.Utils.i18n("plugins.list.outdentTitle"),text:CUI.rte.Utils.i18n("plugins.list.outdentText")}}});
this.config=a
},execute:function(b){var a=undefined;
if((b=="indent")||(b=="outdent")){a=this.config.indentSize
}else{if(CUI.rte.Common.strStartsWith(b,"insert")){a=this.config.keepStructureOnUnlist
}else{b="insert"+b+"list";
a=this.config.keepStructureOnUnlist
}}this.editorKernel.relayCmd(b,a)
},updateState:function(j){var b=j.editContext;
var a,n;
if(this.orderedListUI){a=this.editorKernel.queryState("insertorderedlist",j);
n=(a==null)||(a==CUI.rte.commands.List.NO_LIST_AVAILABLE);
this.orderedListUI.setSelected((a===true)||(a==null));
this.orderedListUI.setDisabled(n)
}if(this.unorderedListUI){a=this.editorKernel.queryState("insertunorderedlist",j);
n=(a==null)||(a==CUI.rte.commands.List.NO_LIST_AVAILABLE);
this.unorderedListUI.setSelected((a===true)||(a==null));
this.unorderedListUI.setDisabled(n)
}if(this.outdentUI){this.outdentUI.setDisabled(!this.editorKernel.queryState("indent",j))
}if(this.indentUI){var m=true;
var d=j.nodeList.getTags(b,[{matcher:function(c){return CUI.rte.Common.isTag(c,"li")
}}],true,true);
var h=d.length;
for(var g=0;
g<h;
g++){var k=d[g].dom;
if(!k.previousSibling){var e=k.parentNode.parentNode;
var f=false;
for(var l=0;
l<h;
l++){if(d[l].dom==e){f=true;
break
}}if(!f){m=false;
break
}}}this.indentUI.setDisabled(!m)
}}});
CUI.rte.plugins.PluginRegistry.register("lists",CUI.rte.plugins.ListPlugin);
CUI.rte.plugins.MiscToolsPlugin=new Class({toString:"MiscToolsPlugin",extend:CUI.rte.plugins.Plugin,specialCharsUI:null,sourceEditUI:null,specialCharsDialog:null,savedRange:null,getFeatures:function(){return["specialchars","sourceedit"]
},initializeUI:function(a){var b=CUI.rte.plugins;
var c=CUI.rte.ui;
if(this.isFeatureEnabled("specialchars")){this.specialCharsUI=a.createElement("specialchars",this,false,this.getTooltip("specialchars"));
a.addElement("misc",b.Plugin.SORT_MISC,this.specialCharsUI,100)
}if(this.isFeatureEnabled("sourceedit")&&this.editorKernel.canEditSource()){this.sourceEditUI=a.createElement("sourceedit",this,true,this.getTooltip("sourceedit"));
a.addElement("misc",b.Plugin.SORT_MISC,this.sourceEditUI,110)
}},insertSpecialChars:function(e){var c=CUI.rte.Common;
var b=this.editorKernel.getDialogManager();
if(b.isShown(this.specialCharsDialog)&&b.toggleVisibility(this.specialCharsDialog)){b.hide(this.specialCharsDialog);
return
}this.savedRange=CUI.rte.Selection.saveNativeSelection(e);
if(!this.specialCharsDialog||b.mustRecreate(this.specialCharsDialog)){var a={insertCharacter:CUI.rte.Utils.scope(function(f){this.insertCharacter(f)
},this),parameters:{command:this.pluginId+"#specialchars"}};
var d=this.config.specialCharsConfig||{};
CUI.rte.Utils.applyDefaults(d,a);
this.specialCharsDialog=b.create(CUI.rte.ui.DialogManager.DLG_SPECCHARS,d);
this.specialCharsDialog.editContext=e
}b.show(this.specialCharsDialog)
},insertCharacter:function(b){var a=CUI.rte.Common;
CUI.rte.Selection.restoreNativeSelection(this.specialCharsDialog.editContext,this.savedRange);
this.editorKernel.relayCmd("InsertHTML",b)
},notifyPluginConfig:function(a){a=a||{};
var b={specialCharsConfig:{tableCls:"richtext-scd-table",rowCls:undefined,cellCls:"richtext-scd-cell",overCls:"richtext-scd-cell-over",magnifyCls:"richtext-scd-magnify",chars:{copyright:{entity:"&copy;"},registered:{entity:"&reg;"},trademark:{entity:"&trade;"}}},tooltips:{sourceedit:{title:CUI.rte.Utils.i18n("plugins.miscTools.sourceEditTitle"),text:CUI.rte.Utils.i18n("plugins.miscTools.sourceEditText")},specialchars:{title:CUI.rte.Utils.i18n("plugins.miscTools.specialCharsTitle"),text:CUI.rte.Utils.i18n("plugins.miscTools.specialCharsText")}}};
if(a.specialCharsConfig&&a.specialCharsConfig.chars){delete b.specialCharsConfig.chars
}CUI.rte.Utils.applyDefaults(a,b);
this.config=a
},execute:function(d,c,a){var b=a.editContext;
if(d=="specialchars"){this.insertSpecialChars(b)
}else{if((d=="sourceedit")&&this.sourceEditUI){CUI.rte.Utils.defer(this.editorKernel.requestSourceEdit,1,this.editorKernel,[this.sourceEditUI.isSelected()])
}}},updateState:function(d){var c=d.editContext;
if(this.specialCharsUI!=null){var b=d.nodeList.getTags(c,[{tagName:["td","th"]}],false);
var a=(b.length>0);
this.specialCharsUI.setDisabled(a)
}},isHeadless:function(b,a){return(b!=="specialchars")
}});
CUI.rte.plugins.PluginRegistry.register("misctools",CUI.rte.plugins.MiscToolsPlugin);
CUI.rte.plugins.ParagraphFormatPlugin=new Class({toString:"ParagraphFormatPlugin",extend:CUI.rte.plugins.Plugin,cachedFormats:null,formatUI:null,getFeatures:function(){return["paraformat"]
},getFormatId:function(e){var b=e.tagName.toLowerCase();
var a=this.getFormats();
var d=a.length;
for(var c=0;
c<d;
c++){var g=a[c];
if(g.tag&&(g.tag==b)){return g.tag
}}return null
},getFormats:function(){var a=CUI.rte.Common;
if(this.cachedFormats==null){this.cachedFormats=this.config.formats||{};
a.removeJcrData(this.cachedFormats);
this.cachedFormats=a.toArray(this.cachedFormats,"tag","description")
}return this.cachedFormats
},setFormats:function(a){this.cachedFormats=a
},hasFormatsConfigured:function(){return !!this.config.formats
},getFormatById:function(a,d){var c=a.length;
for(var b=0;
b<c;
b++){if(a[b].tag==d){return a[b]
}}return null
},initializeUI:function(a){var b=CUI.rte.plugins;
var c=CUI.rte.ui;
if(this.isFeatureEnabled("paraformat")){this.formatUI=a.createParaFormatter("paraformat",this,null,this.getFormats());
a.addElement("paraformat",b.Plugin.SORT_PARAFORMAT,this.formatUI,10)
}},notifyPluginConfig:function(a){a=a||{};
var b={formats:[{tag:"p",description:CUI.rte.Utils.i18n("plugins.paraFormat.defaultP")},{tag:"h1",description:CUI.rte.Utils.i18n("plugins.paraFormat.defaultH1")},{tag:"h2",description:CUI.rte.Utils.i18n("plugins.paraFormat.defaultH2")},{tag:"h3",description:CUI.rte.Utils.i18n("plugins.paraFormat.defaultH3")}]};
if(a.formats){delete b.formats
}CUI.rte.Utils.applyDefaults(a,b);
this.config=a
},execute:function(a){if(this.formatUI){var b=this.formatUI.getSelectedFormat();
if(b){this.editorKernel.relayCmd("format",this.getFormatById(this.getFormats(),b))
}}},updateState:function(g){if(!this.formatUI){return
}var b=CUI.rte.Common;
var j=CUI.rte.DomProcessor;
var d=null;
var e=g.nodeList;
var f=e.commonAncestor;
var n=false;
var h={};
var m=0;
var l=0;
var a=null;
while(f){if(f.nodeType==1){d=this.getFormatId(f);
if(d){h[d]=true;
n=true;
l++;
break
}else{if(b.isTag(f,j.AUXILIARY_ROOT_TAGS)){if(a==null){a=f
}}}}f=f.parentNode
}if(!n){var i=e.nodes.length;
for(var c=0;
c<i;
c++){f=e.nodes[c];
if(f.dom.nodeType==1){var k=this.getFormatId(f.dom);
if(k){if(!h[k]){h[k]=true;
l++
}if(d==null){d=k
}}else{m++
}}else{m++
}}}this.formatUI.selectFormat(d,a,l,m)
}});
CUI.rte.plugins.PluginRegistry.register("paraformat",CUI.rte.plugins.ParagraphFormatPlugin);
CUI.rte.plugins.SubSuperScriptPlugin=new Class({toString:"SubSuperScriptPlugin",extend:CUI.rte.plugins.Plugin,subscriptUI:null,superscriptUI:null,getFeatures:function(){return["subscript","superscript"]
},initializeUI:function(a){var b=CUI.rte.plugins;
var c=CUI.rte.ui;
if(this.isFeatureEnabled("subscript")){this.subscriptUI=a.createElement("subscript",this,true,this.getTooltip("subscript"));
a.addElement("format",b.Plugin.SORT_FORMAT,this.subscriptUI,100)
}if(this.isFeatureEnabled("superscript")){this.superscriptUI=a.createElement("superscript",this,true,this.getTooltip("superscript"));
a.addElement("format",b.Plugin.SORT_FORMAT,this.superscriptUI,110)
}},execute:function(a){this.editorKernel.relayCmd(a)
},updateState:function(b){var a=this.editorKernel.queryState("subscript",b);
var c=this.editorKernel.queryState("superscript",b);
if(this.subscriptUI!=null){this.subscriptUI.setSelected(a)
}if(this.superscriptUI!=null){this.superscriptUI.setSelected(c)
}},notifyPluginConfig:function(a){a=a||{};
var b={tooltips:{subscript:{title:CUI.rte.Utils.i18n("plugins.subSuperScript.subTitle"),text:CUI.rte.Utils.i18n("plugins.subSuperScript.subText")},superscript:{title:CUI.rte.Utils.i18n("plugins.subSuperScript.superTitle"),text:CUI.rte.Utils.i18n("plugins.subSuperScript.superText")}}};
CUI.rte.Utils.applyDefaults(a,b);
this.config=a
}});
CUI.rte.plugins.PluginRegistry.register("subsuperscript",CUI.rte.plugins.SubSuperScriptPlugin);
CUI.rte.plugins.AbstractTablePlugin=new Class({toString:"AbstractTablePlugin",extend:CUI.rte.plugins.Plugin,tableUI:null,insertRowBeforeUI:null,insertRowAfterUI:null,removeRowUI:null,insertColBeforeUI:null,insertColAfterUI:null,removeColUI:null,tableSelection:null,tablePropsDialog:null,currentSelectionDef:null,_init:function(a){this.inherited(arguments);
a.addPluginListener("mousedown",this.clearSelectionHandler,this,this,false);
a.addPluginListener("mouseup",this.addSelectionHandler,this,this,false);
a.addPluginListener("keydown",this.handleSelectionOnKey,this,this,false);
a.addPluginListener("commandexecuted",this.clearSelectionHandler,this,this,false);
a.addPluginListener("beforekeydown",this.handleTableKeys,this,this,false,250)
},isTableMode:function(){return(this.config.editMode==CUI.rte.plugins.AbstractTablePlugin.EDITMODE_TABLE)
},handleTableKeys:function(p){if(p.cancelKey){return
}var f=CUI.rte.Common;
var b=CUI.rte.DomProcessor;
var o=CUI.rte.Selection;
var c=p.editContext;
var t;
if(this.isTableMode()){if(f.ua.isWebKit||f.ua.isIE9){t=this.editorKernel.createQualifiedSelection(c);
if(!t||!f.containsTagInPath(c,t.startNode,"tr")){if(!(p.isCtrl&&p.getCharCode()==90)){var d=f.getChildNodesByType(c.root,["th","td"],true);
if(d.length>0){var u;
if(f.isAncestor(c,c.root.firstChild,t.startNode)){u=d[0]
}else{u=d[d.length-1]
}o.selectNode(c,u,true)
}b.removeNonTableBlocks(c);
p.cancelKey=true
}}else{var r=f.getTagInPath(c,t.startNode,["td","th"]);
var a=this.getTableInfo(this.currentSelectionDef,c);
var n=a.tableMatrix;
var i=n.getCellInfo(r);
if(p.isCtrl()&&!p.isShift()&&(p.getCharCode()==f.KEY_STROKES.ARROW_LEFT||p.getCharCode()==f.KEY_STROKES.ARROW_RIGHT)){p.cancelKey=true
}else{if(i.isFirstRow&&i.isFirstCol){if(p.getCharCode()==f.KEY_STROKES.ARROW_UP&&!p.isShift()){p.cancelKey=true
}else{if(!o.isSelection(t)&&!t.startOffset&&(p.getCharCode()==f.KEY_STROKES.ARROW_LEFT||p.getCharCode()==f.KEY_STROKES.ARROW_UP)){p.cancelKey=true
}}}else{if(i.isLastRow&&i.isLastCol){if(p.getCharCode()==f.KEY_STROKES.ARROW_DOWN&&!p.isShift()){p.cancelKey=true
}else{if(!o.isSelection(t)&&(b.isBlockEnd(c,t.startNode,t.startOffset)||(t.startOffset==null&&t.startNode.tagName.toLowerCase()=="td"))&&(p.getCharCode()==f.KEY_STROKES.ARROW_RIGHT||p.getCharCode()==f.KEY_STROKES.ARROW_DOWN)){p.cancelKey=true
}}}}}}}}if(p.isTab()&&!p.cancelKey){if(!t){t=this.editorKernel.createQualifiedSelection(c)
}if(!o.isSelection(t)){this.editorKernel.execCmd("addundostep");
var g=CUI.rte.commands.Table.getCellFromSelection(c,t);
if(g){var m;
var h=g.parentNode;
d=f.getChildNodesByType(h,f.TABLE_CELLS,false);
var j=f.arrayIndex(d,g)+1;
if(j<d.length){m=d[j]
}else{var s=h.parentNode;
var l=f.getChildNodesByType(s,"tr",false);
var k=f.arrayIndex(l,h)+1;
if(k<l.length){h=l[k];
d=f.getChildNodesByType(h,f.TABLE_CELLS,false);
m=d[0]
}}if(m==null){this.editorKernel.relayCmd("insertrow",{position:"after",caret:"firstCell"})
}if(m!=null){var q=(f.ua.isIE?null:o.getPreferredScrollOffset(c));
o.selectNode(c,m,true);
if(f.ua.isGecko&&c.iFrame){o.ensureCaretVisibility(c,c.iFrame,q)
}}p.cancelKey=true
}}}},handleSelectionOnKey:function(a){if(this.tableSelection){if(a.isBackSpace()||a.isDelete()){this.clearSelectionContent(a.editContext)
}}this.clearSelectionHandler(a)
},addSelectionHandler:function(i){var b=CUI.rte.Common;
var h=CUI.rte.Selection;
var d=false;
var f=(i.getType()=="mouseup")&&(i.getButton()==0)&&i.isCtrl();
if(f&&(b.ua.isIE||b.ua.isWebKit)){var c=i.editContext;
var g=h.createProcessingSelection(c);
var a=CUI.rte.commands.Table.getCellFromSelection(c,g);
if(a){if(a){this.addCellToSelection(a);
i.preventDefault()
}d=true
}}return d
},clearSelectionHandler:function(g){var b=CUI.rte.Common;
var a=g.editContext;
var i=g.getType();
var d=(i=="mousedown")&&(g.getButton()==0)&&g.isCtrl();
if(this.tableSelection){var h=false;
if(i=="keydown"){var l=g.getKey();
if(l>=32){if(!b.ua.isMac||(l!=91)){h=true
}}}else{if(i=="mousedown"){h=!d&&(g.getButton()!=2)
}else{if(i=="commandexecuted"){switch(g.cmd.toLowerCase()){case"removetable":this.tableSelection=null;
break;
case"addundostep":case"clearredohistory":break;
case"removerow":case"removecolumn":case"undo":case"redo":case"insertrow":case"insertcolumn":case"splitcell":case"mergecells":h=true;
break;
case"modifycell":this.refreshTableSelection();
break;
default:break
}}}}if(h){this.removeTableSelection()
}}if(i=="commandexecuted"){if(b.ua.isGecko){var f=false;
var k=g.editContext.win.getSelection();
if(k.rangeCount>1){f=true
}else{if(k.rangeCount==1){var j=k.getRangeAt(0);
var c=j.commonAncestorContainer;
if(c&&(b.getTagInPath(a,c,"table"))){f=true
}}}if(f){CUI.rte.Selection.flushSelection(g.editContext,true)
}}}},addTableSelection:function(d){var b=CUI.rte.Common;
if(this.tableSelection){this.removeTableSelection()
}var f=d.length;
for(var e=0;
e<f;
e++){var a=d[e];
b.addClass(a,CUI.rte.Theme.TABLESELECTION_CLASS)
}this.tableSelection=d
},addCellToSelection:function(b){var a=CUI.rte.Common;
if(!this.tableSelection){this.tableSelection=[]
}a.addClass(b,CUI.rte.Theme.TABLESELECTION_CLASS);
this.tableSelection.push(b)
},removeTableSelection:function(){var b=CUI.rte.Common;
var e=this.tableSelection.length;
for(var d=0;
d<e;
d++){var a=this.tableSelection[d];
b.removeClass(a,CUI.rte.Theme.TABLESELECTION_CLASS)
}this.tableSelection=null
},refreshTableSelection:function(){var d=CUI.rte.Common;
var f=this.tableSelection.length;
var b=[];
for(var e=0;
e<f;
e++){var a=this.tableSelection[e];
if(a.parentNode==null){d.removeClass(a,CUI.rte.Theme.TABLESELECTION_CLASS)
}else{d.addClass(a,CUI.rte.Theme.TABLESELECTION_CLASS);
b.push(a)
}}this.tableSelection=b
},clearSelectionContent:function(d){var e=CUI.rte.DomProcessor;
var i=this.tableSelection.length;
for(var h=0;
h<i;
h++){var a=this.tableSelection[h];
var b=a.childNodes.length;
for(var g=b-1;
g>=0;
g--){a.removeChild(a.childNodes[0])
}var f=e.createEmptyLinePlaceholder(d,false);
if(f){a.appendChild()
}}},createOrEditTable:function(c,f){var e=c.editContext;
this.savedRange=c.savedRange;
this.editorKernel.selectQualifiedRangeBookmark(e,this.savedRange);
var g=this.editorKernel.queryState("table");
var d;
var b=null;
if(g&&!f){d={editContext:e,cmd:"modifytable",table:g,parameters:{command:this.pluginId+"#modifytable"}}
}else{b=CUI.rte.Compatibility.getConfigValue(this.config,"defaultValues.tableTemplate");
if(!b){d={cmd:"createtable",table:null,parameters:{command:c.command?c.command:this.pluginId+"#table"}}
}}var h=this.editorKernel;
if(!b&&d){d.listeners={show:function(){h.fireUIEvent("dialogshow")
},hide:function(){h.fireUIEvent("dialoghide")
}}
}if(b){this.editorKernel.selectQualifiedRangeBookmark(e,this.savedRange);
this.editorKernel.relayCmd("createtable",{html:b})
}else{var a=this.editorKernel.getDialogManager();
if(a.isShown(this.tablePropsDialog)&&a.toggleVisibility(this.tablePropsDialog)){a.hide(this.tablePropsDialog);
return
}this.showTablePropsUI(d,e)
}},showTablePropsUI:function(b,a){return
},execCreateOrEditTable:function(c,b,a){this.editorKernel.selectQualifiedRangeBookmark(a,this.savedRange);
if(c&&b){this.editorKernel.relayCmd(c,b)
}},editCellProps:function(e){var g=e.editContext;
this.savedRange=e.savedRange;
this.editorKernel.selectQualifiedRangeBookmark(g,this.savedRange);
var d=[];
if(e&&e.selectionContext){var b=e.selectionContext;
d=CUI.rte.commands.Table.getCellsFromNodeList(g,b.nodeList)
}else{d.push(this.editorKernel.queryState("modifycell"))
}if(!d){return
}var a={editContext:g,pluginConfig:this.config,cells:d,execFn:CUI.rte.Utils.scope(this.execEditCellProps,this)};
var c=this.editorKernel.getDialogManager();
var f=c.create(CUI.rte.ui.DialogManager.DLG_CELLPROPS,a);
c.show(f)
},execEditCellProps:function(a,b){this.editorKernel.selectQualifiedRangeBookmark(b,this.savedRange);
if(a){var c=this.getHiddenHeaderConfig();
if(c.hiddenHeaderEditingCSS){a.hiddenHeaderEditingCSS=c.hiddenHeaderEditingCSS
}else{a.hiddenHeaderEditingStyle=c.hiddenHeaderEditingStyle
}a.handleHiddenHeader="false";
this.editorKernel.relayCmd("modifyCell",a)
}},selectRow:function(f){var e=f.tableMatrix;
var a=f.cell;
var b=e.getCellDef(a);
var g=e.getRow(b.row);
var d=[];
for(var h=0;
h<g.length;
h++){d[h]=g[h].cellDom
}this.addTableSelection(d)
},selectColumn:function(g){var f=g.tableMatrix;
var a=g.cell;
var b=f.getCellDef(a);
var e=f.getColumn(b.col);
var d=[];
for(var h=0;
h<e.length;
h++){d[h]=e[h].cellDom
}this.addTableSelection(d)
},getFeatures:function(){return["table","removetable","insertrow","removerow","insertcolumn","removecolumn","cellprops","mergecells","splitcell","selectrow","selectcolumn"]
},reportStyles:function(){var a=CUI.rte.Compatibility;
var c=[];
var d=this.config.tableStyles;
if(d!=null){d=a.convertToArray(d,"cssName","text");
a.changeDeprecatedPropertyName(d,"className","cssName");
c.push({type:"table",styles:d})
}var b=this.config.cellStyles;
if(b!=null){b=a.convertToArray(b,"cssName","text");
a.changeDeprecatedPropertyName(b,"className","cssName");
c.push({type:"cell",styles:b})
}return(c.length>0?c:null)
},notifyPluginConfig:function(a){a=a||{};
CUI.rte.Utils.applyDefaults(a,{tableStyles:null,cellStyles:null,defaultValues:{cellspacing:"0",cellpadding:"1",border:"1",columns:"3",rows:"2",header:"none"},tablePropConfig:{basicDefs:true,basicStyling:true},cellPropConfig:{basicDefs:true},hiddenHeaderConfig:{hiddenHeaderStyle:"display: block; height: 1px; width: 1px; overflow: hidden; position: absolute; top: -10px;",hiddenHeaderEditingStyle:"background-color: rgb(215,215,215);"},tooltips:{table:{title:CUI.rte.Utils.i18n("plugins.table.tableTitle"),text:CUI.rte.Utils.i18n("plugins.table.tableText")},cellprops:{title:CUI.rte.Utils.i18n("plugins.table.cellTitle"),text:CUI.rte.Utils.i18n("plugins.table.cellText")},"insertrow-before":{title:CUI.rte.Utils.i18n("plugins.table.insertAboveTitle"),text:CUI.rte.Utils.i18n("plugins.table.insertAboveText")},"insertrow-after":{title:CUI.rte.Utils.i18n("plugins.table.insertBelowTitle"),text:CUI.rte.Utils.i18n("plugins.table.insertBelowText")},removerow:{title:CUI.rte.Utils.i18n("plugins.table.deleteRowTitle"),text:CUI.rte.Utils.i18n("plugins.table.deleteRowText")},"insertcolumn-before":{title:CUI.rte.Utils.i18n("plugins.table.insertLeftTitle"),text:CUI.rte.Utils.i18n("plugins.table.insertLeftText")},"insertcolumn-after":{title:CUI.rte.Utils.i18n("plugins.table.insertRightTitle"),text:CUI.rte.Utils.i18n("plugins.table.insertRightText")},removecolumn:{title:CUI.rte.Utils.i18n("plugins.table.deleteColumnTitle"),text:CUI.rte.Utils.i18n("plugins.table.deleteColumnText")}}});
this.config=a
},initializeTableModeUI:function(a){var b=CUI.rte.plugins;
if(this.isFeatureEnabled("table")&&!this.isTableToolbarMode()){this.tableUI=a.createElement("table",this,false,this.getTooltip("table"),"x-edit-table-properties");
a.addElement("table",b.Plugin.SORT_TABLE_TABLEMODE,this.tableUI,10)
}if(this.isFeatureEnabled("cellprops")){this.cellPropsUI=a.createElement("cellprops",this,false,this.getTooltip("cellprops"));
a.addElement("table",b.Plugin.SORT_TABLE_TABLEMODE,this.cellPropsUI,20)
}if(this.isFeatureEnabled("insertrow")){this.insertRowBeforeUI=a.createElement("insertrow-before",this,false,this.getTooltip("insertrow-before"),null,{cmd:"insertrow",cmdValue:"before"});
a.addElement("table.row",b.Plugin.SORT_TABLE_TABLEMODE+1,this.insertRowBeforeUI,10);
this.insertRowAfterUI=a.createElement("insertrow-after",this,false,this.getTooltip("insertrow-after"),null,{cmd:"insertrow",cmdValue:"after"});
a.addElement("table.row",b.Plugin.SORT_TABLE_TABLEMODE+1,this.insertRowAfterUI,20)
}if(this.isFeatureEnabled("removerow")){this.removeRowUI=a.createElement("removerow",this,false,this.getTooltip("removerow"));
a.addElement("table.row",b.Plugin.SORT_TABLE_TABLEMODE+1,this.removeRowUI,30)
}if(this.isFeatureEnabled("insertcolumn")){this.insertColBeforeUI=a.createElement("insertcolumn-before",this,false,this.getTooltip("insertcolumn-before"),null,{cmd:"insertcolumn",cmdValue:"before"});
a.addElement("table.col",b.Plugin.SORT_TABLE_TABLEMODE+2,this.insertColBeforeUI,10);
this.insertColAfterUI=a.createElement("insertcolumn-after",this,false,this.getTooltip("insertcolumn-after"),null,{cmd:"insertcolumn",cmdValue:"after"});
a.addElement("table.col",b.Plugin.SORT_TABLE_TABLEMODE+2,this.insertColAfterUI,20)
}if(this.isFeatureEnabled("removecolumn")){this.removeColUI=a.createElement("removecolumn",this,false,this.getTooltip("removecolumn"));
a.addElement("table.col",b.Plugin.SORT_TABLE_TABLEMODE+2,this.removeColUI,30)
}},initializeUI:function(a){var b=CUI.rte.plugins;
var c=CUI.rte.ui;
if(!this.isTableMode()){if(this.isFeatureEnabled("table")){this.tableUI=a.createElement("table",this,false,this.getTooltip("table"));
a.addElement("table",b.Plugin.SORT_TABLE,this.tableUI,10)
}}else{this.initializeTableModeUI(a)
}},execute:function(a,e,b){var c=b.editContext;
if(!b.savedRange){b.savedRange=this.editorKernel.createQualifiedRangeBookmark(c)
}var d=a;
var f=a.indexOf(".",a);
if(f>0){d=a.substring(0,f);
e=a.substring(f+1,a.length)
}if(d=="table"){this.createOrEditTable(b,false)
}else{if(d=="createtable"){this.createOrEditTable(b,true)
}else{if(d=="cellprops"){this.editCellProps(b)
}else{if(d=="selectrow"){this.selectRow(e);
this.editorKernel.deferFocus()
}else{if(d=="selectcolumn"){this.selectColumn(e);
this.editorKernel.deferFocus()
}else{this.editorKernel.relayCmd(d,e)
}}}}}},updateState:function(g){this.currentSelectionDef=g;
if(this.isTableMode()){var b=g.editContext;
var c=CUI.rte.Common;
var d=g.nodeList;
var f=CUI.rte.commands.Table.getCellFromNodeList(b,d);
var a=(f!=null);
var h=c.getTagInPath(b,d.commonAncestor,"table");
if(h){var e=new CUI.rte.TableMatrix();
e.createTableMatrix(h);
var i=e.getTableSize();
if(this.removeRowUI){this.removeRowUI.setDisabled((i.rows==1)||!a)
}if(this.removeColUI){this.removeColUI.setDisabled((i.cols==1)||!a)
}if(this.insertColBeforeUI){this.insertColBeforeUI.setDisabled(!a)
}if(this.insertColAfterUI){this.insertColAfterUI.setDisabled(!a)
}if(this.insertRowBeforeUI){this.insertRowBeforeUI.setDisabled(!a)
}if(this.insertRowAfterUI){this.insertRowAfterUI.setDisabled(!a)
}}}},getTableInfo:function(i,c){var a=this.isTableMode();
var d=CUI.rte.Common;
var e=i.nodeList;
var j=i.selection;
var g=CUI.rte.commands.Table.getCellFromNodeList(c,e);
var b=(g!=null);
var h=d.getTagInPath(c,e.commonAncestor,"table");
var k=b||(h!=null);
var f;
if(k){f=new CUI.rte.TableMatrix();
f.createTableMatrix(h)
}return{singleCell:g,isSingleCell:b,tableMatrix:f,tableDom:h,isTable:k}
},handleContextMenu:function(j,k,d){var i=CUI.rte.Common;
var c=this.isTableMode();
var b=this.getTableInfo(k,d);
var t=b.singleCell;
var g=b.isSingleCell;
var q=b.tableMatrix;
var v=b.isTable;
var w=k.selection;
var f=null;
var u=[];
var r=true;
var s=true;
if(v&&c){var p=q.getTableSize();
r=(p.cols>1);
s=(p.rows>1)
}if(v&&!g){if(w.cellSelection){f=q.createSelection(w.cellSelection.cells)
}}if(g){if(this.isFeatureEnabled("cellprops")){u.push({text:CUI.rte.Utils.i18n("plugins.table.cellProps"),plugin:this,cmd:"cellprops",iconCls:"rte-cellprops"})
}}if(f!=null){if(this.isFeatureEnabled("mergecells")){if(f.selectionProps.isRect){u.push({text:CUI.rte.Utils.i18n("plugins.table.mergeCells"),plugin:this,cmd:"mergecells",cmdValue:f,iconCls:"rte-cellmerge"})
}u.push({text:CUI.rte.Utils.i18n("plugins.table.cellProps"),plugin:this,cmd:"cellprops",iconCls:"rte-cellprops"})
}}else{if(g){if(this.isFeatureEnabled("mergecells")){var l=q.getCellInfo(t);
if(!l.isLastCol){f=q.createSelection(t);
f.expand(1,0);
if(f.selectionProps.isRect){u.push({text:CUI.rte.Utils.i18n("plugins.table.mergeRight"),plugin:this,cmd:"mergecells",cmdValue:f,iconCls:"rte-cellmerge"})
}}if(!l.isLastRow){f=q.createSelection(t);
f.expand(0,1);
if(f.selectionProps.isRect){u.push({text:CUI.rte.Utils.i18n("plugins.table.mergeDown"),plugin:this,cmd:"mergecells",cmdValue:f,iconCls:"rte-cellmerge"})
}}}}}if(g){if(this.isFeatureEnabled("splitcell")){u.push({text:CUI.rte.Utils.i18n("plugins.table.splitHor"),plugin:this,cmd:"splitcell",cmdValue:"horizontal",iconCls:"rte-cellsplit-horizontal"});
u.push({text:CUI.rte.Utils.i18n("plugins.table.splitVert"),plugin:this,cmd:"splitcell",cmdValue:"vertical",iconCls:"rte-cellsplit-vertical"})
}}if(u.length>0){j.addItem(j.createItem({text:CUI.rte.Utils.i18n("plugins.table.cell"),subItems:u,iconCls:"rte-cell"}))
}if(g){var e=[];
if(this.isFeatureEnabled("insertcolumn")){e.push({text:CUI.rte.Utils.i18n("plugins.table.insertBefore"),plugin:this,cmd:"insertcolumn",cmdValue:"before",iconCls:"rte-insertcolumn-before"});
e.push({text:CUI.rte.Utils.i18n("plugins.table.insertAfter"),plugin:this,cmd:"insertcolumn",cmdValue:"after",iconCls:"rte-insertcolumn-after"})
}if(this.isFeatureEnabled("removecolumn")&&r){e.push({text:CUI.rte.Utils.i18n("plugins.table.remove"),plugin:this,cmd:"removecolumn",iconCls:"rte-removecolumn"})
}if(e.length>0){j.addItem(j.createItem({text:CUI.rte.Utils.i18n("plugins.table.column"),subItems:e,iconCls:"rte-column"}))
}}if(g){var h=[];
if(this.isFeatureEnabled("insertrow")){h.push({text:CUI.rte.Utils.i18n("plugins.table.insertBefore"),plugin:this,cmd:"insertrow",cmdValue:"before",iconCls:"rte-insertrow-before"});
h.push({text:CUI.rte.Utils.i18n("plugins.table.insertAfter"),plugin:this,cmd:"insertrow",cmdValue:"after",iconCls:"rte-insertrow-after"})
}if(this.isFeatureEnabled("removerow")&&s){h.push({text:CUI.rte.Utils.i18n("plugins.table.remove"),plugin:this,cmd:"removerow",iconCls:"rte-removerow"})
}if(h.length>0){j.addItem(j.createItem({text:CUI.rte.Utils.i18n("plugins.table.row"),subItems:h,iconCls:"rte-row"}))
}if(this.isFeatureEnabled("table")){j.addItem(j.createItem({text:CUI.rte.Utils.i18n("plugins.table.tableProps"),plugin:this,cmd:"table",iconCls:"rte-tableprops"}))
}if(this.isFeatureEnabled("removetable")&&!c){j.addItem(j.createItem({text:CUI.rte.Utils.i18n("plugins.table.removeTable"),plugin:this,cmd:"removetable",iconCls:"rte-removetable"}))
}if(this.isFeatureEnabled("table")){j.addItem(j.createItem({text:CUI.rte.Utils.i18n("plugins.table.nestedTable"),plugin:this,cmd:"createtable",iconCls:"rte-createtable"}))
}var m=false;
if(this.isFeatureEnabled("selectrow")&&g){if(!m){j.addItem(j.createSeparator());
m=true
}j.addItem(j.createItem({text:CUI.rte.Utils.i18n("plugins.table.selectRow"),plugin:this,cmd:"selectrow",cmdValue:{tableMatrix:q,cell:t}}))
}if(this.isFeatureEnabled("selectcolumn")&&g){if(!m){j.addItem(j.createSeparator());
m=true
}j.addItem(j.createItem({text:CUI.rte.Utils.i18n("plugins.table.selectColumn"),plugin:this,cmd:"selectcolumn",cmdValue:{tableMatrix:q,cell:t}}))
}if(!c){var a=b.tableDom.parentNode;
if(i.isRootNode(d,a)){var o=i.getChildIndex(b.tableDom);
if((o==0)||i.isTag(a.childNodes[o-1],"table")){j.addItem(j.createItem({text:CUI.rte.Utils.i18n("plugins.table.insertParaBefore"),plugin:this,cmd:"ensureparagraph",cmdValue:"before"}))
}if((o==(a.childNodes.length-1))||i.isTag(a.childNodes[o+1],"table")){j.addItem(j.createItem({text:CUI.rte.Utils.i18n("plugins.table.insertParaAfter"),plugin:this,cmd:"ensureparagraph",cmdValue:"after"}))
}}}}var n=(w.startNode.nodeType==1)&&!w.endNode&&(w.startOffset==null);
if(!v&&!n){if(this.isFeatureEnabled("table")&&!c){j.addItem(j.createItem({text:CUI.rte.Utils.i18n("plugins.table.createTable"),plugin:this,cmd:"table",iconCls:"rte-createtable"}))
}}},manipulateSelection:function(a){if(this.tableSelection){a.cellSelection={cells:this.tableSelection,otherContent:false}
}},saveRangeBookmark:function(a){if(this.tableSelection){a.cells=this.tableSelection
}},restoreRangeBookmark:function(a){if(a.cells){this.addTableSelection(a.cells)
}},createEmptyTableHTML:function(){var j=this.config.defaultValues||{};
if(j.tableTemplate){return j.tableTemplate
}var k=j.columns||1;
var g=j.rows||1;
var b="<table";
for(var e in j){if(j.hasOwnProperty(e)){var f=e.indexOf(":");
var d=false;
if(f>=0){var h=e.substring(0,f);
d=(h=="jcr")
}if((e!="columns")&&(e!="rows")&&(e!="header")&&!d){b+=" "+e+'="'+CUI.rte.Utils.htmlEncode(j[e])+'"'
}}}b+=">";
for(var a=0;
a<g;
a++){b+="<tr>";
for(var i=0;
i<k;
i++){b+=CUI.rte.TableMatrix.createEmptyCellMarkup()
}b+="</tr>"
}b+="</table>";
return b
},interceptContent:function(j,e){var b=CUI.rte.Common;
var i=CUI.rte.DomProcessor;
if(!this.isTableMode()){return null
}var a=(e?e.editContext:null);
if(j=="emptyContent"){return this.createEmptyTableHTML()
}else{if(j=="postprocessDom"){CUI.rte.DomProcessor.removeNonTableBlocks(a)
}else{if(j=="cleanDom"){if(this.tableSelection){this.removeTableSelection()
}var g=e.root;
var l=CUI.rte.Query.select("table:first",g);
if(l&&(l.length==1)){var f=true;
l=l[0];
var k=b.getChildNodesByType(l,["td","th"],true);
for(var h=0;
h<k.length;
h++){var d=k[h];
if(d.childNodes.length>0){if(!i.isEmptyLinePlaceholder(d)){f=false;
break
}}}if(f){l.parentNode.removeChild(l)
}}}}}return null
},isHeadless:function(b,a){return false
},isTableToolbarMode:function(){return false
},getHiddenHeaderConfig:function(){return this.config.hiddenHeaderConfig
}});
CUI.rte.plugins.AbstractTablePlugin.EDITMODE_DEFAULT="default";
CUI.rte.plugins.AbstractTablePlugin.EDITMODE_TABLE="table";
CUI.rte.plugins.AbstractImagePlugin=new Class({toString:"AbstractImagePlugin",extend:CUI.rte.plugins.Plugin,getFeatures:function(){return["image"]
},notifyPluginConfig:function(a){this.config=a
},execute:function(c,i,e){if(c=="imageProps"){var a=e.editContext;
var h=e.selectionContext;
var b=CUI.rte.commands.Image.getSelectedImage(h);
this.savedRange=e.savedRange;
var f={cmd:"image",editContext:a,execFn:CUI.rte.Utils.scope(this.execModifyImage,this),image:b};
var d=this.editorKernel.getDialogManager();
var g=d.create(CUI.rte.ui.DialogManager.DLG_IMAGEPROPS,f);
d.prepareShow(g);
d.show(g)
}else{if(c=="image"){this.editorKernel.relayCmd("image",i)
}}},execModifyImage:function(c,a){if(c&&a){var b=this.editorKernel.getEditContext();
this.editorKernel.selectQualifiedRangeBookmark(b,this.savedRange);
this.editorKernel.relayCmd(c,a)
}}});
CUI.rte.plugins.UndoRedoPlugin=new Class({toString:"UndoRedoPlugin",extend:CUI.rte.plugins.Plugin,undoUI:null,redoUI:null,maxUndoSteps:0,isDeleteSequence:false,isCaretMovement:false,_init:function(a){this.inherited(arguments);
a.addPluginListener("mouseup",this.addUndoStep,this,this,false);
a.addPluginListener("beforekeydown",this.handleKeyDown,this,this,false);
a.addPluginListener("keyup",this.handleKeyUp,this,this,false);
a.addPluginListener("beforecommandexecuted",this.handleCommand,this,this,false);
a.addPluginListener("commandexecuted",this.handleCommand,this,this,false)
},addUndoStep:function(){this.editorKernel.execCmd("addundostep")
},handleCommand:function(a){if(!a.customCommand||a.customCommand.isUndoable(a.cmd)){this.addUndoStep()
}},handleKeyDown:function(d){if(d.cancelKey){return
}var c=d.getKey();
var a=d.isCtrl();
var b=d.isShift();
var f=a&&!b&&(c==90);
var g=(a&&!b&&(c==89))||(b&&a&&(c==90));
if(f||g){d.cancelKey=true;
this.editorKernel.relayCmd(f?"undo":"redo")
}else{if(d.isSpace()){this.editorKernel.execCmd("addundostep")
}else{if((d.isBackSpace())||(d.isDelete())){if(!this.isDeleteSequence){this.editorKernel.execCmd("addundostep");
this.isDeleteSequence=true
}}else{if(d.isCaretMovement()){if(!this.isCaretMovement){this.editorKernel.execCmd("addundostep");
this.isCaretMovement=true
}}else{if(this.isDeleteSequence||this.isCaretMovement){if(this.isDeleteSequence){this.editorKernel.execCmd("addundostep")
}this.isDeleteSequence=false;
this.isCaretMovement=false
}if((c>32)&&(c!=224)){this.editorKernel.execCmd("clearredohistory")
}}}}}},handleKeyUp:function(a){if(a.isEnter()){this.editorKernel.execCmd("addundostep")
}},getFeatures:function(){return["undo","redo"]
},notifyPluginConfig:function(b){var c={maxUndoSteps:50,tooltips:{undo:{title:CUI.rte.Utils.i18n("plugins.undoRedo.undoTitle"),text:CUI.rte.Utils.i18n("plugins.undoRedo.undoText")},redo:{title:CUI.rte.Utils.i18n("plugins.undoRedo.redoTitle"),text:CUI.rte.Utils.i18n("plugins.undoRedo.redoText")}}};
CUI.rte.Utils.applyDefaults(b,c);
this.config=b;
var a={maxUndoSteps:this.config.maxUndoSteps,history:this.config.history,activeStep:this.config.activeStep};
this.editorKernel.execCmd("undoconfig",a)
},initializeUI:function(a){var b=CUI.rte.plugins;
if(this.isFeatureEnabled("undo")){this.undoUI=new a.createElement("undo",this,false,this.getTooltip("undo"));
a.addElement("undo",b.Plugin.SORT_UNDO,this.undoUI,100)
}if(this.isFeatureEnabled("redo")){this.redoUI=new a.createElement("redo",this,false,this.getTooltip("redo"));
a.addElement("undo",b.Plugin.SORT_UNDO,this.redoUI,110)
}},execute:function(a,b,c){if(a=="undo"){this.editorKernel.relayCmd("undo",b)
}else{if(a=="redo"){this.editorKernel.relayCmd("redo",b)
}}},updateState:function(a){if(this.undoUI){this.undoUI.setDisabled(!this.editorKernel.queryState("undo",a))
}if(this.redoUI){this.redoUI.setDisabled(!this.editorKernel.queryState("redo",a))
}}});
CUI.rte.plugins.PluginRegistry.register("undo",CUI.rte.plugins.UndoRedoPlugin);
CUI.rte.ui.Toolkit=new Class({toString:"Toolkit",toolkitData:{},initialize:function(){},requiresInit:function(){throw new Error("Toolkit#requiresInit is not implemented by the specific toolkit.")
},createToolbarBuilder:function(a){throw new Error("Toolkit#createToolbarBuilder is not implemented by the specific toolkit.")
},createContextMenuBuilder:function(a){throw new Error("Toolkit#createContextMenuBuilder is not implemented by the specific toolkit.")
},createDialogManager:function(a){throw new Error("Toolkit#createDialogManager is not implemented by the specific toolkit.")
},addToolkitData:function(a,b){this.toolkitData[a]=b
},removeToolkitData:function(a){if(this.toolkitData.hasOwnProperty(a)){delete this.toolkitData[a]
}},hasToolkitData:function(a){return this.toolkitData.hasOwnProperty(a)
},getToolkitData:function(a){if(this.toolkitData.hasOwnProperty(a)){return this.toolkitData[a]
}return undefined
}});
CUI.rte.ui.Toolkit.TBHINT_LOCAL="local";
CUI.rte.ui.Toolkit.TBHINT_GLOBAL="global";
CUI.rte.ui.ToolkitRegistry=function(){var a={};
return{register:function(c,b){a[c]={initialized:false,obj:new b()}
},initialize:function(c,e){if(!a.hasOwnProperty(c)){throw new Error("No toolkit registered for type '"+c+"'")
}CUI.rte._toolkit=c;
var b=a[c];
var d=b.obj;
if(!b.initialized&&d.requiresInit()){d.initialize(function(){b.initialized=true;
if(e){e(d)
}})
}else{if(e){e(d)
}}},get:function(c){c=c||CUI.rte._toolkit;
if(!a.hasOwnProperty(c)){throw new Error("No toolkit registered for type '"+c+"'")
}var b=a[c];
var d=b.obj;
if(!b.initialized){if(d.requiresInit()){throw new Error("Toolkit not yet initialized.")
}else{b.initialized=true
}}return b.obj
}}
}();
CUI.rte.ui.UIEvent=new Class({toString:"UIEvent",type:null,editContext:null,construct:function(a,b,c){c=c||{};
this.type=a;
this.editContext=b;
CUI.rte.Utils.apply(this,c)
},getType:function(){return this.type
}});
CUI.rte.ui.ToolbarBuilder=new Class({toString:"ToolbarBuilder",groups:null,construct:function(){this.groups=[]
},insertInArray:function(e,c){var b=c.sort;
var d=e.length;
for(var a=0;
a<d;
a++){if(e[a].sort&&e[a].sort>b){e.splice(a,0,c);
return
}}e.push(c)
},getGroupById:function(c){var a=this.groups.length;
for(var b=0;
b<a;
b++){if(this.groups[b].id==c){return this.groups[b]
}}},addElement:function(d,a,c,b){var e=this.getGroupById(d);
if(!e){e={id:d,sort:a,elements:[]};
this.insertInArray(this.groups,e)
}this.insertInArray(e.elements,{sort:b,def:c})
},createToolbar:function(b,a){return null
},createElement:function(f,c,a,e,b,d){throw new Error("ToolbarBuilder#createElement is not implemented.")
},createParaFormatter:function(d,b,c,a){throw new Error("ToolbarBuilder#createParaFormatter is not implemented.")
},createStyleSelector:function(d,b,c,a){throw new Error("ToolbarBuilder#createStyleSelector is not implemented.")
}});
CUI.rte.ui.ToolbarBuilder.MAIN_TOOLBAR=0;
CUI.rte.ui.ToolbarBuilder.STYLE_TOOLBAR=1;
CUI.rte.ui.Toolbar=new Class({toString:"Toolbar",tbType:null,toolkitRep:null,construct:function(a){this.toolkitRep=a
},getToolkitRep:function(){return this.toolkitRep
},getItem:function(a){throw new Error("Toolbar#getItem is not implemented.")
},getHeight:function(){throw new Error("Toolbar#getHeight is not implemented.")
},adjustToWidth:function(a){},startEditing:function(a){},finishEditing:function(){},enable:function(){throw new Error("Toolbar#enable is not implemented.")
},disable:function(a){throw new Error("Toolbar#disable is not implemented.")
},destroy:function(){throw new Error("Toolbar#destroy is not implemented.")
}});
CUI.rte.ui.TbElement=new Class({toString:"TbElement",id:null,plugin:null,toggle:null,tooltip:null,toolbar:null,construct:function(f,c,a,e,b,d){this._init.apply(this,arguments)
},_init:function(f,c,a,e,b,d){this.id=f;
this.plugin=c;
this.toggle=a;
this.css=(b?b:"x-edit-"+f);
this.cmdDef=d;
if(e){this.tooltip=e;
this.tooltip.cls="x-html-editor-tip"
}else{this.tooltip=null
}},getToolbar:function(){return CUI.rte.ui.ToolbarBuilder.MAIN_TOOLBAR
},addToToolbar:function(a){throw new Error("TbElement#addToToolbar is not implemented.")
},notifyToolbar:function(a){throw new Error("TbElement#notifyToolbar is not implemented.")
},createToolbarDef:function(){throw new Error("TbElement#createToolbarDef is not implemented.")
},setDisabled:function(a){throw new Error("TbElement#setDisabled is not implemented.")
},setSelected:function(b,a){throw new Error("TbElement#setSelected is not implemented.")
}});
CUI.rte.ui.TbParaFormatter=new Class({extend:CUI.rte.ui.TbElement,formatSelector:null,formats:null,construct:function(){},_init:function(g,d,b,f,c,e,a){this.inherited(arguments);
this.formats=a
},notifyToolbar:function(a){this.toolbar=a
},getToolbar:function(){return CUI.rte.ui.ToolbarBuilder.STYLE_TOOLBAR
},initializeSelector:function(){throw new Error("tbParaFormatter#initializeSelector is not implemented.")
},getSelectorDom:function(){throw new Error("TbParaFormatter#getSelectorDom is not implemented.")
},getSelectedFormat:function(){throw new Error("TbParaFormatter#getSelectedFormat is not implemented.")
},selectFormat:function(d,c,b,a){throw new Error("TbParaFormatter#selectFormat is not implemented.")
}});
CUI.rte.ui.TbStyleSelector=new Class({toString:"TbStyleSelector",extend:CUI.rte.ui.TbElement,styleSelector:null,styles:null,_init:function(g,d,a,f,b,e,c){this.inherited(arguments);
this.styles=c
},createStyleOptions:function(){var d='<option value="">[None]</option>';
if(this.styles){var a=this.styles.length;
for(var c=0;
c<a;
c++){var f=this.styles[c];
var b=f.cssName;
var e=f.text;
d+='<option value="'+b+'">'+e+"</option>"
}}return d
},notifyToolbar:function(a){this.toolbar=a
},getToolbar:function(){return CUI.rte.ui.ToolbarBuilder.STYLE_TOOLBAR
},initializeSelector:function(){throw new Error("TbStyleSelector#initializeSelector is not implemented.")
},getSelectorDom:function(){throw new Error("TbStyleSelector#getSelectorDom is not implemented.")
},getSelectedStyle:function(){throw new Error("TbStyleSelector#getSelectedStyle is not implemented.")
},selectStyles:function(a,b){throw new Error("TbStyleSelector#selectStyles is not implemented.")
}});
CUI.rte.ui.ContextMenuBuilder=new Class({toString:"ContextMenuBuilder",items:null,menu:null,construct:function(a){this.items=[];
this.editorKernel=a
},addItem:function(a){this.items.push(a)
},clear:function(){this.items.length=0
},build:function(a,b){throw new Error("ContextMenuBuilder#build is not implemented.")
},createItem:function(a){throw new Error("ContextMenuBuilder#createItem is not implemented.")
},createSeparator:function(){throw new Error("ContextMenuBuilder#createSeparator is not implemented.")
},showAt:function(a,b){throw new Error("ContextMenuBuilder#showAt is not implemented.")
},hideAll:function(){throw new Error("ContextMenuBuilder#hide is not implemented.")
},isVisible:function(){throw new Error("ContextMenuBuilder#isVisible is not implemented.")
}});
CUI.rte.ui.CmItem=Class({toString:"CmItem",build:function(c,d,b,a){throw new Error("CmItem#build is not implemented.")
}});
CUI.rte.ui.CmSeparator=new Class({toString:"CmSeparator",build:function(a){throw new Error("CmSeparator#build must be overridden by implementing classes.")
}});
CUI.rte.ui.DialogManager=new Class({create:function(a,b){throw new Error("DialogManager#create must be implemented")
},mustRecreate:function(a){throw new Error("DialogManager#mustRecreate must be implemented")
},show:function(a){throw new Error("DialogManager#show must be implemented")
},hide:function(a){throw new Error("DialogManager#hide must be implemented")
},alert:function(c,b,a){throw new Error("DialogManager#alert must be implemented")
},isShown:function(a){throw new Error("DialogManager#isShown must be implemented")
},createDialogHelper:function(){throw new Error("DialogManager#createDialogHelper must be implemented")
},prepareShow:function(a){},toggleVisibility:function(a){return false
}});
CUI.rte.ui.DialogManager.DLG_LINK="linkDialog";
CUI.rte.ui.DialogManager.DLG_ANCHOR="anchorDialog";
CUI.rte.ui.DialogManager.DLG_FINDREPLACE="findReplaceDialog";
CUI.rte.ui.DialogManager.DLG_PASTE="pasteDialog";
CUI.rte.ui.DialogManager.DLG_SPECCHARS="specCharsDialog";
CUI.rte.ui.DialogManager.DLG_SPELLCHECKER="spellCheckerDialog";
CUI.rte.ui.DialogManager.DLG_TABLEPROPS="tablePropsDialog";
CUI.rte.ui.DialogManager.DLG_CELLPROPS="cellPropsDialog";
CUI.rte.ui.DialogManager.DLG_TABLEANDCELLPROPS="tableAndCellPropsDialog";
CUI.rte.ui.DialogManager.DLG_IMAGEPROPS="imagePropsDialog";
CUI.rte.ui.DialogHelper=new Class({toString:"DialogHelper",configVersion:null,defaultDialog:null,additionalFields:null,disabledDefaultFields:null,dialogProperties:null,dialogProcessed:null,customDialog:null,editorKernel:null,construct:function(a,b){if(arguments.length===1){b=a;
a=undefined
}this.editorKernel=b;
if(a){this.configure(a)
}},configure:function(a){if(!a.configVersion){a={configVersion:1,customDialog:a}
}CUI.rte.Utils.apply(this,a)
},instantiateDialog:function(a){throw new Error("DialogHelper#instantiateDialog must be implemented in a toolkit-specific way")
},createCustomDialog:function(){return this.instantiateDialog(this.customDialog)
},addAdditionalItems:function(k){var a=[];
if(this.additionalFields){var c=this.additionalFields.length;
for(var g=0;
g<c;
g++){var b=this.additionalFields[g];
if(b.item&&b.item.name){var h=false;
if(b.insertBefore){var e=k.length;
for(var d=0;
d<e;
d++){var j=k[d];
if(j.name==b.insertBefore){k.splice(d,0,b.item);
h=true;
break
}}}if(!h){k.push(b.item)
}if(b.validator){b.item.validator=b.validator;
b.item.evaluateValidatorsFirst=true
}a.push({name:b.item.name,fromModel:b.fromModel,toModel:b.toModel})
}}}return a
},removeDisabledItems:function(c){var a=CUI.rte.Common;
if(this.disabledDefaultFields){var e=c.length;
for(var b=e-1;
b>=0;
b--){var d=c[b];
if(a.arrayContains(this.disabledDefaultFields,d.name)){c.splice(b,1)
}}}},mergeObjects:function(e,d){for(var b in d){if(d.hasOwnProperty(b)){var c=d[b];
if(typeof(c)=="object"){var a=CUI.rte.Utils.copyObject(c);
if(e[b]){CUI.rte.Utils.applyDefaults(e[b],a)
}else{e[b]=a
}}else{e[b]=c
}}}},createExtensibleDialog:function(){if(!this.defaultDialog){throw new Error("Invalid dialogConfig; missing property defaultDialog")
}if(this.defaultDialog.dialogClass){var a=CUI.rte.Utils.copyObject(this.defaultDialog.dialogClass);
if(this.defaultDialog.dialogProperties){this.mergeObjects(a,this.defaultDialog.dialogProperties)
}if(this.dialogProperties){this.mergeObjects(a,this.dialogProperties)
}if(this.parameters){a.parameters=this.parameters
}return this.instantiateDialog(a)
}else{if(this.defaultDialog.items){return null
}else{throw new Error("Invalid dialogConfig; missing property defaultDialog.items or defaultDialog.dialogClass.")
}}},create:function(){if(this.customDialog){this.dialogProcessed=this.createCustomDialog()
}else{this.dialogProcessed=this.createExtensibleDialog()
}return this.dialogProcessed
},calculateInitialPosition:function(a){if(this.dialogProcessed){this.dialogProcessed.setPosition(this.editorKernel.calculateWindowPosition(a))
}},createItem:function(c,b,a){throw new Error("DialogHelper#createItem must be implemented in a toolkit-specific way")
},getItemType:function(a){throw new Error("DialogHelper#getItemType must be implemented in a toolkit-specific way")
},getItemName:function(a){throw new Error("DialogHelper#getItemName must be implemented in a toolkit-specific way")
},getItemValue:function(a){throw new Error("DialogHelper#getItemValue must be implemented in a toolkit-specific way")
},setItemValue:function(a,b){throw new Error("DialogHelper#setItemValue must be implemented in a toolkit-specific way")
}});
CUI.rte.ui.DialogHelper.TYPE_DIALOG="rtelinkdialog";
CUI.rte.ui.DialogHelper.TYPE_TEXTFIELD="textfield";
CUI.rte.ui.DialogHelper.TYPE_HIDDEN="hidden";